{
    "version": "https://jsonfeed.org/version/1",
    "title": "ayçš„åšå®¢",
    "subtitle": "ayçš„åšå®¢",
    "icon": "https://aynya.github.io/images/favicon.ico",
    "description": "ayçš„åšå®¢",
    "home_page_url": "https://aynya.github.io",
    "items": [
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Encoding-API-%E6%B5%81%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Encoding-API-%E6%B5%81%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/",
            "title": "ä½¿ç”¨ Encoding API æµç¼–ç è§£ç ",
            "date_published": "2025-11-27T09:20:32.000Z",
            "content_html": "<p>æœ¬æ–‡ä¸»è¦é€šè¿‡ä¸¤ä¸ªä¾‹å­æ‹†è§£å¦‚ä½•ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨åˆ›å»ºä¸€ä¸ªæ…¢é€Ÿæ•°æ®æºï¼Œå¹¶é€šè¿‡ <code>pipeThrough</code>  ç®¡é“å’Œ <code>TextEncoderStream</code> ã€ <code>TextDecoderStream</code>  å®ç°æ•°æ®çš„ç¼–ç è§£ç </p>\n<h1 id=\"åŸºç¡€æ¦‚å¿µæµçš„ä¸‰ä½ä¸€ä½“\"><a class=\"anchor\" href=\"#åŸºç¡€æ¦‚å¿µæµçš„ä¸‰ä½ä¸€ä½“\">#</a> åŸºç¡€æ¦‚å¿µï¼šæµçš„ä¸‰ä½ä¸€ä½“</h1>\n<ol>\n<li>å¯è¯»æµï¼ˆReadableStreamï¼‰ï¼šæ•°æ®çš„æºå¤´ã€‚æ•°æ®ä»è¿™é‡Œæµå‡º</li>\n<li>å¯å†™æµï¼ˆWritableStreamï¼‰ï¼šæ•°æ®çš„ç»ˆç‚¹ã€‚æ•°æ®æµå…¥è¿™é‡Œå¹¶è¢«å¤„ç†</li>\n<li>Transform æµï¼ˆTransformStreamï¼‰ï¼šæ•°æ®çš„ä¸­é—´å¤„ç†å™¨ã€‚å®ƒæ¥æ”¶ä¸€ç§æ ¼å¼çš„è¾“å…¥æµï¼Œå¹¶è¾“å‡ºå¦ä¸€ç§æ ¼å¼çš„æµï¼ˆä¾‹å¦‚ï¼šè¾“å…¥å­—ç¬¦ä¸² <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>â†’</mo></mrow><annotation encoding=\"application/x-tex\">\\rightarrow</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">â†’</span></span></span></span> è¾“å‡ºå­—èŠ‚ï¼‰</li>\n</ol>\n<h1 id=\"ç¤ºä¾‹ä¸€å­—ç¬¦ä¸²ç¼–ç ä¸æµçš„åˆ›å»ºæºå¤´\"><a class=\"anchor\" href=\"#ç¤ºä¾‹ä¸€å­—ç¬¦ä¸²ç¼–ç ä¸æµçš„åˆ›å»ºæºå¤´\">#</a> ç¤ºä¾‹ä¸€ï¼šå­—ç¬¦ä¸²ç¼–ç ä¸æµçš„åˆ›å»ºï¼ˆæºå¤´ï¼‰</h1>\n<p>å°†å­—ç¬¦  <code>foo</code>  æ¨¡æ‹Ÿæˆæ¯éš”ä¸€ç§’åˆ°è¾¾çš„æ•°æ®æµï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæµè§ˆå™¨å¤„ç†æ•°æ®æ‰€éœ€è¦çš„å­—èŠ‚æ ¼å¼ï¼ˆUTF-8 ç¼–ç ï¼‰</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">102</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// A. å¼‚æ­¥ç”Ÿæˆå™¨ï¼šæ•°æ®æº</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">chars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> encodedText <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Uint8Array<span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> charChunk <span class=\"token keyword\">of</span> encodedText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// æš‚åœ 1 ç§’ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">yield</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> charChunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// B. å¯è¯»æµï¼šå°è£…æ•°æ®æº</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> encodedTextStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReadableStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">async</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">controller</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// éå†å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œå°†æ•°æ®æ¨å…¥æµä¸­</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> charChunk <span class=\"token keyword\">of</span> <span class=\"token function\">chars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>charChunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    controller<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ•°æ®å‘é€å®Œæ¯•ï¼Œå…³é—­æµ</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// C. æ¶ˆè´¹è€…ï¼šè¯»å–å­—èŠ‚æ•°æ®</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> encodedTextStream<span class=\"token punctuation\">.</span><span class=\"token function\">getReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"å­—èŠ‚æ•°æ®ï¼š\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>æ•°æ®æºçš„æ ¼å¼ï¼šæ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸€ä¸ª  <code>Uint8Array</code>  å­—èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚å¯¹åº”ä¸€ä¸ªå­—ç¬¦çš„ UTF-8 ç¼–ç ï¼Œæ‰€æœ‰æ¶‰åŠç½‘ç»œä¼ è¾“æˆ–æ–‡ä»¶ I/O çš„åŸå§‹æ•°æ®æµï¼Œéƒ½å¿…é¡»ä»¥ <code>Uint8Array</code>  çš„å½¢å¼æµåŠ¨</li>\n<li><code>ReadableStream</code>  çš„å¯åŠ¨\n<ul>\n<li><code>async start(controller)</code>  å‡½æ•°åœ¨æµè¢«æ¶ˆè´¹æ—¶è¿è¡Œ</li>\n<li><code>for await (let chunk of chars())</code>  ä¼šæš‚åœï¼Œç­‰å¾…  <code>chars()</code>  ç”Ÿæˆå™¨æ¯ç§’  <code>yield</code>  å‡ºä¸€ä¸ª  <code>Uint8Array</code>  æ•°æ®å—</li>\n</ul>\n</li>\n</ol>\n<h1 id=\"ç¤ºä¾‹äºŒç®¡é“ä¸å®æ—¶è§£ç è§£ç å™¨\"><a class=\"anchor\" href=\"#ç¤ºä¾‹äºŒç®¡é“ä¸å®æ—¶è§£ç è§£ç å™¨\">#</a> ç¤ºä¾‹äºŒï¼šç®¡é“ä¸å®æ—¶è§£ç ï¼ˆè§£ç å™¨ï¼‰</h1>\n<p>å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çœ‹åˆ°çš„æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ä¸€å †å­—èŠ‚æ•°ç»„ã€‚è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ <code>TextDecoderStream</code>  å°†å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦ä¸²æµ</p>\n<p>å°†ä¸Šé¢çš„ <code>encodedTextStream</code>  é€šè¿‡ <code>pipeThrough</code>  ç®¡é“è¿æ¥åˆ° <code>TextDecoderStream</code> ï¼Œå³å¯å®ç°å®æ—¶è§£ç </p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//... (chars () å’Œ encodedTextStream çš„å®šä¹‰ä¿æŒä¸å˜)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// æ–°å¢ï¼šè§£ç æµ</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> decodedTextStream <span class=\"token operator\">=</span> encodedTextStream<span class=\"token punctuation\">.</span><span class=\"token function\">pipeThrough</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoderStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// è¯»å–è§£ç æµ</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> decodedTextStream<span class=\"token punctuation\">.</span><span class=\"token function\">getReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"è§£ç å­—ç¬¦ï¼š\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>\n<p><code>pipeThrough()</code>  çš„åŠ›é‡</p>\n<ul>\n<li><code>encodedTextStream.pipeThrough(new TextDecoderStream())</code>  åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®å¤„ç†ç®¡é“</li>\n<li>æ•°æ®æµï¼š <code>Uint8Array</code>  æµ -&gt;  <code>TextDecoderStream</code>  -&gt;  <code>String</code>  æµ</li>\n<li><code>TextDecoderStream</code>  æ¥æ”¶åˆ°ä¸Šæ¸¸çš„å­—èŠ‚æ•°ç»„åï¼Œç«‹å³å°†å…¶è§£ç ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å­—ç¬¦ä¸²è¾“å‡ºåˆ°æ–°çš„æµ</li>\n</ul>\n</li>\n<li>\n<p>è§£ç çš„æ™ºèƒ½æ€§</p>\n<ul>\n<li>å¦‚æœæ•°æ®æ˜¯å•å­—èŠ‚å­—ç¬¦ï¼ˆä¾‹å¦‚ ASCII å­—ç¬¦ï¼‰ï¼Œ <code>TextDecoderStream</code>  ä¼šç«‹å³å°†å…¶è§£ç ä¸ºå­—ç¬¦ä¸²</li>\n<li>å¦‚æœæ•°æ®æ˜¯å¤šå­—èŠ‚å­—ç¬¦ï¼ˆä¾‹å¦‚ UTF-8 ç¼–ç çš„ä¸­æ–‡å­—ç¬¦ï¼‰ï¼Œ <code>TextDecoderStream</code>  ä¼šç­‰å¾…è¶³å¤Ÿçš„å­—èŠ‚æ•°ï¼Œæ‰èƒ½å°†å…¶è§£ç ä¸ºå­—ç¬¦ä¸²</li>\n</ul>\n<pre><code>[102, 111, 111] -&gt; &quot;foo&quot;\n[240, 159, 152, 138] -&gt; ğŸ˜€\n</code></pre>\n</li>\n</ol>\n<h1 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<ol>\n<li>å¼‚æ­¥ç”Ÿæˆå™¨ï¼šçµæ´»æ•°æ®æºã€</li>\n<li><code>ReadableStream</code> ï¼šä½œä¸ºæ•°æ®æµçš„å…¥å£</li>\n<li>ç®¡é“ï¼šä½œä¸ºæ•°æ®å¤„ç†å’Œæ ¼å¼è½¬æ¢çš„æµæ°´çº¿</li>\n<li><code>TextEncoderStream</code> / <code>TextDecoderStream</code> ï¼šä½œä¸ºå­—èŠ‚å’Œå­—ç¬¦ä¸²çš„è½¬æ¢å·¥å…·</li>\n</ol>\n",
            "tags": [
                "JavaScript",
                "ç¼–ç è§£ç "
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-IntersectionObserver-%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-IntersectionObserver-%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/",
            "title": "ä½¿ç”¨ IntersectionObserver å®ç°å›¾ç‰‡æ‡’åŠ è½½",
            "date_published": "2025-11-25T09:31:58.000Z",
            "content_html": "<p>æœ¬æ–‡ä¸»è¦æ˜¯åœ¨é˜…è¯»çº¢å®ä¹¦æ—¶ï¼Œé‡Œé¢æåˆ°äº†  <code>IntersectionObserver</code>  å¯ä»¥å®ç°å›¾ç‰‡æ‡’åŠ è½½ï¼Œæ‰€ä»¥å°±æƒ³è‡ªå·±å®ç°ä¸€ä¸‹ã€‚</p>\n<p>ä¹‹å‰äº†è§£åˆ°çš„ä¸»è¦è¿˜æ˜¯ç›‘å¬ <code>scroll</code>  äº‹ä»¶ï¼Œè°ƒç”¨ <code>getBoundingClientRect</code>  æ–¹æ³•æ¥åˆ¤æ–­å›¾ç‰‡æ˜¯å¦è¿›å…¥åˆ°è§†å£</p>\n<p>è€Œ IntersectionObserver å®ƒæä¾›äº†ä¸€ç§å¼‚æ­¥è§‚å¯Ÿç›®æ ‡å…ƒç´ ä¸å…¶ç¥–å…ˆå…ƒç´ æˆ–é¡¶çº§æ–‡æ¡£è§†å£äº¤å‰çŠ¶æ€å˜åŒ–çš„æ–¹æ³•ï¼Œå®ƒçš„æ€§èƒ½ä¹Ÿè¿œè¶…ä¼ ç»Ÿçš„  <code>scroll</code>  äº‹ä»¶ç›‘å¬</p>\n<h1 id=\"ä½¿ç”¨-intersectionobserver-å®ç°å›¾ç‰‡æ‡’åŠ è½½\"><a class=\"anchor\" href=\"#ä½¿ç”¨-intersectionobserver-å®ç°å›¾ç‰‡æ‡’åŠ è½½\">#</a> ä½¿ç”¨ IntersectionObserver å®ç°å›¾ç‰‡æ‡’åŠ è½½</h1>\n<h2 id=\"ç¬¬ä¸€æ­¥å‡†å¤‡-html\"><a class=\"anchor\" href=\"#ç¬¬ä¸€æ­¥å‡†å¤‡-html\">#</a> ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ HTML</h2>\n<p>æ ¸å¿ƒæ˜¯ï¼Œä¸ç›´æ¥åœ¨ <code>img</code>  æ ‡ç­¾ä¸Šæ·»åŠ  <code>src</code>  å±æ€§ï¼Œè€Œæ˜¯æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§ï¼Œä¾‹å¦‚ <code>data-src</code></p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1.0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Document<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\"></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token selector\">.image-container</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 80%<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 0 auto<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token selector\">img</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> block<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 400px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 20px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> #f0f0f0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>image-container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Alexander<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Brian<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Luis<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Jack<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Mason<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// ç¼–å†™é€»è¾‘</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"ç¬¬äºŒæ­¥ç¼–å†™-javascript-é€»è¾‘\"><a class=\"anchor\" href=\"#ç¬¬äºŒæ­¥ç¼–å†™-javascript-é€»è¾‘\">#</a> ç¬¬äºŒæ­¥ï¼šç¼–å†™ JavaScript é€»è¾‘</h2>\n<ol>\n<li>é€‰å–æ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡</li>\n<li>åˆ›å»º <code>IntersectionObserver</code>  å®ä¾‹ï¼šæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ç›®æ ‡å…ƒç´ å‘ç”Ÿå¯è§æ€§å˜åŒ–æ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°±ä¼šè¢«æ‰§è¡Œ</li>\n<li>åœ¨å›è°ƒå‡½æ•°ä¸­å¤„ç†é€»è¾‘ï¼š\n<ul>\n<li>éå†è§¦å‘å˜åŒ–çš„ <code>entries</code></li>\n<li>æ£€æŸ¥ <code>entry.isIntersecting</code>  æ˜¯å¦ä¸º <code>true</code> ï¼Œå¦‚æœæ˜¯ï¼Œè¯´æ˜å›¾ç‰‡è¿›å…¥åˆ°è§†å£ï¼Œéœ€è¦åŠ è½½å›¾ç‰‡</li>\n<li>åŠ è½½å›¾ç‰‡ï¼šå°† <code>data-src</code>  å±æ€§çš„å€¼èµ‹å€¼ç»™ <code>src</code>  å±æ€§</li>\n<li>å…³é”®ï¼šå›¾ç‰‡åŠ è½½åï¼Œè°ƒç”¨ <code>observer.unobserve(entry.target)</code>  æ–¹æ³•ï¼Œåœæ­¢è§‚å¯Ÿè¯¥å›¾ç‰‡ï¼Œé¿å…é‡å¤åŠ è½½</li>\n</ul>\n</li>\n<li>è®©è§‚å¯Ÿè€…å¼€å§‹å·¥ä½œï¼šè°ƒç”¨ <code>observer.observe(target)</code>  æ–¹æ³•ï¼Œå¼€å§‹è§‚å¯Ÿç›®æ ‡å…ƒç´ </li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 1. é€‰å–æ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> images <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'img[data-src]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">lazyLoad</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">target</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// 2. åˆ›å»º IntersectionObserver å®ä¾‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> io <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entries<span class=\"token punctuation\">,</span> observer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 3. éå† entries</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    entries<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entry</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> src <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 4. åŠ è½½å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        img<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 5. å›¾ç‰‡åŠ è½½åï¼Œç§»é™¤ data-src å±æ€§</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        img<span class=\"token punctuation\">.</span><span class=\"token function\">removeAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 6. å›¾ç‰‡åŠ è½½åï¼Œåœæ­¢è§‚å¯Ÿè¯¥å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        observer<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token literal-property property\">threshold</span><span class=\"token operator\">:</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  io<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// 7. éå†æ‰€æœ‰å›¾ç‰‡ï¼Œè°ƒç”¨ lazyLoad å‡½æ•°</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>images<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>lazyLoad<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>HTMLï¼šä½¿ç”¨ <code>data-src</code>  å±æ€§æ¥å­˜å‚¨å›¾ç‰‡çš„çœŸå®åœ°å€<br />\n JavaScriptï¼šä½¿ç”¨  <code>IntersectionObserver</code>  ç›‘è§†å›¾ç‰‡<br />\né€»è¾‘ï¼šå½“å›¾ç‰‡  <code>isIntersecting</code> ï¼ˆè¿›å…¥è§†å£ï¼‰æ—¶ï¼Œå°†  <code>data-src</code>  æ›¿æ¢ä¸º  <code>src</code> <br />\n æ€§èƒ½ï¼šåŠ è½½å  <code>unobserve</code> ï¼ˆåœæ­¢è§‚å¯Ÿï¼‰ï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€</p>\n",
            "tags": [
                "JavaScript",
                "å›¾ç‰‡æ‡’åŠ è½½"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Async-Generator-%E6%89%93%E9%80%A0%E4%BA%8B%E4%BB%B6%E6%B5%81/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Async-Generator-%E6%89%93%E9%80%A0%E4%BA%8B%E4%BB%B6%E6%B5%81/",
            "title": "ä½¿ç”¨ Async Generator æ‰“é€ äº‹ä»¶æµ",
            "date_published": "2025-11-13T09:26:11.000Z",
            "content_html": "<h1 id=\"ä½¿ç”¨-async-generator-æ‰“é€ äº‹ä»¶æµ\"><a class=\"anchor\" href=\"#ä½¿ç”¨-async-generator-æ‰“é€ äº‹ä»¶æµ\">#</a> ä½¿ç”¨ Async Generator æ‰“é€ äº‹ä»¶æµ</h1>\n<h2 id=\"å¼•è¨€å¼‚æ­¥ç¼–ç¨‹çš„èŒƒå¼è½¬æ¢\"><a class=\"anchor\" href=\"#å¼•è¨€å¼‚æ­¥ç¼–ç¨‹çš„èŒƒå¼è½¬æ¢\">#</a> å¼•è¨€ï¼šå¼‚æ­¥ç¼–ç¨‹çš„èŒƒå¼è½¬æ¢</h2>\n<p>ä¼ ç»Ÿçš„ <code>addEventListener</code>  æ–¹æ³•ä¸ºäº‹ä»¶ç»‘å®šå›è°ƒå‡½æ•°è™½ç„¶æœ‰æ•ˆï¼Œä½†å½“æˆ‘ä»¬å¤„ç†å¤æ‚çš„ã€æœ‰æ—¶åºçš„äº‹ä»¶åºåˆ—æ—¶ï¼Œä»£ç å¾ˆå¿«å°±ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚</p>\n<p>æœ¬æ–‡ä»‹ç»ä½¿ç”¨ Async Generator æ‰“é€ äº‹ä»¶æµï¼Œå±•ç¤ºäº†å¦‚ä½•å°†å¼‚æ­¥äº‹ä»¶è½¬æ¢ä¸ºå¯è¿­ä»£çš„åºåˆ—</p>\n<h2 id=\"æ ¸å¿ƒä»£ç å°†äº‹ä»¶è½¬åŒ–ä¸º-observable-stream\"><a class=\"anchor\" href=\"#æ ¸å¿ƒä»£ç å°†äº‹ä»¶è½¬åŒ–ä¸º-observable-stream\">#</a> æ ¸å¿ƒä»£ç ï¼šå°†äº‹ä»¶è½¬åŒ–ä¸º Observable Stream</h2>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">ResolveFunction<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> PromiseLike<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Observable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// Promise é˜Ÿåˆ—ï¼šå­˜å‚¨ç­‰å¾…è¢«äº‹ä»¶è§£å†³çš„ Promise</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">private</span> promiseQueue<span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">//resolve å‡½æ•°ï¼šæŒ‡å‘å½“å‰é˜Ÿåˆ—å¤´éƒ¨ Promise çš„è§£å†³å‡½æ•°</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">private</span> resolve<span class=\"token operator\">:</span> ResolveFunction<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promiseQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolve <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åˆå§‹å¯åŠ¨ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªç­‰å¾… Promise</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºä¸€ä¸ªæ–° Promiseï¼Œå¹¶å°†å®ƒçš„ resolve å‡½æ•°èµ‹å€¼ç»™ this.resolve</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promiseQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolve <span class=\"token operator\">=</span> resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºä¸‹ä¸€ä¸ª Promise</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promiseQueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// æ ¸å¿ƒæ–¹æ³•ï¼šå°† DOM äº‹ä»¶è½¬åŒ–ä¸ºå¼‚æ­¥ç”Ÿæˆå™¨æµ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  async <span class=\"token operator\">*</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>element<span class=\"token operator\">:</span> EventTarget<span class=\"token punctuation\">,</span> eventType<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> AsyncGenerator<span class=\"token operator\">&lt;</span>Event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ (Push é˜¶æ®µ)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Event<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">// 1. è§£å†³å½“å‰æ­£åœ¨ç­‰å¾…çš„ Promiseï¼Œå°†äº‹ä»¶æ•°æ®æ¨é€å‡ºå»</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\">// 2. ç«‹å³åˆ›å»ºä¸‹ä¸€ä¸ª Promiseï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">// å¼‚æ­¥ç”Ÿæˆå™¨ï¼šå¯åŠ¨æ‹‰å–æµç¨‹ (Pull é˜¶æ®µ)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\">// å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª Promise è¢«äº‹ä»¶è§£å†³</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token comment\">// æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿ dequeue ä¸è¿”å› undefinedï¼Œé€šå¸¸é€šè¿‡é€»è¾‘ä¿è¯é˜Ÿåˆ—éç©º</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">const</span> nextPromise <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextPromise<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          <span class=\"token keyword\">yield</span> <span class=\"token keyword\">await</span> nextPromise<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœ dequeue è¿”å› undefinedï¼Œåˆ™æ— é™å¾ªç¯ä¼šå¡ä½ï¼Œä½†æˆ‘ä»¬åœ¨é€»è¾‘ä¸Šä¿è¯äº† enqueue ç´§è·Ÿ resolveã€‚</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>è¿è¡Œç¤ºä¾‹</strong></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> observable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// å‡è®¾é¡µé¢ä¸­å­˜åœ¨ä¸€ä¸ª &lt;button> å…ƒç´ </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> button <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>button<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> clickStream <span class=\"token operator\">=</span> observable<span class=\"token punctuation\">.</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>button<span class=\"token punctuation\">,</span> <span class=\"token string\">'click'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// ä½¿ç”¨ for await...of çº¿æ€§å¤„ç†äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> e <span class=\"token keyword\">of</span> clickStream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æŒ‰é’®è¢«ç‚¹å‡»äº†:'</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">//... å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œå¤æ‚çš„å¼‚æ­¥æ“ä½œï¼Œæµç¨‹ä¾ç„¶æ¸…æ™°</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"æœºåˆ¶è§£æ\"><a class=\"anchor\" href=\"#æœºåˆ¶è§£æ\">#</a> æœºåˆ¶è§£æ</h2>\n<p>åˆ©ç”¨ Promise é˜Ÿåˆ—ï¼Œå®ç°äº†äº‹ä»¶å‘ç”Ÿï¼ˆæ¨é€ï¼‰å’Œä»£ç å¤„ç†ï¼ˆæ‹‰å–ï¼‰ä¹‹é—´çš„å®‰å…¨åŒæ­¥</p>\n<ol>\n<li>\n<p>é˜Ÿåˆ—ä¸ºä»€ä¹ˆæ—¶å¿…é¡»çš„ï¼Ÿ<br />\nç¡®ä¿æ—¶åºå’Œé˜²æ­¢äº‹ä»¶ä¸¢å¤±<br />\nåœ¨ä»»ä½•æ—¶å€™ï¼Œ <code>this.resolve</code>  æ€»æ˜¯æŒ‡å‘å½“å‰ç­‰å¾…è¢«è§£å†³çš„ Promise çš„è§£å†³å‡½æ•°ã€‚å½“äº‹ä»¶ä»¥æå¿«çš„é€Ÿåº¦å‘ç”Ÿæ—¶ï¼Œé˜Ÿåˆ—æä¾›äº†ä¸€ä¸ªç¼“å†²</p>\n<ul>\n<li>äº‹ä»¶ A è§¦å‘ï¼š <code>resolve(A)</code>  è§£å†³äº† Promise P1ï¼Œå¹¶åˆ›å»ºäº† Promise P2.</li>\n<li>äº‹ä»¶ B è§¦å‘ï¼šåœ¨ <code>async generator</code>  å¾ªç¯æ¥å¾—åŠæ‹‰å– P2 ä¹‹å‰ï¼Œäº‹ä»¶ B å·²ç»è§¦å‘ï¼Œå®ƒå®‰å…¨çš„ <code>resolve(B)</code>  è§£å†³äº† P2ï¼Œå¹¶åˆ›å»ºäº† P3</li>\n<li>æ‹‰å–å¾ªç¯ï¼šå¾ªç¯ä¾æ¬¡æ¢å¤ï¼Œå…ˆäº§å‡º Aï¼Œå†äº§å‡º B</li>\n</ul>\n<p>å¦‚æœæ²¡æœ‰é˜Ÿåˆ—ï¼Œåœ¨å¿«é€Ÿè¿ç»­äº‹ä»¶ä¸­ï¼Œç¬¬äºŒä¸ªäº‹ä»¶ B ææœ‰å¯èƒ½æ‰¾ä¸åˆ°ç­‰å¾…çš„ Promise è€Œè¢«ä¸¢å¤±ã€‚é˜Ÿåˆ—ç¡®ä¿äº‹ä»¶çš„å‘ç”Ÿé¡ºåºä¸å¤„ç†é¡ºåºä¸¥æ ¼ä¸€è‡´</p>\n</li>\n<li>\n<p>push ä¸ pull å®Œç¾ç»“åˆ<br />\n | æ¨¡å‹ | è§’è‰² | åŠ¨ä½œ | æè¿° |<br />\n| ----- | ----- | ----- | ----- |<br />\n| push | äº‹ä»¶ç›‘å¬å™¨ |  <code>this.resolve(e)</code>  | äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°†æ•°æ®æ¨å…¥ç»™æ­£åœ¨ç­‰å¾…çš„ Promiseã€‚|<br />\n| pull | å¼‚æ­¥ç”Ÿæˆå™¨ |  <code>yield await nextPromise</code>  | ä»£ç å¤„ç†ï¼ˆæ‹‰å–ï¼‰ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ï¼Œç¡®ä¿æ—¶åºã€‚|</p>\n</li>\n</ol>\n<h2 id=\"å¯¹æ¯”\"><a class=\"anchor\" href=\"#å¯¹æ¯”\">#</a> å¯¹æ¯”</h2>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>ä¼ ç»Ÿ addEventListener</th>\n<th>Observable + async generator</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ä»£ç é£æ ¼</td>\n<td>åŸºäºå›è°ƒï¼Œå®¹æ˜“åµŒå¥—ã€‚</td>\n<td>åŸºäº  <code>for await...of</code>  å¾ªç¯ï¼Œæµç¨‹çº¿æ€§åŒ–ã€‚</td>\n</tr>\n<tr>\n<td>æ—¶åºæ§åˆ¶</td>\n<td>éœ€æ‰‹åŠ¨ç®¡ç†è®¡æ•°å™¨ã€è®¡æ—¶å™¨å’Œå¤–éƒ¨çŠ¶æ€ã€‚</td>\n<td>ä½¿ç”¨  <code>await</code>  å…³é”®å­—è‡ªç„¶åœ°æš‚åœ / ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚</td>\n</tr>\n<tr>\n<td>ç»ˆæ­¢ / æ¸…ç†</td>\n<td>å¿…é¡»æ‰‹åŠ¨è°ƒç”¨  <code>removeEventListener</code> ã€‚</td>\n<td>å¯ä»¥é€šè¿‡  <code>break</code>  é€€å‡ºå¾ªç¯ï¼Œå¹¶åœ¨è¿­ä»£å™¨çš„  <code>return</code>  æ–¹æ³•ä¸­å®ç°è‡ªåŠ¨æ¸…ç†ï¼ˆæ˜“äºæ‰©å±•ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td>ç¤ºä¾‹</td>\n<td>ç­‰å¾… 3 æ¬¡ç‚¹å‡»éœ€è¦å¤–éƒ¨è®¡æ•°å™¨å’Œæ‰‹åŠ¨æ¸…ç†ã€‚</td>\n<td>ç­‰å¾… 3 æ¬¡ç‚¹å‡»åªéœ€ä¸€ä¸ªç®€å•çš„  <code>if (count === 3) break;</code> ã€‚</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "JavaScript",
                "Async Generator",
                "äº‹ä»¶æµ"
            ]
        },
        {
            "id": "https://aynya.github.io/Axios-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%8C%96%E5%B0%81%E8%A3%85%EF%BC%88%E5%8E%BB%E9%87%8D%E4%B8%8E%E9%98%B2%E6%8A%96%EF%BC%89/",
            "url": "https://aynya.github.io/Axios-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%8C%96%E5%B0%81%E8%A3%85%EF%BC%88%E5%8E%BB%E9%87%8D%E4%B8%8E%E9%98%B2%E6%8A%96%EF%BC%89/",
            "title": "Axios è¯·æ±‚ä¼˜åŒ–å°è£…ï¼ˆå»é‡ä¸é˜²æŠ–ï¼‰",
            "date_published": "2025-10-27T13:25:49.000Z",
            "content_html": "<h1 id=\"axios-è¯·æ±‚ä¼˜åŒ–å°è£…å»é‡ä¸é˜²æŠ–\"><a class=\"anchor\" href=\"#axios-è¯·æ±‚ä¼˜åŒ–å°è£…å»é‡ä¸é˜²æŠ–\">#</a> Axios è¯·æ±‚ä¼˜åŒ–å°è£…ï¼ˆå»é‡ä¸é˜²æŠ–ï¼‰</h1>\n<p>æ ¸å¿ƒç›®æ ‡æ˜¯å°è£…ä¸€ä¸ªå¥å£®çš„ <code>request</code>  å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å‘èµ·è¯·æ±‚å‰èƒ½è‡ªåŠ¨å¤„ç†é˜Ÿåˆ—ä¸­çš„é‡å¤è¯·æ±‚ï¼ˆå»é‡ï¼‰ï¼Œå¹¶èƒ½é€šè¿‡é…ç½®å®ç°å‘é€é¢‘ç‡é™åˆ¶ï¼ˆé˜²æŠ–ï¼‰</p>\n<p><strong>æ ¸å¿ƒåŠŸèƒ½</strong></p>\n<ol>\n<li>è¯·æ±‚å»é‡ï¼šåˆ©ç”¨ Axios æ‹¦æˆªå™¨ï¼Œåœ¨å‘é€è¯·æ±‚å‰å’Œå“åº”æ¥æ”¶åï¼Œé€šè¿‡ <code>CancelToken</code>  æœºåˆ¶å–æ¶ˆç›¸åŒçš„å¾…å‘è¯·æ±‚</li>\n<li>è¯·æ±‚é˜²æŠ–ï¼šå…è®¸ç”¨æˆ·å†è¯·æ±‚é…ç½®ä¸­æŒ‡å®š <code>debounce</code>  å»¶è¿Ÿæ—¶é—´ï¼Œä»è€Œé™åˆ¶è¯·æ±‚çš„å‘é€é¢‘ç‡</li>\n</ol>\n<h2 id=\"è¯·æ±‚å»é‡æœºåˆ¶\"><a class=\"anchor\" href=\"#è¯·æ±‚å»é‡æœºåˆ¶\">#</a> è¯·æ±‚å»é‡æœºåˆ¶</h2>\n<ol>\n<li>æ ¸å¿ƒæ•°æ®ç»“æ„<br />\nä½¿ç”¨ä¸€ä¸ª <code>Map</code>  ç»“æ„æ¥å­˜å‚¨å¾…å–æ¶ˆçš„è¯·æ±‚ï¼š</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> pendingRequests <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Canceler<span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>Keyï¼šå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”±è¯·æ±‚æ–¹æ³•ã€URLã€å‚æ•°å’Œæ•°æ®ç»„æˆ</li>\n<li>Valueï¼šAxios çš„ <code>Cancelr</code>  å‡½æ•°ï¼Œç”¨äºå–æ¶ˆè¯·æ±‚</li>\n</ul>\n<ol start=\"2\">\n<li>ç”Ÿæˆè¯·æ±‚å”¯ä¸€ Key<br />\n <code>getRequestKey</code>  å‡½æ•°è´Ÿè´£ç”Ÿæˆä¸€ä¸ªç¨³å®šçš„è¯·æ±‚æ ‡è¯†ç¬¦ã€‚ä¸ºäº†ç¡®ä¿è¯·æ±‚æ— è®ºä½•æ—¶å‘é€éƒ½èƒ½åŒ¹é…ã€‚</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// å°† JSON å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥ç¡®ä¿ç¨³å®šæ€§</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>æ‹¦æˆªå™¨å®ç°é€»è¾‘</li>\n</ol>\n<ul>\n<li>è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆ <code>service.interceptors.request</code> ï¼‰\n<ul>\n<li><code>removePendingRequest</code> ï¼š åœ¨å‘é€æ–°è¯·æ±‚å‰ï¼Œæ£€æŸ¥ <code>pendingRequests</code>  ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒ Key çš„è¯·æ±‚ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç«‹å³æ‰§è¡Œ <code>Canceler</code>  å‡½æ•°å–æ¶ˆæ—§è¯·æ±‚ï¼Œå¹¶ä» Map ä¸­åˆ é™¤</li>\n<li><code>addPendingRequest</code> ï¼šä¸ºå½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>CancelToken</code> ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ° <code>pendingRequests</code>  Map ä¸­</li>\n</ul>\n</li>\n<li>å“åº”æ‹¦æˆªå™¨ï¼ˆ <code>service.interceptors.response</code> ï¼‰\n<ul>\n<li>æ— è®ºè¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½éœ€è¦è°ƒç”¨ <code>removePendingRequest(response.config)</code>  å°†å…¶ä» <code>pendingRequests</code>  é˜Ÿåˆ—ä¸­ç§»é™¤</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"è¯·æ±‚é˜²æŠ–æœºåˆ¶\"><a class=\"anchor\" href=\"#è¯·æ±‚é˜²æŠ–æœºåˆ¶\">#</a> è¯·æ±‚é˜²æŠ–æœºåˆ¶</h2>\n<ol>\n<li>æ ¸å¿ƒé˜²æŠ–å‡½æ•° <code>debounceRequest</code> <br />\n è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªæ‰§è¡Œè¯·æ±‚çš„å‡½æ•° <code>func</code>  å’Œå»¶è¿Ÿæ—¶é—´ <code>delay</code> ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¢«é˜²æŠ–çš„æ–°å‡½æ•°</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> debounceTimer<span class=\"token operator\">:</span> ReturnType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> setTimeout<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ä½¿ç”¨å…¨å±€è®¡æ—¶å™¨æ¥ç¡®ä¿æ‰€æœ‰é˜²æŠ–è¯·æ±‚å…±äº«çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">debounceRequest</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function-variable function\">func</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  delay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>debounceTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¯æ¬¡è°ƒç”¨éƒ½æ¸…é™¤ä¸Šä¸€ä¸ªè®¡æ—¶å™¨</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      debounceTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å»¶è¿Ÿåæ‰§è¡ŒåŸå§‹è¯·æ±‚</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>Promise å°è£…ï¼šå…³é”®åœ¨äºä½¿ç”¨ <code>new Promise</code>  å°è£…äº† <code>setTimeout</code>  å†…éƒ¨çš„åŸå§‹è¯·æ±‚ã€‚è¿™ç¡®ä¿äº†å¤–éƒ¨è°ƒç”¨è€…å¾—åˆ°çš„ Promise ( <code>lastRequestPromise</code> ) åªæœ‰åœ¨å»¶è¿Ÿç»“æŸåã€åŸå§‹è¯·æ±‚çœŸæ­£æ‰§è¡Œå¹¶å®Œæˆæ—¶æ‰ä¼šè¢« resolve /reject</li>\n</ul>\n<ol start=\"2\">\n<li>ç»Ÿä¸€å…¥å£ <code>request</code> <br />\n <code>request</code>  å‡½æ•°ä½œä¸ºå°è£…çš„æœ€ç»ˆ APIï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æ˜¯å¦éœ€è¦å¼€å¯é˜²æŠ–åŠŸèƒ½</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">request</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>options<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœé…ç½®ä¸­å­˜åœ¨ debounce å­—æ®µï¼Œåˆ™åº”ç”¨é˜²æŠ–åŒ…è£…</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 1. åˆ›å»ºä¸€ä¸ªé˜²æŠ–ç‰ˆæœ¬çš„ service.request å‡½æ•°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// 2. ç«‹å³æ‰§è¡Œè¿™ä¸ªé˜²æŠ–å‡½æ•°ï¼Œå¹¶ä¼ å…¥ options</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">debounceRequest</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">=></span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// å¦åˆ™ï¼Œç«‹å³å‘é€è¯·æ±‚</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">return</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"å®Œæ•´ä»£ç å®ç°\"><a class=\"anchor\" href=\"#å®Œæ•´ä»£ç å®ç°\">#</a> å®Œæ•´ä»£ç å®ç°</h2>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">&#123;</span> InternalAxiosRequestConfig<span class=\"token punctuation\">,</span> AxiosRequestConfig<span class=\"token punctuation\">,</span> Canceler<span class=\"token punctuation\">,</span> AxiosResponse  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">CustomRequestConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AxiosRequestConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  debounce<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> pendingRequests <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Canceler<span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">addPendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  config<span class=\"token punctuation\">.</span>cancelToken <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>cancelToken <span class=\"token operator\">||</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">axios</span><span class=\"token punctuation\">.</span><span class=\"token function\">CancelToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cancel<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> cancel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">const</span> requestKey <span class=\"token operator\">=</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>requestKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> cancel <span class=\"token operator\">=</span> pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>requestKey<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Canceler<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">å–æ¶ˆé‡å¤è¯·æ±‚: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>requestKey<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>requestKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> service <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  baseURL<span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  timeout<span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>service<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token function\">addPendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">return</span> config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  error <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>service<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token punctuation\">(</span>response<span class=\"token operator\">:</span> AxiosResponse<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  error <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span><span class=\"token function\">isCancel</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è¯·æ±‚å·²å–æ¶ˆ:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è¯·æ±‚å‘ç”Ÿé”™è¯¯:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token keyword\">let</span> debounceTimer<span class=\"token operator\">:</span> ReturnType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> setTimeout<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">debounceRequest</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token function-variable function\">func</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  delay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>debounceTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      debounceTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'qwer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">request</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>options<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">debounceRequest</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">=></span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token keyword\">return</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> request<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "è¯·æ±‚",
                "Axios",
                "å»é‡",
                "é˜²æŠ–"
            ]
        },
        {
            "id": "https://aynya.github.io/%E6%90%9C%E7%B4%A2%E6%A1%86%E7%9B%B8%E5%85%B3%E5%AE%9E%E7%8E%B0%E4%B8%8E%E9%83%A8%E5%88%86%E4%BC%98%E5%8C%96/",
            "url": "https://aynya.github.io/%E6%90%9C%E7%B4%A2%E6%A1%86%E7%9B%B8%E5%85%B3%E5%AE%9E%E7%8E%B0%E4%B8%8E%E9%83%A8%E5%88%86%E4%BC%98%E5%8C%96/",
            "title": "æœç´¢æ¡†ç›¸å…³å®ç°ä¸éƒ¨åˆ†ä¼˜åŒ–",
            "date_published": "2025-09-24T15:16:38.000Z",
            "content_html": "<h1 id=\"ç›®æ ‡\"><a class=\"anchor\" href=\"#ç›®æ ‡\">#</a> ç›®æ ‡</h1>\n<p>å®ç°ä¸€ä¸ªæœç´¢æ¡†ï¼Œè¾“å…¥å†…å®¹åï¼Œå®æ—¶æœç´¢å¹¶å±•ç¤ºä¸‹æ‹‰æ¡†åŒ¹é…çš„ç»“æœã€‚</p>\n<ol>\n<li>è¾“å…¥å†…å®¹</li>\n<li>æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£ï¼Œè¿”å›å­—ç¬¦ä¸²æ•°ç»„</li>\n<li>è¾“å…¥æ¡†åšé˜²æŠ–</li>\n<li>ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚</li>\n<li>ä¸‹æ‹‰æ¡†é‡‡ç”¨è™šæ‹Ÿåˆ—è¡¨</li>\n</ol>\n<h2 id=\"è¾“å…¥å†…å®¹\"><a class=\"anchor\" href=\"#è¾“å…¥å†…å®¹\">#</a> è¾“å…¥å†…å®¹</h2>\n<p>é€šè¿‡ <code>input</code>  ç»„ä»¶å¹¶é‡‡ç”¨ <code>onChange</code>  äº‹ä»¶æ¥è·å–è¾“å…¥çš„å†…å®¹</p>\n<h2 id=\"æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£\"><a class=\"anchor\" href=\"#æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£\">#</a> æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£</h2>\n<p>æŠŠæ¥å£è¯·æ±‚æ“ä½œå†™åˆ° <code>useEffect</code>  ä¸­<br />\nè·å–åˆ°ç»“æœå <code>setState</code>  åˆ°å…¨å±€<br />\næ³¨æ„ï¼šæ¯æ¬¡è¯·æ±‚å®Œåï¼Œéœ€è¦å¯¹æ•´ä¸ªåˆ—è¡¨çš„æ»šåŠ¨æ¡è¿›è¡Œå¤åŸ</p>\n<h2 id=\"è¾“å…¥æ¡†åšé˜²æŠ–\"><a class=\"anchor\" href=\"#è¾“å…¥æ¡†åšé˜²æŠ–\">#</a> è¾“å…¥æ¡†åšé˜²æŠ–</h2>\n<p>é˜²æŠ–å•ç‹¬å†™ä¸€ä¸ª <code>hook</code> ï¼š <code>useDebounce&lt;T&gt;(value: T, delay: number): T </code></p>\n<ol>\n<li>ä¼ å…¥ä¸€ä¸ªå€¼å’Œå»¶æ—¶æ—¶é—´</li>\n<li>åœ¨å†…éƒ¨é€šè¿‡ <code>setState</code>  ç»´æŠ¤ä¸€ä¸ª <code>debounceValue</code></li>\n<li>æ¯æ¬¡ <code>value</code>  å‘ç”Ÿæ”¹å˜æ—¶çˆ¶ç»„ä»¶é‡æ¸²æŸ“ï¼Œæ•´ä¸ª <code>hook</code>  é‡æ–°æ‰§è¡Œ</li>\n<li>å¸è½½æ—¶å–æ¶ˆåŸæ¥çš„å»¶æ—¶ï¼ŒæŒ‚è½½æ—¶è®¾ç½®å»¶æ—¶ï¼Œå»¶æ—¶å®Œåå†å¯¹ <code>debounceValue</code>  èµ‹å€¼</li>\n<li>è¿”å› <code>debounceValue</code>  å³å¯</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useDebounce</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> delay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>debouncedValue<span class=\"token punctuation\">,</span> setDebouncedValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">setDebouncedValue</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> debouncedValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚\"><a class=\"anchor\" href=\"#ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚\">#</a> ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚</h2>\n<p>æœ‰å¯èƒ½ä¸€ç§æƒ…å†µï¼šå½“å‰ä¸€æ¬¡çš„è¯·æ±‚æ¯”ç¬¬äºŒæ¬¡æ…¢ï¼Œé‚£ä¹ˆæ¥æ”¶æ—¶å°±ä¼šè¦†ç›–æœ€è¿‘çš„ä¸€æ¬¡ç»“æœ<br />\næ‰€ä»¥è¿™é‡Œå°±è¦æœ‰ä¸ªå…ˆåé¡ºåº</p>\n<ol>\n<li>ä»¥ <code>useRef</code>  æ¥åˆå§‹åŒ–ä¸€ä¸ªå‘é€ <code>ID</code></li>\n<li>æ¯æ¬¡å‘é€è¯·æ±‚å‰éƒ½è®°å½•ä¸€ä¸‹å‘é€çš„ <code>ID</code></li>\n<li>é€šè¿‡é—­åŒ… +  <code>useRef</code></li>\n<li>å½“å“åº”åˆ°è¾¾çš„æ—¶å€™åªéœ€è¦å¯¹æ¯” <code>useRef</code>  å’Œé—­åŒ…ä¸­è®°å½•çš„å€¼æ˜¯å¦ç›¸ç­‰å°±å¯ä»¥åˆ¤æ–­æ˜¯ä¸æ˜¯æœ€æ–°çš„</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> latestRequestRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> currentRequest <span class=\"token operator\">=</span> <span class=\"token operator\">++</span>latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">fetchSearchResults</span><span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentRequest <span class=\"token operator\">===</span> latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// å½“ç»“æœæ›´æ–°æ—¶ï¼Œé‡ç½®æ»šåŠ¨ä½ç½®</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>debouncedInputValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"è™šæ‹Ÿåˆ—è¡¨çš„å®ç°å®šé«˜\"><a class=\"anchor\" href=\"#è™šæ‹Ÿåˆ—è¡¨çš„å®ç°å®šé«˜\">#</a> è™šæ‹Ÿåˆ—è¡¨çš„å®ç°ï¼ˆå®šé«˜ï¼‰</h2>\n<p>ç›®çš„ï¼šåªæ¸²æŸ“å¯è§éƒ¨åˆ†çš„ dom</p>\n<ol>\n<li>é€šè¿‡ <code>scrollTop</code>  è·å–åˆ°æ»šåŠ¨æ¡çš„ä½ç½®</li>\n<li>æ ¹æ®å…¬å¼ <code>startIndex = Math.floor(scrollTop / ITEM_HEIGHT)</code>  è·å–å¼€å§‹ä¸‹æ ‡</li>\n<li>æ ¹æ®å…¬å¼ <code>endIndex = Math.min(results.length - 1, startIndex + VISIBLE_ITEMS_COUNT)</code>  è·å–ç»“æŸä¸‹æ ‡</li>\n<li>ç„¶åæ ¹æ®è¿™ä¸¤ä¸ªä¸‹æ ‡å»åˆ‡åˆ†æ•°ç»„ï¼Œå¾—åˆ°çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦æ¸²æŸ“çš„å†…å®¹ï¼ˆä½†æ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¦æ¸²æŸ“çš„å†…å®¹ï¼Œé‚£ä¸Šä¸‹ä¸¤è¾¹ç©ºç€çš„åœ°æ–¹æ€ä¹ˆåŠï¼Œå½“ç„¶æ˜¯ç”¨ <code>padding</code>  å»å¡«å……å•¦ï¼‰</li>\n<li>é‚£ä¹ˆï¼Œ <code>paddingTop = paddingTop = startIndex * ITEM_HEIGHT;</code></li>\n<li><code>paddingBottom = (results.length - (endIndex + 1)) * ITEM_HEIGHT</code></li>\n</ol>\n<p>è¿™æ ·ï¼Œæ•´ä¸ªç»“æ„å°±æ˜¯ï¼Œçˆ¶ <code>div</code>  çš„æ ·å¼å°±æ˜¯ <code>paddingTop</code>  +  <code>paddingBottom</code> ï¼Œå­å°±æ˜¯éœ€è¦å¾ªç¯æ¸²æŸ“çš„å†…å®¹äº†</p>\n<p>æ»šåŠ¨æ—¶æ•´ä¸ªé“¾è·¯ï¼šæ»šåŠ¨äº‹ä»¶è§¦å‘ï¼Œé‡æ¸²æŸ“ï¼Œæ¥ç€ä»ç¬¬ä¸€æ­¥å¼€å§‹æ‰§è¡Œ</p>\n<h1 id=\"å…·ä½“ä»£ç \"><a class=\"anchor\" href=\"#å…·ä½“ä»£ç \">#</a> å…·ä½“ä»£ç </h1>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> useState<span class=\"token punctuation\">,</span> useEffect<span class=\"token punctuation\">,</span> useRef<span class=\"token punctuation\">,</span> useCallback <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> useDebounce <span class=\"token keyword\">from</span> <span class=\"token string\">'../hooks/useDebounce'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// æ¨¡æ‹Ÿä¸€ä¸ª API è¯·æ±‚</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">ITEM_HEIGHT</span> <span class=\"token operator\">=</span> <span class=\"token number\">36</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¯ä¸ªåˆ—è¡¨é¡¹çš„é«˜åº¦ï¼ŒåŒ…æ‹¬ padding å’Œ border</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">VISIBLE_ITEMS_COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯è§çš„åˆ—è¡¨é¡¹æ•°é‡</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> Search<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>inputValue<span class=\"token punctuation\">,</span> setInputValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>results<span class=\"token punctuation\">,</span> setResults<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>loading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isInputFocused<span class=\"token punctuation\">,</span> setIsInputFocused<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>scrollTop<span class=\"token punctuation\">,</span> setScrollTop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ»šåŠ¨ä½ç½®</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">const</span> debouncedInputValue <span class=\"token operator\">=</span> <span class=\"token function\">useDebounce</span><span class=\"token punctuation\">(</span>inputValue<span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> listRef <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HTMLUListElement<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¼•ç”¨ä¸‹æ‹‰åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">const</span> latestRequestRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">const</span> currentRequest <span class=\"token operator\">=</span> <span class=\"token operator\">++</span>latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token function\">fetchSearchResults</span><span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentRequest <span class=\"token operator\">===</span> latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token comment\">// å½“ç»“æœæ›´æ–°æ—¶ï¼Œé‡ç½®æ»šåŠ¨ä½ç½®</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>debouncedInputValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleResultClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>result<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">setInputValue</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">setIsInputFocused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç‚¹å‡»åæ¸…ç©ºç»“æœï¼Œéšè—ä¸‹æ‹‰æ¡†</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleInputBlur</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token comment\">// å»¶è¿Ÿè®¾ç½® isInputFocused ä¸º falseï¼Œä»¥ä¾¿åœ¨ç‚¹å‡»ä¸‹æ‹‰é¡¹æ—¶æœ‰æ—¶é—´è§¦å‘ handleResultClick</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token function\">setIsInputFocused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">const</span> handleScroll <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">// è™šæ‹Ÿæ»šåŠ¨è®¡ç®—</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">const</span> startIndex <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>scrollTop <span class=\"token operator\">/</span> <span class=\"token constant\">ITEM_HEIGHT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">const</span> endIndex <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> startIndex <span class=\"token operator\">+</span> <span class=\"token constant\">VISIBLE_ITEMS_COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">const</span> visibleResults <span class=\"token operator\">=</span> results<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">,</span> endIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">const</span> paddingTop <span class=\"token operator\">=</span> startIndex <span class=\"token operator\">*</span> <span class=\"token constant\">ITEM_HEIGHT</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">const</span> paddingBottom <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>endIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token constant\">ITEM_HEIGHT</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">,</span> endIndex<span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">,</span> endIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> paddingTop<span class=\"token punctuation\">,</span> paddingBottom<span class=\"token punctuation\">,</span> scrollTop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>relative w-[300px]<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>inputValue<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setInputValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                <span class=\"token attr-name\">onFocus</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setIsInputFocused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                <span class=\"token attr-name\">onBlur</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>handleInputBlur<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                <span class=\"token attr-name\">placeholder</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Search...<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>w-full p-2 border border-gray-300 rounded-md<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            </span><span class=\"token punctuation\">&#123;</span>loading <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>absolute right-2.5 top-2 text-sm text-gray-500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            </span><span class=\"token punctuation\">&#123;</span>isInputFocused <span class=\"token operator\">&amp;&amp;</span> results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                    <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>listRef<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                    <span class=\"token attr-name\">onScroll</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>handleScroll<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                    <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>absolute top-full left-0 right-0 z-10 list-none p-0 m-0 bg-white border border-gray-300 rounded-md shadow-lg overflow-y-auto<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                    <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\">&lt;!--swigï¿¼0--</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                ></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\">&lt;!--swigï¿¼1--</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        </span><span class=\"token punctuation\">&#123;</span>visibleResults<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                                <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>result<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                                <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">handleResultClick</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                                <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>px-2 flex items-center border-b border-gray-100 cursor-pointer box-border hover:bg-gray-50<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                                <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\">&lt;!--swigï¿¼2--</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                            ></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                                </span><span class=\"token punctuation\">&#123;</span>result<span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Search<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "æœç´¢",
                "React",
                "æ€§èƒ½ä¼˜åŒ–"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BF%AB%E6%8D%B7%E9%94%AE%E7%BB%91%E5%AE%9A/",
            "url": "https://aynya.github.io/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BF%AB%E6%8D%B7%E9%94%AE%E7%BB%91%E5%AE%9A/",
            "title": "ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š",
            "date_published": "2025-05-25T13:02:28.000Z",
            "content_html": "<h1 id=\"ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š\"><a class=\"anchor\" href=\"#ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š\">#</a> ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š</h1>\n<p><strong>åœ¨ React åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ react-hotkeys-hook åº“æ¥å®ç°å¿«æ·é”®ç»‘å®šï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘å…ˆæš‚æ—¶ä½¿ç”¨ä¸€ä¸‹æœ€åŸå§‹çš„å†™æ³•ï¼Œå“ˆå“ˆã€‚</strong></p>\n<h2 id=\"æ€è·¯\"><a class=\"anchor\" href=\"#æ€è·¯\">#</a> æ€è·¯</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªå¿«æ·é”®åˆ°äº‹ä»¶çš„æ˜ å°„è¡¨</li>\n<li>æ·»åŠ ç›‘å¬äº‹ä»¶</li>\n<li>è·å–å½“å‰æŒ‰ä¸‹çš„é”®</li>\n<li>åˆ¤æ–­å½“å‰çš„é˜¶æ®µï¼Œå¦‚æœæ˜¯ä¿®æ”¹é˜¶æ®µï¼Œåˆ™ä¿®æ”¹å¯¹åº”äº‹ä»¶çš„å¿«æ·é”®ï¼Œå¦‚æœæ˜¯æ‰§è¡Œé˜¶æ®µï¼Œåˆ™æ‰§è¡Œå¯¹åº”äº‹ä»¶</li>\n</ol>\n<h2 id=\"ä»£ç \"><a class=\"anchor\" href=\"#ä»£ç \">#</a> ä»£ç </h2>\n<pre><code class=\"language-Tsx\">import React, &#123; useState, useEffect, useCallback &#125; from 'react';\n\ninterface Shortcut &#123;\n  event: () =&gt; void;\n  keys: string[];\n&#125;\n\nfunction redo() &#123;\n  console.log('Redo action');\n&#125;\nfunction undo() &#123;\n  console.log('Undo action');\n&#125;\nfunction save() &#123;\n  console.log('Save action');\n&#125;\n\nconst ShortcutManager: React.FC = () =&gt; &#123;\n  // å¿«æ·é”®äº‹ä»¶æ˜ å°„è¡¨\n  const [shortcuts, setShortcuts] = useState&lt;Shortcut[]&gt;([ \n    &#123; event: redo, keys: ['Control', 'z'] &#125;,\n    &#123; event: undo, keys: ['Control', 'y'] &#125;,\n    &#123; event: save, keys: ['Control', 's'] &#125;\n  ]);\n  // ç¼–è¾‘çŠ¶æ€\n  const [editingIndex, setEditingIndex] = useState&lt;number | null&gt;(null);\n  // æ–°çš„å¿«æ·é”®\n  const [newKeys, setNewKeys] = useState&lt;string[]&gt;([]);\n\n  // ç¨³å®šçš„handleKeyDownå‡½æ•°\n  const handleKeyDown = useCallback((e: KeyboardEvent) =&gt; &#123;\n    const newKey: string[] = [];\n    if (e.ctrlKey || e.metaKey) e.preventDefault();\n    if (e.ctrlKey) newKey.push('Control');\n    if (e.altKey) newKey.push('Alt');\n    if (e.shiftKey) newKey.push('Shift');\n    if (e.metaKey) newKey.push('Meta');\n    if (e.key !== 'Control' &amp;&amp; e.key !== 'shift') newKey.push(e.key.toLowerCase());\n    if (editingIndex !== null) &#123;\n      // å¦‚æœåœ¨ç¼–è¾‘çŠ¶æ€ï¼Œæ›´æ–°æ–°çš„å¿«æ·é”®\n      const updatedShortcuts = shortcuts.map((sc, idx) =&gt; &#123;\n        if (idx === editingIndex) &#123;\n          return &#123; ...sc, keys: newKey &#125;;\n        &#125;\n        return sc;\n      &#125;);\n      setShortcuts(updatedShortcuts);\n    &#125; else &#123;\n      // å¦‚æœä¸åœ¨ç¼–è¾‘çŠ¶æ€ï¼Œæ‰§è¡Œå¯¹åº”çš„å¿«æ·é”®äº‹ä»¶\n      const shortcut = shortcuts.find(sc =&gt; sc.keys.join('+') === newKey.join('+'));\n      shortcut?.event();\n    &#125;\n  &#125;, [editingIndex, shortcuts]);\n\n  // æ·»åŠ å’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨\n  useEffect(() =&gt; &#123;\n    window.addEventListener('keydown', handleKeyDown);\n    return () =&gt; &#123;\n      window.removeEventListener('keydown', handleKeyDown);\n    &#125;;\n  &#125;, [editingIndex, handleKeyDown]);\n\n  const startEditing = (index: number) =&gt; &#123;\n    setEditingIndex(index);\n    setNewKeys([]);\n  &#125;;\n\n  const stopEditing = () =&gt; &#123;\n    setEditingIndex(null);\n    if (newKeys.length &gt; 0) &#123;\n      const updatedShortcuts = shortcuts.map((sc, idx) =&gt; idx === editingIndex ? &#123; ...sc, keys: newKeys &#125; : sc);\n      setShortcuts(updatedShortcuts);\n    &#125;\n  &#125;;\n\n  return (\n    &lt;div&gt;\n      &#123;shortcuts.map((sc, index) =&gt; (\n        &lt;div key=&#123;index&#125;&gt;\n          &lt;span&gt;&#123;sc.event.name&#125;å¿«æ·é”®&lt;/span&gt;\n          &lt;span&gt;&#123;sc.keys.join('+')&#125;&lt;/span&gt;\n          &#123;editingIndex === index ? (\n            &lt;button onClick=&#123;stopEditing&#125;&gt;å®Œæˆ&lt;/button&gt;\n          ) : (\n            &lt;button onClick=&#123;() =&gt; startEditing(index)&#125;&gt;ä¿®æ”¹&lt;/button&gt;\n          )&#125;\n        &lt;/div&gt;\n      ))&#125;\n    &lt;/div&gt;\n  );\n&#125;;\n\nfunction App() &#123;\n  return (\n    &lt;div className=&quot;App&quot;&gt;\n      &lt;ShortcutManager /&gt;\n    &lt;/div&gt;\n  );\n&#125;\n\nexport default App;\n</code></pre>\n",
            "tags": [
                "ä½“éªŒ",
                "React",
                "å¿«æ·é”®"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8Konva-Tween%E5%AE%9E%E7%8E%B0%E6%8B%96%E6%8B%BD%E5%90%8E%E7%9A%84%E6%83%AF%E6%80%A7%E5%8A%A8%E7%94%BB/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8Konva-Tween%E5%AE%9E%E7%8E%B0%E6%8B%96%E6%8B%BD%E5%90%8E%E7%9A%84%E6%83%AF%E6%80%A7%E5%8A%A8%E7%94%BB/",
            "title": "ä½¿ç”¨Konva.Tweenå®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»",
            "date_published": "2025-05-25T09:22:05.000Z",
            "content_html": "<h1 id=\"ä½¿ç”¨konvatweenå®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»\"><a class=\"anchor\" href=\"#ä½¿ç”¨konvatweenå®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»\">#</a> ä½¿ç”¨ Konva.Tween å®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»</h1>\n<p><strong>åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼Œä¸ºç”¨æˆ·æä¾›æµç•…è‡ªç„¶çš„äº¤äº’ä½“éªŒè‡³å…³é‡è¦ã€‚é€šè¿‡ä¸ºæ‹–æ‹½æ“ä½œæ·»åŠ æƒ¯æ€§æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥è®©åº”ç”¨æ„Ÿè§‰æ›´åŠ ç”ŸåŠ¨å’Œè‡ªç„¶ã€‚</strong></p>\n<h2 id=\"å‡†å¤‡å·¥ä½œ\"><a class=\"anchor\" href=\"#å‡†å¤‡å·¥ä½œ\">#</a> å‡†å¤‡å·¥ä½œ</h2>\n<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿å·²å®‰è£… Konva.js åº“ã€‚</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> konva</pre></td></tr></table></figure><p>æˆ–è€…è¯´ç›´æ¥åœ¨ HTML ä¸­ç›´æ¥å¼•ç”¨</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/konva@8.3.10/konva.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"åˆ›å»ºåœºæ™¯å’ŒèŠ‚ç‚¹\"><a class=\"anchor\" href=\"#åˆ›å»ºåœºæ™¯å’ŒèŠ‚ç‚¹\">#</a> åˆ›å»ºåœºæ™¯å’ŒèŠ‚ç‚¹</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªåœºæ™¯å’Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ·»åŠ åˆ°åœºæ™¯ä¸­ã€‚</li>\n<li>æ¯æ¬¡æ‹–æ‹½æ—¶éƒ½è®¡ç®—é€Ÿåº¦ï¼ˆä¸ä¸Šæ¬¡æ‹–æ‹½ä½ç½®çš„å·®å€¼ï¼‰</li>\n<li>åˆ›å»ºä¸€ä¸ª Tween å¯¹è±¡ï¼Œå¹¶è®¾ç½®å…¶å±æ€§ä¸ºèŠ‚ç‚¹çš„ä½ç½®å’Œé€Ÿåº¦</li>\n</ol>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/konva@8.3.10/konva.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token comment\">// åˆ›å»ºèˆå°å’Œå›¾å±‚</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">const</span> height <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>innerHeight<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">const</span> stage <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Stage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token literal-property property\">container</span><span class=\"token operator\">:</span> <span class=\"token string\">\"container\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token literal-property property\">height</span><span class=\"token operator\">:</span> height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">let</span> layer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Layer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      stage<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">let</span> rect <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token literal-property property\">height</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token literal-property property\">fill</span><span class=\"token operator\">:</span> <span class=\"token string\">\"green\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token literal-property property\">draggable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      layer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>rect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      layer<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token keyword\">let</span> lastTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">let</span> lastPos <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">let</span> lastVelocity <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token keyword\">let</span> lastVelocitx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">function</span> <span class=\"token function\">calculateVelocity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token keyword\">const</span> dt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastPos<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastPos<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dt <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            lastVelocitx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            lastVelocity <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            lastVelocitx <span class=\"token operator\">=</span> dx <span class=\"token operator\">/</span> dt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            lastVelocity <span class=\"token operator\">=</span> dy <span class=\"token operator\">/</span> dt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token comment\">// console.log('Velocity:', lastVelocity);</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        lastTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        lastPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      rect<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dragstart\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        lastTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        lastPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      rect<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dragmove\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token function\">calculateVelocity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      rect<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dragend\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>lastVelocitx<span class=\"token punctuation\">,</span> lastVelocity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token keyword\">const</span> targetX <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> lastVelocitx <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ ¹æ®é€Ÿåº¦é¢„æµ‹ç»ˆç‚¹</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">const</span> targetY <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> lastVelocity <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token comment\">// ä½¿ç”¨ Tween åˆ›å»ºæƒ¯æ€§åŠ¨ç”»</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Tween</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          <span class=\"token literal-property property\">node</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          <span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// åŠ¨ç”»æŒç»­æ—¶é—´</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          <span class=\"token literal-property property\">easing</span><span class=\"token operator\">:</span> Konva<span class=\"token punctuation\">.</span>Easings<span class=\"token punctuation\">.</span>EaseOut<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ç¼“åŠ¨å‡½æ•°</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> targetX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> targetY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"tweenå±æ€§è¯¦è§£\"><a class=\"anchor\" href=\"#tweenå±æ€§è¯¦è§£\">#</a> Tween å±æ€§è¯¦è§£</h2>\n<h3 id=\"æ ¸å¿ƒå±æ€§è¯´æ˜\"><a class=\"anchor\" href=\"#æ ¸å¿ƒå±æ€§è¯´æ˜\">#</a> æ ¸å¿ƒå±æ€§è¯´æ˜</h3>\n<ol>\n<li>\n<p><strong>node</strong>ï¼ˆå¿…å¡«ï¼‰</p>\n<ul>\n<li>ç±»å‹ï¼š <code>Konva.Node</code></li>\n<li>ä½œç”¨ï¼šæŒ‡å®šè¦åº”ç”¨åŠ¨ç”»çš„èŠ‚ç‚¹å¯¹è±¡ï¼ˆå¦‚  <code>rect</code>   <code>circle</code>  ç­‰ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>node: rect</code></li>\n</ul>\n</li>\n<li>\n<p><strong>duration</strong>ï¼ˆå¿…å¡«ï¼‰</p>\n<ul>\n<li>ç±»å‹ï¼š <code>Number</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>duration: 1</code>  è¡¨ç¤º 1 ç§’å®ŒæˆåŠ¨ç”»</li>\n<li>æ³¨æ„ï¼šç»“åˆ  <code>easing</code>  å‡½æ•°å¯å®ç°ç¼“åŠ¨æ•ˆæœ</li>\n</ul>\n</li>\n<li>\n<p><strong>easing</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Function</code></li>\n<li>ä½œç”¨ï¼šæ§åˆ¶åŠ¨ç”»çš„ç¼“åŠ¨æ›²çº¿</li>\n<li>å¸¸ç”¨é¢„è®¾ï¼š\n<ul>\n<li><code>Konva.Easings.Linear</code>  çº¿æ€§åŒ€é€Ÿ</li>\n<li><code>Konva.Easings.EaseIn</code>  å…ˆæ…¢åå¿«</li>\n<li><code>Konva.Easings.EaseOut</code>  å…ˆå¿«åæ…¢ï¼ˆé€‚åˆæƒ¯æ€§æ•ˆæœï¼‰</li>\n<li><code>Konva.Easings.EaseInOut</code>  æ…¢ - å¿« - æ…¢</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>ç›®æ ‡å±æ€§</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Number</code></li>\n<li>ä½œç”¨ï¼šæŒ‡å®šèŠ‚ç‚¹è¦åŠ¨ç”»åˆ°çš„ç›®æ ‡å±æ€§å€¼ï¼ˆå¯è®¾ç½®å¤šä¸ªï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>x: targetX, y: targetY, rotation: 360</code></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"é«˜çº§é…ç½®\"><a class=\"anchor\" href=\"#é«˜çº§é…ç½®\">#</a> é«˜çº§é…ç½®</h3>\n<ol start=\"5\">\n<li>\n<p><strong>onFinish</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Function</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»ç»“æŸæ—¶çš„å›è°ƒå‡½æ•°</li>\n<li>ç¤ºä¾‹ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function-variable function\">onFinish</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'åŠ¨ç”»å®Œæˆ'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>\n<p><strong>onUpdate</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Function</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»æ¯å¸§æ›´æ–°æ—¶çš„å›è°ƒ</li>\n<li>ç¤ºä¾‹ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function-variable function\">onUpdate</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  layer<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰‹åŠ¨é‡ç»˜å›¾å±‚</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>\n<p><strong>repeat</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Number</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»é‡å¤æ¬¡æ•°ï¼ˆ0 è¡¨ç¤ºä¸é‡å¤ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>repeat: 2</code>  åŠ¨ç”»å°†æ‰§è¡Œ 3 æ¬¡ï¼ˆåˆå§‹ 1 æ¬¡ + é‡å¤ 2 æ¬¡ï¼‰</li>\n</ul>\n</li>\n<li>\n<p><strong>yoyo</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Boolean</code></li>\n<li>ä½œç”¨ï¼šæ˜¯å¦å¼€å¯å¾€è¿”åŠ¨ç”»ï¼ˆéœ€è¦é…åˆ repeat ä½¿ç”¨ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>yoyo: true</code>  åŠ¨ç”»ä¼šæ­£å‘æ’­æ”¾ååå‘æ’­æ”¾</li>\n</ul>\n</li>\n</ol>\n",
            "tags": [
                "Canvas",
                "Konva",
                "æƒ¯æ€§åŠ¨ç”»"
            ]
        },
        {
            "id": "https://aynya.github.io/%E6%89%8B%E5%86%99Promise/",
            "url": "https://aynya.github.io/%E6%89%8B%E5%86%99Promise/",
            "title": "æ‰‹å†™Promise",
            "date_published": "2025-04-26T13:48:44.000Z",
            "content_html": "<h1 id=\"æ‰‹å†™promise\"><a class=\"anchor\" href=\"#æ‰‹å†™promise\">#</a> æ‰‹å†™ Promise</h1>\n<h2 id=\"æ„é€ å‡½æ•°\"><a class=\"anchor\" href=\"#æ„é€ å‡½æ•°\">#</a> æ„é€ å‡½æ•°</h2>\n<p><strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>å®šä¹‰ç±» =&gt; æ·»åŠ æ„é€ å‡½æ•° =&gt; å®šä¹‰resolve/reject =&gt; æ‰§è¡Œå›è°ƒå‡½æ•°\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// state = PENDING;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// result = undefined;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"çŠ¶æ€åŠåŸå› \"><a class=\"anchor\" href=\"#çŠ¶æ€åŠåŸå› \">#</a> çŠ¶æ€åŠåŸå› </h2>\n<p><strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>æ·»åŠ çŠ¶æ€ =&gt; æ·»åŠ åŸå›  =&gt; è°ƒæ•´resolve/reject =&gt; çŠ¶æ€ä¸å¯é€†\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"thenæ–¹æ³•\"><a class=\"anchor\" href=\"#thenæ–¹æ³•\">#</a> then æ–¹æ³•</h2>\n<h3 id=\"æˆåŠŸæˆ–å¤±è´¥å›è°ƒ\"><a class=\"anchor\" href=\"#æˆåŠŸæˆ–å¤±è´¥å›è°ƒ\">#</a> æˆåŠŸæˆ–å¤±è´¥å›è°ƒ</h3>\n<p>æ ¹æ®å½“å‰çš„çŠ¶æ€ï¼Œæ‰§è¡Œå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚ç‰¹æ®Šçš„å¦‚æœä¼ å…¥çš„å›è°ƒå‡½æ•°ä¸æ˜¯å‡½æ•°ï¼Œè¿”å›åŸå€¼<br />\n<strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>æ·»åŠ å®ä¾‹æ–¹æ³• =&gt; å‚æ•°åˆ¤æ–­ =&gt; æ‰§è¡ŒæˆåŠŸ/å¤±è´¥å›è°ƒ\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¼‚æ­¥å’Œå¤šæ¬¡è°ƒç”¨\"><a class=\"anchor\" href=\"#å¼‚æ­¥å’Œå¤šæ¬¡è°ƒç”¨\">#</a> å¼‚æ­¥å’Œå¤šæ¬¡è°ƒç”¨</h3>\n<p>æ ¹æ®å½“å‰çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ pendingï¼Œå…ˆå°†å›è°ƒå‡½æ•°ä¿å­˜èµ·æ¥ï¼Œç­‰çŠ¶æ€æ”¹å˜åï¼Œå†æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚å¦‚æœå¤šæ¬¡è°ƒç”¨ thenï¼Œå°†å›è°ƒå‡½æ•°ä¿å­˜èµ·æ¥ï¼Œç­‰çŠ¶æ€æ”¹å˜åï¼Œå†æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚<br />\n<strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>å®šä¹‰å®ä¾‹å±æ€§ =&gt; ä¿å­˜å›è°ƒå‡½æ•° =&gt; æ‰§è¡ŒæˆåŠŸ/å¤±è´¥å›è°ƒ\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [&#123;onFulfilled, onRejected&#125;, ã€‚ã€‚ã€‚]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onFulfilled<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onRejected<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                onFulfilled<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                onRejected</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"å¼‚æ­¥ä»»åŠ¡\"><a class=\"anchor\" href=\"#å¼‚æ­¥ä»»åŠ¡\">#</a> å¼‚æ­¥ä»»åŠ¡</h2>\n<p>å…ˆæ‰§è¡Œå®é˜Ÿåˆ—ï¼Œå†æ‰§è¡Œå¾®é˜Ÿåˆ—ã€‚<br />\nè€Œ Promise æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å…ˆæ‰§è¡Œå¾®é˜Ÿåˆ—ï¼Œå†æ‰§è¡Œå®é˜Ÿåˆ—ã€‚<br />\n<strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>å®šä¹‰å‡½æ•° =&gt; è°ƒç”¨æ ¸å¿ƒAPI =&gt; è°ƒç”¨å‡½æ•°\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [&#123;onFulfilled, onRejected&#125;, ã€‚ã€‚ã€‚]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onFulfilled<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onRejected<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token function-variable function\">onFulfilled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                        <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token function-variable function\">onRejected</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> queueMicrotask <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token function\">queueMicrotask</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> MutationObserver <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token keyword\">const</span> obs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token keyword\">const</span> divNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        obs<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>divNode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span><span class=\"token literal-property property\">childList</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        divNode<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<ol>\n<li><strong>æ„é€ å‡½æ•°</strong><br />\næ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå™¨å‡½æ•° <code>executor</code> ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š   <code>resolve</code>  å’Œ <code>reject</code> ã€‚è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ç”¨äºå°† <code>Promise</code>  çš„çŠ¶æ€ä» <code>pending</code>  è½¬å˜ä¸º <code>fulfilled</code>  å’Œ <code>rejected</code> ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// å½“å‰çŠ¶æ€ï¼Œé»˜è®¤ä¸º pending</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// å­˜å‚¨ resolve æˆ– reject çš„ç»“æœ</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>            <span class=\"token comment\">// å­˜å‚¨ then æ–¹æ³•ä¸­æ³¨å†Œçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending è½¬å˜ä¸º fulfilled</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„ onFulfilled å›è°ƒ</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onFulfilled <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending è½¬å˜ä¸º rejected</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„ onRejected å›è°ƒ</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onRejected <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœæ‰§è¡Œå™¨æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ç›´æ¥è°ƒç”¨ reject</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>then æ–¹æ³•</strong><br />\n <code>then</code>  æ–¹æ³•å…è®¸æˆ‘ä»¬ä¸º <code>Promise</code>  æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°ã€‚æ— è®ºå½“å‰ <code>Promise</code>  çš„çŠ¶æ€æ˜¯ <code>fulfilled</code>  è¿˜æ˜¯ <code>rejected</code> ï¼Œ <code>then</code>  æ–¹æ³•éƒ½ä¼šè§¦å‘ç›¸åº”çš„å›è°ƒã€‚å¦‚æœ <code>Promise</code>  ä»ç„¶å¤„äº <code>pending</code>  çŠ¶æ€ï¼Œåˆ™ä¼šå°†å›è°ƒå­˜å‚¨èµ·æ¥ï¼Œç­‰åˆ°çŠ¶æ€æ”¹å˜æ—¶å†æ‰§è¡Œã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// å¦‚æœ then çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™æä¾›é»˜è®¤å®ç°</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token function-variable function\">onFulfilled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                            <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                            <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token function-variable function\">onRejected</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                            <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                            <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">return</span> p2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿”å›æ–°çš„ Promise</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>é™æ€æ–¹æ³•</strong><br />\nä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œè¿˜å®ç°äº†ä¸¤ä¸ªé™æ€æ–¹æ³• <code>resolve</code>  å’Œ <code>reject</code> ï¼Œå®ƒä»¬å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå·²ç»æˆ–æ‹’ç»çš„ <code>Promise</code></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li><strong>è§£æè¿”å›å€¼å‡½æ•°</strong><br />\nå½“ <code>then</code>  æ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªå€¼ã€‚å¦‚æœè¿”å›çš„æ˜¯å¦ä¸€ä¸ª <code>Promise</code> ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…å®ƒçš„çŠ¶æ€å˜åŒ–ï¼›å¦åˆ™ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªå€¼ä½œä¸ºæ–° <code>Promise</code>  çš„ç»“æœ</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chaining cycle detected for promise'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        x<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li><strong>å¼‚æ­¥ä»»åŠ¡</strong><br />\nä¸ºäº†ç¡®ä¿å›è°ƒå‡½æ•°æ€»æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•° <code>runAsynctask</code>  æ¥è°ƒåº¦ä»»åŠ¡ï¼Œä¼˜å…ˆå°è¯•ä½¿ç”¨ <code>queueMicrotask</code> ï¼Œå¦‚æœä¸æ”¯æŒåˆ™å›é€€åˆ° <code>MutationObserver</code>  æˆ– <code>setTimeout</code></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> queueMicrotask <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token function\">queueMicrotask</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> MutationObserver <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> obs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">const</span> divNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        obs<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>divNode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">childList</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        divNode<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li><strong>ä»£ç </strong></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// ä¸‰ç§çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨ then æ–¹æ³•ä¸­æ³¨å†Œçš„å›è°ƒå‡½æ•° [&#123;onFulfilled, onRejected&#125;, ã€‚ã€‚ã€‚]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ– Promise</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     * @param &#123;Function&#125; executor - æ‰§è¡Œå™¨å‡½æ•°ï¼Œæ¥æ”¶ resolve å’Œ reject ä½œä¸ºå‚æ•°</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onFulfilled <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending -> rejected</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onRejected <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">// æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„æ‰§è¡Œå™¨å‡½æ•°ï¼Œä¼ å…¥ resolve å’Œ reject</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœæ‰§è¡Œå™¨å‡½æ•°æ‰§è¡Œå‡ºé”™ï¼Œåˆ™è°ƒç”¨ reject</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>     * æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>     * @param &#123;Function&#125; onFulfilled - æˆåŠŸæ—¶çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>     * @param &#123;Function&#125; onRejected - å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">// è¿”å›æ–°çš„ promise</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">const</span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token comment\">// å½“å‰çŠ¶æ€ä¸º fulfilledï¼Œåˆ™ç›´æ¥è°ƒç”¨ onFulfilled</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                        <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                        <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è§£æå›è°ƒå‡½æ•°çš„è¿”å›å€¼</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                <span class=\"token comment\">// å½“å‰çŠ¶æ€ä¸º rejectedï¼Œåˆ™ç›´æ¥è°ƒç”¨ onRejected</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                        <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                        <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è§£æå›è°ƒå‡½æ•°çš„è¿”å›å€¼</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token comment\">// å½“å‰çŠ¶æ€ä¸º pendingï¼Œåˆ™å°†å›è°ƒå‡½æ•°å­˜å‚¨èµ·æ¥ï¼Œå¾…çŠ¶æ€æ”¹å˜æ—¶å†æ‰§è¡Œ</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    <span class=\"token function-variable function\">onFulfilled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                        <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                                <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                                <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                    <span class=\"token function-variable function\">onRejected</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                        <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                                <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                                <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token keyword\">return</span> p2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿”å›æ–°çš„ promise</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>     * æ³¨å†Œå¤±è´¥çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>     * @param &#123;Function&#125; onRejected - å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>onRejected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>     * æ³¨å†Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>     * @param &#123;Function&#125; callback - æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>     */</span>    </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token function\">finally</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œ</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>     * å°†ä¼ å…¥çš„å€¼è½¬ä¸ºä¸€ä¸ª resolved çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>     * @param &#123;*&#125; value - éœ€è¦è½¬æ¢çš„å€¼</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ª resolved çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>            <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœå·²ç»æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è½¬æ¢ä¸º resolved çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>     * è¿”å›ä¸€ä¸ª rejected çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>     * @param &#123;*&#125; reason - æ‹’ç»çš„åŸå› </pre></td></tr><tr><td data-num=\"143\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ª rejected çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åˆ›å»ºä¸€ä¸ªæ–°çš„ rejected Promise</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"153\"></td><td><pre> * è§£æ Promise çš„è¿”å›å€¼ xï¼Œå¹¶å†³å®šå¦‚ä½•æ›´æ–°æ–°çš„ Promise p2 çš„çŠ¶æ€</pre></td></tr><tr><td data-num=\"154\"></td><td><pre> * @param &#123;MyPromise&#125; p2 - æ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"155\"></td><td><pre> * @param &#123;*&#125; x - then å›è°ƒå‡½æ•°çš„è¿”å›å€¼</pre></td></tr><tr><td data-num=\"156\"></td><td><pre> * @param &#123;Function&#125; resolve - p2 çš„ resolve å‡½æ•°</pre></td></tr><tr><td data-num=\"157\"></td><td><pre> * @param &#123;Function&#125; reject - p2 çš„ reject å‡½æ•°</pre></td></tr><tr><td data-num=\"158\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ x æ˜¯ p2 æœ¬èº«ï¼ŒæŠ›å‡ºå¾ªç¯å¼•ç”¨é”™è¯¯</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chaining cycle detected for promise'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ x æ˜¯ä¸€ä¸ª Promise é€’å½’è§£æçŠ¶æ€</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        x<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre></pre></td></tr><tr><td data-num=\"176\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"177\"></td><td><pre> * å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼ˆå¾®ä»»åŠ¡ä¼˜å…ˆï¼‰</pre></td></tr><tr><td data-num=\"178\"></td><td><pre> * @param &#123;Function&#125; callback - éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡</pre></td></tr><tr><td data-num=\"179\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> queueMicrotask <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>        <span class=\"token function\">queueMicrotask</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> MutationObserver <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token keyword\">const</span> obs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        <span class=\"token keyword\">const</span> divNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        obs<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>divNode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">childList</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>        divNode<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "JavaScript",
                "JavaScript",
                "Promise"
            ]
        },
        {
            "id": "https://aynya.github.io/%E5%A4%9A%E7%A7%8D%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/",
            "url": "https://aynya.github.io/%E5%A4%9A%E7%A7%8D%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/",
            "title": "å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º",
            "date_published": "2025-04-17T10:04:44.000Z",
            "content_html": "<h1 id=\"å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º\"><a class=\"anchor\" href=\"#å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º\">#</a> å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º</h1>\n<p>æ”¯æŒ <code>JSON</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€ä¸“æœ‰æ–‡ä»¶ <code>dmp</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€ <code>xlsx</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€ <code>md</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€‚<br />\næ”¯æŒå¯¼å‡º <code>png</code> ã€ <code>jpg</code> ã€ <code>svg</code> ã€ <code>pdf</code>  æ ¼å¼ã€‚</p>\n<p>è¿™é‡Œä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å°ºå¯¸å­—æ®µ [width, height]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// æ–°å¢æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢æ–¹å‘å±æ€§ (åªåœ¨ center å¸ƒå±€ä¸­ä½¿ç”¨)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">State</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'top-to-bottom'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å¸ƒå±€é£æ ¼å±æ€§</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"json\"><a class=\"anchor\" href=\"#json\">#</a> JSON</h2>\n<h3 id=\"å¯¼å‡º\"><a class=\"anchor\" href=\"#å¯¼å‡º\">#</a> å¯¼å‡º</h3>\n<p>æ„å»ºåˆ†å±‚é€’å½’çš„ json å­—ç¬¦ä¸²ï¼Œç„¶åä¿å­˜åˆ°æœ¬åœ°ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º JSON æ–‡ä»¶</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsJSON</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// é€’å½’æ„å»ºåˆ†å±‚èŠ‚ç‚¹ç»“æ„</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> buildHierarchy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// æ„å»ºå½“å‰èŠ‚ç‚¹çš„å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> currentNode <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            text<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            position<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            children<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token function\">buildHierarchy</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>Boolean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            size<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            collapsed<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            direction<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>direction</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> currentNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹é€’å½’æ„å»ºæ•´ä¸ªæ ‘</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> <span class=\"token function\">buildHierarchy</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// æ„é€ æœ€ç»ˆå¯¼å‡ºçš„æ•°æ®</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        nodes<span class=\"token operator\">:</span> root<span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¯¼å‡ºçš„èŠ‚ç‚¹æ˜¯åˆ†å±‚çš„ç»“æ„</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        connections<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>connections</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»º Blob å¹¶ä¿å­˜æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥\"><a class=\"anchor\" href=\"#å¯¼å…¥\">#</a> å¯¼å…¥</h3>\n<p>å®šä¹‰ json èŠ‚ç‚¹ç±»å‹</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">JSONNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> JSONNode<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è§£æ json æ–‡ä»¶å†…å®¹ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè§£ææˆåŠŸè¿”å›ä¸€ä¸ª State å¯¹è±¡ï¼Œè§£æå¤±è´¥è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚<br />\né€’å½’æ„å»ºèŠ‚ç‚¹ç»“æ„ï¼Œæ›´æ–°åˆ° store ä¸­ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šé€’å½’è§£æå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">const</span> parseHierarchy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> JSONNode<span class=\"token punctuation\">,</span> parsedData<span class=\"token operator\">:</span> ParsedData<span class=\"token punctuation\">,</span> parentId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> collapsed<span class=\"token punctuation\">,</span> direction <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token comment\">// åˆ›å»º</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token keyword\">const</span> currentNode<span class=\"token operator\">:</span> Node <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        position<span class=\"token operator\">:</span> position <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›ä½ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        size<span class=\"token operator\">:</span> size <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›å°ºå¯¸ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        collapsed<span class=\"token operator\">:</span> collapsed <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›æŠ˜å çŠ¶æ€ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        direction<span class=\"token operator\">:</span> direction<span class=\"token operator\">||</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ–¹å‘å±æ€§æ˜¯å¯é€‰çš„</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token comment\">// æ·»åŠ åˆ°èŠ‚ç‚¹è®°å½•</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> currentNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token comment\">// å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å»ºç«‹è¿æ¥</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parentId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token comment\">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>children <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                            <span class=\"token function\">parseHierarchy</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token comment\">// è¯»å–</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Empty file content'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token comment\">// è§£æ JSON æ•°æ®</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token comment\">// åˆå§‹åŒ–</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token keyword\">const</span> parsedData<span class=\"token operator\">:</span> ParsedData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    connections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>nodes <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid JSON structure'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token comment\">// è§£æèŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token function\">parseHierarchy</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–°å…¨å±€çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                    connections<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading JSON file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid JSON file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"dmp\"><a class=\"anchor\" href=\"#dmp\">#</a> dmp</h2>\n<p><code>dmp</code>  æ ¼å¼æ˜¯æˆ‘è¿™ä¸ªæ€ç»´å¯¼å›¾çš„ä¸“æœ‰æ ¼å¼ï¼Œå®ƒåŒ…å«èŠ‚ç‚¹ä¿¡æ¯ã€è¿çº¿ä¿¡æ¯ã€å¸ƒå±€ä¿¡æ¯ç­‰ã€‚</p>\n<h3 id=\"å¯¼å‡º-2\"><a class=\"anchor\" href=\"#å¯¼å‡º-2\">#</a> å¯¼å‡º</h3>\n<p>ç›´æ¥å°† state è½¬æ¢ä¸º json å­—ç¬¦ä¸²ï¼Œç„¶åä¿å­˜åˆ°æœ¬åœ°ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸ºä¸“æœ‰æ–‡ä»¶ dmp æ ¼å¼</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsDMP</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// æ„é€ æœ€ç»ˆå¯¼å‡ºçš„æ•°æ®</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        nodes<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ‰å¹³åŒ–ä¸º Node å¯¹è±¡æ•°ç»„</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        connections<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        selectedNodeId<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>selectedNodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        layoutStyle<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>layoutStyle</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>type<span class=\"token operator\">:</span> <span class=\"token string\">'application/dmp'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.dmp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥-2\"><a class=\"anchor\" href=\"#å¯¼å…¥-2\">#</a> å¯¼å…¥</h3>\n<p>ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè§£æ json å¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡æ•°ç»„è½¬æ¢åˆ° store ä¸­éœ€è¦çš„æ˜ å°„å½¢å¼ï¼Œæ›´æ–° state</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å…¥ DMP æ–‡ä»¶</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param file - DMP æ–‡ä»¶å¯¹è±¡</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @returns Promise&lt;void></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromDMP <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// è¯»å–æ–‡ä»¶å†…å®¹</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Empty file content'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token comment\">// è§£æ DMP æ ¼å¼</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>nodes <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid DMP structure'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">// åˆå§‹åŒ–</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">const</span> parsedData<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token comment\">// è§£æèŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                data<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> Node<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// å¯¹è±¡æ•°ç»„è½¬æ˜ å°„</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    parsedData<span class=\"token punctuation\">[</span>node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–°å…¨å±€çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    connections<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>selectedNodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>layoutStyle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading DMP file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid DMP file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"xlsx\"><a class=\"anchor\" href=\"#xlsx\">#</a> XLSX</h2>\n<p><code>XLSX</code>  æ ¼å¼æ˜¯ Excel è¡¨æ ¼çš„æ ¼å¼ï¼Œå®ƒåŒ…å«èŠ‚ç‚¹ä¿¡æ¯ã€è¿çº¿ä¿¡æ¯ã€å¸ƒå±€ä¿¡æ¯ç­‰ã€‚</p>\n<h3 id=\"å¯¼å‡º-3\"><a class=\"anchor\" href=\"#å¯¼å‡º-3\">#</a> å¯¼å‡º</h3>\n<p>åœ¨å¯¼å‡ºä¸º <code>Excel</code>  æ—¶éœ€è¦å¯¼å…¥ <code>xlsx</code>  åº“ï¼Œç„¶åä½¿ç”¨ <code>xlsx</code>  åº“çš„ <code>utils.json_to_sheet</code>  æ–¹æ³•å°†æ•°æ®è½¬æ¢ä¸º <code>sheet</code> ï¼Œå†ä½¿ç”¨ <code>xlsx</code>  åº“çš„ <code>writeFile</code>  æ–¹æ³•å°† <code>sheet</code>  å†™å…¥æ–‡ä»¶ã€‚<br />\nåˆ†ä¸º nodes è¡¨æ ¼å’Œ connections è¡¨æ ¼ä»¥åŠ global state è¡¨æ ¼ã€‚<br />\nå°†è¿™äº›è¡¨æ ¼å†™å…¥æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ–‡ä»¶åã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º Excel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsExcel</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes<span class=\"token punctuation\">,</span> connections<span class=\"token punctuation\">,</span> selectedNodeId<span class=\"token punctuation\">,</span> layoutStyle <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// Nodes è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> nodesData <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        text<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        position_x<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        position_y<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        size_width<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        size_height<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        collapsed<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        direction<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// Connections è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">const</span> connectionsData <span class=\"token operator\">=</span> connections<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> from<span class=\"token punctuation\">,</span> to <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// Global State è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> globalStateData <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span> key<span class=\"token operator\">:</span> <span class=\"token string\">'selectedNodeId'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> selectedNodeId <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span> key<span class=\"token operator\">:</span> <span class=\"token string\">'layoutStyle'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> layoutStyle <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºå·¥ä½œç°¿</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">const</span> workbook <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ  Nodes å·¥ä½œè¡¨</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">const</span> nodesWorksheet <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">json_to_sheet</span><span class=\"token punctuation\">(</span>nodesData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_append_sheet</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> nodesWorksheet<span class=\"token punctuation\">,</span> <span class=\"token string\">'Nodes'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ  Connections å·¥ä½œè¡¨</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">const</span> connectionsWorksheet <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">json_to_sheet</span><span class=\"token punctuation\">(</span>connectionsData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_append_sheet</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> connectionsWorksheet<span class=\"token punctuation\">,</span> <span class=\"token string\">'Connections'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ  Global State å·¥ä½œè¡¨</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">const</span> globalStateWorksheet <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">json_to_sheet</span><span class=\"token punctuation\">(</span>globalStateData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_append_sheet</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> globalStateWorksheet<span class=\"token punctuation\">,</span> <span class=\"token string\">'Global State'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">// å¯¼å‡ºæ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap_data.xlsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥-3\"><a class=\"anchor\" href=\"#å¯¼å…¥-3\">#</a> å¯¼å…¥</h3>\n<p>å®šä¹‰æ•°æ®ç»“æ„</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰è§£æåçš„æ•°æ®ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">NodeRow</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    position_x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    position_y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    size_width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    size_height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­—ç¬¦ä¸² 'true' æˆ– 'false'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">ConnectionRow</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    from<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    to<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">GlobalStateRow</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    value<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç”±äº <code>xlsx</code>  æ–‡ä»¶çš„æ ¼å¼æ˜¯ <code>ArrayBuffer</code> ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸º <code>ArrayBuffer</code> ï¼Œå†ä½¿ç”¨ <code>xlsx</code>  åº“çš„ <code>read</code>  æ–¹æ³•è§£ææ–‡ä»¶ã€‚<br />\nç„¶åæŠŠä¸‰ä¸ªè¡¨æ ¼åˆ†åˆ«è§£æä¸º <code>Node</code> ã€ <code>Connection</code>  å’Œ <code>GlobalState</code>  å¯¹è±¡ï¼Œå¹¶æ›´æ–°åˆ° <code>store</code>  ä¸­ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">importFromXlsx</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> ArrayBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token keyword\">const</span> workbook <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'array'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token comment\">// è§£æ Nodes è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token keyword\">const</span> nodesSheet <span class=\"token operator\">=</span> workbook<span class=\"token punctuation\">.</span>Sheets<span class=\"token punctuation\">[</span><span class=\"token string\">'Nodes'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">const</span> nodesData <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">sheet_to_json</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>NodeRow<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>nodesSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>nodesData<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">const</span> nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                nodesData<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    nodes<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        id<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        text<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">.</span>position_x<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">.</span>position_y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">.</span>size_width<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">.</span>size_height<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        collapsed<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">===</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        direction<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">||</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// è§£æ Connections è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">const</span> connectionsSheet <span class=\"token operator\">=</span> workbook<span class=\"token punctuation\">.</span>Sheets<span class=\"token punctuation\">[</span><span class=\"token string\">'Connections'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token keyword\">const</span> connectionsData <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">sheet_to_json</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ConnectionRow<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>connectionsSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token keyword\">const</span> connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                connectionsData<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>row<span class=\"token punctuation\">.</span>from<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>row<span class=\"token punctuation\">.</span>to<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å…³ç³»</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                connections<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">,</span> childId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token comment\">// è§£æ Global State è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token keyword\">const</span> globalStateSheet <span class=\"token operator\">=</span> workbook<span class=\"token punctuation\">.</span>Sheets<span class=\"token punctuation\">[</span><span class=\"token string\">'Global State'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>globalStateSheet<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing \"Global State\" sheet'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token keyword\">const</span> globalStateData <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">sheet_to_json</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>GlobalStateRow<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>globalStateSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token keyword\">let</span> selectedNodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token keyword\">let</span> layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'top-to-bottom'</span> <span class=\"token operator\">=</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                globalStateData<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token string\">'selectedNodeId'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                        selectedNodeId <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token string\">'layoutStyle'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'top-to-bottom'</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                            layoutStyle <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>value <span class=\"token keyword\">as</span> <span class=\"token keyword\">typeof</span> layoutStyle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–° store çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                    connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    selectedNodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                    layoutStyle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> nodes<span class=\"token punctuation\">,</span> connections <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading XLSX file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid XLSX file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsArrayBuffer</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"markdown\"><a class=\"anchor\" href=\"#markdown\">#</a> markdown</h2>\n<h3 id=\"å¯¼å‡º-4\"><a class=\"anchor\" href=\"#å¯¼å‡º-4\">#</a> å¯¼å‡º</h3>\n<p>é€šè¿‡è®¾è®¡æ ‡é¢˜çš„çº§åˆ«ï¼Œå°±å¯ä»¥åŒºåˆ†ä¸åŒçš„å±‚çº§ï¼Œä»è€Œå®ç°ä¸åŒå±‚çº§çš„å¯¼å‡ºã€‚<br />\nè¿™ä¸ªå¯ä»¥é€šè¿‡é€’å½’å®ç°ï¼Œæ ¹èŠ‚ç‚¹çš„æ ‡é¢˜çº§åˆ«ä¸º 1ï¼Œä»¥æ­¤ç±»æ¨</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡º markdown</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsMarkdown</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// é€’å½’ç”Ÿæˆ Markdown å†…å®¹</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generateMarkdown</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> level <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹çš„æ ‡é¢˜</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">const</span> heading <span class=\"token operator\">=</span> <span class=\"token string\">'#'</span><span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span>level<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">const</span> metadata <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            position<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            size<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            collapsed<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            direction<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹çš„ Markdown è¡¨ç¤º</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">let</span> markdown <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>heading<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>node<span class=\"token punctuation\">.</span>text<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> &lt;!-- </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>metadata<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> -->\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœèŠ‚ç‚¹æœªæŠ˜å ï¼Œåˆ™é€’å½’ç”Ÿæˆå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                markdown <span class=\"token operator\">+=</span> <span class=\"token function\">generateMarkdown</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> level <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> markdown<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹ç”Ÿæˆ Markdown</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">const</span> rootMarkdown <span class=\"token operator\">=</span> <span class=\"token function\">generateMarkdown</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// å°† Markdown å†…å®¹ä¸‹è½½ä¸ºæ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>rootMarkdown<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'text/markdown'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    a<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> url<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    a<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'mindmap.md'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    a<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥-4\"><a class=\"anchor\" href=\"#å¯¼å…¥-4\">#</a> å¯¼å…¥</h3>\n<p>è¿™é‡Œå…ˆè¯»æ–‡ä»¶ï¼Œè¯»å‡ºæ¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯¹æ”¹å­—ç¬¦ä¸²è¿›è¡Œè§£æ<br />\né€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å¯¹æ¯ä¸€è¡Œçš„æ ‡é¢˜è¿›è¡ŒåŒ¹é…ï¼Œç„¶åæ ¹æ®åŒ¹é…ç»“æœç”ŸæˆèŠ‚ç‚¹å’Œè¿æ¥å…³ç³»ã€‚<br />\nåŒ¹é…å†…å®¹å¦‚ä¸‹</p>\n<pre><code># æ ‡é¢˜å†…å®¹ &lt;!-- æ³¨é‡Šå†…å®¹ --&gt;\n</code></pre>\n<p><strong>åœ¨é€’å½’åˆ†å±‚æ—¶</strong>ï¼Œä½¿ç”¨æ ˆæ¥æ‰¾åˆ°çˆ¶èŠ‚ç‚¹çš„ idï¼Œç„¶åæŠŠå½“å‰èŠ‚ç‚¹çš„ id æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„ children ä¸­ (<strong>ç±»ä¼¼äºæ‹¬å·åŒ¹é…</strong>)<br />\n æŠŠè§£æå‡ºæ¥çš„å†…å®¹æ›´æ–°åˆ° store ä¸­</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å…¥ Markdown æ–‡ä»¶</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param file - Markdown æ–‡ä»¶å¯¹è±¡</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @returns </pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// å¯¼å…¥ Markdown æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromMarkdown <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token comment\">// å®šä¹‰è§£æåçš„èŠ‚ç‚¹å’Œè¿æ¥</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">const</span> nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">const</span> connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token comment\">// å½“å‰å±‚çº§çš„èŠ‚ç‚¹æ ˆ</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token keyword\">const</span> nodeStack<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> level<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token comment\">// é€è¡Œè§£æ Markdown</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                content<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    <span class=\"token comment\">// åŒ¹é…æ ‡é¢˜å’Œå…ƒæ•°æ®</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token keyword\">const</span> headingMatch <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^(#+)\\s+(.+?)\\s+&lt;!--\\s+(.+?)\\s+--></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>headingMatch<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>_<span class=\"token punctuation\">,</span> hashes<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> headingMatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    <span class=\"token keyword\">const</span> level <span class=\"token operator\">=</span> hashes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    <span class=\"token comment\">// è§£æå…ƒæ•°æ®</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token keyword\">const</span> nodeData <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token keyword\">const</span> nodeId <span class=\"token operator\">=</span> nodeData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    <span class=\"token comment\">// åˆ›å»ºèŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        id<span class=\"token operator\">:</span> nodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        position<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        size<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                        collapsed<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                        direction<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">||</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token comment\">// ç¡®å®šçˆ¶å­å…³ç³»</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> nodeStack<span class=\"token punctuation\">[</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>level <span class=\"token operator\">>=</span> level<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                        nodeStack<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token keyword\">const</span> parentId <span class=\"token operator\">=</span> nodeStack<span class=\"token punctuation\">[</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>nodeId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                    <span class=\"token comment\">// å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆ</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                    nodeStack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> nodeId<span class=\"token punctuation\">,</span> level <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–° store çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                    nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading Markdown file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid Markdown file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"å›¾ç‰‡æ ¼å¼çš„å¯¼å‡º\"><a class=\"anchor\" href=\"#å›¾ç‰‡æ ¼å¼çš„å¯¼å‡º\">#</a> å›¾ç‰‡æ ¼å¼çš„å¯¼å‡º</h2>\n<p>åœ¨å¯¼å‡ºå›¾ç‰‡ä¹‹æ—¶éƒ½éœ€è¦å¯¹èŠ‚ç‚¹åœ¨æ–°çš„ <code>stage</code>  ä¸­è¿›è¡Œé‡ç»˜ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ¯ä¸ªæ— è®ºåœ¨å“ªé‡Œï¼Œå¯¼å‡ºçš„å†…å®¹éƒ½æ˜¯æ­£ç¡®çš„ã€‚</p>\n<ol>\n<li><strong>è§„åˆ’åŒºåŸŸ</strong></li>\n</ol>\n<ul>\n<li>æ¯ä¸ªèŠ‚ç‚¹ä½ç½®æˆ‘ä»¬éƒ½å¯ä»¥ä» <code>store</code>  ä¸­çŸ¥é“ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦éå†ä¸€é <code>store</code> ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹çš„ä½ç½®ï¼Œæ‰¾åˆ°æœ€å¤§çš„ <code>x</code>  å’Œ <code>y</code>  åæ ‡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªåæ ‡æ¥ç¡®å®šæ•´ä¸ªåŒºåŸŸçš„å¤§å°ã€‚</li>\n</ul>\n<ol start=\"2\">\n<li><strong>ç»˜åˆ¶èŠ‚ç‚¹</strong></li>\n</ol>\n<ul>\n<li>æ ¹æ®è§„åˆ’çš„åŒºåŸŸï¼Œåœ¨ <code>stage</code>  ä¸­ç»˜åˆ¶èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹çš„ä½ç½®ï¼Œç»˜åˆ¶èŠ‚ç‚¹</li>\n</ul>\n<ol start=\"3\">\n<li><strong>ç»˜åˆ¶è¿çº¿</strong></li>\n</ol>\n<ul>\n<li>æ ¹æ®è§„åˆ’çš„åŒºåŸŸï¼Œæ ¹æ®èŠ‚ç‚¹çš„ä½ç½®ï¼Œç»˜åˆ¶è¿çº¿</li>\n</ul>\n<p>é‡ç»˜ä»£ç ï¼š</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * ç”Ÿæˆä¸´æ—¶çš„ Konva Stageï¼ŒåŒ…å«æ‰€æœ‰èŠ‚ç‚¹å’Œè¿æ¥çº¿ã€‚</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns &#123;Object&#125; åŒ…å« stage å’Œ layer çš„å¯¹è±¡</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generateStage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// ä» Store ä¸­è·å–èŠ‚ç‚¹å’Œè¿æ¥ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes<span class=\"token punctuation\">,</span> connections<span class=\"token punctuation\">,</span> layoutStyle <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nodes <span class=\"token operator\">||</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰èŠ‚ç‚¹å¯ä»¥å¯¼å‡º'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹ç•Œæ¡†ï¼ˆåªåŒ…å«å¯è§èŠ‚ç‚¹ï¼‰</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">let</span> minX <span class=\"token operator\">=</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            minY <span class=\"token operator\">=</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            maxX <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            maxY <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">const</span> visibleNodes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨å¯è§èŠ‚ç‚¹çš„ ID</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// é€’å½’éå†èŠ‚ç‚¹æ ‘ï¼Œæ”¶é›†å¯è§èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">traverseNodes</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™è·³è¿‡</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå¯è§</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token comment\">// æ›´æ–°è¾¹ç•Œæ¡†</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            minX <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>minX<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            minY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>minY<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            maxX <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxX<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            maxY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxY<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœèŠ‚ç‚¹æœªæŠ˜å ï¼Œé€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">traverseNodes</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">traverseNodes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœæ²¡æœ‰å¯è§èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>visibleNodes<span class=\"token punctuation\">.</span>size <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰å¯è§èŠ‚ç‚¹å¯ä»¥å¯¼å‡º'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token comment\">// è®¡ç®—å†…å®¹åŒºåŸŸçš„å®½é«˜</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">const</span> contentWidth <span class=\"token operator\">=</span> maxX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">const</span> contentHeight <span class=\"token operator\">=</span> maxY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»ºä¸´æ—¶çš„ Stage å’Œ Layer</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">const</span> tempContainer <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        tempContainer<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> <span class=\"token string\">'absolute'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        tempContainer<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> <span class=\"token string\">'-9999px'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// éšè—å®¹å™¨</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>tempContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">const</span> tempStage <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Stage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            container<span class=\"token operator\">:</span> tempContainer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            width<span class=\"token operator\">:</span> contentWidth<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            height<span class=\"token operator\">:</span> contentHeight<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token keyword\">const</span> tempLayer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Layer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        tempStage<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>tempLayer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token comment\">// æ·»åŠ ç™½è‰²èƒŒæ™¯çŸ©å½¢ï¼ˆé˜²æ­¢åœ¨ jpg ä¸­é€æ˜èƒŒæ™¯ä¼šè¢«æŸ“æˆé»‘è‰²ï¼‰</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            x<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            y<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            width<span class=\"token operator\">:</span> contentWidth<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            height<span class=\"token operator\">:</span> contentHeight<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            fill<span class=\"token operator\">:</span> <span class=\"token string\">'white'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// å¼ºåˆ¶ç™½è‰²èƒŒæ™¯</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            listening<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">// é˜²æ­¢å½±å“äº¤äº’</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token comment\">// ç»˜åˆ¶å¯è§èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token keyword\">const</span> rect <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span> <span class=\"token comment\">// è°ƒæ•´ä½ç½®ï¼Œä½¿å†…å®¹å±…ä¸­</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                fill<span class=\"token operator\">:</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                stroke<span class=\"token operator\">:</span> <span class=\"token string\">'#000'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                strokeWidth<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> minX <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> minY <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                text<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                fontSize<span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                fill<span class=\"token operator\">:</span> <span class=\"token string\">'#000'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                width<span class=\"token operator\">:</span> width <span class=\"token operator\">-</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                padding<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>rect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token comment\">// ç»˜åˆ¶å¯è§è¿æ¥çº¿</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        connections<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>fromId<span class=\"token punctuation\">,</span> toId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>fromId<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>toId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>startX<span class=\"token punctuation\">,</span> startY<span class=\"token punctuation\">,</span> endX<span class=\"token punctuation\">,</span> endY<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">calculateConnectionPoints</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                conn</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>            <span class=\"token keyword\">const</span> line <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Shape</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                <span class=\"token function-variable function\">sceneFunc</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> shape<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span>startX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span> startY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è°ƒæ•´ä½ç½®</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'top-to-bottom'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>                        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>                            endX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>                            startY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>                            endX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                            endY <span class=\"token operator\">-</span> minY</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                            startX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                            endY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                            endX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                            endY <span class=\"token operator\">-</span> minY</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillStrokeShape</span><span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>                stroke<span class=\"token operator\">:</span> <span class=\"token string\">'black'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>                strokeWidth<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">batchDraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¼ºåˆ¶ç»˜åˆ¶</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token operator\">:</span> tempStage<span class=\"token punctuation\">,</span> layer<span class=\"token operator\">:</span> tempLayer<span class=\"token punctuation\">,</span> container<span class=\"token operator\">:</span> tempContainer <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ç”Ÿæˆ Stage å¤±è´¥'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºpng\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºpng\">#</a> å¯¼å‡ºä¸º png</h3>\n<p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°é‡ç»˜çš„ <code>stage</code> ï¼Œç›´æ¥ä½¿ç”¨ <code>stage.toDataURL()</code>  å³å¯å¾—åˆ°ä¸€ä¸ª png å›¾ç‰‡çš„ base64 å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡ <code>download</code>  è¿›è¡Œä¸‹è½½ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º png</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsPNG</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// å¯¼å‡ºå›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">const</span> dataUrl <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            mimeType<span class=\"token operator\">:</span> <span class=\"token string\">'image/png'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            pixelRatio<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»ºä¸‹è½½é“¾æ¥</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> dataUrl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        link<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'mindmap.png'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºjpg\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºjpg\">#</a> å¯¼å‡ºä¸º jpg</h3>\n<p><strong>æ³¨æ„</strong>å¦‚æœæ²¡æœ‰ç»™ <code>stage</code>  è®¾ç½®ä¸€ä¸ªèƒŒæ™¯é¢œè‰²ï¼Œé‚£ä¹ˆå¯¼å‡ºçš„å›¾ç‰‡ä¼šå‡ºç°é»‘è‰²èƒŒæ™¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆè®¾ç½®ä¸€ä¸ªç™½è‰²èƒŒæ™¯ã€‚<br />\næˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°é‡ç»˜çš„ <code>stage</code> ï¼Œç›´æ¥ä½¿ç”¨ <code>stage.toDataURL()</code>  å³å¯å¾—åˆ°ä¸€ä¸ª jpg å›¾ç‰‡çš„ base64 å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡ <code>download</code>  è¿›è¡Œä¸‹è½½ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º jpg</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsJPG</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">const</span> dataUrl <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            mimeType<span class=\"token operator\">:</span> <span class=\"token string\">'image/jpeg'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            quality<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å›¾ç‰‡è´¨é‡</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            pixelRatio<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æé«˜åˆ†è¾¨ç‡</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> dataUrl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        link<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'mindmap.jpg'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºpdf\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºpdf\">#</a> å¯¼å‡ºä¸º pdf</h3>\n<p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°é‡ç»˜çš„ <code>stage</code> ï¼Œç„¶åä½¿ç”¨ <code>jspdf</code>  è¿›è¡Œå¯¼å‡ºã€‚<br />\n<strong>æ³¨æ„</strong> å½“ <code>stage</code>  ä¸­çš„å®½åº¦å¤§äºé«˜åº¦æ—¶ï¼Œé‡‡ç”¨æ¨ªå‘å¸ƒå±€å¯¼å‡º pdfï¼Œå½“ <code>stage</code>  ä¸­çš„é«˜åº¦å¤§äºå®½åº¦æ—¶ï¼Œé‡‡ç”¨çºµå‘å¸ƒå±€å¯¼å‡º pdfã€‚<br />\n<strong>è¿™æ˜¯å› ä¸ºåœ¨ pdf ä¸­å†…å®¹çš„å®é™…å®½é«˜æ¯”ä¾‹éœ€è¦ä¸ PDF é¡µé¢çš„æ¯”ä¾‹åŒ¹é…</strong></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º PDF</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsPDF</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ç”Ÿæˆä¸´æ—¶ Stage</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// å¯¼å‡ºå›¾ç‰‡ä¸º Data URL</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> dataUrl <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            mimeType<span class=\"token operator\">:</span> <span class=\"token string\">'image/png'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            pixelRatio<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æé«˜åˆ†è¾¨ç‡</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// è·å– Stage çš„å®½é«˜ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">const</span> stageWidthPx <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">const</span> stageHeightPx <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»º jsPDF å®ä¾‹</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// æ ¹æ®èˆå°çš„å®½é«˜å†³å®šé¡µé¢æ–¹å‘</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// åœ¨ pdf ä¸­å†…å®¹çš„å®é™…å®½é«˜æ¯”ä¾‹éœ€è¦ä¸ PDF é¡µé¢çš„æ¯”ä¾‹åŒ¹é…</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">//pdf é¡µé¢çš„æ–¹å‘å†³å®šäº† pdf çš„å®½é«˜æ¯”</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">let</span> pdf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stageWidthPx <span class=\"token operator\">></span> stageHeightPx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            pdf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">jsPDF</span><span class=\"token punctuation\">(</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>stageWidthPx<span class=\"token punctuation\">,</span> stageHeightPx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¨ªå‘å¸ƒå±€</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            pdf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">jsPDF</span><span class=\"token punctuation\">(</span><span class=\"token string\">'p'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>stageHeightPx<span class=\"token punctuation\">,</span> stageWidthPx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// çºµå‘å¸ƒå±€</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token comment\">// å°†å›¾ç‰‡æ·»åŠ åˆ° PDF ä¸­</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token comment\">// æ³¨æ„ï¼šç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ 'px' ä½œä¸ºå•ä½ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦è¿›è¡Œå•ä½è½¬æ¢</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        pdf<span class=\"token punctuation\">.</span><span class=\"token function\">addImage</span><span class=\"token punctuation\">(</span>dataUrl<span class=\"token punctuation\">,</span> <span class=\"token string\">'PNG'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> stageWidthPx<span class=\"token punctuation\">,</span> stageHeightPx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\">// ä¸‹è½½ PDF æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        pdf<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mindmap.pdf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºsvg\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºsvg\">#</a> å¯¼å‡ºä¸º svg</h3>\n<p><strong>svg æ˜¯ä¸€ç§ç”¨äºæè¿°äºŒç»´å›¾å½¢çš„æ ‡è®°è¯­è¨€ï¼Œå®ƒä½¿ç”¨ XML æ ¼å¼æ¥å®šä¹‰å›¾å½¢çš„å½¢çŠ¶ã€é¢œè‰²ã€å¤§å°ç­‰å±æ€§ã€‚</strong><br />\nè¿™ä¸ªæˆ‘ç›®å‰è¿˜ä¸èƒ½å®ç°æ‰‹åŠ¨å¯¼å‡º<br />\nè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>react-konva-to-svg</code>  åº“ï¼Œè¿™ä¸ªåº“å¯ä»¥å°† <code>Konva</code>  çš„ <code>Stage</code>  å¯¼å‡ºä¸º <code>svg</code> ã€‚<br />\nç›´æ¥ä½¿ç”¨ <code>exportStageSVG</code>  å°±å¯ä»¥å°† <code>Stage</code>  å¯¼å‡ºä¸º <code>svg</code> ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º SVG</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsSVG</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ç”Ÿæˆä¸´æ—¶ Stage</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// ä½¿ç”¨ react-konva-to-svg å¯¼å‡º SVG</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> svgContent <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">exportStageSVG</span><span class=\"token punctuation\">(</span>stage<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token function-variable function\">onBefore</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¼€å§‹å¯¼å‡º SVG:'</span><span class=\"token punctuation\">,</span> stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token function-variable function\">onAfter</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SVG å¯¼å‡ºå®Œæˆ:'</span><span class=\"token punctuation\">,</span> stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»º Blob å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>svgContent<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'image/svg+xml'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// ä¸‹è½½ SVG æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.svg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¯¼å‡º SVG æ—¶å‡ºé”™:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<p>ğŸ¾è‡³æ­¤ï¼Œæ€ç»´å¯¼å›¾å¯ä»¥æ”¯æŒå¯¼å‡ºå¤šç§æ ¼å¼</p>\n",
            "tags": [
                "canvas",
                "React",
                "konva.js"
            ]
        },
        {
            "id": "https://aynya.github.io/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E5%A6%82%E4%BD%95%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5xmind%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6/",
            "url": "https://aynya.github.io/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E5%A6%82%E4%BD%95%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5xmind%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6/",
            "title": "æ€ç»´å¯¼å›¾å¦‚ä½•å¯¼å‡ºå¯¼å…¥xmindæ ¼å¼æ–‡ä»¶",
            "date_published": "2025-04-16T13:14:40.000Z",
            "content_html": "<h1 id=\"å¦‚ä½•å°†æ€ç»´å¯¼å›¾å¯¼å‡ºå¯¼å…¥ä¸ºxmindæ–‡ä»¶\"><a class=\"anchor\" href=\"#å¦‚ä½•å°†æ€ç»´å¯¼å›¾å¯¼å‡ºå¯¼å…¥ä¸ºxmindæ–‡ä»¶\">#</a> ğŸ“å¦‚ä½•å°†æ€ç»´å¯¼å›¾å¯¼å‡ºå¯¼å…¥ä¸º XMind æ–‡ä»¶</h1>\n<p><code>Xmind</code>  æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <code>ZIP</code>  å‹ç¼©åŒ…ã€‚å…¶ä¸­åŒ…å«äº†å¤šä¸ª JSON æ–‡ä»¶ (å¦‚ <code>content.json</code> ï¼Œ  <code>metadata.json</code>  ç­‰)ï¼Œè¿™äº›æ–‡ä»¶æè¿°äº†æ€ç»´å¯¼å›¾çš„å†…å®¹å’Œç»“æ„</p>\n<h2 id=\"1-ï¸-å‡†å¤‡å·¥ä½œ\"><a class=\"anchor\" href=\"#1-ï¸-å‡†å¤‡å·¥ä½œ\">#</a> 1. ğŸ› ï¸ å‡†å¤‡å·¥ä½œ</h2>\n<ul>\n<li><strong>JSZip</strong>: ç”¨äºåˆ›å»º ZIP æ–‡ä»¶ã€‚å…è®¸æˆ‘ä»¬è½»æ¾åˆ›å»ºç¬¦åˆ XMind è§„èŒƒçš„ ZIP æ–‡ä»¶</li>\n<li><strong>file-saver</strong>: ç”¨äºä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶ã€‚è¿™ä¸ªåº“ç®€åŒ–äº†æµè§ˆå™¨ç¯å¢ƒä¸‹çš„æ–‡ä»¶ä¸‹è½½è¿‡ç¨‹ã€‚</li>\n</ul>\n<h2 id=\"2-å®šä¹‰æ•°æ®ç»“æ„\"><a class=\"anchor\" href=\"#2-å®šä¹‰æ•°æ®ç»“æ„\">#</a> 2. ğŸ” å®šä¹‰æ•°æ®ç»“æ„</h2>\n<h3 id=\"nodeæ¥å£\"><a class=\"anchor\" href=\"#nodeæ¥å£\">#</a>  <code>Node</code>  æ¥å£</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹ ID</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹æ–‡æœ¬</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹ä½ç½®</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–¹å‘å±æ€§</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ¸…æ™°çš„è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹åŠå…¶å…³ç³»</p>\n<h3 id=\"topicæ¥å£\"><a class=\"anchor\" href=\"#topicæ¥å£\">#</a>  <code>Topic</code>  æ¥å£</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾ä¸»é¢˜ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Topic</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    structureClass<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      attached<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>Topic</code>  æ˜¯ XMind ä¸­çš„ä¸»ä½“ (èŠ‚ç‚¹) æ¨¡å‹ï¼Œå®ƒä¸ä»…åŒ…å«èŠ‚ç‚¹çš„åŸºæœ¬å±æ€§ï¼Œè¿˜å…è®¸é€’å½’åœ°å®šä¹‰å­èŠ‚ç‚¹ã€‚èƒ½å¤Ÿæ„å»ºå¤æ‚çš„æ ‘çŠ¶ç»“æ„</p>\n<h3 id=\"sheetæ¥å£\"><a class=\"anchor\" href=\"#sheetæ¥å£\">#</a>  <code>Sheet</code>  æ¥å£</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾å·¥ä½œè¡¨ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Sheet</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    extensions<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    topicPositioning<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    topicOverlapping<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    coreVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    rootTopic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>Sheet</code>  æ˜¯ XMind ä¸­çš„å·¥ä½œè¡¨æ¨¡å‹ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæ ¹ä¸»é¢˜ï¼Œä»¥åŠå„ç§å±æ€§ï¼Œå¦‚æ ‡é¢˜ã€æ‰©å±•ã€ä¸»é¢˜å®šä½ã€ä¸»é¢˜é‡å ç­‰ã€‚æœ‰åŠ©äºæˆ‘ä»¬ç»„ç»‡æ•´ä¸ªæ€ç»´å¯¼å›¾çš„æ•°æ®ç»“æ„ã€‚</p>\n<h3 id=\"contentjson-metadatajson-manifestjsonç±»å‹\"><a class=\"anchor\" href=\"#contentjson-metadatajson-manifestjsonç±»å‹\">#</a>  <code>ContentJSON</code> ,  <code>MetadataJSON</code> ,  <code>ManifestJSON</code>  ç±»å‹</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰ content.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">type</span> <span class=\"token class-name\">ContentJSON</span> <span class=\"token operator\">=</span> Sheet<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// å®šä¹‰ metadata.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">MetadataJSON</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    modifier<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    dataStructureVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    creator<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    layoutEngineVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    activeSheetId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// å®šä¹‰ manifest.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ManifestJSON</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string-property property\">\"file-entries\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">[</span>filename<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™äº›äº‹ XMind æ–‡ä»¶ä¸­çš„æ ¸å¿ƒ JSON æ–‡ä»¶ï¼Œ <code>ContentJSON</code>  åŒ…å«äº†æ€ç»´å¯¼å›¾çš„æ‰€æœ‰å†…å®¹ï¼› <code>MetadataJSON</code>  æä¾›äº†å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚ç‰ˆæœ¬å·å’Œåˆ›å»ºè€…ï¼› <code>ManifestJSON</code>  æè¿°äº†æ–‡ä»¶æ¸…å•ï¼ŒæŒ‡å®šäº†æ¯ä¸ªæ–‡ä»¶çš„åç§°å’Œåª’ä½“ç±»å‹ã€‚è¿™äº›æ–‡ä»¶å…±åŒæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„ XMind æ–‡ä»¶ã€‚</p>\n<h2 id=\"3-è¾…åŠ©å‡½æ•°\"><a class=\"anchor\" href=\"#3-è¾…åŠ©å‡½æ•°\">#</a> 3. ğŸ§© è¾…åŠ©å‡½æ•°</h2>\n<p>æˆ‘ä»¬å°†ç¼–å†™è¾…åŠ©å‡½æ•°æ¥æ„å»ºæ€ç»´å¯¼å›¾çš„å†…å®¹</p>\n<h3 id=\"buildchildrenå‡½æ•°\"><a class=\"anchor\" href=\"#buildchildrenå‡½æ•°\">#</a>  <code>buildChildren</code>  å‡½æ•°</h3>\n<p>é€’å½’çš„æ„å»ºå­èŠ‚ç‚¹æ ‘çŠ¶ç»“æ„ï¼Œ å°†æ¯ä¸ªèŠ‚ç‚¹è½¬æ¢ä¸º <code>Topic</code>  å¯¹è±¡ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šé€’å½’æ„å»ºå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> buildChildren <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> parentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Processing parentId: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Node with id \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\" not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> childrenIds <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è·å–å½“å‰çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Children IDs for parentId \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\":</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> childrenIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// æ ¹æ®å­èŠ‚ç‚¹ ID æ„å»ºå­èŠ‚ç‚¹åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> childrenIds</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Topic <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">const</span> childNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>childNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Child node with id \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>childId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\" not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                id<span class=\"token operator\">:</span> childNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                structureClass<span class=\"token operator\">:</span> <span class=\"token string\">'org.xmind.ui.logic.right'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                title<span class=\"token operator\">:</span> childNode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                children<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    attached<span class=\"token operator\">:</span> <span class=\"token function\">buildChildren</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">,</span> childNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> topic <span class=\"token keyword\">is</span> Topic <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿‡æ»¤æ‰æ— æ•ˆçš„å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"createcontentjson-å‡½æ•°\"><a class=\"anchor\" href=\"#createcontentjson-å‡½æ•°\">#</a>  <code>createContentJSON</code>  å‡½æ•°</h3>\n<p>ç”¨äºæ„å»º <code>content.json</code>  æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†æ•´ä¸ªæ€ç»´å¯¼å›¾çš„æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½æ­£ç¡®è½¬æ¢æˆ XMind æ ¼å¼</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šæ„å»º content.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> createContentJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ContentJSON <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// æ„å»ºæ ¹èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">const</span> rootTopic<span class=\"token operator\">:</span> Topic <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        id<span class=\"token operator\">:</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        structureClass<span class=\"token operator\">:</span> <span class=\"token string\">'org.xmind.ui.logic.right'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        title<span class=\"token operator\">:</span> rootNode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            attached<span class=\"token operator\">:</span> <span class=\"token function\">buildChildren</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">,</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹é€’å½’</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            id<span class=\"token operator\">:</span> <span class=\"token string\">'simpleMindMap_1744799393059'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token string\">'sheet'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            title<span class=\"token operator\">:</span> <span class=\"token string\">'æ€ç»´å¯¼å›¾æ ‡é¢˜'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            extensions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            topicPositioning<span class=\"token operator\">:</span> <span class=\"token string\">'fixed'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            topicOverlapping<span class=\"token operator\">:</span> <span class=\"token string\">'overlap'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            coreVersion<span class=\"token operator\">:</span> <span class=\"token string\">'2.100.0'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            rootTopic<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"createmetadatajson-å‡½æ•°\"><a class=\"anchor\" href=\"#createmetadatajson-å‡½æ•°\">#</a>  <code>createMetadataJSON</code>  å‡½æ•°</h3>\n<p>ç”¨äºæ„å»º <code>metadata.json</code>  æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†æ€ç»´å¯¼å›¾çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚ç‰ˆæœ¬å·ã€åˆ›å»ºè€…ç­‰ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šæ„å»º metadata.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> createMetadataJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MetadataJSON <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        modifier<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ä¿®æ”¹è€…ï¼ˆå¯ä¸ºç©ºï¼‰</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        dataStructureVersion<span class=\"token operator\">:</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ•°æ®ç»“æ„ç‰ˆæœ¬</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        creator<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            name<span class=\"token operator\">:</span> <span class=\"token string\">'mind-map'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// åˆ›å»ºè€…åç§°</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        layoutEngineVersion<span class=\"token operator\">:</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¸ƒå±€å¼•æ“ç‰ˆæœ¬</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        activeSheetId<span class=\"token operator\">:</span> <span class=\"token string\">'simpleMindMap_1744799393059'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å½“å‰æ´»åŠ¨çš„å·¥ä½œè¡¨ ID</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"createmanifestjson-å‡½æ•°\"><a class=\"anchor\" href=\"#createmanifestjson-å‡½æ•°\">#</a>  <code>createManifestJSON</code>  å‡½æ•°</h3>\n<p>ç”¨äºæ„å»º <code>manifest.json</code>  æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æè¿°äº†æ–‡ä»¶æ¸…å•ï¼ŒæŒ‡å®šäº†æ¯ä¸ªæ–‡ä»¶çš„åç§°å’Œåª’ä½“ç±»å‹ã€‚è¿™å¯¹è§£å‹å’Œè§£æ XMind æ–‡ä»¶å¾ˆé‡è¦ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šæ„å»º manifest.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> createManifestJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ManifestJSON <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string-property property\">\"file-entries\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token string-property property\">\"content.json\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//content.json çš„åª’ä½“ç±»å‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token string-property property\">\"metadata.json\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//metadata.json çš„åª’ä½“ç±»å‹</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token string-property property\">\"manifest.json\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//manifest.json çš„åª’ä½“ç±»å‹</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"4-å¯¼å‡ºxmindæ–‡ä»¶\"><a class=\"anchor\" href=\"#4-å¯¼å‡ºxmindæ–‡ä»¶\">#</a> 4. ğŸš€ å¯¼å‡º XMind æ–‡ä»¶</h2>\n<p>æœ€åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›å†…å®¹æ‰“åŒ…æˆ <code>.xmind</code>  æ–‡ä»¶ä¸‹è½½ã€‚<br />\né€šè¿‡ <code>JSZip</code>  åº“ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤šä¸ª JSON æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª ZIP æ–‡ä»¶ã€‚æ¨¡æ‹Ÿ XMind æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ã€‚ç”Ÿæˆçš„æ–‡ä»¶å¯ä»¥ç›´æ¥è¢« XMind åº”ç”¨ç¨‹åºæ‰“å¼€ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å¯¼å‡ºä¸º XMind æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> exportAsXMind <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// è·å–èŠ‚ç‚¹æ•°æ®</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// æ£€æŸ¥ nodes æ˜¯å¦ä¸ºç©º</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nodes <span class=\"token operator\">||</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰èŠ‚ç‚¹å¯ä»¥å¯¼å‡º'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// æ„å»º content.json</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> contentJson<span class=\"token operator\">:</span> ContentJSON <span class=\"token operator\">=</span> <span class=\"token function\">createContentJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// æ„å»º metadata.json</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> metadataJson<span class=\"token operator\">:</span> MetadataJSON <span class=\"token operator\">=</span> <span class=\"token function\">createMetadataJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// æ„å»º manifest.json</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">const</span> manifestJson<span class=\"token operator\">:</span> ManifestJSON <span class=\"token operator\">=</span> <span class=\"token function\">createManifestJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// ä½¿ç”¨ JSZip æ‰“åŒ…</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">const</span> zip <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSZip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'content.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>contentJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'metadata.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>metadataJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'manifest.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>manifestJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// ç”Ÿæˆå¹¶ä¸‹è½½æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">generateAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'blob'</span><span class=\"token punctuation\">,</span> compression<span class=\"token operator\">:</span> <span class=\"token string\">'DEFLATE'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.xmind'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¯¼å‡ºå¤±è´¥:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> ğŸ‰</h3>\n<p><strong>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†æ€ç»´å¯¼å›¾æ•°æ®å¯¼å‡ºä¸º XMind æ ¼å¼çš„æ–‡ä»¶ã€‚</strong></p>\n<hr />\n<h3 id=\"æ›´æ–°2025-4-17\"><a class=\"anchor\" href=\"#æ›´æ–°2025-4-17\">#</a> âœ¨æ›´æ–°ï¼š2025-4-17</h3>\n<p>æ›´æ–°å†…å®¹ï¼š</p>\n<ul>\n<li>æ·»åŠ äº†å¯¼å…¥ xmind æ ¼å¼æ–‡ä»¶çš„åŠŸèƒ½ã€‚</li>\n</ul>\n<h4 id=\"1-æ•°æ®ç»“æ„å®šä¹‰\"><a class=\"anchor\" href=\"#1-æ•°æ®ç»“æ„å®šä¹‰\">#</a> 1. æ•°æ®ç»“æ„å®šä¹‰</h4>\n<p>è¿™é‡Œå’Œä¹‹å‰ç±»ä¼¼</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾ä¸»é¢˜ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">Topic</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    structureClass<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹ä½ç½®</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        attached<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾å·¥ä½œè¡¨ç±»å‹</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">Sheet</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    extensions<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    topicPositioning<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    topicOverlapping<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    coreVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    rootTopic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// å®šä¹‰ content.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">ContentJSON</span> <span class=\"token operator\">=</span> Sheet<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// å®šä¹‰è§£æåçš„æ•°æ®ç»“æ„</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">ParsedData</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹è®°å½•</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿æ¥å…³ç³»åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"2-é€’å½’è§£æå­èŠ‚ç‚¹å‡½æ•°\"><a class=\"anchor\" href=\"#2-é€’å½’è§£æå­èŠ‚ç‚¹å‡½æ•°\">#</a> 2. é€’å½’è§£æå­èŠ‚ç‚¹å‡½æ•°</h4>\n<p>é€šè¿‡é€’å½’çš„æ–¹å¼è§£æå­èŠ‚ç‚¹ï¼Œå¹¶æ„å»ºèŠ‚ç‚¹è®°å½•å’Œè¿æ¥å…³ç³»åˆ—è¡¨ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šé€’å½’è§£æå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> parseChildren <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>topic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">,</span> parentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> parsedData<span class=\"token operator\">:</span> ParsedData<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> collapsed<span class=\"token punctuation\">,</span> children <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> topic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºå½“å‰èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> node<span class=\"token operator\">:</span> Node <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        text<span class=\"token operator\">:</span> title<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        position<span class=\"token operator\">:</span> position <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›ä½ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        size<span class=\"token operator\">:</span> size <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›å°ºå¯¸ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        collapsed<span class=\"token operator\">:</span> collapsed <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›æŠ˜å çŠ¶æ€ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        direction<span class=\"token operator\">:</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ–¹å‘å±æ€§æ˜¯å¯é€‰çš„</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ åˆ°èŠ‚ç‚¹è®°å½•</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å»ºç«‹è¿æ¥</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>children<span class=\"token operator\">?.</span>attached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        children<span class=\"token punctuation\">.</span>attached<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childTopic<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token function\">parseChildren</span><span class=\"token punctuation\">(</span>childTopic<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"3-è§£æxmindæ–‡ä»¶å‡½æ•°\"><a class=\"anchor\" href=\"#3-è§£æxmindæ–‡ä»¶å‡½æ•°\">#</a> 3. è§£æ XMind æ–‡ä»¶å‡½æ•°</h4>\n<p>è¯»å…¥æ–‡ä»¶è¿”å›ä¸€ä¸ª Promiseï¼Œè§£ææ–‡ä»¶å†…å®¹å¹¶è¿”å›è§£æåçš„æ•°æ®ã€‚<br />\nç”±äº XMind æ–‡ä»¶æ˜¯ä¸€ä¸ª ZIP æ ¼å¼çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ JSZip åº“æ¥è§£æã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å¯¼å…¥ xmind æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromXMind <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">const</span> zip <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSZip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>unzipped<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token comment\">// è¯»å– content.json</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">return</span> unzipped<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'content.json'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">async</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>contentJsonText<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>contentJsonText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing content.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token comment\">// è§£æ content.json</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">const</span> contentJson<span class=\"token operator\">:</span> ContentJSON <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>contentJsonText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token comment\">// åˆå§‹åŒ–è§£ææ•°æ®</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">const</span> parsedData<span class=\"token operator\">:</span> ParsedData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    connections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token comment\">// è§£ææ ¹èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token keyword\">const</span> rootSheet <span class=\"token operator\">=</span> contentJson<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootSheet <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>rootSheet<span class=\"token punctuation\">.</span>rootTopic<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid content.json structure'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token function\">parseChildren</span><span class=\"token punctuation\">(</span>rootSheet<span class=\"token punctuation\">.</span>rootTopic<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–° store çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    connections<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä» metadata.json è·å–</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Failed to import XMind file: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h3 id=\"-2\"><a class=\"anchor\" href=\"#-2\">#</a> ğŸ˜˜</h3>\n<p>ç°åœ¨ä¸ä»…å¯ä»¥å¯¼å‡ºä¸º Xmind æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å¯¼å…¥ Xmind æ–‡ä»¶äº†ï¼Œè™½ç„¶å¯¼å…¥åªé™äºæœ¬æ€ç»´å¯¼å›¾çš„å¯¼å‡ºçš„å¯¼å…¥ï¼Œä½†æ˜¯å¯¼å‡ºçš„æ˜¯å¯ä»¥é€‚é… Xmind çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¼å…¥åˆ° Xmind ä¸­ã€‚</p>\n",
            "tags": [
                "canvas",
                "React",
                "xmind",
                "TypeScript"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E5%AE%9E%E7%8E%B0%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E4%BC%98%E9%9B%85%E8%BF%9E%E7%BA%BF/",
            "url": "https://aynya.github.io/%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E5%AE%9E%E7%8E%B0%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E4%BC%98%E9%9B%85%E8%BF%9E%E7%BA%BF/",
            "title": "è´å¡å°”æ›²çº¿å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿",
            "date_published": "2025-04-11T08:58:11.000Z",
            "content_html": "<h1 id=\"æ„é€ äºŒæ¬¡è´å¡å°”æ›²çº¿è½»æ¾å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿\"><a class=\"anchor\" href=\"#æ„é€ äºŒæ¬¡è´å¡å°”æ›²çº¿è½»æ¾å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿\">#</a> ğŸ“ æ„é€ äºŒæ¬¡è´å¡å°”æ›²çº¿ï¼šè½»æ¾å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿</h1>\n<p>åœ¨å¼€å‘æ€ç»´å¯¼å›¾æˆ–æ ‘çŠ¶ç»“æ„åº”ç”¨æ—¶ï¼Œå¦‚ä½•ä¼˜é›…åœ°è¿æ¥èŠ‚ç‚¹å¹¶ç»˜åˆ¶å¹³æ»‘çš„çº¿æ¡</p>\n<hr />\n<h2 id=\"è´å¡å°”æ›²çº¿ç®€ä»‹\"><a class=\"anchor\" href=\"#è´å¡å°”æ›²çº¿ç®€ä»‹\">#</a> âœ¨ è´å¡å°”æ›²çº¿ç®€ä»‹</h2>\n<p>è´å¡å°”æ›²çº¿æ˜¯ä¸€ç§ç”¨äºç”Ÿæˆå¹³æ»‘æ›²çº¿çš„æ•°å­¦å·¥å…· ã€‚å®ƒå¹¿æ³›åº”ç”¨äºå›¾å½¢è®¾è®¡ã€åŠ¨ç”»ã€UI å¼€å‘ç­‰é¢†åŸŸã€‚è´å¡å°”æ›²çº¿çš„ç‰¹ç‚¹æ˜¯å¯ä»¥é€šè¿‡æ§åˆ¶ç‚¹æ¥è°ƒæ•´æ›²çº¿çš„å½¢çŠ¶ï¼Œä»è€Œç”Ÿæˆå„ç§å¹³æ»‘çš„è·¯å¾„ã€‚<br />\nå¤šä¸ªè´å¡å°”æ›²çº¿çš„ç»„åˆå¯ä»¥ç”Ÿæˆå„ç§å¤æ‚çš„æ›²çº¿ï¼Œå¦‚åœ†å¼§ã€æ›²çº¿ã€è´å¡å°”æ›²çº¿ç­‰ã€‚<br />\nä¸€æ¬¡è´å¡å°”æ›²çº¿çš„å…¬å¼æ˜¯ï¼š <code>B(t) = (1 - t) * Pâ‚€ + t * Pâ‚</code></p>\n<h2 id=\"äºŒæ¬¡è´å¡å°”æ›²çº¿\"><a class=\"anchor\" href=\"#äºŒæ¬¡è´å¡å°”æ›²çº¿\">#</a> äºŒæ¬¡è´å¡å°”æ›²çº¿</h2>\n<p>äºŒæ¬¡è´å¡å°”æ›²çº¿æ˜¯æœ€ç®€å•çš„è´å¡å°”æ›²çº¿ç±»å‹ä¹‹ä¸€ï¼Œå®ƒç”±ä»¥ä¸‹ä¸‰ä¸ªç‚¹å®šä¹‰ï¼š</p>\n<ul>\n<li><strong>èµ·ç‚¹ (Pâ‚€)</strong>ï¼šæ›²çº¿çš„èµ·å§‹ç‚¹ã€‚</li>\n<li><strong>æ§åˆ¶ç‚¹ (Pâ‚)</strong>ï¼šå†³å®šæ›²çº¿çš„å¼¯æ›²æ–¹å‘å’Œç¨‹åº¦ã€‚</li>\n<li><strong>ç»ˆç‚¹ (Pâ‚‚)</strong>ï¼šæ›²çº¿çš„ç»“æŸç‚¹ã€‚<br />\né€šè¿‡è¿™ä¸‰ä¸ªç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€æ¡å¹³æ»‘çš„æ›²çº¿ã€‚å…¶å…¬å¼å¦‚ä¸‹ï¼š<br />\n <code>B(t) = (1 - t) ^ 2 * Pâ‚€ + 2 * t * (1 - t) * Pâ‚ + t ^ 2 * Pâ‚‚</code>  t âˆˆ [0, 1]</li>\n</ul>\n<h3 id=\"ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿è¿æ¥èŠ‚ç‚¹\"><a class=\"anchor\" href=\"#ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿è¿æ¥èŠ‚ç‚¹\">#</a> ğŸ›  ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿è¿æ¥èŠ‚ç‚¹</h3>\n<p>è¿™é‡Œé‡‡ç”¨ <code>react-konva</code>  ä¸­çš„ <code>Shape</code>  ç»„ä»¶æ¥ç»˜åˆ¶äºŒæ¬¡è´å¡å°”æ›²çº¿ã€‚ <code>Shape</code>  æä¾›äº†ä¸€ä¸ª <code>sceneFunc</code>  å±æ€§ï¼Œå…è®¸æˆ‘ä»¬ç›´æ¥æ“ä½œ Canvas ä¸Šä¸‹æ–‡</p>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Shape</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token attr-name\">sceneFunc</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> shape<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span>startX<span class=\"token punctuation\">,</span> startY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç§»åŠ¨åˆ°èµ·ç‚¹</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            startX<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// æ§åˆ¶ç‚¹ X åæ ‡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            endY<span class=\"token punctuation\">,</span>     <span class=\"token comment\">// æ§åˆ¶ç‚¹ Y åæ ‡</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            endX<span class=\"token punctuation\">,</span>     <span class=\"token comment\">// ç»ˆç‚¹ X åæ ‡</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            endY      <span class=\"token comment\">// ç»ˆç‚¹ Y åæ ‡</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillStrokeShape</span><span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åº”ç”¨å¡«å……å’Œæè¾¹</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token attr-name\">stroke</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>blue<span class=\"token punctuation\">\"</span></span>       <span class=\"token comment\">// çº¿æ¡é¢œè‰²</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token attr-name\">strokeWidth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span></span>     <span class=\"token comment\">// çº¿æ¡å®½åº¦</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">/></span></span></pre></td></tr></table></figure><h2 id=\"å‚è€ƒèµ„æ–™å¤šæ¬¡ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä¸‹\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™å¤šæ¬¡ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä¸‹\">#</a> ğŸ“š å‚è€ƒèµ„æ–™ (å¤šæ¬¡ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä¸‹)</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rb252YWpzLm9yZy9kb2NzL3NhbmRib3gvTW9kaWZ5X0N1cnZlc193aXRoX0FuY2hvcl9Qb2ludHMuaHRtbA==\">konva å®˜æ–¹æ–‡æ¡£</span></li>\n</ul>\n",
            "tags": [
                "canvas",
                "konva",
                "è´å¡å°”æ›²çº¿"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%80%83%E8%99%91%E5%B0%BA%E5%AF%B8%E7%9A%84%E5%A4%9A%E5%8F%89%E6%A0%91%E5%88%86%E5%B1%82%E9%80%92%E5%BD%92%E5%B8%83%E5%B1%80%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/",
            "url": "https://aynya.github.io/%E8%80%83%E8%99%91%E5%B0%BA%E5%AF%B8%E7%9A%84%E5%A4%9A%E5%8F%89%E6%A0%91%E5%88%86%E5%B1%82%E9%80%92%E5%BD%92%E5%B8%83%E5%B1%80%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/",
            "title": "è€ƒè™‘å°ºå¯¸çš„å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£",
            "date_published": "2025-04-11T07:57:44.000Z",
            "content_html": "<h1 id=\"å¸¦å°ºå¯¸å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£\"><a class=\"anchor\" href=\"#å¸¦å°ºå¯¸å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£\">#</a> ğŸŒ³ å¸¦å°ºå¯¸å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£</h1>\n<p><strong>è¿™é‡Œä¸»è¦åº”ç”¨ä¸æ€ç»´å¯¼å›¾ï¼Œæ ‘çš„æ–¹å‘æ˜¯ä»å·¦åˆ°å³</strong><br />\nè®©ä½ çš„æ ‘å½¢ç»“æ„ã€Œä¸¥ä¸åˆç¼ã€ï¼âœ¨ æœ¬ç®—æ³•å¯å®ç°ï¼š<br />\nâœ… çˆ¶èŠ‚ç‚¹å‚ç›´å±…ä¸­äºå­èŠ‚ç‚¹åŒºåŸŸ<br />\nâœ… å­èŠ‚ç‚¹å³ä¾§ç«–ç›´æ’åˆ—ä¸é‡å <br />\nâœ… æ”¯æŒåŠ¨æ€å°ºå¯¸å’ŒæŠ˜å çŠ¶æ€<br />\nâœ… O (n) æ—¶é—´å¤æ‚åº¦</p>\n<hr />\n<h2 id=\"æ ¸å¿ƒæ€æƒ³\"><a class=\"anchor\" href=\"#æ ¸å¿ƒæ€æƒ³\">#</a> ğŸ§© æ ¸å¿ƒæ€æƒ³</h2>\n<p>åˆ†ä¸º<strong>ä¸¤é˜¶æ®µ</strong></p>\n<ol>\n<li><strong>ğŸ“ é¢„è®¡ç®—é˜¶æ®µ</strong>ï¼šè‡ªåº•å‘ä¸Šç»Ÿè®¡å­æ ‘å°ºå¯¸</li>\n<li><strong>ğŸ¯ å®šä½é˜¶æ®µ</strong>ï¼šè‡ªé¡¶å‘ä¸‹é€’å½’å¸ƒå±€</li>\n</ol>\n<hr />\n<h2 id=\"ï¸-å®ç°\"><a class=\"anchor\" href=\"#ï¸-å®ç°\">#</a> ğŸ› ï¸ å®ç°</h2>\n<h3 id=\"1-æ•°æ®ç»“æ„å®šä¹‰\"><a class=\"anchor\" href=\"#1-æ•°æ®ç»“æ„å®šä¹‰\">#</a> 1. ğŸ“¦ æ•°æ®ç»“æ„å®šä¹‰</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// èŠ‚ç‚¹ä¸­å¿ƒåæ ‡</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// [å®½åº¦ï¼Œé«˜åº¦]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"2-ï¸-é…ç½®å‚æ•°\"><a class=\"anchor\" href=\"#2-ï¸-é…ç½®å‚æ•°\">#</a> 2. âš™ï¸ é…ç½®å‚æ•°</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">CONFIG</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  horizontalSpacing<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">//  çˆ¶å­æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  verticalSpacing<span class=\"token operator\">:</span> <span class=\"token number\">30</span>     <span class=\"token comment\">//  å…„å¼Ÿå‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"3-é¢„è®¡ç®—å­æ ‘å°ºå¯¸\"><a class=\"anchor\" href=\"#3-é¢„è®¡ç®—å­æ ‘å°ºå¯¸\">#</a> 3. ğŸ“ é¢„è®¡ç®—å­æ ‘å°ºå¯¸</h3>\n<p>é€šè¿‡é€’å½’çš„æ–¹å¼ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹å­æ ‘çš„å°ºå¯¸ (åŒ…æ‹¬è‡ªèº«)<br />\n<strong> ç®—æ³•åŸç†</strong></p>\n<ul>\n<li><strong>è‡ªåº•å‘ä¸Šé€’å½’</strong>ï¼šä»å¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œé€æ­¥å‘ä¸Šè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘å°ºå¯¸ã€‚</li>\n<li><strong>è€ƒè™‘æŠ˜å çŠ¶æ€</strong>ï¼šå¦‚æœèŠ‚ç‚¹è¢«æŠ˜å ï¼Œå®ƒçš„å­èŠ‚ç‚¹å°†ä¸å‚ä¸å¸ƒå±€ï¼Œç›´æ¥è¿”å›èŠ‚ç‚¹è‡ªèº«çš„å°ºå¯¸ã€‚</li>\n<li><strong>åˆå¹¶å­èŠ‚ç‚¹å°ºå¯¸</strong>ï¼šå¯¹äºéå¶å­èŠ‚ç‚¹ï¼Œéœ€è¦è®¡ç®—å…¶æ‰€æœ‰å­èŠ‚ç‚¹çš„é«˜åº¦æ€»å’Œ (å¹¶ä¸è‡ªèº«é«˜åº¦å–æœ€å¤§å€¼)ï¼Œå¹¶æ‰¾å‡ºæœ€å¤§å­èŠ‚ç‚¹çš„å®½åº¦ã€‚</li>\n</ul>\n<p>å›¾è§£è¿æ¥ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly92aWV3ZXIuZGlhZ3JhbXMubmV0Lz90YWdzPSU3QiU3RCZhbXA7bGlnaHRib3g9MSZhbXA7aGlnaGxpZ2h0PTAwMDBmZiZhbXA7ZWRpdD1fYmxhbmsmYW1wO2xheWVycz0xJmFtcDtuYXY9MSZhbXA7dGl0bGU9JUU2JTlDJUFBJUU1JTkxJUJEJUU1JTkwJThEJUU3JUJCJTk4JUU1JTlCJUJFLmRyYXdpbyZhbXA7ZGFyaz1hdXRvI1IlM0NteGZpbGUlM0UlM0NkaWFncmFtJTIwbmFtZSUzRCUyMiVFNyVBQyVBQyUyMDElMjAlRTklQTElQjUlMjIlMjBpZCUzRCUyMkk0S0VmanRHV1IxX1E0cjZZUmNPJTIyJTNFN1poZGI1c3dGSVolMkZqUzhiWWZQcHk1RFFkbHJYVGFxbVNiMWo0SUpYQnpQSGFaTDklMkJwbGdFcjdhWkJxMHk3YXIySzhQWUo3WDUyQUhtTFBGNWtxRWVmcUJ4NFFCWk1RYllNNEJRaEJCUyUyRjBVeXJaVVhOc29oVVRRV0FjZGhEdjZnMml4Q2x2Um1Dd2JnWkp6Sm1uZUZDT2VaU1NTRFMwVWdxJTJCYllRJTJCY05aJTJCYWh3bnBDSGRSeUxycUZ4ckx0RlE5NUI3MGEwS1R0SG95ZEhBNXNnaXJZUDBteXpTTSUyQmJvbW1RRXdaNEp6V2JZV214bGhCYnlLUzNuZDVUT2olMkI0a0prc2xUTHZDdjUyTDJIdWVYQ1dMM241ZTNVZkp4ZGFIdjhoU3lsWDVoUFZtNXJRZ0l2c3BpVXR6RUFLYSUyRlRxa2tkM2tZRmFOcjViblNVcmxncWdkVnN6dXA2Z2xFU0xLcFNYcVNWNFF2aUJSYkZWS05ZZzFNcnhqbzZ2NjZ4bDlMYVEyOW83VlFPNTdzNzN5QW9ocWF5eTh3UW44ZUk5TnFNdks2aUNBYWlkRzN4JTJCQW0lMkJmeVVmT2UzOXh2bjVwM0pieDlIV2tjZElEM1lUbWEwZiUyRmszZ3pUMFFucWdqTTA0NDBMMU01NlJZYmkxODY5bmJTRzNCeHV5eHVKbUhlZW1pbXRlTktPVllGdGZoTkVqa2NjQkhtanZjREthWCUyQnMyQzc4Uzlva3ZxYVE4VTVvbzM5TXZ5RkwxZGJocGpTOW9IQmR6OFVOR2swSmc1S0VlUDlYeVBrNXdHZXByY1dIMXN2enlHUk43R0JjUnRwdXJ2JTJCclhiZXh4MFIzTFJMdHJZdUFBM3dDJTJCQlFJYiUyQkJqNEpnZ3d3TzVPOFlEdkFqenZHSzJJeUthSkZmRklrU0hpSmVaOXE2R1pjRU9BZDV2ZzkyV29CdDdwQVclMkJPQmQ3NXU3Tm5qT1N4bk5ZV3BNZkR2dVFaelVPM0ozbHNnQVBncVliS0UzJTJCWE0lMkJlZlBKWjNIUHlySm8lMkYzajRMZkUzMHI4UGglMkYxZnJkcXRYbjRhdFdyZW9NUDdhSmJlTmFQaHoxclczMFM4WmQ0TUgyQ2RiRTlGcUdvWWtOTzU1QkEwNlEzZlVOdWVhazJtd003MTNQaVU1VnZ1a2NLQUJxNHpZMUFJWTdKUUQlMkJmTGVEbTRLcGMzNlZUMjJNSndacyUyQkdDaE55NSUyQjhJU1Q0dGtsRHZTRyUyQmxZNVJ3JTJCb3o2Yk1hR2RVYUo2VUx4aE1mWUM5TTg0WDJ6bWdyWFpwWHZkc09WQyUyQnFPN2hIOUxkV08xJTJGWmpQNENRJTNEJTNEJTNDJTJGZGlhZ3JhbSUzRSUzQyUyRm14ZmlsZSUzRQ==\">è®¡ç®—å°ºå¯¸</span></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹ ID</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„ä¸€ä¸ªæ˜ å°„</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @returns å½“å‰èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ &#123;width: number, height: number&#125;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€æˆ–å¶å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// é€’å½’è®¡ç®—å­èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">let</span> totalChildHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">let</span> maxChildWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    totalChildHeight <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    maxChildWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxChildWidth<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆåŒ…å«é—´è·ï¼‰</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> totalChildHeight <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹å®½åº¦ = è‡ªèº«å®½åº¦ + æœ€å¤§å­èŠ‚ç‚¹å®½åº¦ + æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> maxChildWidth <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆå–è‡ªèº«é«˜åº¦å’Œå­æ ‘é«˜åº¦ä¸­çš„è¾ƒå¤§å€¼ï¼‰</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">const</span> totalHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subtreeHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"4-èŠ‚ç‚¹æ ‘å¸ƒå±€\"><a class=\"anchor\" href=\"#4-èŠ‚ç‚¹æ ‘å¸ƒå±€\">#</a> 4. ğŸ“ˆ èŠ‚ç‚¹æ ‘å¸ƒå±€</h3>\n<p>æ ¹æ®è®¡ç®—å‡ºçš„å­æ ‘å°ºå¯¸ï¼Œé€’å½’åœ°è®¾ç½®æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½®<br />\n<strong>ç®—æ³•åŸç†</strong>ï¼š</p>\n<ul>\n<li><strong>è‡ªé¡¶å‘ä¸‹é€’å½’</strong>ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œæ ¹æ®çˆ¶èŠ‚ç‚¹çš„ä½ç½®å’Œå­æ ‘å°ºå¯¸ï¼Œç¡®å®šæ¯ä¸ªå­èŠ‚ç‚¹çš„ä½ç½®ã€‚</li>\n<li><strong>å‚ç›´å±…ä¸­å¯¹é½</strong>ï¼šä¸ºäº†ä¿æŒè§†è§‰ä¸Šçš„å¹³è¡¡ï¼Œå­èŠ‚ç‚¹ç›¸å¯¹äºçˆ¶èŠ‚ç‚¹å‚ç›´å±…ä¸­å¯¹é½ã€‚</li>\n<li><strong>å¿½ç•¥æŠ˜å èŠ‚ç‚¹</strong>ï¼šå¦‚æœæŸä¸ªèŠ‚ç‚¹è¢«æŠ˜å ï¼Œåˆ™ä¸å¤„ç†å…¶å­èŠ‚ç‚¹ã€‚</li>\n</ul>\n<p>å…„å¼ŸèŠ‚ç‚¹éœ€è¦ç´¯åŠ å‚ç›´ä½ç§»æ‰ä¿è¯ä¸ä¼šé‡å <br />\nå¹¶ä¸”æ³¨æ„çˆ¶èŠ‚ç‚¹æ˜¯æ›´å…·èŠ‚ç‚¹æ ‘çš„é«˜åº¦æ¥ç¡®å®šå‚ç›´ä½ç½®çš„åç§»é‡ï¼Œè€Œå­èŠ‚ç‚¹åˆ™æ˜¯æ ¹æ®è‡ªèº«é«˜åº¦æ¥ç¡®å®šå‚ç›´ä½ç½®çš„åç§»é‡ã€‚</p>\n<p>å›¾è§£ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly92aWV3ZXIuZGlhZ3JhbXMubmV0Lz90YWdzPSU3QiU3RCZhbXA7bGlnaHRib3g9MSZhbXA7aGlnaGxpZ2h0PTAwMDBmZiZhbXA7ZWRpdD1fYmxhbmsmYW1wO2xheWVycz0xJmFtcDtuYXY9MSZhbXA7dGl0bGU9JUU2JTlDJUFBJUU1JTkxJUJEJUU1JTkwJThEJUU3JUJCJTk4JUU1JTlCJUJFLmRyYXdpbyZhbXA7ZGFyaz1hdXRvI1IlM0NteGZpbGUlM0UlM0NkaWFncmFtJTIwbmFtZSUzRCUyMiVFNyVBQyVBQyUyMDElMjAlRTklQTElQjUlMjIlMjBpZCUzRCUyMkk0S0VmanRHV1IxX1E0cjZZUmNPJTIyJTNFN1psYmI1c3dHSVolMkZqUyUyQkx3TVNBTDBPU3R0TzZybEpWVGVvZEE0ZXdPbkZtbkNiWnI1OEpKZ1J3RHRWQ0RsTjdVJTJGUGhFOCUyRkxhJTJCd3Z3TzZORjNjOG1JNiUyQnNZaFFBTTFvQWV3JTJCZ05DQ1ZrZiUyQnl5TExQT0lpTXclMkZFUElsVXBUTHduUHdoS2xoVW15VVJTU3NWQldOVUpOTnFNR1NUQ1FsRkpSWnd6dWJWYWtOR3E2Tk9nNWcwQXM5aFFKdlJIMGtrUm5uVWcyNFp2eWRKUENwR3RoeWMzeGtIUldYMUpPa29pTmg4STJRUGdOM2pqSW04TkY3MENNM2dGVnp5ZHJkYjdxNG54c2xFSE5MQXYlMkIlMkZ6M2xjOHZZMGhmWDFKSDhQNCUyQiUyQnhHOWZJZTBKbDZZRFZac1N3SWNEYWJSQ1RyeEFTMlB4OGxnanhQZ3pDN081ZWF5OWhJakttOHNtU3hPYWxpQk1JRldXeUUxQ1R2Q0JzVHdaZXlpcnJyS0Y3cWhiRmNkVDNmd0s5Q293M3lSYk5BQ1I2dk95Nlp5SUxDOGdGRThQSVFyZDJ4ZzVFRlc0TDA2MjN3RUwlMkI4eDclMkZaNCUyQnZDZWZoaXM4ZTNsdDZqQmhFTnQ0TWgyZWpja0k3OUpnMFRTbnVNTWk2dkoyeENqc1B0QVA5QlY0TU5kdHJpMXRuUFRTNnUwNndZempoZCUyQmp3STM0allEN0NrdmNKSmslMkJtOUt0UGdKNkZQTEUxRXdpWXl4dlBuOURPeWlmdzZQTlR1ajVNb3l1YmlCelNKc3dBbHc4MzZYUlZlMSUyQk5NQktvdHpxUk84eSUyQmZhYUFqcVdpWmhnT3JCdkJRVTBtTmtHNWJPcUttamdNSCUyQkNid08yQ0FnSSUyQkJiNE1CQnRoZFJUemd1d0QzRzFwTEtLS3FZd0U5bEhBSTM0VmQ5MEpVUFhjRTlnZzMySGZzcG9zY0RYdTdMZmJPJTJGJTJCMmhOaXprdXNod0xGeiUyQlZSU0ZHa1YxYm1wTlVWZmpKZ1R3QUhpeUlJM2pyMHgwJTJGVzV5OFVkbE9LbXh2RThaTXJ6d3pETGd6JTJGWHR1T3ViVHRHVHJtJTJGRjlyMXRTZXN5MWxUWnEySmQ5bDB5M3VEamJURnFha0VEV1EzQkxOTXlJR3FLQmwzYmNGRmJ3bWtPZzNKSjdQYUJuTFRjOEhWTmdLMVZaQUQ4JTJGbXJuMXdWZDUlMkZxV3hOVWUyNjdvZ0t3enI0UFdBWWZNcTNPTjVSM3JJN1p6eWRPbVViWTVxTFhUcm1VZlpCOE11ajdBM2hYYngzTWR3M08yYnV6YzVtbjF0RTdTSEZlM09XbEl5YUtiWlpzbEdUS0pWTEVmMGlCTmszQ2JqMHFPSkdwa29mZFMzT0NDTkZ5S0dDZFUlMkJ1aTkycjBPbGhyaGlTVnk0TFZJZGkwZEJEMXNJRmp0SldVekhoTFZFRzVrb0d0OWRkRCUyQnZrVEFZeUlhZmEwVVhEJTJGOFA0aXFPVFhWUlQxMW9oS1pOU3hPY3hscUslMkJPdGg2UTUwNXdia2xON2R5NGc1WDNBa2VQY2xDNGc1MzNBTHY0Q2t0NTFEN2FhOVphWDVjOSUyQiUyQmNwVyUyRm5ocUQlMkY0QyUzQyUyRmRpYWdyYW0lM0UlM0MlMkZteGZpbGUlM0U=\">å¸ƒå±€</span></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * é€’å½’è®¾ç½®æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½® (å‰åºéå†)</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹çš„ ID</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„éšå°„</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param parentX çˆ¶èŠ‚ç‚¹çš„ X åæ ‡</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param parentY çˆ¶èŠ‚ç‚¹çš„ Y åæ ‡</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> sizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹ä½ç½®ï¼ˆæ ¹æ®è¯¥ç‚¹çš„èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ï¼Œå‚ç›´å±…ä¸­ï¼‰</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePosition</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€ä¸å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­èŠ‚ç‚¹èµ·å§‹ä½ç½®</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> sizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// å­èŠ‚ç‚¹æ°´å¹³ä½ç½®</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">const</span> childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">+</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">// é€’å½’å¸ƒå±€</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">// æ›´æ–°ç´¯ç§¯ Y åæ ‡ï¼ˆåŒ…å«é—´è·ï¼‰</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h2 id=\"ä¼˜åŒ–å»ºè®®\"><a class=\"anchor\" href=\"#ä¼˜åŒ–å»ºè®®\">#</a> âš¡ä¼˜åŒ–å»ºè®®</h2>\n<ul>\n<li>å¦‚æœçˆ¶èŠ‚ç‚¹çš„é«˜åº¦å°±æ˜¯è¯¥èŠ‚ç‚¹æ ‘çš„é«˜åº¦æ—¶ï¼Œå­èŠ‚ç‚¹ä¼šåœ¨çˆ¶èŠ‚ç‚¹ Y åæ ‡çš„å¼€å§‹å¤„å¼€å§‹æ’åˆ— (å¾…è§£å†³)</li>\n<li>ç¼“å­˜å­æ ‘çš„å°ºå¯¸ï¼Œé¿å…é‡å¤è®¡ç®—</li>\n<li>å¢é‡æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼Œå‡å°‘é‡ç»˜æ¬¡æ•°</li>\n</ul>\n<h2 id=\"é€‚ç”¨åœºæ™¯\"><a class=\"anchor\" href=\"#é€‚ç”¨åœºæ™¯\">#</a> ğŸŒŸ é€‚ç”¨åœºæ™¯</h2>\n<ul>\n<li>æ€ç»´å¯¼å›¾å·¥å…· ğŸ§ </li>\n<li>æ–‡ä»¶ç›®å½•å¯è§†åŒ– ğŸ“‚</li>\n<li>ç»„ç»‡æ¶æ„å›¾ ğŸ‘¥</li>\n</ul>\n<hr />\n<p>ğŸ’¡ å°è´´å£«ï¼šè°ƒæ•´  <code>horizontalSpacing</code>  å’Œ  <code>verticalSpacing</code>  å¯è·å¾—ä¸åŒé£æ ¼çš„å¸ƒå±€æ•ˆæœï¼ğŸ¨</p>\n<hr />\n<p>âœ¨ä¼˜åŒ–æ›´æ–°ï¼š2025-04-13<br />\n ä¼˜åŒ–å†…å®¹ï¼š</p>\n<ul>\n<li>å°†å¸ƒå±€ä»£ç æ”¾åˆ°ä¸»å‡½æ•°ä¸­ï¼Œç”¨ <code>map</code>  å»è®°å½•æ›´æ–°åçš„èŠ‚ç‚¹ä½ç½®ï¼Œå¸ƒå±€ç»“æŸåç»Ÿä¸€æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°ã€‚</li>\n</ul>\n<p>ä¼˜åŒ–åŸå› ï¼š</p>\n<ul>\n<li>åŸæ¥çš„ä»£ç åœ¨å¸ƒå±€çš„æ—¶å€™æ¯æ¬¡ç®—å‡ºçš„ä½ç½®éƒ½ç›´æ¥è°ƒç”¨ <code>setNodePosition</code>  å»æ›´æ–°ï¼Œä¼šå¯¼è‡´ç»„ä»¶é‡æ¸²æŸ“å¤šæ¬¡ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>\n</ul>\n<p><strong>å®æµ‹å¯ä»¥å¤§å¤§å‡å°‘é‡ç»˜æ¬¡æ•°ï¼Œæå‡æ€§èƒ½ã€‚</strong></p>\n<p>ä»£ç ï¼š</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateTreeLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// 1. åˆ›å»ºä¸´æ—¶ä½ç½®å­˜å‚¨å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// 2. æ¸…ç©ºä½ç½®</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// 3. ä¿®æ”¹åçš„å¸ƒå±€å‡½æ•°ï¼ˆä¸å†ç›´æ¥æ›´æ–°çŠ¶æ€ï¼‰</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨åˆ°ä¸´æ—¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token keyword\">const</span> childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">+</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token comment\">// 5. ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä½ç½®</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<p>âœ¨ä¼˜åŒ–æ›´æ–°ï¼š2025-04-16<br />\n æ›´æ–°å†…å®¹ï¼š</p>\n<ul>\n<li>ä½¿ç”¨æ€ç»´å¯¼å›¾çš„æ ‘å¸ƒå±€ç®—æ³•ï¼Œå®ç°äº† <code>right-to-left</code>  &amp;  <code>center</code>  &amp;  <code>top-to-bottom</code>  æ ‘å¸ƒå±€ç»“æ„ï¼Œç°åœ¨ä¸€å…±æœ‰å››ç§æ ‘å¸ƒå±€ç»“æ„</li>\n</ul>\n<p>æ›´æ–°åŸå› ï¼š</p>\n<ul>\n<li>åŸæ¥çš„å¸ƒå±€ç»“æ„å¤ªå•ä¸€</li>\n</ul>\n<p>æ­¥éª¤ï¼š</p>\n<ol>\n<li><strong>çŠ¶æ€ç®¡ç†ä¸­æ·»åŠ å¸ƒå±€ç»“æ„é€‰æ‹©</strong></li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å°ºå¯¸å­—æ®µ [width, height]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// æ–°å¢æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢æ–¹å‘å±æ€§ (åªåœ¨ center å¸ƒå±€ä¸­ä½¿ç”¨)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">State</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'top-to-bottom'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å¸ƒå±€é£æ ¼å±æ€§</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>å¯¹äº center å¸ƒå±€éœ€è¦ä¸€ä¸ªç‰¹å®šçš„ direction å±æ€§</strong><br />\n <code>center</code>  å¸ƒå±€æˆ‘é‡‡ç”¨çš„æ˜¯åªå¯¹äºæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¿›è¡Œå·¦å³åŒºåˆ†ï¼Œä¸€åŠåœ¨å·¦ä¸€åŠåœ¨å³è¾¹ï¼Œå…¶ä»–çš„å­èŠ‚ç‚¹å°±ç›´æ¥ç»§æ‰¿å…¶çˆ¶èŠ‚ç‚¹çš„ <code>direction</code>  å±æ€§ã€‚è¿™æ ·å°±å¯ä»¥åˆ’åˆ†å‡ºå·¦å­æ ‘å’Œå³å­æ ‘ã€‚<br />\nå½“ç„¶ï¼åœ¨æ¯æ¬¡å¯¹æ ¹èŠ‚ç‚¹è¿›è¡Œæ“ä½œæ—¶éƒ½éœ€è¦ä»æ–°è®¡ç®— <code>direction</code>  å±æ€§.<br />\n å› æ­¤åœ¨çŠ¶æ€ç®¡ç†ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æ›´æ–° center å¸ƒå±€çš„ direction</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function-variable function\">updateChildrenDirections</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">const</span> updateNodeDirection <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> parentDirection<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœçˆ¶èŠ‚ç‚¹æœ‰æ–¹å‘ï¼Œç»§æ‰¿çˆ¶èŠ‚ç‚¹çš„æ–¹å‘</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentDirection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> parentDirection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token comment\">// é€’å½’æ›´æ–°å­èŠ‚ç‚¹çš„æ–¹å‘</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token function\">updateNodeDirection</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// console.log(JSON.parse(JSON.stringify(rootNode.children)))</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootNode <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">const</span> child <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'center'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    child<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        index <span class=\"token operator\">&lt;</span> rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">?</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    child<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'right-to-left'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    child<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// console.log(JSON.parse(JSON.stringify(rooFtNode.children)))</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\">// è°ƒç”¨å‡½æ•°æ›´æ–°æ‰€æœ‰å­èŠ‚ç‚¹çš„æ–¹å‘</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">const</span> child <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token function\">updateNodeDirection</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>left-to-right &amp; right-to-left å¸ƒå±€ä»£ç </strong><br />\nåªéœ€è¦å°†ä¹‹å‰çš„å¸ƒå±€ä»£ç åŒºåˆ†ä¸ºå·¦å³ï¼Œä¿®æ”¹ <code>childX</code>  çš„è®¡ç®—æ–¹æ³•å³å¯å®ç°</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useMindmapStore <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/useMindmapStore'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeWidth</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeHeight</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> horizontalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// çˆ¶å­èŠ‚ç‚¹æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> verticalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// å…„å¼ŸèŠ‚ç‚¹å‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateTreeLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">const</span> layoutStyle <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>layoutStyle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// 1. åˆ›å»ºä¸´æ—¶ä½ç½®å­˜å‚¨å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">// 2. ä¿®æ”¹æ¸…ç©ºä½ç½®çš„æ–¹å¼</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// 3. ä¿®æ”¹åçš„å¸ƒå±€å‡½æ•°ï¼ˆä¸å†ç›´æ¥æ›´æ–°çŠ¶æ€ï¼‰</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨åˆ°ä¸´æ—¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token keyword\">let</span> childX <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// åŠ </span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">+</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'right-to-left'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// å‡</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">-</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token comment\">// 5. ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä½ç½®</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"88\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"89\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹ ID</pre></td></tr><tr><td data-num=\"90\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"91\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„ä¸€ä¸ªæ˜ å°„</pre></td></tr><tr><td data-num=\"92\"></td><td><pre> * @returns å½“å‰èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ &#123;width: number, height: number&#125;</pre></td></tr><tr><td data-num=\"93\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€æˆ–å¶å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// é€’å½’è®¡ç®—å­èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token keyword\">let</span> totalChildHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token keyword\">let</span> maxChildWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    totalChildHeight <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    maxChildWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxChildWidth<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆåŒ…å«é—´è·ï¼‰</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> totalChildHeight <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹å®½åº¦ = è‡ªèº«å®½åº¦ + æœ€å¤§å­èŠ‚ç‚¹å®½åº¦ + æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> maxChildWidth <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆå–è‡ªèº«é«˜åº¦å’Œå­æ ‘é«˜åº¦ä¸­çš„è¾ƒå¤§å€¼ï¼‰</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token keyword\">const</span> totalHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subtreeHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> calculateTreeLayout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li><strong>center å¸ƒå±€ä»£ç </strong><br />\nåˆ’åˆ†ä¸ºå·¦å­æ ‘å’Œå³å­æ ‘ï¼Œå·¦å­æ ‘æŒ‰ç…§ <code>right-to-left</code>  å¸ƒå±€ï¼Œå³å­æ ‘æŒ‰ç…§ <code>left-to-right</code>  å¸ƒå±€ã€‚æ³¨æ„è®¡ç®—å­æ ‘å°ºå¯¸çš„æ—¶å€™ä¹Ÿéœ€è¦å°†ä¸¤ä¸ªå­æ ‘åˆ†å¼€è®¡ç®—ã€‚æ€»çš„æ¥è¯´å°±æ˜¯å°†å·¦å³å­æ ‘åˆ†åˆ«æ‰§è¡Œä¸¤æ¬¡å¸ƒå±€ç®—æ³•å°±å¯ä»¥å®ç°ã€‚</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useMindmapStore <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/useMindmapStore'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ä½¿ç”¨ Store ä¸­çš„ direction å±æ€§</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeWidth</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeHeight</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> horizontalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// çˆ¶å­èŠ‚ç‚¹æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">const</span> verticalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// å…„å¼ŸèŠ‚ç‚¹å‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€ï¼ˆä»ä¸­é—´å‘å·¦å³å¸ƒå±€ï¼‰</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateCenterLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">// ä¸´æ—¶å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„æ–°ä½ç½®</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// åˆå§‹åŒ–æ‰€æœ‰èŠ‚ç‚¹ä½ç½®ä¸º [0, 0]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// å­æ ‘å°ºå¯¸ç¼“å­˜ï¼ˆå…¨å±€å…±äº«ï¼‰</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// åˆ†ç¦»å·¦å³å­æ ‘</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">const</span> leftChildren <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">const</span> rightChildren <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">// å¸ƒå±€å·¦ä¾§å­æ ‘</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutLeftTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token keyword\">let</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                currentX <span class=\"token operator\">-=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> currentX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">let</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        leftChildren<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> originalRootX<span class=\"token punctuation\">,</span> sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            sum <span class=\"token operator\">+=</span> childSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token comment\">// å¸ƒå±€å³ä¾§å­æ ‘</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutRightTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            parentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            <span class=\"token keyword\">let</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                currentX <span class=\"token operator\">+=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Setting position for </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>nodeId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">:</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> currentX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">,</span> nodeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                childY <span class=\"token operator\">+=</span> childSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token keyword\">let</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        rightChildren<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> originalRootX<span class=\"token punctuation\">,</span> sum<span class=\"token punctuation\">,</span> rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            sum <span class=\"token operator\">+=</span> childSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token comment\">// å¸ƒå±€å·¦å³å­æ ‘</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token function\">layoutLeftTree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token function\">layoutRightTree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token keyword\">let</span> minY <span class=\"token operator\">=</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token keyword\">let</span> maxY <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> nodeId <span class=\"token keyword\">in</span> newPositions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token keyword\">const</span> y <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        minY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>minY<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        maxY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxY<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>minY<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> Number<span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>maxY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        minY <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        maxY <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">minY: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>minY<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">, maxY: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>maxY<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>    <span class=\"token comment\">// è®¾ç½®æ ¹èŠ‚ç‚¹ä½ç½®</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>originalRootX<span class=\"token punctuation\">,</span> maxY <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token comment\">// æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„ä½ç½®</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>    useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre></pre></td></tr><tr><td data-num=\"164\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"165\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"166\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>        sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>        <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    <span class=\"token keyword\">let</span> totalHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token keyword\">let</span> maxWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        totalHeight <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        maxWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxWidth<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>    <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> totalHeight <span class=\"token operator\">-</span> verticalSpacing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> maxWidth <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> calculateCenterLayout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li><strong>top-to-bottom çš„å¸ƒå±€ä»£ç </strong><br />\nåªéœ€è¦å°†åŸæ¥çš„å¸ƒå±€ç®—æ³•ï¼Œå®½åº¦æ”¹ä¸ºé«˜åº¦ï¼Œé«˜åº¦æ”¹ä¸ºå®½åº¦å³å¯ã€‚æ ¸å¿ƒçš„è®¡ç®—æ€æƒ³ä¹Ÿæ˜¯ä¸å˜ï¼Œå…ˆå°ºå¯¸å†å¸ƒå±€ï¼Œä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ <code>left-to-right</code>  é¡ºæ—¶é’ˆæ—‹æ”¹å˜ <code>x</code>  å’Œ <code>y</code>  åæ ‡å¾—æ¥çš„ã€‚</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useMindmapStore <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/useMindmapStore'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeWidth</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeHeight</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> horizontalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// çˆ¶å­èŠ‚ç‚¹æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> verticalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// å…„å¼ŸèŠ‚ç‚¹å‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateVerticaLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// 1. åˆ›å»ºä¸´æ—¶ä½ç½®å­˜å‚¨å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token comment\">// 2. ä¿®æ”¹æ¸…ç©ºä½ç½®çš„æ–¹å¼</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>subtreeSizes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">// 3. ä¿®æ”¹åçš„å¸ƒå±€å‡½æ•°ï¼ˆä¸å†ç›´æ¥æ›´æ–°çŠ¶æ€ï¼‰</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨åˆ°ä¸´æ—¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">let</span> childX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      childY <span class=\"token operator\">=</span> currentY <span class=\"token operator\">+</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      childX <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">// 5. ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä½ç½®</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"85\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"86\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹ ID</pre></td></tr><tr><td data-num=\"87\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"88\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„ä¸€ä¸ªæ˜ å°„</pre></td></tr><tr><td data-num=\"89\"></td><td><pre> * @returns å½“å‰èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ &#123;width: number, height: number&#125;</pre></td></tr><tr><td data-num=\"90\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€æˆ–å¶å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">// é€’å½’è®¡ç®—å­èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token keyword\">let</span> totalChildHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">let</span> maxChildWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    maxChildWidth <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    totalChildHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>totalChildHeight<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> totalChildHeight <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> maxChildWidth <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token keyword\">const</span> totalWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subtreeWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> totalWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> totalWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> calculateVerticaLayout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ğŸ¾è‡³æ­¤ï¼Œå®Œæˆäº† <code>left-to-right</code>  &amp;  <code>right-to-left</code>  &amp;  <code>center</code>  &amp;  <code>top-to-bottom</code>  ç»“æ„çš„å¸ƒå±€ï¼Œå½“ç„¶ï¼åç»­ä¹Ÿå¯ä»¥æ·»åŠ  <code>æ—¶é—´è½´å¸ƒå±€ç»“æ„</code>  &amp;  <code>é±¼éª¨å›¾</code>  &amp;  <code>åŠ›å¯¼å‘</code> ç­‰ç­‰è®¸å¤šç»“æ„å¸ƒå±€</p>\n<hr />\n",
            "tags": [
                "canvas",
                "JavaScript",
                "æ ‘",
                "æ€ç»´å¯¼å›¾"
            ]
        },
        {
            "id": "https://aynya.github.io/Konva-js%E5%AE%9E%E7%8E%B0%E8%B6%85%E8%87%AA%E7%84%B6%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/",
            "url": "https://aynya.github.io/Konva-js%E5%AE%9E%E7%8E%B0%E8%B6%85%E8%87%AA%E7%84%B6%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/",
            "title": "Konva.jså®ç°è¶…è‡ªç„¶æ–‡æœ¬ç¼–è¾‘",
            "date_published": "2025-04-10T03:38:33.000Z",
            "content_html": "<h1 id=\"å½“-canvas-é‡è§-domåœ¨-konva-ä¸­å®ç°ä¸æ»‘æ–‡æœ¬ç¼–è¾‘çš„æŠ€å·§\"><a class=\"anchor\" href=\"#å½“-canvas-é‡è§-domåœ¨-konva-ä¸­å®ç°ä¸æ»‘æ–‡æœ¬ç¼–è¾‘çš„æŠ€å·§\">#</a> ğŸ¨ å½“ Canvas é‡è§ DOMï¼šåœ¨ Konva ä¸­å®ç°ä¸æ»‘æ–‡æœ¬ç¼–è¾‘çš„æŠ€å·§</h1>\n<h2 id=\"ä¸ºä»€ä¹ˆéœ€è¦-dom-canvas-çš„æ··åˆæ–¹æ¡ˆ\"><a class=\"anchor\" href=\"#ä¸ºä»€ä¹ˆéœ€è¦-dom-canvas-çš„æ··åˆæ–¹æ¡ˆ\">#</a> ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ DOM + Canvas çš„æ··åˆæ–¹æ¡ˆï¼Ÿ</h2>\n<p>konva çš„ <code>Text</code>  ç»„ä»¶è™½ç„¶å¼ºå¤§ï¼Œä½†åœ¨å¤„ç†<strong>å¤æ‚æ–‡æœ¬ç¼–è¾‘</strong>æ—¶å­˜åœ¨å±€é™ï¼š</p>\n<ul>\n<li>âŒ¨ï¸ ç¼ºå°‘è‡ªåŠ¨æ¢è¡Œã€å…‰æ ‡æ§åˆ¶ç­‰åŸç”Ÿèƒ½åŠ›</li>\n<li>ğŸ–¥ï¸ å¤æ‚æ ·å¼æ”¯æŒæœ‰é™</li>\n</ul>\n<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé€šè¿‡ DOM å…ƒç´ æ¨¡æ‹Ÿ Canvas çš„æ–‡æœ¬ç¼–è¾‘ï¼</p>\n<hr />\n<h2 id=\"ç›®æ ‡\"><a class=\"anchor\" href=\"#ç›®æ ‡\">#</a> ğŸ“Œ ç›®æ ‡</h2>\n<p>è®© Konva ç”»å¸ƒä¸­çš„èŠ‚ç‚¹æ–‡æœ¬ <strong>åŒå‡»å¯ç¼–è¾‘</strong>ï¼Œæ•ˆæœåƒç›´æ¥åœ¨ Canvas ä¸Šè¾“å…¥æ–‡å­—ä¸€æ ·ä¸æ»‘ï¼ï¼ˆæ— éœ€ Konva çš„å¤æ‚ç»„ä»¶ï¼Œç›´æ¥ç”¨åŸç”Ÿ <code>&lt;textarea&gt;</code>  å®ç°ï¼ï¼‰</p>\n<h2 id=\"æ ¸å¿ƒæ€è·¯\"><a class=\"anchor\" href=\"#æ ¸å¿ƒæ€è·¯\">#</a> ğŸ”§ æ ¸å¿ƒæ€è·¯</h2>\n<ol>\n<li><strong>åŒå‡»è§¦å‘</strong>ï¼šç›‘å¬ konva èŠ‚ç‚¹çš„ <code>onDblClick</code>  äº‹ä»¶</li>\n<li><strong>DOM å®šä½</strong>ï¼šKonva ç”»å¸ƒåæ ‡ç³»è®¡ç®— DOM å…ƒç´ çš„ç»å¯¹ä½ç½®</li>\n<li><strong>åŒæ­¥æ ·å¼</strong>ï¼šè®© <code>&lt;textarea&gt;</code>  å®Œå…¨å¤åˆ» Konva èŠ‚ç‚¹çš„æ ·å¼ (é¢œè‰²ã€å­—ä½“ã€å­—å·ç­‰)</li>\n<li><strong>æ•°æ®åŒæ­¥</strong>ï¼šè¾“å…¥å®Œæˆæ—¶æ›´æ–° Konva èŠ‚ç‚¹æ–‡æœ¬å’Œå°ºå¯¸</li>\n</ol>\n<hr />\n<h2 id=\"ä»£ç \"><a class=\"anchor\" href=\"#ä»£ç \">#</a> ğŸ“ ä»£ç </h2>\n<h3 id=\"1ï¸âƒ£-ç›‘å¬åŒå‡»äº‹ä»¶\"><a class=\"anchor\" href=\"#1ï¸âƒ£-ç›‘å¬åŒå‡»äº‹ä»¶\">#</a> 1ï¸âƒ£ ç›‘å¬åŒå‡»äº‹ä»¶</h3>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleDoubleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> KonvaEventObject<span class=\"token operator\">&lt;</span>MouseEvent<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> stage <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">getStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—ç¼©æ”¾åçš„ä½ç½®</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> areaPosition <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    x<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">scaleX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    y<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">scaleY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// åˆ›å»º DOM è¾“å…¥æ¡†</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">createTextarea</span><span class=\"token punctuation\">(</span>areaPosition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"2ï¸âƒ£-åˆ›å»º-dom-è¾“å…¥æ¡†\"><a class=\"anchor\" href=\"#2ï¸âƒ£-åˆ›å»º-dom-è¾“å…¥æ¡†\">#</a> 2ï¸âƒ£ åˆ›å»º DOM è¾“å…¥æ¡†</h3>\n<ol>\n<li>åˆ›å»º  <code>textarea</code></li>\n<li>æ‰¾åˆ° konva çš„ä½ç½®ï¼Œå¹¶åŒæ­¥åˆ° DOM ä¸­</li>\n<li>å¤åˆ»æ ·å¼</li>\n<li>èšç„¦</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åˆ›å»º textarea</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> textarea <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"textarea\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"konva-container\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>container<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>container<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>textarea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> <span class=\"token string\">\"absolute\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>areaPosition<span class=\"token punctuation\">.</span>y<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>areaPosition<span class=\"token punctuation\">.</span>x<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontSize <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> scale<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>border <span class=\"token operator\">=</span> <span class=\"token string\">\"2px solid #4f46e5\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Rect çš„ stroke</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>borderRadius <span class=\"token operator\">=</span> <span class=\"token string\">\"8px\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Rect çš„ cornerRadius</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>padding <span class=\"token operator\">=</span> <span class=\"token string\">\"20px\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Text çš„ padding</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>margin <span class=\"token operator\">=</span> <span class=\"token string\">\"0px\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>overflow <span class=\"token operator\">=</span> <span class=\"token string\">\"hidden\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">\"#ffffff\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Rect çš„ fill</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>outline <span class=\"token operator\">=</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>resize <span class=\"token operator\">=</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>wordBreak <span class=\"token operator\">=</span> <span class=\"token string\">\"break-word\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontFamily <span class=\"token operator\">=</span> <span class=\"token string\">\"Arial, sans-serif\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Text çš„ fontFamily</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>transformOrigin <span class=\"token operator\">=</span> <span class=\"token string\">\"left top\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>color <span class=\"token operator\">=</span> <span class=\"token string\">\"#000000\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Text çš„é¢œè‰²</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"3ï¸âƒ£-æ•°æ®åŒæ­¥ä¸é”€æ¯\"><a class=\"anchor\" href=\"#3ï¸âƒ£-æ•°æ®åŒæ­¥ä¸é”€æ¯\">#</a> 3ï¸âƒ£ æ•°æ®åŒæ­¥ä¸é”€æ¯</h3>\n<ol>\n<li>ç›‘å¬äº‹ä»¶ï¼šç›‘å¬é”®ç›˜äº‹ä»¶ã€å¤±ç„¦äº‹ä»¶</li>\n<li>ç§»é™¤ DOM å…ƒç´ </li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">removeTextarea</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// ç›‘å¬é”®ç›˜äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keydown\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token string\">\"Enter\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>e<span class=\"token punctuation\">.</span>shiftKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        textarea<span class=\"token punctuation\">.</span><span class=\"token function\">blur</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤±å»ç„¦ç‚¹è§¦å‘ä¿å­˜</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"input\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">measureText</span><span class=\"token punctuation\">(</span>textarea<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>width<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>height<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// å¤±ç„¦æ—¶ä¿å­˜æ–‡æœ¬</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"blur\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">const</span> newText <span class=\"token operator\">=</span> textarea<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    actions<span class=\"token punctuation\">.</span><span class=\"token function\">updateNodeText</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°èŠ‚ç‚¹æ–‡æœ¬</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    actions<span class=\"token punctuation\">.</span><span class=\"token function\">updateNodeSize</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token function\">measureText</span><span class=\"token punctuation\">(</span>newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">removeTextarea</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç§»é™¤ textarea</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"4ï¸âƒ£-æµ‹é‡æ–‡æœ¬å°ºå¯¸\"><a class=\"anchor\" href=\"#4ï¸âƒ£-æµ‹é‡æ–‡æœ¬å°ºå¯¸\">#</a> 4ï¸âƒ£ æµ‹é‡æ–‡æœ¬å°ºå¯¸</h3>\n<p>é€šè¿‡ç›´æ¥åœ¨ DOM ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„  <code>Konva.Text</code>  å…ƒç´ ï¼Œç„¶åè·å–å®ƒçš„å°ºå¯¸ã€‚ç”±äºè¿™è¾¹å¤åˆ»çš„ <code>padding</code>  æ˜¯ 20px ä¸Šä¸‹å·¦å³éƒ½æœ‰ï¼Œæ‰€ä»¥å®½é«˜éƒ½è¦åŠ ä¸Š 40pxã€‚<br />\nå¦‚æœçŸ¥è¯†å•å•çš„å¤åˆ»ï¼Œå°±ä¸éœ€è¦åŠ  <code>padding</code>  äº†ï¼Œç›´æ¥è¿”å›å®½é«˜å°±è¡Œã€‚</p>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æµ‹é‡æ–‡æœ¬å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> measureText <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> tempText <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        fontSize<span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        text<span class=\"token operator\">:</span> text</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        tempText<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        tempText<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"5ï¸âƒ£-æ–‡æœ¬ä½ç½®è·å–è¯¦è§£å‘é‡è¿ç®—\"><a class=\"anchor\" href=\"#5ï¸âƒ£-æ–‡æœ¬ä½ç½®è·å–è¯¦è§£å‘é‡è¿ç®—\">#</a> 5ï¸âƒ£ æ–‡æœ¬ä½ç½®è·å–è¯¦è§£ (å‘é‡è¿ç®—)</h3>\n<ol>\n<li><code>stage</code>  çš„ <code>x &amp; y</code>  æ˜¯æ•´ä¸ªç”»å¸ƒç›¸å¯¹äºè§†å£çš„åç§»é‡</li>\n<li><code>node</code>  çš„ <code>postion</code>  æ˜¯å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºç”»å¸ƒçš„åç§»é‡</li>\n<li>è€Œæˆ‘ä»¬è¦è·å–çš„æ˜¯å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºè§†å£çš„åç§»é‡</li>\n<li>è€Œ <code>node</code>  å®é™…çš„ç›¸å¯¹äºç”»å¸ƒçš„åç§»é‡æ˜¯å— <code>scale</code>  å½±å“çš„</li>\n<li>æ‰€ä»¥å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºè§†å£çš„åç§»é‡å°±æ˜¯ï¼š <code>stage + node * scale</code></li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è·å–æ–‡æœ¬ä½ç½®</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> areaPosition <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    x<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    y<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>é€šè¿‡ DOM + Canvas çš„æ··åˆæ–¹æ¡ˆï¼Œå®ç°äº†ä¸€ä¸ªè¶…è‡ªç„¶æ–‡æœ¬ç¼–è¾‘çš„ç»„ä»¶ã€‚é€šè¿‡ç›‘å¬ <code>onDblClick</code>  äº‹ä»¶ï¼Œåœ¨ç”»å¸ƒä¸ŠåŒå‡»æ—¶åˆ›å»ºä¸€ä¸ª <code>textarea</code> ï¼Œå¹¶åŒæ­¥æ ·å¼å’Œä½ç½®ã€‚é€šè¿‡é”®ç›˜äº‹ä»¶å’Œå¤±ç„¦äº‹ä»¶ï¼Œå®ç°äº†æ–‡æœ¬çš„ä¿å­˜å’Œå°ºå¯¸çš„æ›´æ–°ã€‚</p>\n<h2 id=\"äº®ç‚¹\"><a class=\"anchor\" href=\"#äº®ç‚¹\">#</a> ğŸŒˆ äº®ç‚¹</h2>\n<ul>\n<li>çº¯åŸç”Ÿ DOM æ“ä½œï¼Œè½»é‡é«˜æ•ˆ</li>\n<li><strong>å®Œç¾èåˆ</strong>ï¼šè¾“å…¥æ¡†ä¸ç”»å¸ƒå…ƒç´ æ— ç¼è¡”æ¥</li>\n</ul>\n<hr />\n<p>ğŸ‰ <strong>ç°åœ¨ï¼Œç”»å¸ƒèŠ‚ç‚¹æ‹¥æœ‰ â€œç¼–è¾‘è¶…èƒ½åŠ›â€ äº†ï¼</strong></p>\n",
            "tags": [
                "canvas",
                "konva",
                "Dom",
                "Text"
            ]
        },
        {
            "id": "https://aynya.github.io/Konva%E5%AE%9E%E7%8E%B0%E4%BB%A5%E9%BC%A0%E6%A0%87%E4%B8%BA%E4%B8%AD%E5%BF%83%E7%9A%84%E7%B2%BE%E5%87%86%E7%94%BB%E5%B8%83%E7%BC%A9%E6%94%BE/",
            "url": "https://aynya.github.io/Konva%E5%AE%9E%E7%8E%B0%E4%BB%A5%E9%BC%A0%E6%A0%87%E4%B8%BA%E4%B8%AD%E5%BF%83%E7%9A%84%E7%B2%BE%E5%87%86%E7%94%BB%E5%B8%83%E7%BC%A9%E6%94%BE/",
            "title": "Konvaå®ç°ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒçš„ç²¾å‡†ç”»å¸ƒç¼©æ”¾",
            "date_published": "2025-04-09T02:43:31.000Z",
            "content_html": "<h1 id=\"å¦‚ä½•å®ç°ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒçš„ç²¾å‡†ç”»å¸ƒç¼©æ”¾\"><a class=\"anchor\" href=\"#å¦‚ä½•å®ç°ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒçš„ç²¾å‡†ç”»å¸ƒç¼©æ”¾\">#</a> å¦‚ä½•å®ç°ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒçš„ç²¾å‡†ç”»å¸ƒç¼©æ”¾ï¼Ÿ</h1>\n<h2 id=\"ä¸€-æ ¸å¿ƒåŸç†åæ ‡ç³»è½¬æ¢\"><a class=\"anchor\" href=\"#ä¸€-æ ¸å¿ƒåŸç†åæ ‡ç³»è½¬æ¢\">#</a> ä¸€ã€æ ¸å¿ƒåŸç†ï¼šåæ ‡ç³»è½¬æ¢</h2>\n<p>è¦å®ç°ç²¾å‡†ç¼©æ”¾ï¼Œéœ€è¦ç†è§£ä¸¤ä¸ªæ ¸å¿ƒåæ ‡ç³»ï¼š</p>\n<ol>\n<li><strong>è§†å£åæ ‡ç³»</strong>ï¼šç”¨æˆ·å½“å‰çœ‹åˆ°çš„åŒºåŸŸï¼ˆViewportï¼‰</li>\n<li><strong>å†…å®¹åæ ‡ç³»</strong>ï¼šç”»å¸ƒçš„å®é™…å†…å®¹ï¼ˆContentï¼‰</li>\n</ol>\n<p>ç¼©æ”¾çš„æœ¬è´¨å°±æ˜¯è¿™ä¸¤ä¸ªåæ ‡ç³»çš„æ¯”ä¾‹å˜æ¢ã€‚æˆ‘ä»¬çš„ç›®çš„æ˜¯ï¼š<strong>æ— è®ºç¼©æ”¾æ¯”ä¾‹å¦‚ä½•å˜åŒ–ï¼Œé¼ æ ‡ç‚¹å¯¹åº”çš„å†…å®¹ä½ç½®å§‹ç»ˆä¿æŒä¸å˜</strong>ã€‚</p>\n<h3 id=\"æ•°å­¦å…³ç³»\"><a class=\"anchor\" href=\"#æ•°å­¦å…³ç³»\">#</a> æ•°å­¦å…³ç³»</h3>\n<p>è®¾ï¼š</p>\n<ul>\n<li>å½“å‰ç¼©æ”¾æ¯”ä¾‹ï¼š <code>S</code></li>\n<li>æ–°ç¼©æ”¾æ¯”ä¾‹ï¼š <code>S'</code></li>\n<li>é¼ æ ‡çš„è§†å£åæ ‡ï¼š <code>å‘é‡A = (P_x, P_y)</code></li>\n<li>ç”»å¸ƒåç§»é‡ (ç›¸å¯¹äºè§†å£)ï¼š <code>å‘é‡B = (O_x, O_y)</code></li>\n</ul>\n<p>å°†é¼ æ ‡ç›¸å¯¹äºè§†å£çš„åæ ‡å‡å»ç”»å¸ƒçš„åç§»é‡å¾—åˆ°é¼ æ ‡ç›¸å¯¹äºç”»å¸ƒçš„åæ ‡ï¼š<br />\nåˆ™å†…å®¹åæ ‡ç³»ä¸‹å¯¹åº”çš„ç‚¹ä¸ºå‘é‡ Cï¼š<br />\n <code>C_x = (P_x - O_x) / S</code> <br />\n <code>C_y = (P_y - O_y) / S</code> <br />\n <code>å‘é‡C = å‘é‡B - å‘é‡A</code></p>\n<p>ç¼©æ”¾åä¿æŒè¯¥ç‚¹çš„ä½ç½®ä¸å˜ï¼š<br />\nç›¸å¯¹ä½ç½®è¦ä¹˜ä»¥æ–°çš„ç¼©æ”¾æ¯”ä¾‹ <code>S'</code> ï¼š<br />\nå¯å¾— (è¿™æ—¶å€™æˆ‘ä»¬è¦æ±‚çš„å°±æ˜¯æ–°çš„ç”»å¸ƒåç§»é‡äº†)<br />\n <code>P_x = O_x' + C_x * S'</code> <br />\n <code>P_y = O_y' + C_y * S'</code> <br />\n <code>å‘é‡A = å‘é‡B + å‘é‡C'</code></p>\n<p>å°±å¯ä»¥è§£å¾—æ–°çš„ç”»å¸ƒåç§»é‡äº† <code>(O_x', O_y')</code> <br />\n <code>O_x = Px - C_x * S'</code> <br />\n <code>O_y = Py - C_y * S'</code></p>\n<h2 id=\"ä»£ç å®ç°\"><a class=\"anchor\" href=\"#ä»£ç å®ç°\">#</a> ä»£ç å®ç°ï¼š</h2>\n<ol>\n<li><strong>åæ ‡ç³»è½¬æ¢</strong><br />\n <code>(pointer - stage)</code>  å°†è§†å£åæ ‡è½¬æ¢ä¸ºå†…å®¹ç»å¯¹åæ ‡ï¼Œå†é™¤ä»¥å½“å‰ç¼©æ”¾æ¯”ä¾‹å¾—åˆ°åŸå§‹å†…å®¹åæ ‡ç³»çš„ä½ç½®ã€‚</li>\n<li><strong>ç¼©æ”¾æ–¹å‘å¤„ç†</strong><br />\né€šè¿‡ <code>deltaY</code>  åˆ¤æ–­æ»šè½®æ–¹å‘ï¼Œç»“åˆ <code>ctrlKey</code>  å¤„ç†å¿«æ·é”®</li>\n<li><strong>ä½ç½®è¡¥å¿è®¡ç®—</strong><br />\n <code>pointer - mousePointTo * newScale</code>  å®ç°è§†è§‰ä½ç½®çš„ç¡®å®šï¼Œç¡®ä¿ç¼©æ”¾åé¼ æ ‡ç‚¹å¯¹åº”çš„å†…å®¹ä½ç½®ä¸å˜ã€‚</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å¤„ç†é¼ æ ‡æ»šè½®ç¼©æ”¾</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">const</span> handleWheel <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> KonvaEventObject<span class=\"token operator\">&lt;</span>WheelEvent<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\">// 1. é˜»æ­¢åŸæ¥çš„é»˜è®¤æ»šåŠ¨äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        e<span class=\"token punctuation\">.</span>evt<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">const</span> stage <span class=\"token operator\">=</span> stageRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stage<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>stage<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// 2. è·å–å½“å‰çš„ç¼©æ”¾çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> oldScale <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">scaleX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">const</span> pointer <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>pointer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pointer<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 3. è®¡ç®—é¼ æ ‡ç‚¹åœ¨å†…å®¹åæ ‡ç³»çš„çœŸå®ä½ç½®</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> mousePointTo <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            x<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>pointer<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> oldScale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            y<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>pointer<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> oldScale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// 4. ç¡®å®šç¼©æ”¾æ–¹å‘å’Œæ¯”ä¾‹</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">let</span> direction <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>evt<span class=\"token punctuation\">.</span>deltaY <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœæŒ‰ä½ Ctrl é”®ï¼Œåè½¬æ–¹å‘</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>evt<span class=\"token punctuation\">.</span>ctrlKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            direction <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>direction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">const</span> scaleBy <span class=\"token operator\">=</span> <span class=\"token number\">1.2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¯æ¬¡ç¼©æ”¾çš„æ¯”ä¾‹</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">let</span> newScale <span class=\"token operator\">=</span> direction <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> oldScale <span class=\"token operator\">*</span> scaleBy <span class=\"token operator\">:</span> oldScale <span class=\"token operator\">/</span> scaleBy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token comment\">// 5. é™åˆ¶ç¼©æ”¾æ¯”ä¾‹</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        newScale <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.2</span><span class=\"token punctuation\">,</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> newScale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// æ›´æ–°ç¼©æ”¾æ¯”ä¾‹</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">scale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> x<span class=\"token operator\">:</span> newScale<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> newScale <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\">// è®¡ç®—æ–°çš„åç§»é‡</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">const</span> newPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            x<span class=\"token operator\">:</span> pointer<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> mousePointTo<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> newScale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            y<span class=\"token operator\">:</span> pointer<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> mousePointTo<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> newScale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token comment\">// åº”ç”¨å˜æ¢</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span>newPos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"å¯è§†åŒ–ç†è§£\"><a class=\"anchor\" href=\"#å¯è§†åŒ–ç†è§£\">#</a> å¯è§†åŒ–ç†è§£</h2>\n<p>å‡è®¾ï¼š</p>\n<ul>\n<li>å½“å‰ç¼©æ”¾ï¼š <code>1x</code></li>\n<li>ç”»å¸ƒåç§»ï¼š <code>(0, 0)</code></li>\n<li>é¼ æ ‡ä½ç½®ï¼š <code>(500, 300)</code> <br />\n å½“æ”¾å¤§åˆ° <code>2x</code>  æ—¶ï¼š</li>\n</ul>\n<ol>\n<li>è®¡ç®—åŸå§‹å†…å®¹ä½ç½®</li>\n</ol>\n<pre><code>(500 - 0) / 1 = 500\n(300 - 0) / 1 = 300\n</code></pre>\n<ol start=\"2\">\n<li>è®¡ç®—æ–°åç§»é‡</li>\n</ol>\n<pre><code>newX = 500 - 500 * 2 = -500\nnewY = 300 - 300 * 2 = -300\n</code></pre>\n<ol start=\"3\">\n<li>ç»“æœï¼šå†…å®¹å‘å·¦ä¸Šè§’åç§»ï¼Œæ˜¯çš„åŸä¸­å¿ƒç‚¹ä¿æŒå¯è§</li>\n</ol>\n<h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>é€šè¿‡åæ ‡ç³»è½¬æ¢å’Œæ•°å­¦å…³ç³»ï¼Œå®ç°äº†ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒçš„ç²¾å‡†ç”»å¸ƒç¼©æ”¾ã€‚</p>\n<hr />\n<p>å®Œæ•´é¡¹ç›®ä»£ç ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2F5bnlhL0RuaU1hcA==\">https://github.com/aynya/DniMap</span></p>\n",
            "tags": [
                "canvas",
                "React",
                "konva",
                "canvas"
            ]
        },
        {
            "id": "https://aynya.github.io/js%E8%A7%A3%E8%AE%B0/",
            "url": "https://aynya.github.io/js%E8%A7%A3%E8%AE%B0/",
            "title": "jsè§£è®°",
            "date_published": "2025-04-06T02:26:15.000Z",
            "content_html": "<h1 id=\"å®ç°objectassignå’Œcompleteassign\"><a class=\"anchor\" href=\"#å®ç°objectassignå’Œcompleteassign\">#</a> å®ç° Object.assign () å’Œ completeAssign ()</h1>\n<h2 id=\"objectassign\"><a class=\"anchor\" href=\"#objectassign\">#</a> Object.assign()</h2>\n<p><code>Object.assign()</code>  æ–¹æ³•ç”¨äºå°†æ‰€æœ‰<strong>æºå¯¹è±¡çš„å¯æšä¸¾å±æ€§</strong>ï¼Œå¤åˆ¶åˆ°ç›®æ ‡å¯¹è±¡ã€‚å®ƒå°†è¿”å›ç›®æ ‡å¯¹è±¡ã€‚</p>\n<h3 id=\"è¯­æ³•\"><a class=\"anchor\" href=\"#è¯­æ³•\">#</a> è¯­æ³•</h3>\n<p><code>Object.assign(target, ...sources)</code></p>\n<h3 id=\"ç¤ºä¾‹\"><a class=\"anchor\" href=\"#ç¤ºä¾‹\">#</a> ç¤ºä¾‹</h3>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> source <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">c</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> returnedTarget <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// &#123; a: 1, b: 4, c: 5 &#125;</span></pre></td></tr></table></figure><h3 id=\"æ‰‹å†™å®ç°\"><a class=\"anchor\" href=\"#æ‰‹å†™å®ç°\">#</a> æ‰‹å†™å®ç°</h3>\n<p>ä½¿ç”¨ <code>for...of</code>  å¾ªç¯éå† <code>sources</code>  æ•°ç»„ï¼Œç„¶åä½¿ç”¨ <code>Object.keys()</code>  å’Œ <code>Object.getOwnPropertySymbols()</code>  è·å– <code>source</code>  å¯¹è±¡çš„å¯æšä¸¾å±æ€§å’Œ <code>symbol</code>  ç±»å‹çš„å±æ€§ã€‚</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">objectAssign</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>sources</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> target <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   target <span class=\"token operator\">=</span> <span class=\"token function\">Object</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> source <span class=\"token keyword\">of</span> sources<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> source <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>source <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">getOwnPropertySymbols</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è·å– symbol çš„ key</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">function</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> source</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> key <span class=\"token keyword\">of</span> keys<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      target<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> source<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> source<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"completeassign\"><a class=\"anchor\" href=\"#completeassign\">#</a> completeAssign()</h2>\n<p><code>completeAssign()</code>  å¤„ç†çš„æ˜¯å¯æšä¸¾å±æ€§å’Œ <code>symbol</code>  ç±»å‹çš„å±æ€§ï¼Œ <code>getters</code>  ä¸ä¼šè¢«å¤åˆ¶ï¼Œä¸å¯æšä¸¾å±æ€§è¢«å¿½ç•¥ã€‚</p>\n<h3 id=\"ç¤ºä¾‹-2\"><a class=\"anchor\" href=\"#ç¤ºä¾‹-2\">#</a> ç¤ºä¾‹</h3>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> source <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\">// prototype</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token literal-property property\">enumerable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// å¯æšä¸¾ data descriptor</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token literal-property property\">c</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ä¸å¯æšä¸¾ data descriptor</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token literal-property property\">d</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ä¸å¯æšä¸¾ accessor descriptor </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_d<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_d <span class=\"token operator\">=</span> value</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token literal-property property\">e</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// å¯æšä¸¾ accessor descriptor </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_e <span class=\"token operator\">=</span> value</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token literal-property property\">enumerable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">completeAssign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// &#123;b: 4, c: 5&#125;</span></pre></td></tr></table></figure><h3 id=\"æ‰‹å†™å®ç°-2\"><a class=\"anchor\" href=\"#æ‰‹å†™å®ç°-2\">#</a> æ‰‹å†™å®ç°</h3>\n<p>ä½¿ç”¨ <code>Object.getOwnPropertyDescriptors()</code>  è·å– <code>source</code>  å¯¹è±¡çš„æ‰€æœ‰å±æ€§æè¿°ç¬¦ã€‚å†ä½¿ç”¨ <code>Object.defineProperties()</code>  è®¾ç½® <code>target</code>  å¯¹è±¡çš„å±æ€§æè¿°ç¬¦ã€‚æœ€åéå† <code>source</code>  å¯¹è±¡çš„ <code>symbol</code>  ç±»å‹çš„å±æ€§ï¼Œè®¾ç½® <code>target</code>  å¯¹è±¡çš„å±æ€§ã€‚</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">completeAssign</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>sources</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'11'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  target <span class=\"token operator\">=</span> <span class=\"token function\">Object</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> source <span class=\"token keyword\">of</span> sources<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>source <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    source <span class=\"token operator\">=</span> <span class=\"token function\">Object</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperties</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">getOwnPropertyDescriptors</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è·å–åˆ°ç‰¹æœ‰çš„</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> key <span class=\"token keyword\">of</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">getOwnPropertySymbols</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// Symbol å±æ€§</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      target<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> source<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å®ç°clearalltimeout\"><a class=\"anchor\" href=\"#å®ç°clearalltimeout\">#</a> å®ç° clearAllTimeout ()</h1>\n<p><code>clearAllTimeout()</code>  æ–¹æ³•ç”¨äºæ¸…é™¤æ‰€æœ‰çš„ <code>setTimeout()</code>  å®šæ—¶å™¨ã€‚</p>\n<h3 id=\"ä»£ç å®ç°\"><a class=\"anchor\" href=\"#ä»£ç å®ç°\">#</a> ä»£ç å®ç°</h3>\n<p>å¼€å¤šä¸ªå®šæ—¶å™¨ï¼Œç„¶åä¾æ¬¡æ¸…é™¤ã€‚æ€»èƒ½æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨ã€‚</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">clearAllTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">let</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    id <span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å®ç°async-helper-sequence-parallel\"><a class=\"anchor\" href=\"#å®ç°async-helper-sequence-parallel\">#</a> å®ç° async helper -  <code>sequence()</code>  &amp;  <code>parallel()</code></h1>\n<h2 id=\"parallel\"><a class=\"anchor\" href=\"#parallel\">#</a> parallel</h2>\n<p><code>sequence()</code>  æ–¹æ³•ç”¨äºå°†å¼‚æ­¥å‡½æ•°ä¸²è¡ŒåŒ–ï¼Œä¾æ¬¡æ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚</p>\n<h3 id=\"ä»£ç å®ç°-2\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-2\">#</a> ä»£ç å®ç°</h3>\n<ol>\n<li>å®šä¹‰ <code>promisify()</code>  æ–¹æ³•ï¼Œå°†å¼‚æ­¥å‡½æ•°è½¬æ¢ä¸º Promise å¯¹è±¡ã€‚</li>\n<li>ä½¿ç”¨ <code>Promise.resolve()</code>  å°†è¾“å…¥è½¬æ¢ä¸º Promise å¯¹è±¡ã€‚</li>\n<li>ç„¶åå¼€å§‹é“¾å¼è°ƒç”¨ï¼Œæ¯æ¬¡è¿”å›çš„å€¼ä½œä¸ºä¸‹ä¸€ä¸ªå¼‚æ­¥å‡½æ•°çš„è¾“å…¥ã€‚</li>\n<li>æœ€åè§£å†³æ—¶è°ƒç”¨å›è°ƒå‡½æ•°ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>type Callback = (error: Error, data: any) => void</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>type AsyncFunc = (</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   callback: Callback,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   data: any</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>) => void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * @param &#123;AsyncFunc[]&#125; funcs</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * @return &#123;(callback: Callback) => void&#125;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">sequence</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">funcs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">const</span> promiseFuncs <span class=\"token operator\">=</span> funcs<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>promisify<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">let</span> promise <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    promiseFuncs<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promiseFunc</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      promise <span class=\"token operator\">=</span> promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>promiseFunc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>   </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">promisify</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fun</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> newData</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>newData<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"parallel-2\"><a class=\"anchor\" href=\"#parallel-2\">#</a> parallel()</h2>\n<p><code>parallel()</code>  æ–¹æ³•ç”¨äºå°†å¼‚æ­¥å‡½æ•°å¹¶è¡ŒåŒ–ï¼ŒåŒæ—¶æ‰§è¡Œå¼‚æ­¥å‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚</p>\n<h3 id=\"ä»£ç å®ç°-3\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-3\">#</a> ä»£ç å®ç°</h3>\n<ol>\n<li>å®šä¹‰ <code>promisify()</code>  æ–¹æ³•ï¼Œå°†å¼‚æ­¥å‡½æ•°è½¬æ¢ä¸º Promise å¯¹è±¡ã€‚</li>\n<li>ä½¿ç”¨ <code>Promise.all()</code>  å°†å¼‚æ­¥å‡½æ•°å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚</li>\n<li>æœ€åè§£å†³æ—¶è°ƒç”¨å›è°ƒå‡½æ•°ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>type Callback = (error: Error, data: any) => void</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>type AsyncFunc = (</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   callback: Callback,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   data: any</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>) => void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * @param &#123;AsyncFunc[]&#125; funcs</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * @return &#123;(callback: Callback) => void&#125;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">funcs</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// const promisiFuncs = funcs.map(promisify);</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>funcs<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span> <span class=\"token operator\">=></span> <span class=\"token function\">promisify</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">promisify</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fun</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> newData</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>newData<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å®ç°async-helper-race\"><a class=\"anchor\" href=\"#å®ç°async-helper-race\">#</a> å®ç° async helper -  <code>race()</code></h1>\n<h2 id=\"race\"><a class=\"anchor\" href=\"#race\">#</a> race()</h2>\n<p><code>race()</code>  æ–¹æ³•ä¼šåœ¨ä»»ä½•ä¸€ä¸ª function ç»“æŸæˆ–è€…äº§ç”Ÿ error çš„æ—¶å€™è°ƒç”¨æœ€ç»ˆçš„ callbackã€‚</p>\n<h2 id=\"ä»£ç å®ç°-4\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-4\">#</a> ä»£ç å®ç°</h2>\n<ol>\n<li>ä¸ºæ¯ä¸ª function éƒ½æ·»åŠ ä¸€ä¸ª flagï¼Œå¦‚æœ flag ä¸º trueï¼Œåˆ™ä¸å†æ‰§è¡Œåç»­çš„ functionã€‚</li>\n<li>ä½¿ç”¨ <code>forEach()</code>  éå†æ¯ä¸ª functionï¼Œå¹¶è°ƒç”¨å…¶å‡½æ•°ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>type Callback = (error: Error, data: any) => void</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>type AsyncFunc = (</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   callback: Callback,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   data: any</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>) => void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * @param &#123;AsyncFunc[]&#125; funcs</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * @return &#123;(callback: Callback) => void&#125;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">funcs</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> input</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">let</span> flag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fun</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>arg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>flag <span class=\"token operator\">===</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      flag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> func <span class=\"token keyword\">of</span> funcs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>fun<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å®ç°promiseall\"><a class=\"anchor\" href=\"#å®ç°promiseall\">#</a> å®ç° <code>Promise.all()</code></h1>\n<h2 id=\"promiseall\"><a class=\"anchor\" href=\"#promiseall\">#</a> Promise.all()</h2>\n<p><code>Promise.all()</code>  æ–¹æ³•ç”¨äºå°†å¤šä¸ª Promise å¯¹è±¡ç»„åˆä¸ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚è¯¥ Promise å¯¹è±¡åœ¨ä¼ å…¥çš„æ‰€æœ‰ Promise å¯¹è±¡éƒ½æˆåŠŸæ—¶æ‰ä¼šæˆåŠŸï¼Œä¸€æ—¦æœ‰ä¸€ä¸ª Promise å¯¹è±¡å¤±è´¥ï¼Œåˆ™ç«‹å³è¿”å›ä¸€ä¸ªå¤±è´¥çš„ Promise å¯¹è±¡ã€‚</p>\n<h2 id=\"ä»£ç å®ç°-5\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-5\">#</a> ä»£ç å®ç°</h2>\n<ol>\n<li>é€šè¿‡ä¸€ä¸ªæ•°ç»„å­˜å‚¨æ¯ä¸ª Promise å®Œæˆåçš„ç»“æœ</li>\n<li>è°ƒç”¨ <code>Promise.resolve()</code>  å°†è¾“å…¥è½¬æ¢ä¸º Promise å¯¹è±¡ã€‚</li>\n<li>ä½¿ç”¨ <code>.then(onfulfilled, onrejected)</code>  å½“ Promise æˆåŠŸæ—¶è°ƒç”¨ onfulfilledï¼Œå½“ Promise å¤±è´¥æ—¶è°ƒç”¨ onrejectedã€‚ä¹Ÿå°±ç›´æ¥ reject å‡ºå»äº†</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @param &#123;Array&lt;any>&#125; promises - notice input might have non-Promises</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @return &#123;Promise&lt;any[]>&#125;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promises</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>promises<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">const</span> promise <span class=\"token operator\">=</span> promises<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">===</span> promises<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr />\n<h1 id=\"å®ç°promiseallsettled\"><a class=\"anchor\" href=\"#å®ç°promiseallsettled\">#</a> å®ç° <code>Promise.allSettled()</code></h1>\n<h2 id=\"promiseallsettled\"><a class=\"anchor\" href=\"#promiseallsettled\">#</a> Promise.allSettled()</h2>\n<p><code>Promise.allSettled()</code>  æ–¹æ³•è¿”å›ä¸€ä¸ªåœ¨æ‰€æœ‰ç»™å®šçš„ <code>promise</code>  éƒ½å·²ç» <code>fulfilled</code>  æˆ– <code>rejected</code>  åçš„ <code>promise</code> ï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡è¡¨ç¤ºå¯¹åº”çš„ <code>promise</code>  ç»“æœã€‚</p>\n<h3 id=\"ç¤ºä¾‹-3\"><a class=\"anchor\" href=\"#ç¤ºä¾‹-3\">#</a> ç¤ºä¾‹</h3>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Promise<span class=\"token punctuation\">.</span><span class=\"token function\">allSettled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">33</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">66</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token number\">99</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ä¸€ä¸ªé”™è¯¯\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">values</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// [</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//   &#123; status: 'fulfilled', value: 33 &#125;,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">//   &#123; status: 'fulfilled', value: 66 &#125;,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">//   &#123; status: 'fulfilled', value: 99 &#125;,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">//   &#123;status: 'rejected', reason: Error: ä¸€ä¸ªé”™è¯¯&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// ]</span></pre></td></tr></table></figure><h2 id=\"ä»£ç å®ç°-6\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-6\">#</a> ä»£ç å®ç°</h2>\n<ol>\n<li>é€šè¿‡ä¸€ä¸ªæ•°ç»„å­˜å‚¨æ¯ä¸ª Promise å®Œæˆåçš„ç»“æœ</li>\n<li>æ³¨æ„æ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯ <code>resolve</code>  å’Œ <code>reject</code>  åçš„ç»“æœï¼Œæ‰€ä»¥éœ€è¦åˆ†åˆ«å¤„ç†ã€‚</li>\n<li>ä½¿ç”¨ <code>.finally()</code>  æ–¹æ³•ï¼Œå½“ Promise å®Œæˆæ—¶è°ƒç”¨ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @param &#123;Array&lt;any>&#125; promises - notice that input might contains non-promises</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @return &#123;Promise&lt;Array&lt;&#123;status: 'fulfilled', value: any&#125; | &#123;status: 'rejected', reason: any&#125;>>&#125;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">allSettled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promises</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">let</span> results <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">let</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>promises<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">const</span> promise <span class=\"token operator\">=</span> promises<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          results<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">status</span><span class=\"token operator\">:</span> <span class=\"token string\">'fulfilled'</span><span class=\"token punctuation\">,</span> value <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          results<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">status</span><span class=\"token operator\">:</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">,</span> reason <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          idx <span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>idx <span class=\"token operator\">===</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr />\n<h1 id=\"å®ç°promiseany\"><a class=\"anchor\" href=\"#å®ç°promiseany\">#</a> å®ç° <code>Promise.any()</code></h1>\n<h2 id=\"promiseany\"><a class=\"anchor\" href=\"#promiseany\">#</a> Promise.any()</h2>\n<p><code>Promise.any()</code>  æ¥æ”¶ä¸€ä¸ª <code>Promise</code>  å¯è¿­ä»£å¯¹è±¡ï¼Œåªè¦å…¶ä¸­çš„ä¸€ä¸ª  <code>promise</code>  æˆåŠŸï¼Œå°±è¿”å›é‚£ä¸ªå·²ç»æˆåŠŸçš„  <code>promise</code>  ã€‚å¦‚æœå¯è¿­ä»£å¯¹è±¡ä¸­æ²¡æœ‰ä¸€ä¸ª  <code>promise</code>  æˆåŠŸï¼ˆå³æ‰€æœ‰çš„  <code>promises</code>  éƒ½å¤±è´¥ / æ‹’ç»ï¼‰ï¼Œå°±è¿”å›ä¸€ä¸ªå¤±è´¥çš„  <code>promise</code>  å’Œ <code>AggregateError</code>  ç±»å‹çš„å®ä¾‹ï¼Œå®ƒæ˜¯  <code>Error</code>  çš„ä¸€ä¸ªå­ç±»ï¼Œç”¨äºæŠŠå•ä¸€çš„é”™è¯¯é›†åˆåœ¨ä¸€èµ·ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å’Œ <code>Promise.all()</code>  æ˜¯ç›¸åçš„ã€‚</p>\n<h2 id=\"ä»£ç å®ç°-7\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-7\">#</a> ä»£ç å®ç°</h2>\n<ol>\n<li>æ•°ç»„å­˜å‚¨æ¯ä¸ª <code>promise</code>  å¤±è´¥çš„åŸå› ã€‚</li>\n<li>ä½¿ç”¨ <code>.catch()</code>  æ–¹æ³•ï¼Œå½“ Promise å…¨éƒ¨å¤±è´¥æ—¶è°ƒç”¨ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promise å¯¹è±¡åŒ…å« <code>AggregateError</code> ã€‚</li>\n<li>å½“æœ‰ä¸€ä¸ª <code>promise</code>  æˆåŠŸæ—¶ç›´æ¥ <code>resolve</code>  æ‰</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @param &#123;Array&lt;Promise>&#125; promises</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @return &#123;Promise&#125;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promises</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">let</span> results <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">let</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">const</span> promise <span class=\"token operator\">=</span> promises<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      promise</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          results<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          idx <span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>idx <span class=\"token operator\">===</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AggregateError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"æ‰‹å†™_clonedeep\"><a class=\"anchor\" href=\"#æ‰‹å†™_clonedeep\">#</a> æ‰‹å†™ <code>_.cloneDeep()</code></h1>\n<p>å®ç°æ·±æ‹·è´æ”¯æŒ</p>\n<ul>\n<li>åŸºç¡€æ•°æ®ç±»å‹åŠå…¶ wrapper object</li>\n<li>ç®€å• Objectï¼ˆå¯æšä¸¾å±æ€§ï¼‰</li>\n<li>æ•°ç»„ Array</li>\n<li>æ³¨æ„å¾ªç¯å¼•ç”¨</li>\n</ul>\n<h2 id=\"ä»£ç å®ç°-8\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-8\">#</a> ä»£ç å®ç°</h2>\n<p><strong>ä»€ä¹ˆæ˜¯ <code>WeakMap</code> ï¼Ÿ</strong><br />\n <code>WeakMap</code>  æ˜¯ä¸€ä¸ªé”®å€¼å¯¹é›†åˆï¼Œé”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œå€¼å¯ä»¥æ˜¯ä»»æ„ç±»å‹ã€‚ <code>WeakMap</code>  å¯¹é”®çš„å¼•ç”¨æ˜¯å¼±å¼•ç”¨<br />\né€šè¿‡ <code>WeakMap</code>  è®°å½•å·²ç»æ‹·è´çš„å¯¹è±¡ï¼Œé¿å…å¾ªç¯å¼•ç”¨</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> visited <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">cloneDeep</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> data <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">\"number\"</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'boolean'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'symbol'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'bigint'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>visited<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> visited<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  visited<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      res<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">cloneDeep</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">of</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">ownKeys</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      res<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">cloneDeep</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"promise-rejectçš„æ—¶å€™è‡ªåŠ¨retry\"><a class=\"anchor\" href=\"#promise-rejectçš„æ—¶å€™è‡ªåŠ¨retry\">#</a> Promise reject çš„æ—¶å€™è‡ªåŠ¨ retry</h1>\n<p>å®ç°ä¸€ä¸ª fetchWithAutoRetry (fetcher, count)ï¼Œå½“å‡ºé”™çš„æ—¶å€™ä¼šè‡ªåŠ¨é‡è¯•ï¼Œç›´åˆ°æœ€å¤§çš„é‡è¯•æ¬¡æ•°ã€‚</p>\n<h2 id=\"ä»£ç å®ç°-9\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-9\">#</a> ä»£ç å®ç°</h2>\n<ol>\n<li>Promise é“¾çš„é“¾æ¥<br />\n <code>fetcher</code>  è¿”å›ä¸€ä¸ª Promise<br />\n å¦‚æœ <code>fetcher</code>  æˆåŠŸåï¼Œå°±ä¼šè¿”å›æˆåŠŸç»“æœ<br />\nå¦‚æœ <code>fetcher</code>  å¤±è´¥åï¼Œ <code>.catch()</code>  è¢«è§¦å‘<br />\nåœ¨ <code>.catch()</code>  ä¸­ï¼Œå¦‚æœæ¬¡æ•°ç”¨å®Œäº†ç›´æ¥è¿”å›å¤±è´¥ç»“æœï¼Œå¦åˆ™å°†ç»§ç»­æ‰§è¡Œ <code>fetcher</code></li>\n<li>é€’å½’å·¥ä½œ<br />\næ¯æ¬¡é€’å½’å‡å°‘æ¬¡æ•°<br />\næ¬¡æ•°ä¸º 0 æ—¶åœæ­¢ï¼ŒæŠ›å‡ºé”™è¯¯<br />\næ¯æ¬¡é€’å½’è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œè¿™ä¸ª Promise ä¼šè¢«ä¸Šä¸€çº§çš„.catch () é“¾æ¥èµ·æ¥ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @param &#123;() => Promise&lt;any>&#125; fetcher</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param &#123;number&#125; maximumRetryCount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @return &#123;Promise&lt;any>&#125;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">fetchWithAutoRetry</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fetcher<span class=\"token punctuation\">,</span> maximumRetryCount</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">fetcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>maximumRetryCount <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">fetchWithAutoRetry</span><span class=\"token punctuation\">(</span>fetcher<span class=\"token punctuation\">,</span> maximumRetryCount <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å®ç°è´Ÿç´¢å¼•\"><a class=\"anchor\" href=\"#å®ç°è´Ÿç´¢å¼•\">#</a> å®ç°è´Ÿç´¢å¼•</h1>\n<h2 id=\"å®ç°æ€è·¯\"><a class=\"anchor\" href=\"#å®ç°æ€è·¯\">#</a> å®ç°æ€è·¯</h2>\n<p>é€šè¿‡ Proxy ä»£ç†å®ç°ï¼Œè®¾ç½® <code>get</code>  æ–¹æ³•é€šè¿‡ <code>Reflect.get</code>  è·å–å±æ€§å€¼ï¼Œå¹¶è¿”å›ç»“æœã€‚è®¾ç½® <code>set</code>  æ–¹æ³•é€šè¿‡ <code>Reflect.set</code>  è®¾ç½®å±æ€§å€¼ï¼Œå¹¶è¿”å›ç»“æœã€‚</p>\n<h2 id=\"ä»£ç å®ç°-10\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-10\">#</a> ä»£ç å®ç°</h2>\n<p>æ³¨æ„åˆ¤æ–­ç´¢å¼•è¿˜æ˜¯æ–¹æ³•</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isNumber</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prop</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">typeof</span> prop <span class=\"token operator\">!==</span> <span class=\"token string\">'symbol'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>prop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">normalizeProp</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prop<span class=\"token punctuation\">,</span> arrLength</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> prop <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> prop <span class=\"token operator\">:</span> prop <span class=\"token operator\">+</span> arrLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> reciever<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isNumber</span><span class=\"token punctuation\">(</span>prop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        prop <span class=\"token operator\">=</span> <span class=\"token function\">normalizeProp</span><span class=\"token punctuation\">(</span><span class=\"token operator\">+</span>prop<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> reciever<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> reciever<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isNumber</span><span class=\"token punctuation\">(</span>prop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        prop <span class=\"token operator\">=</span> <span class=\"token function\">normalizeProp</span><span class=\"token punctuation\">(</span><span class=\"token operator\">+</span>prop<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>prop <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> prop<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> reciever<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å®ç°domçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–\"><a class=\"anchor\" href=\"#å®ç°domçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–\">#</a> å®ç° DOM çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h1>\n<p>å°† DOM åºåˆ—åŒ–ä¸ºå¯¹è±¡ï¼Œå¯¹è±¡ååºåˆ—åŒ–ä¸º DOMã€‚</p>\n<h2 id=\"å®ç°æ€è·¯-2\"><a class=\"anchor\" href=\"#å®ç°æ€è·¯-2\">#</a> å®ç°æ€è·¯</h2>\n<ol>\n<li>è·å– DOM èŠ‚ç‚¹ï¼Œé€šè¿‡ <code>tagName</code>  å¯ä»¥å¾—åˆ°èŠ‚ç‚¹ç±»å‹ï¼Œé€šè¿‡ <code>attributes</code>  å¯ä»¥å¾—åˆ°èŠ‚ç‚¹çš„å±æ€§ï¼Œå†é€šè¿‡ <code>childNodes</code>  å»éå†å­èŠ‚ç‚¹ã€‚é€’å½’æ·»åŠ åˆ°å¯¹è±¡ä¸­ã€‚</li>\n<li>å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡ <code>createElement</code>  åˆ›å»ºèŠ‚ç‚¹ï¼Œç›´æ¥è®¾ç½® <code>element[key] = value</code>  å¯ä»¥å°†å±æ€§è®¾ç½®åˆ°èŠ‚ç‚¹ä¸Šã€‚é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹ã€‚</li>\n</ol>\n<h2 id=\"ä»£ç å®ç°-11\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-11\">#</a> ä»£ç å®ç°</h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @param &#123;HTMLElement&#125; </pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @return &#123;object&#125; object literal presentation</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">virtualize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>tagName<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ ‡ç­¾å</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> attr <span class=\"token keyword\">of</span> element<span class=\"token punctuation\">.</span>attributes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// è·å–å±æ€§</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> attr<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'class'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'className'</span> <span class=\"token operator\">:</span> attr<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    result<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> attr<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> node <span class=\"token keyword\">of</span> element<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>nodeType <span class=\"token operator\">===</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// æ–‡æœ¬èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>textContent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// å…¶ä»–èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">virtualize</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  result<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> children<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> * @param &#123;object&#125; valid object literal presentation</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> * @return &#123;HTMLElement&#125; </pre></td></tr><tr><td data-num=\"31\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">json</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">// create the top level emlement</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// recursively append the children</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// textnode</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> json <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// æ–‡æœ¬èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">return</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>type<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>children<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>attrs<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> json<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">]</span> <span class=\"token keyword\">of</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span>attrs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    element<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è®¾ç½®å±æ€§</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token keyword\">const</span> childrenArr <span class=\"token operator\">=</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>children<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> children <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>children<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> child <span class=\"token keyword\">of</span> childrenArr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    element<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">return</span> element<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"æ‰‹å†™promiseprototypefinally\"><a class=\"anchor\" href=\"#æ‰‹å†™promiseprototypefinally\">#</a> æ‰‹å†™ <code>Promise.prototype.finally()</code></h1>\n<p>å¯ä»¥å† <code>promise</code>  è¢« <code>settle</code>  çš„æ—¶å€™æ‰§è¡Œä¸€ä¸ª <code>callback</code> ï¼Œæ— è®ºæ˜¯å¦è¢« <code>fulfill</code>  æˆ–è€… <code>reject</code> ï¼Œéƒ½ä¼šæ‰§è¡Œ <code>callback</code> ã€‚</p>\n<h2 id=\"å®ç°æ€è·¯-3\"><a class=\"anchor\" href=\"#å®ç°æ€è·¯-3\">#</a> å®ç°æ€è·¯</h2>\n<p>è¿”å›ä¸€ä¸ª <code>Promise</code>  å½“å‰ <code>promise</code>  è¢« <code>settle</code>  çš„æ—¶å€™æ‰§è¡Œ <code>callback</code> ï¼Œå¹¶è¿”å› <code>promise</code> ã€‚æ³¨æ„å›è°ƒå‡½æ•°å¯èƒ½è¿”å›ä¸€ä¸ª <code>promise</code> ï¼Œå¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ª <code>promise</code> ï¼Œåˆ™è¿”å›çš„ <code>promise</code>  çš„çŠ¶æ€å’Œ <code>callback</code>  çš„è¿”å›å€¼ä¸€è‡´ã€‚</p>\n<h2 id=\"ä»£ç å®ç°-12\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-12\">#</a> ä»£ç å®ç°</h2>\n<p>è®¾ç½®æ— è®ºå½“ <code>promise</code>  è¢« <code>fulfill</code>  æˆ–è€… <code>reject</code>  çš„æ—¶å€™æ‰§è¡Œ <code>onFinally</code> ï¼Œå¦‚æœ <code>onFinally</code>  è¿”å›çš„æ˜¯ä¸€ä¸ª <code>promise</code> ï¼Œåˆ™è¿”å›çš„ <code>promise</code>  çš„çŠ¶æ€å’Œ <code>onFinally</code>  çš„è¿”å›å€¼ä¸€è‡´ã€‚å½“ <code>await</code>  ä¸€ä¸ªè¢« <code>reject</code>  çš„ <code>promise</code>  ç›¸å½“äºæŠ›å‡ºå¼‚å¸¸</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @param &#123;Promise&lt;any>&#125; promise</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param &#123;() => void&#125; onFinally</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @returns &#123;Promise&lt;any>&#125;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myFinally</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> onFinally</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">return</span> promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// console.log(1);</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">await</span> <span class=\"token function\">onFinally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">await</span> <span class=\"token function\">onFinally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">const</span> promise <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">myFinally</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      res<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 4</span></pre></td></tr></table></figure><h1 id=\"åˆ›å»ºlazyman\"><a class=\"anchor\" href=\"#åˆ›å»ºlazyman\">#</a> åˆ›å»º LazyMan</h1>\n<h2 id=\"å®ç°æ€è·¯-4\"><a class=\"anchor\" href=\"#å®ç°æ€è·¯-4\">#</a> å®ç°æ€è·¯</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªæ“ä½œå¯¹è±¡</li>\n<li>åœ¨å¯¹è±¡ä¸­ä¿®æ”¹å‡½æ•°ä¸­çš„å±æ€§ï¼Œå¹¶è¿”å›å¯¹è±¡æœ¬èº«ï¼Œå®ç°é“¾å¼è°ƒç”¨</li>\n<li>é€šè¿‡ <code>setTimeout</code>  æ¥å°†ä»»åŠ¡åŠ å…¥å»¶æ—¶é˜Ÿåˆ—ï¼Œåªæœ‰å½“è¿™æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¿™æ¬¡é“¾å¼è°ƒç”¨æ—¶ï¼Œ <code>setTimeout</code>  ä»»åŠ¡å¤„ç†å‡½æ•°å¹¶ä¸ä¼šæ‰§è¡Œï¼Œç­‰åˆ°é“¾å¼è°ƒç”¨ç»“æŸï¼Œæ‰ä¼šæ‰§è¡Œ <code>setTimeout</code>  ä»»åŠ¡å¤„ç†å‡½æ•°ã€‚</li>\n</ol>\n<h2 id=\"ä»£ç å®ç°-13\"><a class=\"anchor\" href=\"#ä»£ç å®ç°-13\">#</a> ä»£ç å®ç°</h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// interface Laziness &#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//   sleep: (time: number) => Laziness</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//   sleepFirst: (time: number) => Laziness</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//   eat: (food: string) => Laziness</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// &#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param &#123;string&#125; name</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @param &#123;(log: string) => void&#125; logFn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * @returns &#123;Laziness&#125;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">LazyMan</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> logFn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// your code here</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">let</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token function\">logFn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Hi, I'm </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">const</span> Man <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function-variable function\">eat</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token function\">logFn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Eat </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token function-variable function\">sleep</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">delay</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token function\">logFn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Wake up after </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>delay<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>delay <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token string\">'seconds'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'second'</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function-variable function\">sleepFirst</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">delay</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      queue<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span><span class=\"token function\">logFn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Wake up after </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>delay<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>delay <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token string\">'seconds'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'second'</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>task <span class=\"token keyword\">of</span> queue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">await</span> <span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">return</span> Man<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token function\">LazyMan</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Jack'</span><span class=\"token punctuation\">,</span> console<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token string\">'banana'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">eat</span><span class=\"token punctuation\">(</span><span class=\"token string\">'apple'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">sleepFirst</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">// Wake up after 2 seconds.</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">// Hi, I'm Jack.</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">// Eat banana.</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">// Eat apple.</span></pre></td></tr></table></figure><h1 id=\"æ•°ç»„æ‰å¹³åŒ–çš„å¤šç§å†™æ³•\"><a class=\"anchor\" href=\"#æ•°ç»„æ‰å¹³åŒ–çš„å¤šç§å†™æ³•\">#</a> æ•°ç»„æ‰å¹³åŒ–çš„å¤šç§å†™æ³•</h1>\n<h2 id=\"ç›®å‰å…­ç§\"><a class=\"anchor\" href=\"#ç›®å‰å…­ç§\">#</a> ç›®å‰å…­ç§</h2>\n<h2 id=\"ä»£ç \"><a class=\"anchor\" href=\"#ä»£ç \">#</a> ä»£ç </h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 1. Array.prototype.flat()</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">flat</span><span class=\"token punctuation\">(</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 2. æ‰‹å†™é€’å½’ flat</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myFlat</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arrs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> arr <span class=\"token keyword\">of</span> arrs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            res <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token function\">myFlat</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            res<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">myFlat</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// 3. reduce</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myFlat2</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arrs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> arrs<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pre<span class=\"token punctuation\">,</span> cur</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> pre<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>cur<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">myFlat2</span><span class=\"token punctuation\">(</span>cur<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> cur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">myFlat2</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// 4. æ‰©å±•è¿ç®—ç¬¦</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myFlat3</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arrs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>arrs<span class=\"token punctuation\">.</span><span class=\"token function\">some</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        arrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>arrs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> arrs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">myFlat3</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">// 5. toString + split (ä»…é™äºæ•°å­—æ•°ç»„)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myFlat4</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arrs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">return</span> arrs<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">myFlat4</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">// 6. JSON.stringify + parse</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myFlat5</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arrs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">let</span> str <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>arrs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    str <span class=\"token operator\">=</span> str<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">(\\[|\\])</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    str <span class=\"token operator\">=</span> <span class=\"token string\">'['</span> <span class=\"token operator\">+</span> str <span class=\"token operator\">+</span> <span class=\"token string\">']'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">myFlat5</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"å¸¦æ ‡ç­¾çš„æ¨¡æ¿\"><a class=\"anchor\" href=\"#å¸¦æ ‡ç­¾çš„æ¨¡æ¿\">#</a> å¸¦æ ‡ç­¾çš„æ¨¡æ¿</h1>\n<p>å¸¦æ ‡ç­¾çš„æ¨¡æ¿æ˜¯æ¨¡æ¿å­—é¢é‡çš„ä¸€ç§æ›´é«˜çº§çš„å½¢å¼ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨å‡½æ•°è§£ææ¨¡æ¿å­—é¢é‡ã€‚æ ‡ç­¾å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå…¶ä½™çš„å‚æ•°ä¸è¡¨è¾¾å¼ç›¸å…³ã€‚ä½ å¯ä»¥ç”¨æ ‡ç­¾å‡½æ•°å¯¹è¿™äº›å‚æ•°æ‰§è¡Œä»»ä½•æ“ä½œï¼Œå¹¶è¿”å›è¢«æ“ä½œè¿‡çš„å­—ç¬¦ä¸²ï¼ˆæˆ–è€…ï¼Œä¹Ÿå¯è¿”å›å®Œå…¨ä¸åŒçš„å†…å®¹ï¼Œè§ä¸‹é¢çš„ç¤ºä¾‹ï¼‰ã€‚ç”¨ä½œæ ‡ç­¾çš„å‡½æ•°åæ²¡æœ‰é™åˆ¶ã€‚</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> person <span class=\"token operator\">=</span> <span class=\"token string\">\"Mike\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> age <span class=\"token operator\">=</span> <span class=\"token number\">28</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">myTag</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">strings<span class=\"token punctuation\">,</span> personExp<span class=\"token punctuation\">,</span> ageExp</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> str0 <span class=\"token operator\">=</span> strings<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"That \"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> str1 <span class=\"token operator\">=</span> strings<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \" is a \"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> str2 <span class=\"token operator\">=</span> strings<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \".\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> ageStr <span class=\"token operator\">=</span> ageExp <span class=\"token operator\">></span> <span class=\"token number\">99</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"centenarian\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"youngster\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// æˆ‘ä»¬ç”šè‡³å¯ä»¥è¿”å›ä½¿ç”¨æ¨¡æ¿å­—é¢é‡æ„å»ºçš„å­—ç¬¦ä¸²</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>str0<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>personExp<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>str1<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>ageStr<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>str2<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> myTag<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">That </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>person<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> is a </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>age<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// That Mike is a youngster.</span></pre></td></tr></table></figure><figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">p</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">strings<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>values</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>strings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>p<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">h</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token number\">1</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">, h</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">, h</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token number\">3</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// => [ 'h', ', h', ', h' ]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// => [ 1, 2, 3 ]</span></pre></td></tr></table></figure>",
            "tags": [
                "js",
                "js"
            ]
        },
        {
            "id": "https://aynya.github.io/%E7%94%A8Cookie-HttpOnly%E5%AE%9E%E7%8E%B0%E5%8F%8CToken%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%BB%91%E5%8A%A8%E5%88%B7%E6%96%B0/",
            "url": "https://aynya.github.io/%E7%94%A8Cookie-HttpOnly%E5%AE%9E%E7%8E%B0%E5%8F%8CToken%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%BB%91%E5%8A%A8%E5%88%B7%E6%96%B0/",
            "title": "ç”¨Cookie+HttpOnlyå®ç°åŒTokenè®¤è¯ä¸æ»‘åŠ¨åˆ·æ–°",
            "date_published": "2025-04-03T15:21:04.000Z",
            "content_html": "<h1 id=\"ç”¨-cookiehttponly-å®ç°åŒ-token-è®¤è¯ä¸æ»‘åŠ¨åˆ·æ–°\"><a class=\"anchor\" href=\"#ç”¨-cookiehttponly-å®ç°åŒ-token-è®¤è¯ä¸æ»‘åŠ¨åˆ·æ–°\">#</a> ç”¨ Cookie+HttpOnly å®ç°åŒ Token è®¤è¯ä¸æ»‘åŠ¨åˆ·æ–°</h1>\n<h2 id=\"ä¸ºä»€ä¹ˆéœ€è¦åŒ-token-æ–¹æ¡ˆ\"><a class=\"anchor\" href=\"#ä¸ºä»€ä¹ˆéœ€è¦åŒ-token-æ–¹æ¡ˆ\">#</a> ä¸ºä»€ä¹ˆéœ€è¦åŒ Token æ–¹æ¡ˆï¼Ÿ</h2>\n<p>ä¼ ç»Ÿå• Token æ–¹æ¡ˆé¢ä¸´ä¸¤å¤§ç—›ç‚¹ï¼š</p>\n<ol>\n<li><strong>å®‰å…¨é£é™©</strong> - Token æ³„éœ²ç­‰äºæ°¸ä¹…å…¥ä¾µ</li>\n<li><strong>ä½“éªŒé—®é¢˜</strong> - é¢‘ç¹é‡æ–°ç™»å½•å½±å“ç”¨æˆ·ä½“éªŒ</li>\n</ol>\n<p>åŒ Token æ–¹æ¡ˆå®Œç¾è§£å†³ï¼š</p>\n<ul>\n<li>ğŸ›¡ï¸ <strong>Access Tokenï¼ˆçŸ­æ—¶æ•ˆï¼‰</strong>ï¼š15-30 åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œé™ä½è¢«ç›—é£é™©</li>\n<li>ğŸ”„ <strong>Refresh Tokenï¼ˆé•¿æ—¶æ•ˆï¼‰</strong>ï¼š7-30 å¤©æœ‰æ•ˆæœŸï¼Œé™é»˜åˆ·æ–°ä¼šè¯</li>\n</ul>\n<h2 id=\"æŠ€æœ¯é€‰å‹\"><a class=\"anchor\" href=\"#æŠ€æœ¯é€‰å‹\">#</a> æŠ€æœ¯é€‰å‹</h2>\n<table>\n<thead>\n<tr>\n<th>ç»„ä»¶</th>\n<th>æ–¹æ¡ˆ</th>\n<th>ä¼˜åŠ¿è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Access Token</td>\n<td>JWT + localStorage</td>\n<td>æ–¹ä¾¿å‰ç«¯ä½¿ç”¨ï¼Œè‡ªåŠ¨è¿‡æœŸ</td>\n</tr>\n<tr>\n<td>Refresh Token</td>\n<td>HttpOnly Cookie</td>\n<td>é˜²æ­¢ XSS çªƒå–ï¼ŒæœåŠ¡ç«¯å¯æ§</td>\n</tr>\n<tr>\n<td>åŠ å¯†ç®—æ³•</td>\n<td>bcrypt</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"å®ç°æ ¸å¿ƒæµç¨‹\"><a class=\"anchor\" href=\"#å®ç°æ ¸å¿ƒæµç¨‹\">#</a> å®ç°æ ¸å¿ƒæµç¨‹</h2>\n<pre><code>ğŸ”‘ è®¤è¯æµç¨‹å…¨è§£æï¼ˆâ†’ è¡¨ç¤ºè¯·æ±‚ï¼Œâ† è¡¨ç¤ºå“åº”ï¼‰\n\n1. ã€ç™»å½•é˜¶æ®µã€‘\nç”¨æˆ· â†’ å‰ç«¯ï¼šæäº¤è´¦å·å¯†ç \nå‰ç«¯ â†’ åç«¯ï¼šPOST /login\nåç«¯ â† å‰ç«¯ï¼š\n   â”‚ HTTP Status 200\n   â”œâ”€ Headers: Set-Cookie: refreshToken=xxx; HttpOnly\n   â””â”€ Body: &#123; &quot;accessToken&quot;: &quot;jwt_token&quot; &#125;\n\n2. ã€æ­£å¸¸è¯·æ±‚ã€‘\nç”¨æˆ· â†’ å‰ç«¯ï¼šå‘èµ·æ•°æ®è¯·æ±‚\nå‰ç«¯ â†’ åç«¯ï¼š\n   â”‚ Headers: Authorization: Bearer accessToken\n   â”œâ”€ è¯·æ±‚æ•æ„Ÿæ•°æ®\nåç«¯ â† å‰ç«¯ï¼š\n   â”‚ HTTP Status 401ï¼ˆTokenè¿‡æœŸï¼‰\n   â””â”€ Body: &#123; &quot;error&quot;: &quot;Token expired&quot; &#125;\n\n3. ã€è‡ªåŠ¨åˆ·æ–°ã€‘\nå‰ç«¯ â†’ åç«¯ï¼šPOST /refresh-token\n   â”‚ è‡ªåŠ¨æºå¸¦ Cookie: refreshToken=xxx\nåç«¯ â† å‰ç«¯ï¼š\n   â”‚ HTTP Status 200\n   â””â”€ Body: &#123; &quot;accessToken&quot;: &quot;new_jwt_token&quot; &#125;\n\n4. ã€é‡è¯•è¯·æ±‚ã€‘\nå‰ç«¯ â†’ åç«¯ï¼šé‡æ–°å‘é€åŸå§‹è¯·æ±‚\n   â”‚ Headers: Authorization: Bearer new_jwt_token\nåç«¯ â† å‰ç«¯ï¼š\n   â”‚ HTTP Status 200\n   â””â”€ Body: è¯·æ±‚æ•°æ®\n</code></pre>\n<h2 id=\"æ ¸å¿ƒä»£ç å®ç°\"><a class=\"anchor\" href=\"#æ ¸å¿ƒä»£ç å®ç°\">#</a> æ ¸å¿ƒä»£ç å®ç°</h2>\n<h3 id=\"åç«¯å…³é”®ä»£ç \"><a class=\"anchor\" href=\"#åç«¯å…³é”®ä»£ç \">#</a> åç«¯å…³é”®ä»£ç </h3>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// ç™»å½•æ¥å£</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>router<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/login'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">//... éªŒè¯ç”¨æˆ·åå¯†ç </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// ç”ŸæˆåŒ Token</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> accessToken <span class=\"token operator\">=</span> <span class=\"token function\">generateAccessToken</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> refreshToken <span class=\"token operator\">=</span> <span class=\"token function\">generateRefreshToken</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½® HttpOnly Cookieï¼ˆæ³¨æ„å®‰å…¨é…ç½®ï¼ï¼‰</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">cookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">'refreshToken'</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token literal-property property\">httpOnly</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token literal-property property\">secure</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token literal-property property\">sameSite</span><span class=\"token operator\">:</span> <span class=\"token string\">'lax'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token literal-property property\">maxAge</span><span class=\"token operator\">:</span> <span class=\"token number\">7</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token comment\">// 7 å¤©</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> accessToken <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// åˆ·æ–°æ¥å£</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>router<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/refresh'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">const</span> refreshToken <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>refreshToken<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è‡ªåŠ¨æºå¸¦</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">const</span> decoded <span class=\"token operator\">=</span> <span class=\"token function\">verifyRefreshToken</span><span class=\"token punctuation\">(</span>refreshToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">const</span> newAccessToken <span class=\"token operator\">=</span> <span class=\"token function\">generateAccessToken</span><span class=\"token punctuation\">(</span>decoded<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">accessToken</span><span class=\"token operator\">:</span> newAccessToken <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">clearCookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">'refreshToken'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å‰ç«¯æ‹¦æˆªå™¨\"><a class=\"anchor\" href=\"#å‰ç«¯æ‹¦æˆªå™¨\">#</a> å‰ç«¯æ‹¦æˆªå™¨</h3>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//axios å®ä¾‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> api <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">baseURL</span><span class=\"token operator\">:</span> <span class=\"token constant\">API_URL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token literal-property property\">withCredentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// å…³é”®é…ç½®ï¼</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// å“åº”æ‹¦æˆªå™¨</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>api<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRequest <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">401</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>originalRequest<span class=\"token punctuation\">.</span>_retry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    originalRequest<span class=\"token punctuation\">.</span>_retry <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> data <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> api<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/refresh'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'accessToken'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">api</span><span class=\"token punctuation\">(</span>originalRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"é¿å‘æŒ‡å—\"><a class=\"anchor\" href=\"#é¿å‘æŒ‡å—\">#</a> é¿å‘æŒ‡å—ğŸš¨</h2>\n<ol>\n<li><strong>CORS é…ç½®</strong>ï¼šæœªå¯ç”¨ CORS å‡­è¯</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åç«¯å¿…é¡»é…ç½®</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">origin</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:3000'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token literal-property property\">credentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// å…³é”®ï¼</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>Cookie å‚æ•°</strong>ï¼šCookie å‚æ•°é…ç½®é”™è¯¯</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>res<span class=\"token punctuation\">.</span><span class=\"token function\">cookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">'refreshToken'</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">httpOnly</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">secure</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ç”Ÿäº§ç¯å¢ƒå¿…é¡» true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token literal-property property\">sameSite</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'none'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'lax'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>ç¼ºå°‘ cookie-parser ä¸­é—´ä»¶</strong></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> cookie-parser</pre></td></tr></table></figure><figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> cookieParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cookie-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cookieParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li><strong>å‰ç«¯è¯·æ±‚å¤´</strong>ï¼šå‰ç«¯è¯·æ±‚å¤´é…ç½®é”™è¯¯</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//axios é…ç½®</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">withCredentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr></table></figure><h2 id=\"æ»‘åŠ¨åˆ·æ–°refreshtokenå®ç°\"><a class=\"anchor\" href=\"#æ»‘åŠ¨åˆ·æ–°refreshtokenå®ç°\">#</a> æ»‘åŠ¨åˆ·æ–° refreshToken å®ç°</h2>\n<p><strong>ä»€ä¹ˆæ˜¯æ»‘åŠ¨åˆ·æ–°æœºåˆ¶ï¼Ÿ</strong><br />\næ»‘åŠ¨åˆ·æ–°æœºåˆ¶æ˜¯æŒ‡åœ¨ç”¨æˆ·æ‰§è¡ŒæŸäº›å…³é”®æ“ä½œï¼ˆå¦‚è¿›å…¥æˆ¿é—´ã€æäº¤è¡¨å•ç­‰ï¼‰æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ£€æŸ¥å¹¶æ›´æ–° refreshToken çš„æœ‰æ•ˆæœŸã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…ä¿æŒæ´»è·ƒçŠ¶æ€ï¼Œè€Œä¸ä¼šå› ä¸º refreshToken è¿‡æœŸè€Œè¢«è¿«é‡æ–°ç™»å½•ã€‚</p>\n<ol>\n<li><strong>ä»è¯·æ±‚ä¸­è·å– refreshToken</strong></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> refreshTokenFromCookie <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>refreshToken<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>refreshTokenFromCookie<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'åˆ·æ–°ä»¤ç‰Œç¼ºå¤±ï¼'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>éªŒè¯ refreshToken æ˜¯å¦æœ‰æ•ˆ</strong></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">const</span> decoded <span class=\"token operator\">=</span> <span class=\"token function\">verifyRefreshToken</span><span class=\"token punctuation\">(</span>refreshTokenFromCookie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>decoded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œï¼'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'éªŒè¯åˆ·æ–°ä»¤ç‰Œå¤±è´¥ï¼'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>ç”Ÿæˆæ–°çš„ refreshToken å¹¶è®¾ç½®åˆ° Cookie</strong><br />\n è¿™é‡Œçš„ <code>config.jwtRefreshTokenExpiry</code>  æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">userId</span><span class=\"token operator\">:</span> decoded<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">nickname</span><span class=\"token operator\">:</span> decoded<span class=\"token punctuation\">.</span>nickname <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> newRefreshToken <span class=\"token operator\">=</span> <span class=\"token function\">generateRefreshToken</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> jwtExpiryInSeconds <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>jwtRefreshTokenExpiry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> cookieMaxAge <span class=\"token operator\">=</span> jwtExpiryInSeconds <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>res<span class=\"token punctuation\">.</span><span class=\"token function\">cookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">'refreshToken'</span><span class=\"token punctuation\">,</span> newRefreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token literal-property property\">httpOnly</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token literal-property property\">secure</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token literal-property property\">sameSite</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'none'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'lax'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token literal-property property\">domain</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'.yourdomain.com'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token literal-property property\">maxAge</span><span class=\"token operator\">:</span> cookieMaxAge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>é€šè¿‡ HttpOnly Cookie + JWT çš„åŒ Token æ–¹æ¡ˆï¼Œæˆ‘ä»¬å®ç°äº†ï¼š</p>\n<ul>\n<li>âœ… æ›´é«˜çš„å®‰å…¨æ€§ï¼ˆé˜² XSS çªƒå–ï¼‰</li>\n<li>âœ… æ— ç¼çš„ç”¨æˆ·ä½“éªŒï¼ˆé™é»˜åˆ·æ–°ï¼‰</li>\n<li>âœ… çµæ´»çš„æ§åˆ¶èƒ½åŠ›ï¼ˆå¼ºåˆ¶ä¸‹çº¿ã€è®¾å¤‡ç®¡ç†ï¼‰</li>\n</ul>\n<p>å®Œæ•´ä»£ç  <a href=\"\">https://github.com/aynya/VoiceChat</a></p>\n",
            "tags": [
                "React",
                "React",
                "Node.js",
                "Cookie",
                "HttpOnly",
                "JWT",
                "Token"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%81%8A%E5%A4%A9%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E8%B7%B3%E8%BD%AC/",
            "url": "https://aynya.github.io/%E8%81%8A%E5%A4%A9%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E8%B7%B3%E8%BD%AC/",
            "title": "èŠå¤©å†å²è®°å½•è·³è½¬",
            "date_published": "2025-04-01T15:38:09.000Z",
            "content_html": "<h3 id=\"å‰ç½®\"><a class=\"anchor\" href=\"#å‰ç½®\">#</a> å‰ç½®</h3>\n<ol>\n<li>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒèŠå¤©è®°å½•æ˜¯æ»šåŠ¨çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ»šåŠ¨æ¡çš„ä½ç½®ï¼Œç„¶åï¼Œé€šè¿‡æ»šåŠ¨æ¡çš„ä½ç½®ï¼Œæ¥å®šä½åˆ°èŠå¤©è®°å½•çš„ä½ç½®ã€‚</li>\n<li>èŠå¤©è®°å½•çš„  <code>flex-direction</code>  æ˜¯ <code>column-reverse</code>  çš„ï¼Œæ‰€ä»¥æœ€åº•ä¸‹çš„ <code>container.scrollTop</code>  ä¸º 0ï¼Œä¸Šæ»‘åŠ¨å‡å°‘</li>\n<li><code>getBoundingClientRect</code>  å¯ä»¥è·å–åˆ°å…ƒç´ çš„ä½ç½®ï¼ŒåŒ…æ‹¬ <code>top</code> ã€ <code>bottom</code> ã€ <code>left</code> ã€ <code>right</code>  ç­‰ã€‚è¿™äº›éƒ½æ˜¯ç›¸å¯¹äºè§†å£çš„ä½ç½®ã€‚</li>\n</ol>\n<h3 id=\"ä»£ç \"><a class=\"anchor\" href=\"#ä»£ç \">#</a> ä»£ç </h3>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token constant\">DOCTYPE</span> html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>html lang<span class=\"token operator\">=</span><span class=\"token string\">\"en\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token operator\">&lt;</span>meta charset<span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token operator\">&lt;</span>meta name<span class=\"token operator\">=</span><span class=\"token string\">\"viewport\"</span> content<span class=\"token operator\">=</span><span class=\"token string\">\"width=device-width, initial-scale=1.0\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Scroll to Message Example<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>title<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token operator\">&lt;</span>style<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      body <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token literal-property property\">margin</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        font<span class=\"token operator\">-</span>family<span class=\"token operator\">:</span> Arial<span class=\"token punctuation\">,</span> sans<span class=\"token operator\">-</span>serif<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      #message<span class=\"token operator\">-</span>container <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token literal-property property\">display</span><span class=\"token operator\">:</span> flex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        flex<span class=\"token operator\">-</span>direction<span class=\"token operator\">:</span> column<span class=\"token operator\">-</span>reverse<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* åå‘æ’åˆ— */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token literal-property property\">height</span><span class=\"token operator\">:</span> 400px<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* å›ºå®šé«˜åº¦ */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        overflow<span class=\"token operator\">-</span>y<span class=\"token operator\">:</span> auto<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* å‚ç›´æ»šåŠ¨ */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token literal-property property\">border</span><span class=\"token operator\">:</span> 1px solid #ccc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token literal-property property\">padding</span><span class=\"token operator\">:</span> 16px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        box<span class=\"token operator\">-</span>sizing<span class=\"token operator\">:</span> border<span class=\"token operator\">-</span>box<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token punctuation\">.</span>message <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        background<span class=\"token operator\">-</span>color<span class=\"token operator\">:</span> #f0f0f0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token literal-property property\">padding</span><span class=\"token operator\">:</span> 8px 12px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        margin<span class=\"token operator\">-</span>bottom<span class=\"token operator\">:</span> 8px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        border<span class=\"token operator\">-</span>radius<span class=\"token operator\">:</span> 4px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token punctuation\">.</span>highlight<span class=\"token operator\">-</span>message <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        background<span class=\"token operator\">-</span>color<span class=\"token operator\">:</span> yellow <span class=\"token operator\">!</span>important<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* é«˜äº®æ ·å¼ */</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>style<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Scroll to Message Example<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"message-container\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span> æ¶ˆæ¯åˆ—è¡¨ <span class=\"token operator\">--</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>Oldest<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">2</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"3\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">3</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"4\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">4</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"5\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">5</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"6\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">6</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"7\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">7</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"8\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">8</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"9\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">9</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">10</span> <span class=\"token punctuation\">(</span>Newest<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"11\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">11</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"12\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">12</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"13\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">13</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"14\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">14</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"15\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">15</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"16\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">16</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"17\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">17</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"message\"</span> data<span class=\"token operator\">-</span>message<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token string\">\"18\"</span><span class=\"token operator\">></span>Message <span class=\"token number\">18</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token operator\">&lt;</span>button onclick<span class=\"token operator\">=</span><span class=\"token string\">\"scrollToMessage(18)\"</span><span class=\"token operator\">></span>Scroll to Message <span class=\"token number\">18</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token keyword\">function</span> <span class=\"token function\">scrollToMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">messageId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message-container\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">const</span> targetElement <span class=\"token operator\">=</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">[data-message-id=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>messageId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"]</span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>targetElement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          <span class=\"token comment\">// è·å–å®¹å™¨å’Œç›®æ ‡å…ƒç´ çš„ä½ç½®ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          <span class=\"token keyword\">const</span> containerRect <span class=\"token operator\">=</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">getBoundingClientRect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–‡æœ¬çŸ©å½¢ç›¸å¯¹äºè§†å£çš„ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          <span class=\"token keyword\">const</span> elementRect <span class=\"token operator\">=</span> targetElement<span class=\"token punctuation\">.</span><span class=\"token function\">getBoundingClientRect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç›®æ ‡å…ƒç´ ç›¸å¯¹äºè§†å£çš„çŸ©å½¢ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>containerRect<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">,</span> elementRect<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          <span class=\"token comment\">// è®¡ç®—éœ€è¦æ»šåŠ¨çš„è·ç¦»ï¼ˆè€ƒè™‘åå‘æ»šåŠ¨ï¼‰</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          <span class=\"token keyword\">const</span> scrollOffset <span class=\"token operator\">=</span> elementRect<span class=\"token punctuation\">.</span>top <span class=\"token operator\">-</span> containerRect<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token keyword\">const</span> containerCenter <span class=\"token operator\">=</span> containerRect<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>containerRect<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">.</span>scrollTop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          <span class=\"token keyword\">const</span> targetScrollTop <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            container<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">+</span> scrollOffset <span class=\"token operator\">-</span> containerCenter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          <span class=\"token comment\">// æ‰§è¡Œå¹³æ»‘æ»šåŠ¨</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          container<span class=\"token punctuation\">.</span><span class=\"token function\">scrollTo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            <span class=\"token literal-property property\">top</span><span class=\"token operator\">:</span> targetScrollTop<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token literal-property property\">behavior</span><span class=\"token operator\">:</span> <span class=\"token string\">\"smooth\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          <span class=\"token comment\">// é«˜äº®é€»è¾‘</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          targetElement<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"highlight-message\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> targetElement<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"highlight-message\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            <span class=\"token number\">2000</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Message with ID </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>messageId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> not found.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>html<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"å›¾è§£\"><a class=\"anchor\" href=\"#å›¾è§£\">#</a> å›¾è§£</h3>\n<pre><code>[ç›®æ ‡æ¶ˆæ¯]                    target\n\n\n+-----------------------------+\n| è§†å£é¡¶éƒ¨                     |\n|                             |\n| [æ—§æ¶ˆæ¯] &lt;-- å®¹å™¨é¡¶éƒ¨   container    |\n| [æ¶ˆæ¯2]                     |\n| [æ¶ˆæ¯3]                     |\n| ...                         |\n| [ç›®æ ‡æ¶ˆæ¯]                target |\n| ...                         |\n| [æ–°æ¶ˆæ¯] &lt;-- å®¹å™¨åº•éƒ¨        |\n|                             |\n| è§†å£åº•éƒ¨                     |\n+-----------------------------+\n</code></pre>\n<p>è¿™é‡Œçš„ <code>target</code>  å’Œ <code>container</code>  æ˜¯å®¹å™¨å’Œæ¶ˆæ¯ç›¸å¯¹äºè§†å£é¡¶éƒ¨çš„è·ç¦»ï¼Œä¹Ÿå°±æ˜¯ <code>container.getBoundingClientRect();</code>  å’Œ <code>targetElement.getBoundingClientRect();</code>  çš„ <code>top</code>  å€¼ã€‚<br />\nç”¨ç›®æ ‡çš„å€¼å‡å»å®¹å™¨çš„å€¼ï¼Œå°±æ˜¯éœ€è¦æ»šåŠ¨çš„è·ç¦»ã€‚<br />\n <code>container.scrollTop + target - container</code>  å°±å¯ä»¥å¾—åˆ°æŠŠç›®æ ‡å…ƒç´ æ»šè¿›å®¹å™¨å†…çš„æ»šåŠ¨æ¡çš„ä½ç½®ã€‚<br />\nä½†æ˜¯æˆ‘ä»¬éœ€è¦æ”¾åœ¨ä¸­é—´ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å‡å»å®¹å™¨çš„ä¸­é—´ä½ç½®ã€‚ä¹Ÿå°±æ˜¯å‡å» <code>containerRect.height / 2;</code> <br />\n å½“ç„¶ï¼Œç›®æ ‡æ¶ˆæ¯åœ¨è§†å£ä¸Šæ–¹æ—¶ï¼Œ <code>getBoundingClientRect</code>  çš„ <code>top</code>  å€¼æ˜¯è´Ÿæ•°ï¼Œæ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚<br />\nç”±æ­¤å¯å¾—ï¼Œè¿™ä¸ªè§£å…·æœ‰æ™®éæ€§</p>\n",
            "tags": [
                "js",
                "chat",
                "js",
                "scroll"
            ]
        },
        {
            "id": "https://aynya.github.io/a-small-SocketIo-WebRTC-Demo/",
            "url": "https://aynya.github.io/a-small-SocketIo-WebRTC-Demo/",
            "title": "a small SocketIo+WebRTC Demo",
            "date_published": "2025-03-24T03:22:26.000Z",
            "content_html": "<h1 id=\"åŸºäºsocketioå’Œwebrtcçš„å®æ—¶è¯­éŸ³èŠå¤©å®¤demoç‰ˆæœ¬\"><a class=\"anchor\" href=\"#åŸºäºsocketioå’Œwebrtcçš„å®æ—¶è¯­éŸ³èŠå¤©å®¤demoç‰ˆæœ¬\">#</a> åŸºäº Socket.IO å’Œ WebRTC çš„å®æ—¶è¯­éŸ³èŠå¤©å®¤ (Demo ç‰ˆæœ¬)</h1>\n<h2 id=\"åŠŸèƒ½äº®ç‚¹\"><a class=\"anchor\" href=\"#åŠŸèƒ½äº®ç‚¹\">#</a> åŠŸèƒ½äº®ç‚¹</h2>\n<ul>\n<li>ğŸ™ï¸ å®æ—¶è¯­éŸ³é€šè¯ï¼ˆP2P ç›´è¿ï¼‰</li>\n<li>ğŸ’¬ æ–‡å­—æ¶ˆæ¯ç¾¤èŠï¼ˆæˆ¿é—´éš”ç¦»ï¼‰</li>\n<li>ğŸšª åŠ¨æ€æˆ¿é—´ç®¡ç†</li>\n<li>ğŸŒ è‡ªåŠ¨ NAT ç©¿é€ï¼ˆSTUN æœåŠ¡ï¼‰</li>\n</ul>\n<h2 id=\"æŠ€æœ¯æ ˆ\"><a class=\"anchor\" href=\"#æŠ€æœ¯æ ˆ\">#</a> æŠ€æœ¯æ ˆ</h2>\n<table>\n<thead>\n<tr>\n<th>æŠ€æœ¯</th>\n<th>ç”¨é€”</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span class=\"exturl\" data-url=\"aHR0cDovL1NvY2tldC5JTw==\">Socket.IO</span></td>\n<td>ä¿¡ä»¤æœåŠ¡å™¨ / æ¶ˆæ¯ä¸­è½¬</td>\n</tr>\n<tr>\n<td>WebRTC</td>\n<td>éŸ³è§†é¢‘ P2P é€šä¿¡</td>\n</tr>\n<tr>\n<td>React</td>\n<td>å‰ç«¯ç•Œé¢æ¡†æ¶</td>\n</tr>\n<tr>\n<td>Node.js</td>\n<td>åç«¯æœåŠ¡</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<h2 id=\"å¿«é€Ÿå¼€å§‹\"><a class=\"anchor\" href=\"#å¿«é€Ÿå¼€å§‹\">#</a> å¿«é€Ÿå¼€å§‹</h2>\n<h3 id=\"ç¯å¢ƒå‡†å¤‡\"><a class=\"anchor\" href=\"#ç¯å¢ƒå‡†å¤‡\">#</a> ç¯å¢ƒå‡†å¤‡</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># å‰ç«¯ä¾èµ–</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> socket.io-client react react-dom</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># åç«¯ä¾èµ–</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> express socket.io cors</pre></td></tr></table></figure><h3 id=\"ä»£ç è§£æ\"><a class=\"anchor\" href=\"#ä»£ç è§£æ\">#</a> ä»£ç è§£æ</h3>\n<h4 id=\"ç³»ç»Ÿæ¶æ„å›¾\"><a class=\"anchor\" href=\"#ç³»ç»Ÿæ¶æ„å›¾\">#</a> ç³»ç»Ÿæ¶æ„å›¾</h4>\n<pre><code>  +----------------+      ä¿¡ä»¤äº¤äº’       +----------------+\n  |  æµè§ˆå™¨å®¢æˆ·ç«¯  | â†â€”â€” Socket.IO â€”â€”â†’ |  ä¿¡ä»¤æœåŠ¡å™¨     |\n  +----------------+                    +----------------+\n        â–²                                   |\n        | WebRTCåª’ä½“æµï¼ˆP2Pç›´è¿ï¼‰            |\n        â–¼                                   â–¼\n  +----------------+                    +----------------+\n  |  å…¶ä»–å®¢æˆ·ç«¯     | â†â€”â€” WebRTC â€”â€”â€”â€”â†’ |  å…¶ä»–å®¢æˆ·ç«¯      |\n  +----------------+                    +----------------+\n</code></pre>\n<h4 id=\"æœåŠ¡ç«¯æ ¸å¿ƒé€»è¾‘serverjs\"><a class=\"anchor\" href=\"#æœåŠ¡ç«¯æ ¸å¿ƒé€»è¾‘serverjs\">#</a> æœåŠ¡ç«¯æ ¸å¿ƒé€»è¾‘ (server.js)</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æˆ¿é—´ç®¡ç†ä¸­é—´ä»¶</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>io<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connection'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">socket</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'join-room'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">roomId</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    socket<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>roomId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Socket.IO å†…ç½®æˆ¿é—´ç®¡ç†</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>roomId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-connected'</span><span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// ICE å€™é€‰è½¬å‘ç®¡é“</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> targetId<span class=\"token punctuation\">,</span> signal <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>targetId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">senderId</span><span class=\"token operator\">:</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> signal <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"æœåŠ¡å™¨åˆå§‹åŒ–\"><a class=\"anchor\" href=\"#æœåŠ¡å™¨åˆå§‹åŒ–\">#</a> æœåŠ¡å™¨åˆå§‹åŒ–</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> cors <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cors'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> io <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"socket.io\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token literal-property property\">cors</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token literal-property property\">origin</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token literal-property property\">methods</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>åŠŸèƒ½</strong>ï¼š<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1IVFRQU29ja2V0LTB1MXFtNGNtMTFiZm52bnliYzQ1ZHFkNWRxOTBhdDc0ZS5JTw==\">åˆ›å»ºåŸºç¡€ HTTP æœåŠ¡å¹¶é…ç½® Socket.IO</span><br />\n<strong> å…³é”®é…ç½®</strong>ï¼š</p>\n<ul>\n<li><code>cors</code>  ä¸­é—´ä»¶ç”¨äºè§£å†³è·¨åŸŸé—®é¢˜ï¼Œå…è®¸ä»»ä½•æ¥æºçš„è¯·æ±‚è®¿é—®æœåŠ¡å™¨</li>\n<li><code>origin: &quot;*&quot;</code>  å…è®¸ä»»ä½•æ¥æºçš„è¯·æ±‚è®¿é—®æœåŠ¡å™¨</li>\n<li>æŒ‡å®šä½¿ç”¨ WebSocket ä¼ è¾“ (é»˜è®¤åŒ…å«è½®è¯¢å¤‡ç”¨)</li>\n</ul>\n<h4 id=\"è¿æ¥ç®¡ç†\"><a class=\"anchor\" href=\"#è¿æ¥ç®¡ç†\">#</a> è¿æ¥ç®¡ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>io<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connection'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">socket</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">ç”¨æˆ· </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>socket<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> å·²è¿æ¥</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// åç»­äº‹ä»¶ç›‘å¬ä»£ç ...</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>åŠŸèƒ½</strong>ï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶<br />\n<strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼š</p>\n<ul>\n<li>å®¢æˆ·ç«¯è¿æ¥æ—¶è‡ªåŠ¨è§¦å‘</li>\n<li>æ¯ä¸ª <code>socket</code>  å¯¹è±¡ä»£è¡¨ä¸€ä¸ªç‹¬ç«‹å®¢æˆ·ç«¯è¿æ¥</li>\n<li><code>socket.id</code>  æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥</li>\n</ul>\n<h4 id=\"æˆ¿é—´ç®¡ç†\"><a class=\"anchor\" href=\"#æˆ¿é—´ç®¡ç†\">#</a> æˆ¿é—´ç®¡ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'join-room'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">roomId</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  socket<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>roomId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// åŠ å…¥æŒ‡å®šæˆ¿é—´</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  socket<span class=\"token punctuation\">.</span>roomId <span class=\"token operator\">=</span> roomId<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// å­˜å‚¨æˆ¿é—´å·åˆ° socket å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myId'</span><span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿”å›å®¢æˆ·ç«¯ ID</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>roomId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-connected'</span><span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¹¿æ’­æ–°äººåŠ å…¥</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒæ–¹æ³•</strong>ï¼š</p>\n<ul>\n<li><code>socket.join(roomId)</code> ï¼šSocket.IO å†…ç½®æˆ¿é—´ç®¡ç†ã€‚</li>\n<li><code>socket.to(roomId).emit()</code> ï¼šå‘æŒ‡å®šæˆ¿é—´å¹¿æ’­æ¶ˆæ¯<br />\n<strong>æ•°æ®æµ</strong>ï¼š</li>\n</ul>\n<pre><code>å®¢æˆ·ç«¯A --join-room--&gt; æœåŠ¡ç«¯\næœåŠ¡ç«¯ --&gt; å®¢æˆ·ç«¯Aï¼šå‘é€myId\næœåŠ¡ç«¯ --&gt; æˆ¿é—´å…¶ä»–å®¢æˆ·ç«¯ï¼šå‘é€user-connected\n</code></pre>\n<h4 id=\"ä¿¡ä»¤è½¬å‘\"><a class=\"anchor\" href=\"#ä¿¡ä»¤è½¬å‘\">#</a> ä¿¡ä»¤è½¬å‘</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> targetId<span class=\"token punctuation\">,</span> signal <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>targetId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token literal-property property\">senderId</span><span class=\"token operator\">:</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    signal </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>åŠŸèƒ½</strong>ï¼šä¸­è½¬ WebRTC è¿æ¥ä¿¡ä»¤<br />\n<strong>åœºæ™¯</strong>ï¼š</p>\n<ul>\n<li>è½¬å‘ Offer/Answer ä¿¡ä»¤</li>\n<li>è½¬å‘ ICE å€™é€‰ä¿¡ä»¤<br />\n<strong>è·¯ç”±é€»è¾‘</strong>ï¼š</li>\n</ul>\n<pre><code>å®¢æˆ·ç«¯A --signal--&gt; æœåŠ¡ç«¯ --&gt; å®¢æˆ·ç«¯B\n</code></pre>\n<h4 id=\"èŠå¤©æ¶ˆæ¯ç®¡ç†\"><a class=\"anchor\" href=\"#èŠå¤©æ¶ˆæ¯ç®¡ç†\">#</a> èŠå¤©æ¶ˆæ¯ç®¡ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chat message'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">msg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  io<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>roomId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chat message'</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>å¹¿æ’­æœºåˆ¶</strong>ï¼š</p>\n<ul>\n<li><code>io.to(socket.roomId).emit('chat message', msg);</code> ï¼šå‘æŒ‡å®šæˆ¿é—´å¹¿æ’­æ¶ˆæ¯</li>\n<li>ä¿è¯æ¶ˆæ¯ä»…åœ¨æˆ¿é—´å†…ä¼ æ’­</li>\n</ul>\n<h4 id=\"æ–­å¼€è¿æ¥å¤„ç†\"><a class=\"anchor\" href=\"#æ–­å¼€è¿æ¥å¤„ç†\">#</a> æ–­å¼€è¿æ¥å¤„ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'disconnect'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>roomId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    socket<span class=\"token punctuation\">.</span><span class=\"token function\">to</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>roomId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-disconnected'</span><span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>è§¦å‘åœºæ™¯</strong>ï¼š</p>\n<ul>\n<li>ç”¨æˆ·ä¸»åŠ¨å…³é—­ç½‘é¡µ</li>\n<li>ç½‘ç»œæ–­å¼€</li>\n<li>æ‰‹åŠ¨åˆ·æ–°</li>\n</ul>\n<h4 id=\"å®¢æˆ·ç«¯æ ¸å¿ƒé€»è¾‘appjs\"><a class=\"anchor\" href=\"#å®¢æˆ·ç«¯æ ¸å¿ƒé€»è¾‘appjs\">#</a> å®¢æˆ·ç«¯æ ¸å¿ƒé€»è¾‘ (App.js)</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// WebRTC è¿æ¥ç®¡ç†å™¨</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createPeerConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">targetId</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCPeerConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">iceServers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token literal-property property\">urls</span><span class=\"token operator\">:</span> <span class=\"token string\">'stun:stun.l.google.com:19302'</span> <span class=\"token comment\">// Google å…¬å…± STUN æœåŠ¡å™¨</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// æ·»åŠ æœ¬åœ°éŸ³é¢‘è½¨é“</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  localStream<span class=\"token punctuation\">.</span><span class=\"token function\">getTracks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">track</span> <span class=\"token operator\">=></span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    pc<span class=\"token punctuation\">.</span><span class=\"token function\">addTrack</span><span class=\"token punctuation\">(</span>track<span class=\"token punctuation\">,</span> localStream<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// å¤„ç†è¿œç¨‹éŸ³é¢‘æµ</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    remoteAudioRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    remoteAudioRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å…¼å®¹ iOS è‡ªåŠ¨æ’­æ”¾é™åˆ¶</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"çŠ¶æ€ç®¡ç†\"><a class=\"anchor\" href=\"#çŠ¶æ€ç®¡ç†\">#</a> çŠ¶æ€ç®¡ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>messages<span class=\"token punctuation\">,</span> setMessages<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¶ˆæ¯åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>message<span class=\"token punctuation\">,</span> setMessage<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// è¾“å…¥æ¡†å†…å®¹</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>myId<span class=\"token punctuation\">,</span> setMyId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// å½“å‰ç”¨æˆ· ID</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>roomId<span class=\"token punctuation\">,</span> setRoomId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// æˆ¿é—´å·</span></pre></td></tr></table></figure><h4 id=\"éŸ³è§†é¢‘åˆå§‹åŒ–\"><a class=\"anchor\" href=\"#éŸ³è§†é¢‘åˆå§‹åŒ–\">#</a> éŸ³è§†é¢‘åˆå§‹åŒ–</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  navigator<span class=\"token punctuation\">.</span>mediaDevices<span class=\"token punctuation\">.</span><span class=\"token function\">getUserMedia</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">audio</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">stream</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      localAudioRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// å…¶ä»–åˆå§‹åŒ–ä»£ç ...</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>å…³é”® API</strong>ï¼š</p>\n<ul>\n<li><code>getUserMedia</code> ï¼šè·å–ç”¨æˆ·åª’ä½“ï¼ˆéŸ³é¢‘ / è§†é¢‘ï¼‰</li>\n<li><code>srcObject</code> ï¼šè®¾ç½®åª’ä½“æµåˆ° <code>&lt;audio&gt;</code>  å…ƒç´ <br />\n<strong>æ³¨æ„</strong>ï¼š</li>\n<li>éœ€è¦ HTTPS ç¯å¢ƒï¼ˆlocalhost é™¤å¤–ï¼‰</li>\n<li>å¤„ç†ç”¨æˆ·æ‹’ç»æƒé™æƒ…å†µ</li>\n</ul>\n<h4 id=\"webrtcè¿æ¥ç®¡ç†\"><a class=\"anchor\" href=\"#webrtcè¿æ¥ç®¡ç†\">#</a> WebRTC è¿æ¥ç®¡ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createPeerConnection</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">targetId<span class=\"token punctuation\">,</span> isInitiator <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCPeerConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token literal-property property\">iceServers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">urls</span><span class=\"token operator\">:</span> <span class=\"token string\">'stun:stun.l.google.com:19302'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// æ·»åŠ æœ¬åœ°éŸ³è½¨</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  localAudioRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject<span class=\"token punctuation\">.</span><span class=\"token function\">getTracks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">track</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    pc<span class=\"token punctuation\">.</span><span class=\"token function\">addTrack</span><span class=\"token punctuation\">(</span>track<span class=\"token punctuation\">,</span> localAudioRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// å¤„ç†è¿œç¨‹æµ</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    remoteAudioRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// ICE å€™é€‰å¤„ç†</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onicecandidate</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> targetId<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">signal</span><span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>candidate<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// å‘èµ·æ–¹åˆ›å»º Offer</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInitiator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    pc<span class=\"token punctuation\">.</span><span class=\"token function\">createOffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">offer</span> <span class=\"token operator\">=></span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span>offer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> targetId<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">signal</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>æµç¨‹è§£æ</strong>ï¼š<br />\n&lt;pre class=&quot;mermaid&quot;&gt;sequenceDiagram<br />\n å‚ä¸è€… A-&gt;&gt; å‚ä¸è€… A: åˆ›å»º PeerConnection<br />\n å‚ä¸è€… A-&gt;&gt; å‚ä¸è€… A: æ·»åŠ æœ¬åœ°éŸ³è½¨<br />\nå‚ä¸è€… A-&gt;&gt; å‚ä¸è€… A: è®¾ç½® ontrack å›è°ƒ<br />\nå‚ä¸è€… A-&gt;&gt;STUN: è·å– ICE å€™é€‰<br />\nå‚ä¸è€… A-&gt;&gt; æœåŠ¡ç«¯ï¼šå‘é€å€™é€‰<br />\næœåŠ¡ç«¯ -&gt;&gt; å‚ä¸è€… B: è½¬å‘å€™é€‰<br />\nå‚ä¸è€… B-&gt;&gt; å‚ä¸è€… B: å¤„ç†å€™é€‰ &lt;/pre&gt;</p>\n<h4 id=\"ä¿¡ä»¤å¤„ç†\"><a class=\"anchor\" href=\"#ä¿¡ä»¤å¤„ç†\">#</a> ä¿¡ä»¤å¤„ç†</h4>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleSignal</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> senderId<span class=\"token punctuation\">,</span> signal <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>peersRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">[</span>senderId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">createPeerConnection</span><span class=\"token punctuation\">(</span>senderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> pc <span class=\"token operator\">=</span> peersRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">[</span>senderId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>signal<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'offer'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>signal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token keyword\">const</span> answer <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createAnswer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span>answer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">targetId</span><span class=\"token operator\">:</span> senderId<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">signal</span><span class=\"token operator\">:</span> answer <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// å¤„ç† answer å’Œ candidate...</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä¿¡ä»¤å¤„ç†å¤±è´¥:'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>çŠ¶æ€è½¬æ¢</strong>ï¼š</p>\n<pre><code>stable -&gt; have-local-offer -&gt; have-remote-offer -&gt; stable\n</code></pre>\n<h4 id=\"ç”¨æˆ·ç•Œé¢æ³¨æ„\"><a class=\"anchor\" href=\"#ç”¨æˆ·ç•Œé¢æ³¨æ„\">#</a> ç”¨æˆ·ç•Œé¢æ³¨æ„</h4>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>&#123;/* éŸ³é¢‘å…ƒç´  */&#125;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>audio</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>&#123;localAudioRef&#125;</span> <span class=\"token attr-name\">autoPlay</span> <span class=\"token attr-name\">muted</span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>audio</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>&#123;remoteAudioRef&#125;</span> <span class=\"token attr-name\">autoPlay</span> <span class=\"token punctuation\">/></span></span></pre></td></tr></table></figure><p><strong>å…ƒç´ è¯´æ˜</strong>ï¼š</p>\n<ul>\n<li><code>localAudioRef</code> ï¼šç”¨äºæ˜¾ç¤ºæœ¬åœ°éŸ³é¢‘æµ</li>\n<li><code>remoteAudioRef</code> ï¼šç”¨äºæ˜¾ç¤ºè¿œç¨‹éŸ³é¢‘æµ</li>\n<li><code>autoPlay</code> ï¼šè‡ªåŠ¨æ’­æ”¾éŸ³é¢‘æµ</li>\n<li><code>muted</code> ï¼šé™éŸ³æœ¬åœ°éŸ³é¢‘æµ</li>\n</ul>\n<h4 id=\"ä»£ç ç»†èŠ‚æ€»ç»“\"><a class=\"anchor\" href=\"#ä»£ç ç»†èŠ‚æ€»ç»“\">#</a> ä»£ç ç»†èŠ‚æ€»ç»“</h4>\n<ol>\n<li><strong>ä¿®æ”¹çŠ¶æ€çš„æ‰©å±•è¿ç®—ç¬¦å’Œå‡½æ•°è¡¨è¾¾å¼</strong><br />\nåœ¨ <code>useEffect</code>  ä¸­ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ä¼šäº§ç”Ÿé—­åŒ…é™·é˜±ï¼Œå› ä¸ºé¦–æ¬¡åŠ è½½æ—¶ï¼Œ <code>messages</code>  æ•°ç»„ä¸ºç©ºï¼Œåç»­çš„ <code>setMessages</code>  æ“ä½œä¼šç›´æ¥ä¿®æ”¹ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œè€Œä¸ä¼šæ›´æ–°çŠ¶æ€ã€‚å› æ­¤ï¼Œä½¿ç”¨å‡½æ•°è¡¨è¾¾å¼æ¥å®šä¹‰ <code>handleChatMessage</code>  å‡½æ•°ï¼Œå¯ä»¥é¿å…é—­åŒ…é™·é˜±ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æ¨è</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleChatMessage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">msg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token function\">setMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prev</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>prev<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// ä¸æ¨è</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleChatMessage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">msg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token function\">setMessages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>messages<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>æ¯æ¬¡æŒ‚è½½ç»“æŸéƒ½è¦æ–­å¼€ Socket.IO è¿æ¥</strong><br />\nå¦‚æœä¸æ–­å¼€ä¼šå¯¼è‡´é‡å¤è¿æ¥ï¼Œæ‰€ä»¥æ¯æ¬¡æŒ‚è½½ç»“æŸéƒ½è¦æ–­å¼€ Socket.IO è¿æ¥ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">off</span><span class=\"token punctuation\">(</span><span class=\"token string\">'signal'</span><span class=\"token punctuation\">,</span> handleSignal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">off</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-connected'</span><span class=\"token punctuation\">,</span> handleUserConnected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">off</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-disconnected'</span><span class=\"token punctuation\">,</span> handleUserDisconnected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">off</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myId'</span><span class=\"token punctuation\">,</span> setMyId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      socket<span class=\"token punctuation\">.</span><span class=\"token function\">off</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chat message'</span><span class=\"token punctuation\">,</span> handleChatMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"ç³»ç»Ÿæµç¨‹å›¾\"><a class=\"anchor\" href=\"#ç³»ç»Ÿæµç¨‹å›¾\">#</a> ç³»ç»Ÿæµç¨‹å›¾</h3>\n<p>&lt;pre class=&quot;mermaid&quot;&gt;sequenceDiagram<br />\nparticipant A as ç”¨æˆ· A<br />\nparticipant S as æœåŠ¡ç«¯<br />\n participant B as ç”¨æˆ· B</p>\n<p>A-&gt;&gt;S: join-room(101)<br />\nS-&gt;&gt;A: myId(A)<br />\nS-&gt;&gt;B: user-connected(A)<br />\n B-&gt;&gt;B: åˆ›å»º PeerConnection<br />\nB-&gt;&gt;S: å‘é€ Offer<br />\nS-&gt;&gt;A: è½¬å‘ Offer<br />\nA-&gt;&gt;S: å‘é€ Answer<br />\nS-&gt;&gt;B: è½¬å‘ Answer<br />\nA-&gt;&gt;B: ICE å€™é€‰äº¤æ¢<br />\n B-&gt;&gt;A: ICE å€™é€‰äº¤æ¢<br />\n A-&gt;&gt;B: è¯­éŸ³æµä¼ è¾“<br />\n A-&gt;&gt;S: å‘é€æ–‡å­—æ¶ˆæ¯<br />\n S-&gt;&gt;B: è½¬å‘æ¶ˆæ¯ &lt;/pre&gt;</p>\n<h3 id=\"ä½¿ç”¨æ­¥éª¤\"><a class=\"anchor\" href=\"#ä½¿ç”¨æ­¥éª¤\">#</a> ä½¿ç”¨æ­¥éª¤</h3>\n<ol>\n<li><strong>å¯åŠ¨åç«¯æœåŠ¡ï¼š</strong></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> run dev</pre></td></tr></table></figure><ol>\n<li><strong>å¯åŠ¨å‰ç«¯åº”ç”¨ï¼š</strong></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> part1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">npm</span> run dev</pre></td></tr></table></figure><ol>\n<li><strong>æ‰“å¼€å¤šä¸ªæµè§ˆå™¨çª—å£</strong><br />\nè®¿é—® <code>http://localhost:5173</code> ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥æˆ¿é—´ IDï¼Œç‚¹å‡» â€œåŠ å…¥æˆ¿é—´â€ æŒ‰é’®ï¼Œå³å¯è¿›è¡Œå®æ—¶è¯­éŸ³èŠå¤©ã€‚</li>\n<li><strong>åŠŸèƒ½éªŒè¯</strong><br />\nè¯´è¯ï¼šèƒ½å¤Ÿå¬åˆ°è‡ªå·±çš„å£°éŸ³<br />\nè¾“å…¥æ–‡å­—å‘é€ï¼šåŒæ–¹çª—å£åŒæ­¥æ˜¾ç¤ºæ¶ˆæ¯<br />\nå…³é—­çª—å£ï¼šå¯¹æ–¹æ”¶åˆ°æ–­å¼€é€šçŸ¥</li>\n</ol>\n<h3 id=\"å…³é”®æ³¨æ„äº‹é¡¹\"><a class=\"anchor\" href=\"#å…³é”®æ³¨æ„äº‹é¡¹\">#</a> å…³é”®æ³¨æ„äº‹é¡¹</h3>\n<ol>\n<li><strong>éº¦å…‹é£æƒé™é—®é¢˜</strong><br />\néœ€è¦åœ¨æµè§ˆå™¨ä¸­å…è®¸éº¦å…‹é£æƒé™ï¼Œå¦åˆ™æ— æ³• å‘é€è¯­éŸ³ã€‚</li>\n<li><strong>æœ¬åœ°å¼€å‘é™åˆ¶</strong><br />\nç¡®ä¿ Socket.IO æœåŠ¡ç«¯é…ç½® CORSï¼Œå…è®¸è·¨åŸŸè¯·æ±‚ï¼Œå¦åˆ™æ— æ³•æ­£å¸¸é€šä¿¡ã€‚</li>\n<li><strong>NAT ç©¿é€é—®é¢˜</strong><br />\nå…¬å…± STUN æœåŠ¡å™¨å¯èƒ½ä¸ç¨³å®š</li>\n</ol>\n<h3 id=\"å¸¸è§é—®é¢˜æ’æŸ¥\"><a class=\"anchor\" href=\"#å¸¸è§é—®é¢˜æ’æŸ¥\">#</a> å¸¸è§é—®é¢˜æ’æŸ¥</h3>\n<table>\n<thead>\n<tr>\n<th>ç°è±¡</th>\n<th>å¯èƒ½åŸå› </th>\n<th>è§£å†³æ–¹æ¡ˆ</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ— æ³•å¬åˆ°å¯¹æ–¹å£°éŸ³</td>\n<td>æœªæ·»åŠ éŸ³é¢‘è½¨é“</td>\n<td>æ£€æŸ¥ <code>pc.addTrack</code>  è°ƒç”¨</td>\n</tr>\n<tr>\n<td>è¿æ¥çŠ¶æ€å¡åœ¨ checking</td>\n<td>ICE å€™é€‰æœªäº¤æ¢æˆåŠŸ</td>\n<td>æ£€æŸ¥ STUN æœåŠ¡å™¨å¯ç”¨æ€§</td>\n</tr>\n<tr>\n<td>æ–‡å­—æ¶ˆæ¯æœªå¹¿æ’­</td>\n<td>æœªåŠ å…¥ç›¸åŒæˆ¿é—´</td>\n<td>éªŒè¯ <code>join-room</code>  äº‹ä»¶å¤„ç†</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"æ‰©å±•ä¼˜åŒ–å»ºè®®\"><a class=\"anchor\" href=\"#æ‰©å±•ä¼˜åŒ–å»ºè®®\">#</a> æ‰©å±•ä¼˜åŒ–å»ºè®®</h3>\n<ol>\n<li>å¢åŠ æˆ¿é—´çŠ¶æ€æ˜¾ç¤ºï¼šå½“å‰æˆ¿é—´äººæ•°ã€æˆ¿é—´åˆ—è¡¨ç­‰ã€‚</li>\n<li>ä¼˜åŒ– UI ä½“éªŒï¼šå¦‚åŠ è½½åŠ¨ç”»ã€é”™è¯¯æç¤ºç­‰ã€‚</li>\n<li>æ·»åŠ è§†é¢‘èŠå¤©åŠŸèƒ½ï¼šä½¿ç”¨ WebRTC çš„ <code>createOffer</code>  å’Œ <code>createAnswer</code>  æ–¹æ³•å®ç°è§†é¢‘èŠå¤©ã€‚</li>\n</ol>\n<h2 id=\"æŠ€æœ¯è¡¥å……2025-4-3æ›´æ–°\"><a class=\"anchor\" href=\"#æŠ€æœ¯è¡¥å……2025-4-3æ›´æ–°\">#</a> æŠ€æœ¯è¡¥å…… (2025-4-3 æ›´æ–°)</h2>\n<ol>\n<li><strong>remoteAudioStream çš„è¦†ç›–é—®é¢˜</strong><br />\nåœ¨å½“å‰ä»£ç ä¸­ï¼Œpc.ontrack äº‹ä»¶ä¼šå°†æ¥æ”¶åˆ°çš„è¿œç¨‹éŸ³é¢‘æµç›´æ¥è®¾ç½®åˆ° remoteAudioStream çŠ¶æ€ä¸­</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">remoteAudioStream</span><span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå½“å¤šä¸ªç”¨æˆ·åŠ å…¥æˆ¿é—´æ—¶ï¼Œæ¯æ¬¡æ¥æ”¶åˆ°æ–°çš„è¿œç¨‹éŸ³é¢‘æµæ—¶ï¼Œéƒ½ä¼šè¦†ç›–ä¹‹å‰çš„  <code>remoteAudioStream</code> ã€‚å› æ­¤ï¼Œæœ€ç»ˆåªä¼šæœ‰ä¸€ä¸ªç”¨æˆ·çš„éŸ³é¢‘æµè¢«æ’­æ”¾ï¼Œå…¶ä»–ç”¨æˆ·çš„éŸ³é¢‘æµä¼šè¢«ä¸¢å¼ƒã€‚</p>\n<ol start=\"2\">\n<li><strong>ä¿®æ”¹å‰ç«¯ä»£ç ä»¥æ”¯æŒå¤šéŸ³é¢‘æµ</strong><br />\nå°†  <code>remoteAudioStream</code>  æ›¿æ¢ä¸º  <code>remoteAudioStreams</code> ï¼Œå¹¶å°†å…¶è®¾è®¡ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸º  <code>userId</code> ï¼Œå€¼ä¸ºå¯¹åº”çš„éŸ³é¢‘æµã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token literal-property property\">remoteAudioStreams</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å­˜å‚¨æ‰€æœ‰è¿œç¨‹ç”¨æˆ·çš„éŸ³é¢‘æµ</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">remoteAudioStreams</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token operator\">...</span>state<span class=\"token punctuation\">.</span>remoteAudioStreams<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">[</span>targetId<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å°†éŸ³é¢‘æµä¸ç›®æ ‡ç”¨æˆ·å…³è”</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>ä¿®æ”¹ user-disconnected å¤„ç†ï¼š</strong><br />\nå½“ç”¨æˆ·æ–­å¼€è¿æ¥æ—¶ï¼Œä»  <code>remoteAudioStreams</code>  ä¸­ç§»é™¤å¯¹åº”çš„éŸ³é¢‘æµï¼š</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>socket<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-disconnected'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> peersRef <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>peersRef<span class=\"token punctuation\">[</span>userId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    peersRef<span class=\"token punctuation\">[</span>userId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">delete</span> peersRef<span class=\"token punctuation\">[</span>userId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token literal-property property\">peersRef</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">.</span>peersRef <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token literal-property property\">users</span><span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token literal-property property\">remoteAudioStreams</span><span class=\"token operator\">:</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">fromEntries</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        Object<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>remoteAudioStreams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> id <span class=\"token operator\">!==</span> userId<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li><strong>åŠ¨æ€æ¸²æŸ“å¤šä¸ª audio å…ƒç´ </strong><br />\nå½“å‰çš„ä»£ç ä¸­åªä½¿ç”¨äº†ä¸€ä¸ª  <code>remoteAudioStream</code> ï¼Œå› æ­¤åªä¼šæ’­æ”¾ä¸€ä¸ªè¿œç¨‹ç”¨æˆ·çš„éŸ³é¢‘æµã€‚å¦‚æœè¦æ”¯æŒå¤šä¸ªè¿œç¨‹ç”¨æˆ·çš„éŸ³é¢‘æµï¼Œéœ€è¦å°†  <code>remoteAudioStream</code>  æ›¿æ¢ä¸ºä¸€ä¸ªæ•°ç»„æˆ–å¯¹è±¡ï¼ˆä¾‹å¦‚  <code>remoteAudioStreams</code> ï¼‰ï¼Œå¹¶åŠ¨æ€æ¸²æŸ“å¤šä¸ª  <code>audio</code>  å…ƒç´ æ¥æ’­æ”¾æ¯ä¸ªè¿œç¨‹ç”¨æˆ·çš„éŸ³é¢‘æµã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> useSocketStore <span class=\"token keyword\">from</span> <span class=\"token string\">'./store'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">AudioPlayers</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> localAudioStream<span class=\"token punctuation\">,</span> remoteAudioStreams <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSocketStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span><span class=\"token comment\">/* æœ¬åœ°éŸ³é¢‘ */</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token operator\">&lt;</span>audio</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ref<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ref</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> ref <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> localAudioStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        autoPlay</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        muted</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span><span class=\"token comment\">/* è¿œç¨‹éŸ³é¢‘ */</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span>remoteAudioStreams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">[</span>userId<span class=\"token punctuation\">,</span> stream<span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stream<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœéŸ³é¢‘æµä¸ºç©ºï¼Œè·³è¿‡æ¸²æŸ“</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          <span class=\"token operator\">&lt;</span>audio</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            key<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>userId<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            ref<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ref</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> ref <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            autoPlay</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> AudioPlayers<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"è¡¥å……æ€»ç»“\"><a class=\"anchor\" href=\"#è¡¥å……æ€»ç»“\">#</a> è¡¥å……æ€»ç»“</h3>\n<ul>\n<li>ğŸš€è½¬è¿œç¨‹éŸ³é¢‘æµä¸ºè¿œç¨‹éŸ³é¢‘æµå¯¹è±¡</li>\n<li>ğŸš€åŠ¨æ€æ¸²æŸ“å¤šä¸ª audio å…ƒç´ </li>\n</ul>\n<hr />\n<h3 id=\"å®Œæ•´ä»£ç è·å–\"><a class=\"anchor\" href=\"#å®Œæ•´ä»£ç è·å–\">#</a> å®Œæ•´ä»£ç è·å–</h3>\n<p>è®¿é—®<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2F5bnlhL1ZvaWNlLUNoYXQtRGVtbw==\"> GitHub ä»“åº“</span>ï¼Œè·å–å®Œæ•´ä»£ç ã€‚</p>\n",
            "tags": [
                "Demo",
                "WebRTC",
                "SocketIo"
            ]
        },
        {
            "id": "https://aynya.github.io/webpack%E6%89%93%E5%8C%85/",
            "url": "https://aynya.github.io/webpack%E6%89%93%E5%8C%85/",
            "title": "webpackæ‰“åŒ…",
            "date_published": "2025-03-21T11:19:54.000Z",
            "content_html": "<h3 id=\"webpackæ˜¯ä»€ä¹ˆ\"><a class=\"anchor\" href=\"#webpackæ˜¯ä»€ä¹ˆ\">#</a> webpack æ˜¯ä»€ä¹ˆï¼Ÿ</h3>\n<p>Webpack æ˜¯ä¸€ä¸ªç°ä»£ JavaScript åº”ç”¨çš„é™æ€æ¨¡å—æ‰“åŒ…å·¥å…·ã€‚å®ƒé€šè¿‡åˆ†ææ¨¡å—ä¾èµ–å…³ç³»ï¼Œå°†é¡¹ç›®ä¸­çš„æ‰€æœ‰èµ„æºï¼ˆJSã€CSSã€å›¾ç‰‡ç­‰ï¼‰è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„é™æ€èµ„æºï¼Œå¹¶æ”¯æŒä»£ç ä¼˜åŒ–ä¸æ‰©å±•åŠŸèƒ½</p>\n<h3 id=\"æ ¸å¿ƒæ¦‚å¿µ\"><a class=\"anchor\" href=\"#æ ¸å¿ƒæ¦‚å¿µ\">#</a> æ ¸å¿ƒæ¦‚å¿µ</h3>\n<ol>\n<li><strong>Entry</strong> (å…¥å£)\n<ul>\n<li>å®šä¹‰æ‰“åŒ…èµ·ç‚¹ï¼Œæ”¯æŒå•å…¥å£ï¼ˆstringï¼‰ã€å¤šå…¥å£ï¼ˆarray æˆ– objectï¼‰</li>\n<li>ç¤ºä¾‹ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">index</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'./src/utils.js'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// åˆå¹¶ä¸º 1 ä¸ª chunk</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token literal-property property\">vendor</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/vendor.js'</span> <span class=\"token comment\">// ç‹¬ç«‹ chunk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>Output</strong> (è¾“å‡º)\n<ul>\n<li>æŒ‡å®šæ‰“åŒ…æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ä¸å‘½åè§„åˆ™ï¼Œå¸¸ç”¨ path å’Œ filename é…ç½®ã€‚</li>\n<li>ç¤ºä¾‹ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'[name].[contenthash].js'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>Loader</strong> (åŠ è½½å™¨)\n<ul>\n<li>å¤„ç†é JS æ–‡ä»¶ï¼ˆå¦‚ CSSã€å›¾ç‰‡ï¼‰ï¼Œéœ€å®‰è£…å¯¹åº” Loaderã€‚</li>\n<li>ç¤ºä¾‹ï¼šé€šè¿‡ css-loader å’Œ style-loader å¤„ç† CSS æ–‡ä»¶ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token literal-property property\">module</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">rules</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.css$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">use</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'style-loader'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'css-loader'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>Plugin</strong> (æ’ä»¶)\n<ul>\n<li>æ‰©å±• Webpack åŠŸèƒ½ï¼Œå¦‚ç”Ÿæˆ HTML æ¨¡æ¿ã€æ¸…ç†æ„å»ºç›®å½•ã€‚</li>\n<li>å¸¸ç”¨æ’ä»¶ï¼š\n<ul>\n<li>HtmlWebpackPluginï¼šè‡ªåŠ¨ç”Ÿæˆ HTML å¹¶æ³¨å…¥ JS æ–‡ä»¶</li>\n<li>CopyWebpackPluginï¼šå¤åˆ¶é™æ€æ–‡ä»¶ï¼ˆå¦‚æ— éœ€æ‰“åŒ…çš„é…ç½®æ–‡ä»¶ï¼‰</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><strong>Mode</strong> (æ¨¡å¼)\n<ul>\n<li>åŒºåˆ†å¼€å‘ï¼ˆdevelopmentï¼‰ä¸ç”Ÿäº§ï¼ˆproductionï¼‰ç¯å¢ƒï¼Œå†…ç½®ä»£ç å‹ç¼©ç­‰ä¼˜åŒ–</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"æ ¸å¿ƒåŠŸèƒ½ä¸ä¼˜åŒ–\"><a class=\"anchor\" href=\"#æ ¸å¿ƒåŠŸèƒ½ä¸ä¼˜åŒ–\">#</a> æ ¸å¿ƒåŠŸèƒ½ä¸ä¼˜åŒ–</h3>\n<ol>\n<li><strong>çƒ­æ¨¡å—æ›¿æ¢</strong> (HMR)\n<ul>\n<li>å¼€å‘æ—¶ä»…æ›´æ–°ä¿®æ”¹çš„æ¨¡å—ï¼Œæå‡æ„å»ºé€Ÿåº¦ã€‚</li>\n<li>é…ç½®ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token literal-property property\">devServer</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">hot</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token literal-property property\">open</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>ç¼“å­˜ä¼˜åŒ–</strong>\n<ul>\n<li>hash ç­–ç•¥ï¼š\n<ul>\n<li>hash: å…¨å±€å”¯ä¸€å“ˆå¸Œï¼Œä»»ä¸€æ–‡ä»¶å˜åŠ¨åˆ™å…¨éƒ¨æ›´æ–°ã€‚</li>\n<li>chunkhash: åŸºäº Chunk ç”Ÿæˆï¼ŒåŒ Chunk å…±äº«å“ˆå¸Œã€‚</li>\n<li>contenthash: åŸºäºæ–‡ä»¶å†…å®¹ç”Ÿæˆï¼Œæ–‡ä»¶å†…å®¹ä¸å˜åˆ™å“ˆå¸Œä¸å˜ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><strong>Tree Shaking</strong>\n<ul>\n<li>ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œéœ€è¦æ»¡è¶³ ES6 æ¨¡å—åŒ–è§„èŒƒï¼Œä¸”ä½¿ç”¨ tree-shaking æ’ä»¶</li>\n</ul>\n</li>\n<li><strong>Source Map</strong>\n<ul>\n<li>æ˜ å°„ç¼–è¯‘åä»£ç åˆ°æºç ï¼Œä¾¿äºè°ƒè¯•ã€‚å¸¸ç”¨é…ç½®ï¼š\n<ul>\n<li>å¼€å‘ç¯å¢ƒï¼š <code>cheap-module-eval-source-map</code> ï¼ˆå¿«é€Ÿå®šä½è¡Œï¼‰</li>\n<li>ç”Ÿäº§ç¯å¢ƒï¼š <code>cheap-module-source-map</code> ï¼ˆä¸æš´éœ²æºç ï¼‰</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"å¼€å‘ä¸ç”Ÿäº§ç¯å¢ƒé…ç½®\"><a class=\"anchor\" href=\"#å¼€å‘ä¸ç”Ÿäº§ç¯å¢ƒé…ç½®\">#</a> å¼€å‘ä¸ç”Ÿäº§ç¯å¢ƒé…ç½®</h3>\n<ol>\n<li><strong>å¼€å‘æœåŠ¡å™¨</strong>\n<ul>\n<li>å¯åŠ¨æœ¬åœ°æœåŠ¡å¹¶æ”¯æŒä»£ç†ï¼ŒHMRï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token literal-property property\">devServer</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">port</span><span class=\"token operator\">:</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token literal-property property\">proxy</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">'/api'</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:3000'</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>ä»£ç åˆ†å‰²</strong>\n<ul>\n<li>é€šè¿‡  <code>SplitChunksPlugin</code>  æ‹†åˆ†å…¬å…±ä»£ç ï¼Œå‡å°‘é¦–å±åŠ è½½æ—¶é—´</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"å¸¸è§èµ„æºå¤„ç†ç¤ºä¾‹\"><a class=\"anchor\" href=\"#å¸¸è§èµ„æºå¤„ç†ç¤ºä¾‹\">#</a> å¸¸è§èµ„æºå¤„ç†ç¤ºä¾‹</h3>\n<ol>\n<li>å¤„ç†å›¾ç‰‡ä¸å­—ä½“\n<ul>\n<li>ä½¿ç”¨  <code>url-loader</code>  æˆ–  <code>file-loader</code> ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.(png|jpg|gif)$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token literal-property property\">use</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> <span class=\"token string\">'url-loader'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token literal-property property\">options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">limit</span><span class=\"token operator\">:</span> <span class=\"token number\">8192</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// å°äº 8KB è½¬ä¸º Base64</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>å¤„ç† Less/Sass\n<ul>\n<li>å®‰è£… <code>less-loader</code>  å’Œ <code>sass-loader</code> ï¼Œé…ç½®é“¾å¼ Loaderï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.less$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token literal-property property\">use</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'style-loader'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'css-loader'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'less-loader'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"å®é™…åº”ç”¨ç¤ºä¾‹\"><a class=\"anchor\" href=\"#å®é™…åº”ç”¨ç¤ºä¾‹\">#</a> å®é™…åº”ç”¨ç¤ºä¾‹</h3>\n<ol>\n<li>å®‰è£… <code>webpack</code></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev webpack webpack-cli</pre></td></tr></table></figure><ol start=\"2\">\n<li>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>webpack.config.js</code> ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å…¥å£æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// è¾“å‡ºè·¯å¾„</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'main.js'</span> <span class=\"token comment\">// è¾“å‡ºæ–‡ä»¶å</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> config</pre></td></tr></table></figure><ol start=\"3\">\n<li>æ·»åŠ è„šæœ¬åˆ° <code>package.json</code> ï¼šæ–¹ä¾¿æ‰§è¡Œ <code>npm run build</code></li>\n</ol>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack --mode=development\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>æŠŠåº”ç”¨å˜æˆä¸€ä¸ªæœ€å°çš„ React åº”ç”¨</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> react react-dom</pre></td></tr></table></figure><ol start=\"5\">\n<li>é…ç½®åŠ è½½å™¨ï¼Œå°† Jxx è„šæœ¬è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„ JavaScript ä»£ç </li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'main.js'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token literal-property property\">module</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// æ·»åŠ åŠ è½½å™¨</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token literal-property property\">rules</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.js$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> <span class=\"token string\">'babel-loader'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token literal-property property\">options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token literal-property property\">presets</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@babel/preset-react'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æŠŠåŠ è½½å™¨å’Œå®ƒæ‰€éœ€è¦çš„åŒ…ä½œä¸ºå¼€å‘ä¾èµ–é¡¹æ¥å®‰è£…</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> @babel/core babel-loader @babel/preset-react --save-dev</pre></td></tr></table></figure><ol start=\"6\">\n<li>æŠŠ babel æ‰§è¡Œçš„è½¬ç½®è¿‡ç¨‹è®¾ç½®ä¸ºé¢„è®¾ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª babel-loader</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.js$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> <span class=\"token string\">'babel-loader'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token literal-property property\">options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token literal-property property\">presets</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'@babel/preset-react'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç”¨å‘½ä»¤å®‰è£…è¿™ä¸ªé¢„è®¾</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> @babel/preset-env --save-dev</pre></td></tr></table></figure><ol start=\"7\">\n<li>ä½¿ç”¨ CSS æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ CSS å’Œ style åŠ è½½å™¨</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">rules</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.js$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> <span class=\"token string\">'babel-loader'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token literal-property property\">options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token literal-property property\">presets</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@babel/preset-react'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.css$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token literal-property property\">use</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'style-loader'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'css-loader'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å®‰è£…åŠ è½½å™¨</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> style-loader css-loader --save-dev</pre></td></tr></table></figure><ol start=\"8\">\n<li>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿå¯¹åº”ä»£ç æ”¹å˜çš„ serviceï¼Œä½¿å¾—ä¸éœ€è¦ä»æ–°åˆ·æ–°é¡µé¢</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev webpack-dev-server</pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ª npm è„šæœ¬æ¥å¯åŠ¨</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack --mode=development\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack serve --mode=development\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨ webpack.config.js ä¸­æ·»åŠ  devServer é…ç½®</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'main.js'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token literal-property property\">devServer</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// æ·»åŠ  devServer</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">static</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token literal-property property\">compress</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token literal-property property\">port</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>npm start</code>  å‘½ä»¤åœ¨ 3000 ç«¯å£å¯åŠ¨ä¸€ä¸ªæœåŠ¡äº†</p>\n<ol start=\"9\">\n<li>å½“æˆ‘ä»¬ä»£ç å‡ºé”™æ—¶ï¼Œé”™è¯¯ä½ç½®ä¸æºä»£ç çš„å®é™…ä½ç½®ä¸ä¸€è‡´<br />\næˆ‘ä»¬éœ€è¦ webpack ä¸º bundle ç”Ÿæˆä¸€ä¸ªæ‰€è°“çš„ source mapï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥çŸ¥é“é”™è¯¯ä½ç½®<br />\nåœ¨é…ç½®å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ <code>devtool</code>  å±æ€§</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token literal-property property\">devServer</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token literal-property property\">devtool</span><span class=\"token operator\">:</span> <span class=\"token string\">'source-map'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ·»åŠ  devtool</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// ..</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"10\">\n<li>æˆ‘ä»¬å¯ä»¥è®¾ç½® webpack åœ¨ production æ¨¡å¼ä¸‹ä½¿ç”¨ä¸€äº›ä¼˜åŒ–</li>\n</ol>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack-part7\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.0.1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"practising webpack\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack --mode=production\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ç”Ÿäº§æ¨¡å¼</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack serve --mode=development\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token property\">\"license\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MIT\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "React",
                "React",
                "webpack"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%87%AA%E5%AE%9A%E4%B9%89hook/",
            "url": "https://aynya.github.io/%E8%87%AA%E5%AE%9A%E4%B9%89hook/",
            "title": "è‡ªå®šä¹‰hook",
            "date_published": "2025-03-21T07:46:09.000Z",
            "content_html": "<h3 id=\"ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰hook\"><a class=\"anchor\" href=\"#ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰hook\">#</a> ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰ hookï¼Ÿ</h3>\n<p>è‡ªå®šä¹‰ Hooks æ˜¯ä¸€ä¸ªä»¥ <code>use</code>  å¼€å¤´çš„ JavaScript å‡½æ•°ï¼Œå®ƒå†…éƒ¨å¯ä»¥è°ƒç”¨å…¶ä»–çš„ Hooksï¼Œå¦‚ <code>useState</code> ã€ <code>useEffect</code>  ç­‰ã€‚</p>\n<h3 id=\"ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªå®šä¹‰hooks\"><a class=\"anchor\" href=\"#ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªå®šä¹‰hooks\">#</a> ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªå®šä¹‰ Hooks?</h3>\n<ul>\n<li><strong>ä»£ç å¤ç”¨</strong>ï¼š å½“å¤šä¸ªç»„ä»¶éœ€è¦ç›¸åŒçš„é€»è¾‘æ—¶ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ Hooks å°†è¿™äº›é€»è¾‘å°è£…èµ·æ¥ï¼Œé¿å…é‡å¤ç¼–å†™ç›¸åŒçš„ä»£ç ã€‚</li>\n<li><strong>æé«˜ä»£ç æ¸…æ™°åº¦</strong>ï¼šé€šè¿‡å°†ç‰¹å®šåŠŸèƒ½çš„é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¯ä»¥ä½¿ç»„ä»¶æ›´åŠ ç®€æ´ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤ã€‚</li>\n</ul>\n<h3 id=\"å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰hooks\"><a class=\"anchor\" href=\"#å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰hooks\">#</a> å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰ Hooksï¼Ÿ</h3>\n<p>åˆ›å»ºè‡ªå®šä¹‰ Hooks éå¸¸ç®€å•ï¼Œåªéœ€ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶æ ¹æ®éœ€è¦åœ¨å…¶å†…éƒ¨è°ƒç”¨å…¶ä»– Hooksã€‚<br />\nä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨ Hookï¼Œå¯ä»¥è¿™æ ·åšï¼š</p>\n<figure class=\"highlight jsx\"><figcaption data-lang=\"React JSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useState <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">useCounter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">initialValue <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>initialValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">increment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">decrement</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token punctuation\">,</span> increment<span class=\"token punctuation\">,</span> decrement <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ç»„ä»¶ä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨</p>\n<figure class=\"highlight jsx\"><figcaption data-lang=\"React JSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> useCounter <span class=\"token keyword\">from</span> <span class=\"token string\">'./useCounter'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">CounterComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token punctuation\">,</span> increment<span class=\"token punctuation\">,</span> decrement <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">useCounter</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Count: </span><span class=\"token punctuation\">&#123;</span>count<span class=\"token punctuation\">&#125;</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>increment<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Increase</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>decrement<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Decrease</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> CounterComponent<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"è‡ªå®šä¹‰hooksçš„é«˜çº§åº”ç”¨\"><a class=\"anchor\" href=\"#è‡ªå®šä¹‰hooksçš„é«˜çº§åº”ç”¨\">#</a> è‡ªå®šä¹‰ hooks çš„é«˜çº§åº”ç”¨</h3>\n<p>è‡ªå®šä¹‰ Hooks è¿˜å¯ä»¥ç”¨äºå¤„ç†å‰¯ä½œç”¨ï¼ˆå¦‚æ•°æ®è·å–ï¼‰ã€ç»„åˆå¤šä¸ª Hooksã€å‚æ•°åŒ– Hooks ä»¥åŠåŒ…å«æ¡ä»¶é€»è¾‘ç­‰</p>\n<ul>\n<li><strong>å¤„ç†å‰¯ä½œç”¨</strong>ï¼šæ¯”å¦‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºæ•°æ®è·å–çš„ Hookã€‚</li>\n<li><strong>ç»„åˆå¤šä¸ª Hooks</strong>ï¼šæ¯”å¦‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª Hookï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°è¿”å›ä¸€ä¸ªåŒ…å«å¤šä¸ª Hooks çš„ç»„åˆã€‚</li>\n<li><strong>å‚æ•°åŒ– Hooks</strong>ï¼šæ¯”å¦‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª Hookï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°è¿”å›ä¸€ä¸ªå®šåˆ¶åŒ–çš„ Hookã€‚</li>\n<li><strong>åŒ…å«æ¡ä»¶é€»è¾‘</strong>ï¼šæ¯”å¦‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª Hookï¼Œå®ƒæ ¹æ®æ¡ä»¶è¿”å›ä¸åŒçš„ Hookã€‚</li>\n</ul>\n<h3 id=\"æœ€ä½³å®è·µ\"><a class=\"anchor\" href=\"#æœ€ä½³å®è·µ\">#</a> æœ€ä½³å®è·µ</h3>\n<ul>\n<li>ç¡®ä¿è‡ªå®šä¹‰ Hooks åªåœ¨é¡¶å±‚æ— æ¡ä»¶åœ°è°ƒç”¨å…¶ä»– Hooksã€‚</li>\n<li>å°½é‡ä¿æŒè‡ªå®šä¹‰ Hooks çš„åŠŸèƒ½å•ä¸€ï¼Œæ¯ä¸ª Hook åº”è¯¥ä¸“æ³¨äºè§£å†³ä¸€ä¸ªé—®é¢˜ã€‚</li>\n<li>åœ¨è®¾è®¡è‡ªå®šä¹‰ Hooks æ—¶è€ƒè™‘å…¶å¯æµ‹è¯•æ€§å’Œè°ƒè¯•ä¾¿åˆ©æ€§ã€‚</li>\n</ul>\n",
            "tags": [
                "React",
                "react",
                "hooks"
            ]
        }
    ]
}