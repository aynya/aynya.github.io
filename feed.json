{
    "version": "https://jsonfeed.org/version/1",
    "title": "ayçš„åšå®¢",
    "subtitle": "ayçš„åšå®¢",
    "icon": "https://aynya.github.io/images/favicon.ico",
    "description": "ayçš„åšå®¢",
    "home_page_url": "https://aynya.github.io",
    "items": [
        {
            "id": "https://aynya.github.io/Vue-Express-%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0%E9%83%A8%E5%88%86%E6%80%9D%E8%80%83%E5%AE%9E%E7%8E%B0/",
            "url": "https://aynya.github.io/Vue-Express-%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0%E9%83%A8%E5%88%86%E6%80%9D%E8%80%83%E5%AE%9E%E7%8E%B0/",
            "title": "Vue + Express å¤´åƒä¸Šä¼ éƒ¨åˆ†æ€è€ƒå®ç°",
            "date_published": "2026-01-23T04:21:56.000Z",
            "content_html": "<h1 id=\"vue-express-å¤´åƒä¸Šä¼ éƒ¨åˆ†æ€è€ƒå®ç°\"><a class=\"anchor\" href=\"#vue-express-å¤´åƒä¸Šä¼ éƒ¨åˆ†æ€è€ƒå®ç°\">#</a> Vue + Express å¤´åƒä¸Šä¼ éƒ¨åˆ†æ€è€ƒå®ç°</h1>\n<h2 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> ğŸ“– å‰è¨€</h2>\n<p>åœ¨ Web åº”ç”¨ä¸­ï¼Œå¤´åƒä¸Šä¼ æ˜¯ä¸€ä¸ªå¸¸è§çš„åŠŸèƒ½éœ€æ±‚ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Vue 3 + Express + MySQL çš„æŠ€æœ¯æ ˆä¸­å®ç°ä¸€ä¸ªå®Œæ•´çš„å¤´åƒä¸Šä¼ åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‰ç«¯é¢„è§ˆã€åç«¯å­˜å‚¨ã€æ–‡ä»¶ç®¡ç†å’Œèµ„æºæ¸…ç†ç­‰å…¨æµç¨‹ã€‚</p>\n<h2 id=\"æ ¸å¿ƒè®¾è®¡æ€è·¯\"><a class=\"anchor\" href=\"#æ ¸å¿ƒè®¾è®¡æ€è·¯\">#</a> ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€è·¯</h2>\n<p>æˆ‘ä»¬çš„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</p>\n<ol>\n<li><strong>å»¶è¿Ÿä¸Šä¼ </strong>ï¼šç”¨æˆ·é€‰æ‹©å›¾ç‰‡åï¼Œåªåœ¨å‰ç«¯æ˜¾ç¤ºé¢„è§ˆï¼Œä¸ç«‹å³ä¸Šä¼ </li>\n<li><strong>ç»Ÿä¸€å¤„ç†</strong>ï¼šåªæœ‰åœ¨ä¿å­˜æ•°æ®æ—¶æ‰ä¸Šä¼ å›¾ç‰‡ï¼Œé¿å…æ— æ•ˆä¸Šä¼ </li>\n<li><strong>èµ„æºç®¡ç†</strong>ï¼šè‡ªåŠ¨æ¸…ç†æ—§å›¾ç‰‡ï¼Œé¿å…æ–‡ä»¶ç³»ç»Ÿåƒåœ¾</li>\n<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå­˜å‚¨ç›¸å¯¹è·¯å¾„è€Œé base64ï¼Œå‡å°‘æ•°æ®åº“å’Œç½‘ç»œä¼ è¾“å‹åŠ›</li>\n</ol>\n<h2 id=\"æŠ€æœ¯æ ˆ\"><a class=\"anchor\" href=\"#æŠ€æœ¯æ ˆ\">#</a> ğŸ“‹ æŠ€æœ¯æ ˆ</h2>\n<ul>\n<li><strong>å‰ç«¯</strong>ï¼šVue 3 + TypeScript + Element Plus</li>\n<li><strong>åç«¯</strong>ï¼šExpress + TypeScript + MySQL</li>\n<li><strong>æ–‡ä»¶å­˜å‚¨</strong>ï¼šæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆå¯æ‰©å±•ä¸º OSS/CDNï¼‰</li>\n</ul>\n<h2 id=\"ï¸-æ•´ä½“æ¶æ„\"><a class=\"anchor\" href=\"#ï¸-æ•´ä½“æ¶æ„\">#</a> ğŸ—ï¸ æ•´ä½“æ¶æ„</h2>\n<pre><code>ç”¨æˆ·é€‰æ‹©å›¾ç‰‡\n    â†“\nå‰ç«¯è¯»å–ä¸º base64ï¼ˆé¢„è§ˆï¼‰\n    â†“\nç”¨æˆ·ç‚¹å‡»ä¿å­˜\n    â†“\nå‘é€ base64 åˆ°åç«¯\n    â†“\nåç«¯ä¿å­˜ä¸ºæ–‡ä»¶ â†’ è¿”å›ç›¸å¯¹è·¯å¾„\n    â†“\nå­˜å‚¨ç›¸å¯¹è·¯å¾„åˆ°æ•°æ®åº“\n    â†“\nå‰ç«¯é€šè¿‡é™æ€æ–‡ä»¶æœåŠ¡è®¿é—®å›¾ç‰‡\n</code></pre>\n<h2 id=\"å®ç°æ­¥éª¤\"><a class=\"anchor\" href=\"#å®ç°æ­¥éª¤\">#</a> ğŸ’» å®ç°æ­¥éª¤</h2>\n<h3 id=\"ç¬¬ä¸€æ­¥å‰ç«¯å›¾ç‰‡é€‰æ‹©å’Œé¢„è§ˆ\"><a class=\"anchor\" href=\"#ç¬¬ä¸€æ­¥å‰ç«¯å›¾ç‰‡é€‰æ‹©å’Œé¢„è§ˆ\">#</a> ç¬¬ä¸€æ­¥ï¼šå‰ç«¯å›¾ç‰‡é€‰æ‹©å’Œé¢„è§ˆ</h3>\n<p>å½“ç”¨æˆ·é€‰æ‹©å›¾ç‰‡æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨  <code>FileReader</code>  API å°†å›¾ç‰‡è¯»å–ä¸º base64 æ ¼å¼ï¼Œç”¨äºå³æ—¶é¢„è§ˆã€‚</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/web/src/views/CreateAgentView.vue</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">handleImageUpload</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target <span class=\"token keyword\">as</span> HTMLInputElement</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>files<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">// æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º 2MBï¼‰</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">></span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        ElMessage<span class=\"token punctuation\">.</span><span class=\"token function\">warning</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">// è¯»å–ä¸º base64 ç”¨äºé¢„è§ˆï¼ˆä¿å­˜æ—¶ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onloadend</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">const</span> base64 <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// æ˜¾ç¤ºé¢„è§ˆï¼ˆbase64ï¼‰</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        avatar<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> base64</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsDataURL</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Image read error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      ElMessage<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å›¾ç‰‡è¯»å–å¤±è´¥'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>å…³é”®ç‚¹ï¼š</strong></p>\n<ul>\n<li>ä½¿ç”¨  <code>FileReader.readAsDataURL()</code>  å°†æ–‡ä»¶è½¬æ¢ä¸º base64</li>\n<li>ç«‹å³æ˜¾ç¤ºé¢„è§ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ</li>\n<li>æ·»åŠ æ–‡ä»¶å¤§å°éªŒè¯ï¼Œé˜²æ­¢ä¸Šä¼ è¿‡å¤§æ–‡ä»¶</li>\n</ul>\n<h3 id=\"ç¬¬äºŒæ­¥åˆ›å»ºå·¥å…·å‡½æ•°å‰ç«¯\"><a class=\"anchor\" href=\"#ç¬¬äºŒæ­¥åˆ›å»ºå·¥å…·å‡½æ•°å‰ç«¯\">#</a> ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå·¥å…·å‡½æ•°ï¼ˆå‰ç«¯ï¼‰</h3>\n<p>ä¸ºäº†ç»Ÿä¸€å¤„ç†ä¸åŒæ ¼å¼çš„å¤´åƒ URLï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå·¥å…·å‡½æ•°ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/web/src/utils/avatar.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAvatarUrl</span><span class=\"token punctuation\">(</span>avatar<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>avatar<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœæ˜¯ base64 æˆ–å®Œæ•´ URLï¼Œç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data:'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> avatar</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒåŠ ä¸Š API åŸºç¡€ URL</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token constant\">API_BASE_URL</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VITE_API_BASE_URL</span> <span class=\"token operator\">||</span> <span class=\"token string\">'http://localhost:3000'</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">API_BASE_URL</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> avatar <span class=\"token operator\">:</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> avatar<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š</strong></p>\n<ul>\n<li>å¤„ç† base64 æ ¼å¼ï¼ˆé¢„è§ˆæ—¶ä½¿ç”¨ï¼‰</li>\n<li>å¤„ç†å®Œæ•´ URLï¼ˆå¤–éƒ¨é“¾æ¥ï¼‰</li>\n<li>å¤„ç†ç›¸å¯¹è·¯å¾„ï¼ˆæœåŠ¡å™¨å­˜å‚¨çš„å›¾ç‰‡ï¼‰</li>\n</ul>\n<h3 id=\"ç¬¬ä¸‰æ­¥ä¿å­˜æ—¶å‘é€-base64\"><a class=\"anchor\" href=\"#ç¬¬ä¸‰æ­¥ä¿å­˜æ—¶å‘é€-base64\">#</a> ç¬¬ä¸‰æ­¥ï¼šä¿å­˜æ—¶å‘é€ base64</h3>\n<p>å½“ç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶ï¼Œå°† base64 å›¾ç‰‡æ•°æ®ä¸€èµ·å‘é€åˆ°åç«¯ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/web/src/views/CreateAgentView.vue</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleSubmit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">//... å…¶ä»–éªŒè¯é€»è¾‘</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    name<span class=\"token operator\">:</span> name<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    description<span class=\"token operator\">:</span> description<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    tag<span class=\"token operator\">:</span> selectedCategory<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    avatar<span class=\"token operator\">:</span> avatar<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å‘é€ base64 æˆ– URL</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">//... å¤„ç†å“åº”</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ç¬¬å››æ­¥åç«¯å¤„ç†å›¾ç‰‡ä¿å­˜\"><a class=\"anchor\" href=\"#ç¬¬å››æ­¥åç«¯å¤„ç†å›¾ç‰‡ä¿å­˜\">#</a> ç¬¬å››æ­¥ï¼šåç«¯å¤„ç†å›¾ç‰‡ä¿å­˜</h3>\n<p>åç«¯æ¥æ”¶åˆ° base64 æ•°æ®åï¼Œéœ€è¦å°†å…¶ä¿å­˜ä¸ºæ–‡ä»¶ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/utils/avatar.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveAvatarFromBase64</span><span class=\"token punctuation\">(</span>base64<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// 1. è§£æ base64 æ•°æ®</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> base64Data <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^data:image\\/\\w+;base64,</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>base64Data<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// 2. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 2MBï¼‰</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// 3. æ£€æµ‹å›¾ç‰‡æ ¼å¼</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">let</span> fileExtension <span class=\"token operator\">=</span> <span class=\"token string\">'png'</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">const</span> mimeMatch <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">data:image\\/(\\w+);base64</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mimeMatch <span class=\"token operator\">&amp;&amp;</span> mimeMatch<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> ext <span class=\"token operator\">=</span> mimeMatch<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'png'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jpg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gif'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'webp'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      fileExtension <span class=\"token operator\">=</span> ext <span class=\"token operator\">===</span> <span class=\"token string\">'jpeg'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'jpg'</span> <span class=\"token operator\">:</span> ext</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// 4. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> fileId <span class=\"token operator\">=</span> <span class=\"token function\">generateUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> fileName <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileExtension<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">const</span> filePath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UPLOAD_DIR</span><span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// 5. ä¿å­˜æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">// 6. è¿”å›ç›¸å¯¹è·¯å¾„</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/uploads/avatars/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>å…³é”®æ­¥éª¤è§£æï¼š</strong></p>\n<ol>\n<li><strong>è§£æ base64</strong>ï¼šç§»é™¤  <code>data:image/xxx;base64,</code>  å‰ç¼€ï¼Œè·å–çº¯ base64 æ•°æ®</li>\n<li><strong>è½¬æ¢ä¸º Buffer</strong>ï¼šä½¿ç”¨ Node.js çš„  <code>Buffer</code>  å°† base64 è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®</li>\n<li><strong>éªŒè¯å¤§å°</strong>ï¼šç¡®ä¿æ–‡ä»¶ä¸è¶…è¿‡é™åˆ¶</li>\n<li><strong>æ£€æµ‹æ ¼å¼</strong>ï¼šä» base64 å‰ç¼€ä¸­æå–å›¾ç‰‡æ ¼å¼</li>\n<li><strong>ç”Ÿæˆæ–‡ä»¶å</strong>ï¼šä½¿ç”¨ UUID ç¡®ä¿æ–‡ä»¶åå”¯ä¸€</li>\n<li><strong>ä¿å­˜æ–‡ä»¶</strong>ï¼šå†™å…¥åˆ°æŒ‡å®šç›®å½•</li>\n<li><strong>è¿”å›è·¯å¾„</strong>ï¼šè¿”å›ç›¸å¯¹è·¯å¾„ï¼Œä¾¿äºå­˜å‚¨åˆ°æ•°æ®åº“</li>\n</ol>\n<h3 id=\"ç¬¬äº”æ­¥åœ¨åˆ›å»ºæ›´æ–°æ¥å£ä¸­å¤„ç†\"><a class=\"anchor\" href=\"#ç¬¬äº”æ­¥åœ¨åˆ›å»ºæ›´æ–°æ¥å£ä¸­å¤„ç†\">#</a> ç¬¬äº”æ­¥ï¼šåœ¨åˆ›å»º / æ›´æ–°æ¥å£ä¸­å¤„ç†</h3>\n<p>åœ¨åˆ›å»ºæ™ºèƒ½ä½“çš„æ¥å£ä¸­ï¼Œæ£€æµ‹å¹¶å¤„ç† base64 å›¾ç‰‡ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/routes/agents.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>router<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> authenticateToken<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> name<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">,</span> avatar <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// å¤„ç†å¤´åƒï¼šå¦‚æœæ˜¯ base64ï¼Œä¿å­˜ä¸ºæ–‡ä»¶å¹¶è·å–ç›¸å¯¹è·¯å¾„</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">let</span> avatarUrl<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>avatar <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> avatar <span class=\"token operator\">!==</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">const</span> avatarStr <span class=\"token operator\">=</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>avatar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isBase64Image</span><span class=\"token punctuation\">(</span>avatarStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        avatarUrl <span class=\"token operator\">=</span> <span class=\"token function\">saveAvatarFromBase64</span><span class=\"token punctuation\">(</span>avatarStr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          code<span class=\"token operator\">:</span> <span class=\"token number\">4001</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          message<span class=\"token operator\">:</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">'å›¾ç‰‡å¤„ç†å¤±è´¥'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          data<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœä¸æ˜¯ base64ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆå¯èƒ½æ˜¯ URLï¼‰</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      avatarUrl <span class=\"token operator\">=</span> avatarStr <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// å­˜å‚¨åˆ°æ•°æ®åº“</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">await</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">INSERT INTO agents (id, name, description, avatar, ...) VALUES (?, ?, ?, ?, ...)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">[</span>agentId<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> avatarUrl<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"ç¬¬å…­æ­¥æ›´æ–°æ—¶çš„æ—§å›¾ç‰‡æ¸…ç†\"><a class=\"anchor\" href=\"#ç¬¬å…­æ­¥æ›´æ–°æ—¶çš„æ—§å›¾ç‰‡æ¸…ç†\">#</a> ç¬¬å…­æ­¥ï¼šæ›´æ–°æ—¶çš„æ—§å›¾ç‰‡æ¸…ç†</h3>\n<p>æ›´æ–°æ™ºèƒ½ä½“æ—¶ï¼Œå¦‚æœä¸Šä¼ äº†æ–°å›¾ç‰‡ï¼Œéœ€è¦åˆ é™¤æ—§å›¾ç‰‡ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/routes/agents.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateData<span class=\"token punctuation\">.</span>avatar <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">let</span> avatarUrl<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> avatarValue <span class=\"token operator\">=</span> updateData<span class=\"token punctuation\">.</span>avatar <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>updateData<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>avatarValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isBase64Image</span><span class=\"token punctuation\">(</span>avatarValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœæ˜¯ base64ï¼Œä¿å­˜ä¸ºæ–°æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      avatarUrl <span class=\"token operator\">=</span> <span class=\"token function\">saveAvatarFromBase64</span><span class=\"token punctuation\">(</span>avatarValue<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">// åˆ é™¤æ—§å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœä¸æ˜¯ base64ï¼Œç›´æ¥ä½¿ç”¨</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      avatarUrl <span class=\"token operator\">=</span> avatarValue</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœæ–° URL ä¸æ—§ URL ä¸åŒï¼Œåˆ é™¤æ—§å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar <span class=\"token operator\">&amp;&amp;</span> agent<span class=\"token punctuation\">.</span>avatar <span class=\"token operator\">!==</span> avatarUrl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// å¦‚æœè®¾ç½®ä¸º nullï¼Œåˆ é™¤æ—§å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ç¬¬ä¸ƒæ­¥åˆ é™¤æ™ºèƒ½ä½“æ—¶æ¸…ç†å¤´åƒ\"><a class=\"anchor\" href=\"#ç¬¬ä¸ƒæ­¥åˆ é™¤æ™ºèƒ½ä½“æ—¶æ¸…ç†å¤´åƒ\">#</a> ç¬¬ä¸ƒæ­¥ï¼šåˆ é™¤æ™ºèƒ½ä½“æ—¶æ¸…ç†å¤´åƒ</h3>\n<p>åˆ é™¤æ™ºèƒ½ä½“æ—¶ï¼Œä¹Ÿè¦åˆ é™¤å¯¹åº”çš„å¤´åƒæ–‡ä»¶ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/routes/agents.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>router<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:agentId'</span><span class=\"token punctuation\">,</span> authenticateToken<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// æŸ¥è¯¢ agent ä¿¡æ¯ï¼ŒåŒ…æ‹¬ avatar</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> rows <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token generic-function\"><span class=\"token function\">query</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">&#123;</span> avatar<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">'SELECT id, creator_id, avatar FROM agents WHERE id = ?'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">[</span>agentId<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> agent <span class=\"token operator\">=</span> rows<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// åˆ é™¤å…³è”çš„ threads</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">await</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">'DELETE FROM threads WHERE agent_id = ?'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>agentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// åˆ é™¤å¤´åƒæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// åˆ é™¤ agent è®°å½•</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">await</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">'DELETE FROM agents WHERE id = ?'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>agentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"ç¬¬å…«æ­¥é…ç½®é™æ€æ–‡ä»¶æœåŠ¡\"><a class=\"anchor\" href=\"#ç¬¬å…«æ­¥é…ç½®é™æ€æ–‡ä»¶æœåŠ¡\">#</a> ç¬¬å…«æ­¥ï¼šé…ç½®é™æ€æ–‡ä»¶æœåŠ¡</h3>\n<p>ä¸ºäº†è®©å‰ç«¯èƒ½å¤Ÿè®¿é—®ä¸Šä¼ çš„å›¾ç‰‡ï¼Œéœ€è¦é…ç½® Express çš„é™æ€æ–‡ä»¶æœåŠ¡ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/index.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> fileURLToPath <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'url'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> __filename <span class=\"token operator\">=</span> <span class=\"token function\">fileURLToPath</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> __dirname <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>__filename<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// é…ç½®é™æ€æ–‡ä»¶æœåŠ¡</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/uploads'</span><span class=\"token punctuation\">,</span> express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'../uploads'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå‰ç«¯å°±å¯ä»¥é€šè¿‡  <code>http://localhost:3000/uploads/avatars/uuid.png</code>  è®¿é—®å›¾ç‰‡äº†ã€‚</p>\n<h3 id=\"ç¬¬ä¹æ­¥å¢åŠ -json-å¤§å°é™åˆ¶\"><a class=\"anchor\" href=\"#ç¬¬ä¹æ­¥å¢åŠ -json-å¤§å°é™åˆ¶\">#</a> ç¬¬ä¹æ­¥ï¼šå¢åŠ  JSON å¤§å°é™åˆ¶</h3>\n<p>ç”±äº base64 ç¼–ç ä¼šå¢åŠ çº¦ 33% çš„å¤§å°ï¼Œéœ€è¦å¢åŠ  Express çš„ JSON è§£æå¤§å°é™åˆ¶ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/index.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> limit<span class=\"token operator\">:</span> <span class=\"token string\">'3mb'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 2MB å›¾ç‰‡ base64 ç¼–ç åçº¦ 2.67MB</span></pre></td></tr></table></figure><h2 id=\"å·¥å…·å‡½æ•°è¯¦è§£\"><a class=\"anchor\" href=\"#å·¥å…·å‡½æ•°è¯¦è§£\">#</a> ğŸ”§ å·¥å…·å‡½æ•°è¯¦è§£</h2>\n<h3 id=\"å‰ç«¯å·¥å…·å‡½æ•°\"><a class=\"anchor\" href=\"#å‰ç«¯å·¥å…·å‡½æ•°\">#</a> å‰ç«¯å·¥å…·å‡½æ•°</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/web/src/utils/avatar.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * è·å–å¤´åƒ URLï¼ˆå¤„ç†ç›¸å¯¹è·¯å¾„ã€å®Œæ•´ URL å’Œ base64ï¼‰</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAvatarUrl</span><span class=\"token punctuation\">(</span>avatar<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>avatar<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">//base64 æˆ–å®Œæ•´ URL ç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data:'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> avatar</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// ç›¸å¯¹è·¯å¾„éœ€è¦åŠ ä¸Š API åŸºç¡€ URL</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token constant\">API_BASE_URL</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VITE_API_BASE_URL</span> <span class=\"token operator\">||</span> <span class=\"token string\">'http://localhost:3000'</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">API_BASE_URL</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>avatar<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> avatar <span class=\"token operator\">:</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> avatar<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"åç«¯å·¥å…·å‡½æ•°\"><a class=\"anchor\" href=\"#åç«¯å·¥å…·å‡½æ•°\">#</a> åç«¯å·¥å…·å‡½æ•°</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// apps/server/src/utils/avatar.ts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * ä¿å­˜ base64 å›¾ç‰‡åˆ°æ–‡ä»¶ç³»ç»Ÿ</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveAvatarFromBase64</span><span class=\"token punctuation\">(</span>base64<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// è§£æã€éªŒè¯ã€ä¿å­˜æ–‡ä»¶...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/uploads/avatars/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * åˆ é™¤å¤´åƒæ–‡ä»¶</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>avatarUrl<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// åªå¤„ç†ç›¸å¯¹è·¯å¾„ï¼Œå®‰å…¨åˆ é™¤æ–‡ä»¶...</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * æ£€æŸ¥æ˜¯å¦ä¸º base64 å›¾ç‰‡</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isBase64Image</span><span class=\"token punctuation\">(</span>str<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">return</span> str<span class=\"token operator\">?.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data:image/'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ•°æ®æµè½¬å›¾\"><a class=\"anchor\" href=\"#æ•°æ®æµè½¬å›¾\">#</a> ğŸ“Š æ•°æ®æµè½¬å›¾</h2>\n<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  ç”¨æˆ·é€‰æ‹©   â”‚\nâ”‚   å›¾ç‰‡æ–‡ä»¶   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜\n       â”‚\n       â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      FileReader      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  å‰ç«¯è¯»å–   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt; â”‚  base64     â”‚\nâ”‚   ä¸º base64  â”‚                      â”‚  é¢„è§ˆæ˜¾ç¤º    â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n       â”‚\n       â”‚ ç”¨æˆ·ç‚¹å‡»ä¿å­˜\n       â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTP POST       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  å‘é€è¯·æ±‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt; â”‚  åç«¯æ¥æ”¶   â”‚\nâ”‚  (å« base64) â”‚                      â”‚   base64     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜\n                                            â”‚\n                                            â–¼\n                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                    â”‚ ä¿å­˜ä¸ºæ–‡ä»¶   â”‚\n                                    â”‚ ç”Ÿæˆ UUID    â”‚\n                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜\n                                           â”‚\n                                           â–¼\n                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                    â”‚ è¿”å›ç›¸å¯¹è·¯å¾„ â”‚\n                                    â”‚ /uploads/... â”‚\n                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜\n                                           â”‚\n                                           â–¼\n                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                    â”‚ å­˜å‚¨åˆ°æ•°æ®åº“ â”‚\n                                    â”‚  VARCHAR(255)â”‚\n                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n</code></pre>\n<h2 id=\"å‰ç«¯ä½¿ç”¨ç¤ºä¾‹\"><a class=\"anchor\" href=\"#å‰ç«¯ä½¿ç”¨ç¤ºä¾‹\">#</a> ğŸ¨ å‰ç«¯ä½¿ç”¨ç¤ºä¾‹</h2>\n<p>åœ¨ Vue ç»„ä»¶ä¸­ä½¿ç”¨ï¼š</p>\n<pre><code class=\"language-vue\">&lt;template&gt;\n  &lt;div&gt;\n    &lt;!-- å¤´åƒé¢„è§ˆ --&gt;\n    &lt;img v-if=&quot;avatar&quot; :src=&quot;getAvatarUrl(avatar)&quot; alt=&quot;Avatar&quot; /&gt;\n    \n    &lt;!-- æ–‡ä»¶é€‰æ‹© --&gt;\n    &lt;input\n      ref=&quot;fileInputRef&quot;\n      type=&quot;file&quot;\n      @change=&quot;handleImageUpload&quot;\n      accept=&quot;image/*&quot;\n    /&gt;\n  &lt;/div&gt;\n&lt;/template&gt;\n\n&lt;script setup lang=&quot;ts&quot;&gt;\nimport &#123; ref &#125; from 'vue'\nimport &#123; getAvatarUrl &#125; from '@/utils/avatar'\n\nconst avatar = ref&lt;string | null&gt;(null)\nconst fileInputRef = ref&lt;HTMLInputElement | null&gt;(null)\n\nfunction handleImageUpload(e: Event) &#123;\n  const file = (e.target as HTMLInputElement).files?.[0]\n  if (file) &#123;\n    const reader = new FileReader()\n    reader.onloadend = () =&gt; &#123;\n      avatar.value = reader.result as string // base64\n    &#125;\n    reader.readAsDataURL(file)\n  &#125;\n&#125;\n&lt;/script&gt;\n</code></pre>\n<h2 id=\"ï¸-æ•°æ®åº“è®¾è®¡\"><a class=\"anchor\" href=\"#ï¸-æ•°æ®åº“è®¾è®¡\">#</a> ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡</h2>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> agents <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  id <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  name <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  description <span class=\"token keyword\">TEXT</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  avatar <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">-- å­˜å‚¨ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ /uploads/avatars/uuid.png</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">-- ... å…¶ä»–å­—æ®µ</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨ VARCHAR (255)ï¼Ÿ</strong></p>\n<ul>\n<li>ç›¸å¯¹è·¯å¾„é€šå¸¸åªæœ‰ 50-100 ä¸ªå­—ç¬¦</li>\n<li>ä¸éœ€è¦ TEXT ç±»å‹ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´</li>\n<li>è¶³å¤Ÿå­˜å‚¨å®Œæ•´çš„ç›¸å¯¹è·¯å¾„</li>\n</ul>\n<h2 id=\"æ€§èƒ½ä¼˜åŒ–è¦ç‚¹\"><a class=\"anchor\" href=\"#æ€§èƒ½ä¼˜åŒ–è¦ç‚¹\">#</a> âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</h2>\n<h3 id=\"1-å»¶è¿Ÿä¸Šä¼ ç­–ç•¥\"><a class=\"anchor\" href=\"#1-å»¶è¿Ÿä¸Šä¼ ç­–ç•¥\">#</a> 1. å»¶è¿Ÿä¸Šä¼ ç­–ç•¥</h3>\n<p><strong>é—®é¢˜</strong>ï¼šå¦‚æœç”¨æˆ·é€‰æ‹©å›¾ç‰‡åç«‹å³ä¸Šä¼ ï¼Œä½†æœ€ç»ˆå–æ¶ˆæ“ä½œï¼Œä¼šäº§ç”Ÿæ— æ•ˆä¸Šä¼ ã€‚</p>\n<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåªåœ¨ç”¨æˆ·ç¡®è®¤ä¿å­˜æ—¶æ‰ä¸Šä¼ ã€‚</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// âŒ ä¸å¥½çš„åšæ³•ï¼šç«‹å³ä¸Šä¼ </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleImageUpload</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> <span class=\"token operator\">...</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> base64 <span class=\"token operator\">=</span> <span class=\"token operator\">...</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">await</span> <span class=\"token function\">uploadAvatar</span><span class=\"token punctuation\">(</span>base64<span class=\"token punctuation\">)</span> <span class=\"token comment\">// ç«‹å³ä¸Šä¼ </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  avatar<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>url</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// âœ… å¥½çš„åšæ³•ï¼šå»¶è¿Ÿä¸Šä¼ </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">handleImageUpload</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> <span class=\"token operator\">...</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> base64 <span class=\"token operator\">=</span> <span class=\"token operator\">...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  avatar<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> base64 <span class=\"token comment\">// åªæ˜¾ç¤ºé¢„è§ˆ</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// ä¿å­˜æ—¶æ‰ä¸Šä¼ </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"2-å­˜å‚¨ç›¸å¯¹è·¯å¾„è€Œé-base64\"><a class=\"anchor\" href=\"#2-å­˜å‚¨ç›¸å¯¹è·¯å¾„è€Œé-base64\">#</a> 2. å­˜å‚¨ç›¸å¯¹è·¯å¾„è€Œé base64</h3>\n<p><strong>é—®é¢˜</strong>ï¼šbase64 ç¼–ç ä¼šå¢åŠ çº¦ 33% çš„å¤§å°ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“ä¼šå ç”¨å¤§é‡ç©ºé—´ã€‚</p>\n<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä¿å­˜ä¸ºæ–‡ä»¶ï¼Œåªå­˜å‚¨ç›¸å¯¹è·¯å¾„ã€‚</p>\n<table>\n<thead>\n<tr>\n<th>æ–¹æ¡ˆ</th>\n<th>2MB å›¾ç‰‡å¤§å°</th>\n<th>æ•°æ®åº“å ç”¨</th>\n<th>åˆ—è¡¨æ¥å£ä¼ è¾“</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>base64</td>\n<td>~2.67MB</td>\n<td>~2.67MB</td>\n<td>æ¯ä¸ªæ™ºèƒ½ä½“ 2.67MB</td>\n</tr>\n<tr>\n<td>ç›¸å¯¹è·¯å¾„</td>\n<td>2MBï¼ˆæ–‡ä»¶ï¼‰</td>\n<td>~50 å­—ç¬¦</td>\n<td>æ¯ä¸ªæ™ºèƒ½ä½“ 50 å­—ç¬¦</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-è‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶\"><a class=\"anchor\" href=\"#3-è‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶\">#</a> 3. è‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶</h3>\n<p><strong>é—®é¢˜</strong>ï¼šæ›´æ–°æˆ–åˆ é™¤æ—¶ï¼Œæ—§å›¾ç‰‡æ–‡ä»¶ä¼šæ®‹ç•™åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>\n<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåœ¨æ›´æ–°å’Œåˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†ã€‚</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æ›´æ–°æ—¶åˆ é™¤æ—§å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isBase64Image</span><span class=\"token punctuation\">(</span>newAvatar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  avatarUrl <span class=\"token operator\">=</span> <span class=\"token function\">saveAvatarFromBase64</span><span class=\"token punctuation\">(</span>newAvatar<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldAvatar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>oldAvatar<span class=\"token punctuation\">)</span> <span class=\"token comment\">// åˆ é™¤æ—§æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// åˆ é™¤æ™ºèƒ½ä½“æ—¶åˆ é™¤å¤´åƒ</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">deleteAvatarFile</span><span class=\"token punctuation\">(</span>agent<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ï¸-å®‰å…¨è€ƒè™‘\"><a class=\"anchor\" href=\"#ï¸-å®‰å…¨è€ƒè™‘\">#</a> ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘</h2>\n<h3 id=\"1-æ–‡ä»¶å¤§å°é™åˆ¶\"><a class=\"anchor\" href=\"#1-æ–‡ä»¶å¤§å°é™åˆ¶\">#</a> 1. æ–‡ä»¶å¤§å°é™åˆ¶</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å‰ç«¯é™åˆ¶</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">></span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ElMessage<span class=\"token punctuation\">.</span><span class=\"token function\">warning</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// åç«¯é™åˆ¶</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"2-æ–‡ä»¶æ ¼å¼éªŒè¯\"><a class=\"anchor\" href=\"#2-æ–‡ä»¶æ ¼å¼éªŒè¯\">#</a> 2. æ–‡ä»¶æ ¼å¼éªŒè¯</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åªå…è®¸å¸¸è§å›¾ç‰‡æ ¼å¼</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> allowedFormats <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'png'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jpg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gif'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'webp'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>allowedFormats<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>ext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  fileExtension <span class=\"token operator\">=</span> <span class=\"token string\">'png'</span> <span class=\"token comment\">// é»˜è®¤ä½¿ç”¨ png</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"3-è·¯å¾„å®‰å…¨\"><a class=\"anchor\" href=\"#3-è·¯å¾„å®‰å…¨\">#</a> 3. è·¯å¾„å®‰å…¨</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åˆ é™¤æ–‡ä»¶æ—¶ï¼Œåªå¤„ç†ç›¸å¯¹è·¯å¾„</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>avatarUrl<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data:'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> avatarUrl<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token comment\">// ä¸å¤„ç† base64 æˆ–å¤–éƒ¨ URL</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ–‡ä»¶ç»“æ„\"><a class=\"anchor\" href=\"#æ–‡ä»¶ç»“æ„\">#</a> ğŸ“ æ–‡ä»¶ç»“æ„</h2>\n<pre><code>é¡¹ç›®æ ¹ç›®å½•/\nâ”œâ”€â”€ apps/\nâ”‚   â”œâ”€â”€ web/\nâ”‚   â”‚   â””â”€â”€ src/\nâ”‚   â”‚       â”œâ”€â”€ utils/\nâ”‚   â”‚       â”‚   â””â”€â”€ avatar.ts          # å‰ç«¯å¤´åƒå·¥å…·å‡½æ•°\nâ”‚   â”‚       â”œâ”€â”€ views/\nâ”‚   â”‚       â”‚   â”œâ”€â”€ CreateAgentView.vue\nâ”‚   â”‚       â”‚   â””â”€â”€ ConfigureAgentView.vue\nâ”‚   â”‚       â””â”€â”€ components/\nâ”‚   â”‚           â”œâ”€â”€ AgentCard.vue\nâ”‚   â”‚           â””â”€â”€ AgentDetailModal.vue\nâ”‚   â””â”€â”€ server/\nâ”‚       â””â”€â”€ src/\nâ”‚           â”œâ”€â”€ utils/\nâ”‚           â”‚   â””â”€â”€ avatar.ts          # åç«¯å¤´åƒå·¥å…·å‡½æ•°\nâ”‚           â”œâ”€â”€ routes/\nâ”‚           â”‚   â””â”€â”€ agents.ts          # æ™ºèƒ½ä½“è·¯ç”±\nâ”‚           â”œâ”€â”€ index.ts               # Express é…ç½®\nâ”‚           â””â”€â”€ uploads/               # ä¸Šä¼ æ–‡ä»¶ç›®å½•\nâ”‚               â””â”€â”€ avatars/            # å¤´åƒå­˜å‚¨ç›®å½•\nâ””â”€â”€ packages/\n    â””â”€â”€ types/\n        â””â”€â”€ src/\n            â””â”€â”€ index.ts               # ç±»å‹å®šä¹‰\n</code></pre>\n<h2 id=\"å¸¸è§é—®é¢˜\"><a class=\"anchor\" href=\"#å¸¸è§é—®é¢˜\">#</a> ğŸ” å¸¸è§é—®é¢˜</h2>\n<h3 id=\"q1-ä¸ºä»€ä¹ˆä¸åœ¨é€‰æ‹©å›¾ç‰‡æ—¶ç«‹å³ä¸Šä¼ \"><a class=\"anchor\" href=\"#q1-ä¸ºä»€ä¹ˆä¸åœ¨é€‰æ‹©å›¾ç‰‡æ—¶ç«‹å³ä¸Šä¼ \">#</a> Q1: ä¸ºä»€ä¹ˆä¸åœ¨é€‰æ‹©å›¾ç‰‡æ—¶ç«‹å³ä¸Šä¼ ï¼Ÿ</h3>\n<p><strong>A:</strong> å»¶è¿Ÿä¸Šä¼ å¯ä»¥é¿å…æ— æ•ˆä¸Šä¼ ã€‚å¦‚æœç”¨æˆ·é€‰æ‹©å›¾ç‰‡åå–æ¶ˆæ“ä½œï¼Œç«‹å³ä¸Šä¼ ä¼šäº§ç”Ÿæ— ç”¨çš„æ–‡ä»¶ã€‚åªæœ‰åœ¨ç”¨æˆ·ç¡®è®¤ä¿å­˜æ—¶æ‰ä¸Šä¼ ï¼Œæ›´åŠ é«˜æ•ˆã€‚</p>\n<h3 id=\"q2-ä¸ºä»€ä¹ˆä¸ç›´æ¥å­˜å‚¨-base64-åˆ°æ•°æ®åº“\"><a class=\"anchor\" href=\"#q2-ä¸ºä»€ä¹ˆä¸ç›´æ¥å­˜å‚¨-base64-åˆ°æ•°æ®åº“\">#</a> Q2: ä¸ºä»€ä¹ˆä¸ç›´æ¥å­˜å‚¨ base64 åˆ°æ•°æ®åº“ï¼Ÿ</h3>\n<p><strong>A:</strong> base64 ç¼–ç ä¼šå¢åŠ çº¦ 33% çš„å¤§å°ï¼Œ2MB çš„å›¾ç‰‡ä¼šå˜æˆçº¦ 2.67MBã€‚å¦‚æœåˆ—è¡¨æ¥å£è¿”å›å¤šä¸ªæ™ºèƒ½ä½“ï¼Œæ¯ä¸ªéƒ½åŒ…å« base64 å¤´åƒï¼Œä¼šå¯¼è‡´ï¼š</p>\n<ul>\n<li>æ•°æ®åº“å­˜å‚¨å‹åŠ›å¤§</li>\n<li>ç½‘ç»œä¼ è¾“æ…¢</li>\n<li>å‰ç«¯è§£ææ…¢</li>\n</ul>\n<p>å­˜å‚¨ç›¸å¯¹è·¯å¾„åªéœ€è¦çº¦ 50 å­—ç¬¦ï¼Œæ€§èƒ½æ›´å¥½ã€‚</p>\n<h3 id=\"q3-å¦‚ä½•æ‰©å±•ä¸ºä½¿ç”¨-osscdn\"><a class=\"anchor\" href=\"#q3-å¦‚ä½•æ‰©å±•ä¸ºä½¿ç”¨-osscdn\">#</a> Q3: å¦‚ä½•æ‰©å±•ä¸ºä½¿ç”¨ OSS/CDNï¼Ÿ</h3>\n<p><strong>A:</strong> åªéœ€è¦ä¿®æ”¹  <code>saveAvatarFromBase64</code>  å‡½æ•°ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveAvatarFromBase64</span><span class=\"token punctuation\">(</span>base64<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>base64Data<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// ä¸Šä¼ åˆ° OSS</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> fileName <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token function\">generateUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileExtension<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">await</span> ossClient<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">avatars/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// è¿”å› CDN URL</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://cdn.example.com/avatars/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>fileName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"q4-å¦‚ä½•å¤„ç†å›¾ç‰‡å‹ç¼©\"><a class=\"anchor\" href=\"#q4-å¦‚ä½•å¤„ç†å›¾ç‰‡å‹ç¼©\">#</a> Q4: å¦‚ä½•å¤„ç†å›¾ç‰‡å‹ç¼©ï¼Ÿ</h3>\n<p><strong>A:</strong> å¯ä»¥åœ¨å‰ç«¯ä¸Šä¼ å‰å‹ç¼©ï¼Œæˆ–åç«¯ä¿å­˜æ—¶å‹ç¼©ã€‚æ¨èå‰ç«¯å‹ç¼©ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// ä½¿ç”¨ canvas å‹ç¼©å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">compressImage</span><span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">,</span> maxWidth <span class=\"token operator\">=</span> <span class=\"token number\">800</span><span class=\"token punctuation\">,</span> quality <span class=\"token operator\">=</span> <span class=\"token number\">0.8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    img<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'canvas'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">// è®¡ç®—æ–°å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">const</span> ratio <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>maxWidth <span class=\"token operator\">/</span> img<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> maxWidth <span class=\"token operator\">/</span> img<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      canvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> ratio</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      canvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>height <span class=\"token operator\">*</span> ratio</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">// ç»˜åˆ¶å¹¶å‹ç¼©</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      ctx<span class=\"token operator\">?.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">const</span> compressedBase64 <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token string\">'image/jpeg'</span><span class=\"token punctuation\">,</span> quality<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>compressedBase64<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    img<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> ğŸ“ æ€»ç»“</h2>\n<p>æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†ä¸€ä¸ªå®Œæ•´çš„å¤´åƒä¸Šä¼ å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š</p>\n<ol>\n<li>âœ… <strong>å‰ç«¯é¢„è§ˆ</strong>ï¼šä½¿ç”¨ FileReader å®ç°å³æ—¶é¢„è§ˆ</li>\n<li>âœ… <strong>å»¶è¿Ÿä¸Šä¼ </strong>ï¼šåªåœ¨ä¿å­˜æ—¶ä¸Šä¼ ï¼Œé¿å…æ— æ•ˆæ“ä½œ</li>\n<li>âœ… <strong>æ–‡ä»¶å­˜å‚¨</strong>ï¼šä¿å­˜ä¸ºæ–‡ä»¶è€Œé base64ï¼Œæå‡æ€§èƒ½</li>\n<li>âœ… <strong>èµ„æºç®¡ç†</strong>ï¼šè‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶ï¼Œé¿å…åƒåœ¾æ–‡ä»¶</li>\n<li>âœ… <strong>å·¥å…·å‡½æ•°</strong>ï¼šç»Ÿä¸€å¤„ç†ä¸åŒæ ¼å¼çš„å¤´åƒ URL</li>\n<li>âœ… <strong>å®‰å…¨éªŒè¯</strong>ï¼šæ–‡ä»¶å¤§å°ã€æ ¼å¼éªŒè¯</li>\n<li>âœ… <strong>é™æ€æœåŠ¡</strong>ï¼šé…ç½® Express é™æ€æ–‡ä»¶æœåŠ¡</li>\n</ol>\n",
            "tags": [
                "å¤´åƒä¸Šä¼ ",
                "Express",
                "Vue"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%B8%BA-markdown-%E4%BB%A3%E7%A0%81%E5%9D%97%E6%B7%BB%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%A0%87%E7%AD%BE%E5%92%8C%E5%A4%8D%E5%88%B6%E5%8A%9F%E8%83%BD/",
            "url": "https://aynya.github.io/%E4%B8%BA-markdown-%E4%BB%A3%E7%A0%81%E5%9D%97%E6%B7%BB%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%A0%87%E7%AD%BE%E5%92%8C%E5%A4%8D%E5%88%B6%E5%8A%9F%E8%83%BD/",
            "title": "ä¸º markdown ä»£ç å—æ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶åŠŸèƒ½",
            "date_published": "2026-01-06T10:33:51.000Z",
            "content_html": "<h1 id=\"ä¸º-markdown-ä»£ç å—æ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶åŠŸèƒ½\"><a class=\"anchor\" href=\"#ä¸º-markdown-ä»£ç å—æ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶åŠŸèƒ½\">#</a> ä¸º Markdown ä»£ç å—æ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶åŠŸèƒ½</h1>\n<h2 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h2>\n<p>åœ¨ç°ä»£çš„ AI èŠå¤©åº”ç”¨ä¸­ï¼Œä»£ç å—çš„å±•ç¤ºæ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ã€‚ç”¨æˆ·ä¸ä»…éœ€è¦çœ‹åˆ°è¯­æ³•é«˜äº®çš„ä»£ç ï¼Œè¿˜éœ€è¦èƒ½å¤Ÿå¿«é€Ÿè¯†åˆ«ä»£ç è¯­è¨€ç±»å‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¸€é”®å¤åˆ¶ä»£ç ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Vue 3 + markdown-it + highlight.js çš„æŠ€æœ¯æ ˆä¸­ï¼Œä¸ºä»£ç å—æ·»åŠ è¯­è¨€æ ‡ç­¾å’Œå¤åˆ¶åŠŸèƒ½ã€‚</p>\n<h2 id=\"æŠ€æœ¯æ ˆ\"><a class=\"anchor\" href=\"#æŠ€æœ¯æ ˆ\">#</a> æŠ€æœ¯æ ˆ</h2>\n<ul>\n<li><strong>Vue 3</strong> - å‰ç«¯æ¡†æ¶</li>\n<li><strong>markdown-it</strong> - Markdown è§£æå™¨</li>\n<li><strong>highlight.js</strong> - ä»£ç è¯­æ³•é«˜äº®åº“</li>\n<li><strong>TypeScript</strong> - ç±»å‹æ”¯æŒ</li>\n</ul>\n<h2 id=\"æ ¸å¿ƒæŒ‘æˆ˜\"><a class=\"anchor\" href=\"#æ ¸å¿ƒæŒ‘æˆ˜\">#</a> æ ¸å¿ƒæŒ‘æˆ˜</h2>\n<h3 id=\"1-markdown-it-çš„æ¸²æŸ“æœºåˆ¶\"><a class=\"anchor\" href=\"#1-markdown-it-çš„æ¸²æŸ“æœºåˆ¶\">#</a> 1. markdown-it çš„æ¸²æŸ“æœºåˆ¶</h3>\n<p>markdown-it åœ¨æ¸²æŸ“ä»£ç å—æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ  <code>&lt;pre&gt;&lt;code&gt;</code>  æ ‡ç­¾ã€‚å¦‚æœæˆ‘ä»¬åœ¨  <code>highlight</code>  å‡½æ•°ä¸­è¿”å›åŒ…å«è¿™äº›æ ‡ç­¾çš„ HTMLï¼Œä¼šå¯¼è‡´æ ‡ç­¾é‡å¤å’Œç©ºè¡Œé—®é¢˜ã€‚</p>\n<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé‡å†™  <code>fence</code>  è§„åˆ™ï¼Œå®Œå…¨è‡ªå®šä¹‰ä»£ç å—çš„æ¸²æŸ“é€»è¾‘ã€‚</p>\n<h3 id=\"2-ä»£ç å—ç»“æ„è®¾è®¡\"><a class=\"anchor\" href=\"#2-ä»£ç å—ç»“æ„è®¾è®¡\">#</a> 2. ä»£ç å—ç»“æ„è®¾è®¡</h3>\n<p>æˆ‘ä»¬éœ€è¦åœ¨ä»£ç å—ä¸Šæ–¹æ·»åŠ ä¸€ä¸ªå¤´éƒ¨ï¼ŒåŒ…å«ï¼š</p>\n<ul>\n<li>è¯­è¨€ç±»å‹æ ‡ç­¾ï¼ˆå·¦ä¾§ï¼‰</li>\n<li>å¤åˆ¶æŒ‰é’®ï¼ˆå³ä¾§ï¼‰</li>\n</ul>\n<h2 id=\"å®ç°æ–¹æ¡ˆ\"><a class=\"anchor\" href=\"#å®ç°æ–¹æ¡ˆ\">#</a> å®ç°æ–¹æ¡ˆ</h2>\n<h3 id=\"ç¬¬ä¸€æ­¥é‡å†™-fence-è§„åˆ™\"><a class=\"anchor\" href=\"#ç¬¬ä¸€æ­¥é‡å†™-fence-è§„åˆ™\">#</a> ç¬¬ä¸€æ­¥ï¼šé‡å†™ fence è§„åˆ™</h3>\n<p>markdown-it çš„  <code>fence</code>  è§„åˆ™è´Ÿè´£æ¸²æŸ“ä»£ç å—ã€‚æˆ‘ä»¬éœ€è¦å®Œå…¨é‡å†™è¿™ä¸ªè§„åˆ™ï¼Œä»¥ä¾¿åœ¨ä»£ç å—å‘¨å›´æ·»åŠ å¤´éƒ¨ä¿¡æ¯ã€‚</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰ fence è§„åˆ™çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">FenceRule</span> <span class=\"token operator\">=</span> NonNullable<span class=\"token operator\">&lt;</span>MarkdownIt<span class=\"token punctuation\">[</span><span class=\"token string\">'renderer'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rules'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'fence'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">FenceRuleParams</span> <span class=\"token operator\">=</span> Parameters<span class=\"token operator\">&lt;</span>FenceRule<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// é‡å†™ fence è§„åˆ™</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>md<span class=\"token punctuation\">.</span>renderer<span class=\"token punctuation\">.</span>rules<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">fence</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  tokens<span class=\"token operator\">:</span> FenceRuleParams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  idx<span class=\"token operator\">:</span> FenceRuleParams<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  _options<span class=\"token operator\">:</span> FenceRuleParams<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  _env<span class=\"token operator\">:</span> FenceRuleParams<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  _self<span class=\"token operator\">:</span> FenceRuleParams<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// æå–è¯­è¨€å’Œä»£ç å†…å®¹</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>info <span class=\"token operator\">?</span> token<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">const</span> langName <span class=\"token operator\">=</span> info <span class=\"token operator\">?</span> info<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\s+</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>content <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">//... å¤„ç†é€»è¾‘</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ç¬¬äºŒæ­¥è¯­è¨€æ£€æµ‹å’Œç¾åŒ–\"><a class=\"anchor\" href=\"#ç¬¬äºŒæ­¥è¯­è¨€æ£€æµ‹å’Œç¾åŒ–\">#</a> ç¬¬äºŒæ­¥ï¼šè¯­è¨€æ£€æµ‹å’Œç¾åŒ–</h3>\n<p>æˆ‘ä»¬éœ€è¦ï¼š</p>\n<ol>\n<li>æ£€æµ‹ä»£ç çš„è¯­è¨€ç±»å‹</li>\n<li>å°†è¯­è¨€æ ‡è¯†ç¬¦è½¬æ¢ä¸ºå‹å¥½çš„æ˜¾ç¤ºåç§°ï¼ˆå¦‚  <code>javascript</code>  â†’  <code>JavaScript</code> ï¼‰</li>\n</ol>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¯­è¨€åç§°æ˜ å°„</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> langMap<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  javascript<span class=\"token operator\">:</span> <span class=\"token string\">'JavaScript'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  typescript<span class=\"token operator\">:</span> <span class=\"token string\">'TypeScript'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  python<span class=\"token operator\">:</span> <span class=\"token string\">'Python'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">//... æ›´å¤šè¯­è¨€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// è¯­è¨€æ£€æµ‹é€»è¾‘</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">let</span> highlightedCode <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">let</span> detectedLang <span class=\"token operator\">=</span> langName <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>langName <span class=\"token operator\">&amp;&amp;</span> hljs<span class=\"token punctuation\">.</span><span class=\"token function\">getLanguage</span><span class=\"token punctuation\">(</span>langName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// ä½¿ç”¨æŒ‡å®šè¯­è¨€è¿›è¡Œé«˜äº®</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlight</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    language<span class=\"token operator\">:</span> langName<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ignoreIllegals<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  highlightedCode <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  detectedLang <span class=\"token operator\">=</span> langName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// è‡ªåŠ¨æ£€æµ‹è¯­è¨€</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlightAuto</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  highlightedCode <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  detectedLang <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>language <span class=\"token operator\">||</span> <span class=\"token string\">'text'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// ç¾åŒ–æ˜¾ç¤ºåç§°</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">const</span> displayLang <span class=\"token operator\">=</span> langMap<span class=\"token punctuation\">[</span>detectedLang<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> detectedLang <span class=\"token operator\">||</span> <span class=\"token string\">'Text'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"ç¬¬ä¸‰æ­¥ç”Ÿæˆä»£ç å—-html\"><a class=\"anchor\" href=\"#ç¬¬ä¸‰æ­¥ç”Ÿæˆä»£ç å—-html\">#</a> ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆä»£ç å— HTML</h3>\n<p>æˆ‘ä»¬ç”ŸæˆåŒ…å«å¤´éƒ¨å’Œä»£ç å†…å®¹çš„å®Œæ•´ HTML ç»“æ„ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è½¬ä¹‰ä»£ç å†…å®¹ç”¨äº data å±æ€§</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> escapedCode <span class=\"token operator\">=</span> md<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">escapeHtml</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// ç”Ÿæˆå”¯ä¸€çš„ ID</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> codeId <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">code-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// è¿”å›å®Œæ•´çš„ä»£ç å— HTML</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  &lt;div class=\"code-block-wrapper\"></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    &lt;div class=\"code-block-header\"></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      &lt;span class=\"code-block-lang\"></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>displayLang<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      &lt;button </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        class=\"code-block-copy-btn\" </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        data-code-content=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>escapedCode<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\"</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;quot;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">'</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;#39;'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        title=\"å¤åˆ¶ä»£ç \"</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        type=\"button\"</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      ></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        &lt;svg class=\"copy-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          &lt;rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\">&lt;/rect></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          &lt;path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\">&lt;/path></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        &lt;/svg></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        &lt;svg class=\"check-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"display: none;\"></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          &lt;polyline points=\"20 6 9 17 4 12\">&lt;/polyline></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        &lt;/svg></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        &lt;span class=\"copy-text\">å¤åˆ¶&lt;/span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      &lt;/button></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    &lt;/div></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    &lt;pre class=\"hljs\">&lt;code></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>highlightedCode<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/code>&lt;/pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  &lt;/div></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"ç¬¬å››æ­¥å®ç°å¤åˆ¶åŠŸèƒ½\"><a class=\"anchor\" href=\"#ç¬¬å››æ­¥å®ç°å¤åˆ¶åŠŸèƒ½\">#</a> ç¬¬å››æ­¥ï¼šå®ç°å¤åˆ¶åŠŸèƒ½</h3>\n<p>æˆ‘ä»¬ä½¿ç”¨äº‹ä»¶å§”æ‰˜çš„æ–¹å¼å¤„ç†å¤åˆ¶æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleGlobalClick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> MouseEvent<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// ä½¿ç”¨ closest å¯»æ‰¾ç‚¹å‡»çš„ç›®æ ‡æŒ‰é’®</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> btn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target <span class=\"token keyword\">as</span> HTMLElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">closest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.code-block-copy-btn'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> HTMLElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>btn <span class=\"token operator\">||</span> btn<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">'copied'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> codeContent <span class=\"token operator\">=</span> btn<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-code-content'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>codeContent<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// è§£ç  HTML å®ä½“</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">const</span> textarea <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'textarea'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> codeContent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">const</span> decodedContent <span class=\"token operator\">=</span> textarea<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// å¤åˆ¶åˆ°å‰ªè´´æ¿</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>clipboard<span class=\"token punctuation\">.</span><span class=\"token function\">writeText</span><span class=\"token punctuation\">(</span>decodedContent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// æ›´æ–°æŒ‰é’®çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">const</span> copyIcon <span class=\"token operator\">=</span> btn<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.copy-icon'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> HTMLElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">const</span> checkIcon <span class=\"token operator\">=</span> btn<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.check-icon'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> HTMLElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">const</span> copyText <span class=\"token operator\">=</span> btn<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.copy-text'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> HTMLElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    btn<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'copied'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>copyIcon<span class=\"token punctuation\">)</span> copyIcon<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>checkIcon<span class=\"token punctuation\">)</span> checkIcon<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'block'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>copyText<span class=\"token punctuation\">)</span> copyText<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">'å·²å¤åˆ¶'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">// 2 ç§’åæ¢å¤</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      btn<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'copied'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>copyIcon<span class=\"token punctuation\">)</span> copyIcon<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'block'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>checkIcon<span class=\"token punctuation\">)</span> checkIcon<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>copyText<span class=\"token punctuation\">)</span> copyText<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">'å¤åˆ¶'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    ElMessage<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ä»£ç å·²å¤åˆ¶'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¤åˆ¶å¤±è´¥'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    ElMessage<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¤åˆ¶å¤±è´¥'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Ÿ</strong></p>\n<ol>\n<li><strong>åŠ¨æ€å†…å®¹</strong>ï¼šä»£ç å—æ˜¯é€šè¿‡ markdown-it åŠ¨æ€ç”Ÿæˆçš„ï¼Œä½¿ç”¨äº‹ä»¶å§”æ‰˜å¯ä»¥è‡ªåŠ¨å¤„ç†æ‰€æœ‰æŒ‰é’®</li>\n<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåªéœ€è¦ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæŒ‰é’®å•ç‹¬ç»‘å®š</li>\n<li><strong>ç®€åŒ–ç®¡ç†</strong>ï¼šä¸éœ€è¦åœ¨å†…å®¹æ›´æ–°æ—¶é‡æ–°ç»‘å®šäº‹ä»¶</li>\n</ol>\n<h3 id=\"ç¬¬äº”æ­¥æ ·å¼è®¾è®¡\"><a class=\"anchor\" href=\"#ç¬¬äº”æ­¥æ ·å¼è®¾è®¡\">#</a> ç¬¬äº”æ­¥ï¼šæ ·å¼è®¾è®¡</h3>\n<p>æˆ‘ä»¬ä½¿ç”¨æ·±è‰²ä¸»é¢˜ï¼Œå¹¶æ·»åŠ äº†ä¸°å¯Œçš„äº¤äº’æ•ˆæœï¼š</p>\n<figure class=\"highlight css\"><figcaption data-lang=\"CSS\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* ä»£ç å—åŒ…è£…å™¨ */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token selector\">.code-block-wrapper</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 1em 0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">border-radius</span><span class=\"token punctuation\">:</span> 8px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span> hidden<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> #0d1117<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">border</span><span class=\"token punctuation\">:</span> 1px solid <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/* ä»£ç å—å¤´éƒ¨ */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token selector\">.code-block-header</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> flex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token property\">align-items</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token property\">justify-content</span><span class=\"token punctuation\">:</span> space-between<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 8px 12px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.03<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token property\">border-bottom</span><span class=\"token punctuation\">:</span> 1px solid <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">/* è¯­è¨€æ ‡ç­¾ */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token selector\">.code-block-lang</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 0.75rem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token property\">font-weight</span><span class=\"token punctuation\">:</span> 500<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token property\">text-transform</span><span class=\"token punctuation\">:</span> uppercase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token property\">letter-spacing</span><span class=\"token punctuation\">:</span> 0.5px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token property\">font-family</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'SF Mono'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Monaco'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Inconsolata'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Roboto Mono'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Consolas'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Courier New'</span><span class=\"token punctuation\">,</span> monospace<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">/* å¤åˆ¶æŒ‰é’® */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token selector\">.code-block-copy-btn</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> flex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token property\">align-items</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token property\">gap</span><span class=\"token punctuation\">:</span> 6px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 6px 12px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> transparent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token property\">border</span><span class=\"token punctuation\">:</span> 1px solid <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token property\">border-radius</span><span class=\"token punctuation\">:</span> 6px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 0.75rem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token property\">cursor</span><span class=\"token punctuation\">:</span> pointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token property\">transition</span><span class=\"token punctuation\">:</span> all 0.2s ease<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token selector\">.code-block-copy-btn:hover</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token property\">border-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.9<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">/* å¤åˆ¶æˆåŠŸçŠ¶æ€ */</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token selector\">.code-block-copy-btn.copied</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>34<span class=\"token punctuation\">,</span> 197<span class=\"token punctuation\">,</span> 94<span class=\"token punctuation\">,</span> 0.15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token property\">border-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>34<span class=\"token punctuation\">,</span> 197<span class=\"token punctuation\">,</span> 94<span class=\"token punctuation\">,</span> 0.3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> #22c55e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"å…³é”®æŠ€æœ¯ç‚¹\"><a class=\"anchor\" href=\"#å…³é”®æŠ€æœ¯ç‚¹\">#</a> å…³é”®æŠ€æœ¯ç‚¹</h2>\n<h3 id=\"1-ä¸ºä»€ä¹ˆé‡å†™-fence-è€Œä¸æ˜¯-highlight\"><a class=\"anchor\" href=\"#1-ä¸ºä»€ä¹ˆé‡å†™-fence-è€Œä¸æ˜¯-highlight\">#</a> 1. ä¸ºä»€ä¹ˆé‡å†™ fence è€Œä¸æ˜¯ highlightï¼Ÿ</h3>\n<ul>\n<li><code>highlight</code>  å‡½æ•°åªå¤„ç†ä»£ç å†…å®¹çš„é«˜äº®ï¼Œè¿”å›çš„ HTML ä¼šè¢« markdown-it åŒ…è£¹åœ¨  <code>&lt;pre&gt;&lt;code&gt;</code>  ä¸­</li>\n<li><code>fence</code>  è§„åˆ™å®Œå…¨æ§åˆ¶ä»£ç å—çš„æ¸²æŸ“ï¼Œå¯ä»¥è¿”å›åŒ…å«å¤´éƒ¨å’Œä»£ç çš„å®Œæ•´ HTML ç»“æ„</li>\n</ul>\n<h3 id=\"2-html-å®ä½“è½¬ä¹‰\"><a class=\"anchor\" href=\"#2-html-å®ä½“è½¬ä¹‰\">#</a> 2. HTML å®ä½“è½¬ä¹‰</h3>\n<p>ä»£ç å†…å®¹éœ€è¦è½¬ä¹‰åå­˜å‚¨åœ¨  <code>data-code-content</code>  å±æ€§ä¸­ï¼Œé˜²æ­¢ XSS æ”»å‡»ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> escapedCode <span class=\"token operator\">=</span> md<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">escapeHtml</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// æ›¿æ¢å¼•å·ï¼Œé¿å…ç ´å HTML å±æ€§</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data<span class=\"token operator\">-</span>code<span class=\"token operator\">-</span>content<span class=\"token operator\">=</span><span class=\"token string\">\"$&#123;escapedCode.replace(/\"</span><span class=\"token operator\">/</span>g<span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;quot;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">'</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;#39;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span>\"</pre></td></tr></table></figure><h3 id=\"3-çŠ¶æ€ç®¡ç†\"><a class=\"anchor\" href=\"#3-çŠ¶æ€ç®¡ç†\">#</a> 3. çŠ¶æ€ç®¡ç†</h3>\n<p>æ¯ä¸ªå¤åˆ¶æŒ‰é’®éƒ½æœ‰ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†ï¼š</p>\n<ul>\n<li>ä½¿ç”¨  <code>copied</code>  class æ ‡è®°å¤åˆ¶çŠ¶æ€</li>\n<li>ä½¿ç”¨ç‹¬ç«‹çš„  <code>setTimeout</code>  å®šæ—¶å™¨ï¼Œäº’ä¸å¹²æ‰°</li>\n<li>é€šè¿‡æ£€æŸ¥  <code>copied</code>  class é˜²æ­¢é‡å¤ç‚¹å‡»</li>\n</ul>\n<h3 id=\"4-ç±»å‹å®‰å…¨\"><a class=\"anchor\" href=\"#4-ç±»å‹å®‰å…¨\">#</a> 4. ç±»å‹å®‰å…¨</h3>\n<p>ä½¿ç”¨ TypeScript çš„ç±»å‹æ¨æ–­æ¥ç¡®ä¿ç±»å‹å®‰å…¨ï¼š</p>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">FenceRule</span> <span class=\"token operator\">=</span> NonNullable<span class=\"token operator\">&lt;</span>MarkdownIt<span class=\"token punctuation\">[</span><span class=\"token string\">'renderer'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rules'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'fence'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">FenceRuleParams</span> <span class=\"token operator\">=</span> Parameters<span class=\"token operator\">&lt;</span>FenceRule<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥ä» markdown-it çš„ç±»å‹å®šä¹‰ä¸­è‡ªåŠ¨æ¨æ–­å‡ºæ­£ç¡®çš„å‚æ•°ç±»å‹ã€‚</p>\n<h2 id=\"å®Œæ•´ä»£ç ç»“æ„\"><a class=\"anchor\" href=\"#å®Œæ•´ä»£ç ç»“æ„\">#</a> å®Œæ•´ä»£ç ç»“æ„</h2>\n<h3 id=\"markdowntså·¥å…·å‡½æ•°\"><a class=\"anchor\" href=\"#markdowntså·¥å…·å‡½æ•°\">#</a> markdown.tsï¼ˆå·¥å…·å‡½æ•°ï¼‰</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createMarkdownRenderer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MarkdownIt <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> md <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MarkdownIt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    html<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    linkify<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    typographer<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function-variable function\">highlight</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>str<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> lang<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">// åªè¿”å›é«˜äº®åçš„ä»£ç å†…å®¹</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// é‡å†™ fence è§„åˆ™</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  md<span class=\"token punctuation\">.</span>renderer<span class=\"token punctuation\">.</span>rules<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">fence</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// ç”ŸæˆåŒ…å«å¤´éƒ¨å’Œä»£ç çš„å®Œæ•´ HTML</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">return</span> md<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"chatviewvueä½¿ç”¨\"><a class=\"anchor\" href=\"#chatviewvueä½¿ç”¨\">#</a> ChatView.vueï¼ˆä½¿ç”¨ï¼‰</h3>\n<pre><code class=\"language-vue\">&lt;template&gt;\n  &lt;div @click=&quot;handleGlobalClick&quot;&gt;\n    &lt;div v-html=&quot;renderMarkdown(message.content)&quot;&gt;&lt;/div&gt;\n  &lt;/div&gt;\n&lt;/template&gt;\n\n&lt;script setup lang=&quot;ts&quot;&gt;\nimport &#123; createMarkdownRenderer &#125; from '@monorepo/utils';\n\nconst md = createMarkdownRenderer();\n\nfunction renderMarkdown(text: string): string &#123;\n  return md.render(text);\n&#125;\n\nconst handleGlobalClick = async (e: MouseEvent) =&gt; &#123;\n  // å¤„ç†å¤åˆ¶æŒ‰é’®ç‚¹å‡»\n  // ...\n&#125;;\n&lt;/script&gt;\n</code></pre>\n<h2 id=\"æ•ˆæœå±•ç¤º\"><a class=\"anchor\" href=\"#æ•ˆæœå±•ç¤º\">#</a> æ•ˆæœå±•ç¤º</h2>\n<p>æœ€ç»ˆå®ç°çš„ä»£ç å—åŒ…å«ï¼š</p>\n<ol>\n<li><strong>è¯­è¨€æ ‡ç­¾</strong>ï¼šæ˜¾ç¤ºä»£ç çš„è¯­è¨€ç±»å‹ï¼ˆå¦‚ &quot;PYTHON&quot;ã€&quot;JavaScript&quot;ï¼‰</li>\n<li><strong>å¤åˆ¶æŒ‰é’®</strong>ï¼šç‚¹å‡»åå¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿</li>\n<li><strong>è§†è§‰åé¦ˆ</strong>ï¼šå¤åˆ¶æˆåŠŸåæ˜¾ç¤ºç»¿è‰²å¯¹å‹¾å’Œ &quot;å·²å¤åˆ¶&quot; æ–‡å­—</li>\n<li><strong>è¯­æ³•é«˜äº®</strong>ï¼šä½¿ç”¨ highlight.js è¿›è¡Œä»£ç é«˜äº®</li>\n<li><strong>ç¾è§‚æ ·å¼</strong>ï¼šæ·±è‰²ä¸»é¢˜ï¼Œåœ†è§’è¾¹æ¡†ï¼Œè‡ªå®šä¹‰æ»šåŠ¨æ¡</li>\n</ol>\n<h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>é€šè¿‡é‡å†™ markdown-it çš„  <code>fence</code>  è§„åˆ™ï¼Œæˆ‘ä»¬æˆåŠŸåœ°ï¼š</p>\n<ol>\n<li>âœ… ä¸ºä»£ç å—æ·»åŠ äº†è¯­è¨€æ ‡ç­¾</li>\n<li>âœ… å®ç°äº†å¤åˆ¶åŠŸèƒ½</li>\n<li>âœ… ä¿æŒäº†ä»£ç é«˜äº®åŠŸèƒ½</li>\n<li>âœ… æä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ</li>\n<li>âœ… ç¡®ä¿äº†ç±»å‹å®‰å…¨</li>\n</ol>\n<p>è¿™ä¸ªå®ç°æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>\n<ul>\n<li><strong>å¯å¤ç”¨</strong>ï¼šæå–åˆ°å·¥å…·å‡½æ•°ä¸­ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨</li>\n<li><strong>ç±»å‹å®‰å…¨</strong>ï¼šä½¿ç”¨ TypeScript ç¡®ä¿ç±»å‹æ­£ç¡®</li>\n<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡</li>\n<li><strong>ç”¨æˆ·ä½“éªŒ</strong>ï¼šæä¾›æ¸…æ™°çš„è§†è§‰åé¦ˆ</li>\n</ul>\n",
            "tags": [
                "markdown",
                "markdown-it",
                "highlight.js"
            ]
        },
        {
            "id": "https://aynya.github.io/markdown-it-%E5%BC%95%E5%85%A5-highlight-js/",
            "url": "https://aynya.github.io/markdown-it-%E5%BC%95%E5%85%A5-highlight-js/",
            "title": "markdown-it å¼•å…¥ highlight.js",
            "date_published": "2026-01-05T09:25:38.000Z",
            "content_html": "<h1 id=\"ä»£ç é«˜äº®å®ç°åŸç†è¯¦è§£\"><a class=\"anchor\" href=\"#ä»£ç é«˜äº®å®ç°åŸç†è¯¦è§£\">#</a> ä»£ç é«˜äº®å®ç°åŸç†è¯¦è§£</h1>\n<h2 id=\"æ•´ä½“æ¶æ„\"><a class=\"anchor\" href=\"#æ•´ä½“æ¶æ„\">#</a> æ•´ä½“æ¶æ„</h2>\n<p>ä»£ç é«˜äº®çš„å®ç°æ¶‰åŠä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>\n<ol>\n<li><strong>markdown-it</strong> - Markdown è§£æå™¨</li>\n<li><strong>highlight.js</strong> - ä»£ç é«˜äº®å¼•æ“</li>\n<li><strong>CSS æ ·å¼</strong> - è§†è§‰å‘ˆç°</li>\n</ol>\n<h2 id=\"ä¸€-markdown-it-çš„å·¥ä½œåŸç†\"><a class=\"anchor\" href=\"#ä¸€-markdown-it-çš„å·¥ä½œåŸç†\">#</a> ä¸€ã€Markdown-it çš„å·¥ä½œåŸç†</h2>\n<h3 id=\"11-markdown-it-æ˜¯ä»€ä¹ˆ\"><a class=\"anchor\" href=\"#11-markdown-it-æ˜¯ä»€ä¹ˆ\">#</a> 1.1 Markdown-it æ˜¯ä»€ä¹ˆï¼Ÿ</h3>\n<p><code>markdown-it</code>  æ˜¯ä¸€ä¸ª Markdown è§£æå™¨ï¼Œå®ƒå°† Markdown æ–‡æœ¬è½¬æ¢ä¸º HTMLã€‚</p>\n<h3 id=\"12-åŸºæœ¬å·¥ä½œæµç¨‹\"><a class=\"anchor\" href=\"#12-åŸºæœ¬å·¥ä½œæµç¨‹\">#</a> 1.2 åŸºæœ¬å·¥ä½œæµç¨‹</h3>\n<pre><code>åŸå§‹ Markdown æ–‡æœ¬\n    â†“\nmarkdown-it è§£æå™¨\n    â†“\nAST (æŠ½è±¡è¯­æ³•æ ‘)\n    â†“\næ¸²æŸ“å™¨ (Renderer)\n    â†“\nHTML å­—ç¬¦ä¸²\n</code></pre>\n<h3 id=\"13-ä»£ç å—çš„å¤„ç†\"><a class=\"anchor\" href=\"#13-ä»£ç å—çš„å¤„ç†\">#</a> 1.3 ä»£ç å—çš„å¤„ç†</h3>\n<p>å½“ markdown-it é‡åˆ°ä»£ç å—æ—¶ï¼ˆä¾‹å¦‚ ````javascript` æˆ–ä¸‰ä¸ªåå¼•å·ï¼‰ï¼Œå®ƒä¼šï¼š</p>\n<ol>\n<li><strong>è¯†åˆ«ä»£ç å—</strong>ï¼šæ£€æµ‹åˆ°ä»£ç å—æ ‡è®°</li>\n<li><strong>æå–å†…å®¹</strong>ï¼šè·å–ä»£ç å†…å®¹å’Œè¯­è¨€æ ‡è¯†</li>\n<li><strong>è°ƒç”¨ highlight å‡½æ•°</strong>ï¼šå¦‚æœé…ç½®äº†  <code>highlight</code>  é€‰é¡¹ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°</li>\n<li><strong>æ›¿æ¢ä¸º HTML</strong>ï¼šå°†å‡½æ•°è¿”å›çš„ HTML æ’å…¥åˆ°æœ€ç»ˆè¾“å‡ºä¸­</li>\n</ol>\n<h3 id=\"14-é…ç½®ä¸­çš„-highlight-é€‰é¡¹\"><a class=\"anchor\" href=\"#14-é…ç½®ä¸­çš„-highlight-é€‰é¡¹\">#</a> 1.4 é…ç½®ä¸­çš„ highlight é€‰é¡¹</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> md<span class=\"token operator\">:</span> MarkdownIt <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MarkdownIt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  html<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  linkify<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  typographer<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function-variable function\">highlight</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>str<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> lang<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// è¿™ä¸ªå‡½æ•°ä¼šåœ¨é‡åˆ°ä»£ç å—æ—¶è¢«è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">//str: ä»£ç å†…å®¹</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">//lang: è¯­è¨€æ ‡è¯†ï¼ˆå¦‚ 'javascript', 'python' ç­‰ï¼‰</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// è¿”å›å€¼: HTML å­—ç¬¦ä¸²</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>å…³é”®ç‚¹</strong>ï¼š</p>\n<ul>\n<li><code>highlight</code>  å‡½æ•°æ˜¯ markdown-it çš„<strong>é’©å­å‡½æ•°</strong></li>\n<li>æ¯å½“è§£æå™¨é‡åˆ°ä»£ç å—ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°</li>\n<li>å‡½æ•°æ¥æ”¶åŸå§‹ä»£ç å­—ç¬¦ä¸²å’Œè¯­è¨€æ ‡è¯†</li>\n<li>å‡½æ•°å¿…é¡»è¿”å› HTML å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²ä¼šæ›¿æ¢åŸå§‹çš„ä»£ç å—</li>\n</ul>\n<h2 id=\"äºŒ-highlightjs-çš„å·¥ä½œåŸç†\"><a class=\"anchor\" href=\"#äºŒ-highlightjs-çš„å·¥ä½œåŸç†\">#</a> äºŒã€Highlight.js çš„å·¥ä½œåŸç†</h2>\n<h3 id=\"21-highlightjs-æ˜¯ä»€ä¹ˆ\"><a class=\"anchor\" href=\"#21-highlightjs-æ˜¯ä»€ä¹ˆ\">#</a> 2.1 Highlight.js æ˜¯ä»€ä¹ˆï¼Ÿ</h3>\n<p><code>highlight.js</code>  æ˜¯ä¸€ä¸ªè¯­æ³•é«˜äº®åº“ï¼Œå®ƒèƒ½å¤Ÿï¼š</p>\n<ul>\n<li>è¯†åˆ«ä»£ç ä¸­çš„å…³é”®å­—ã€å­—ç¬¦ä¸²ã€æ³¨é‡Šç­‰è¯­æ³•å…ƒç´ </li>\n<li>ä¸ºè¿™äº›å…ƒç´ æ·»åŠ  CSS ç±»å</li>\n<li>é€šè¿‡ CSS ç±»ååº”ç”¨ä¸åŒçš„é¢œè‰²æ ·å¼</li>\n</ul>\n<h3 id=\"22-æ ¸å¿ƒ-api\"><a class=\"anchor\" href=\"#22-æ ¸å¿ƒ-api\">#</a> 2.2 æ ¸å¿ƒ API</h3>\n<h4 id=\"221-hljsgetlanguagelang\"><a class=\"anchor\" href=\"#221-hljsgetlanguagelang\">#</a> 2.2.1  <code>hljs.getLanguage(lang)</code></h4>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lang <span class=\"token operator\">&amp;&amp;</span> hljs<span class=\"token punctuation\">.</span><span class=\"token function\">getLanguage</span><span class=\"token punctuation\">(</span>lang<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// æ£€æŸ¥ highlight.js æ˜¯å¦æ”¯æŒè¯¥è¯­è¨€</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>æ£€æŸ¥ highlight.js æ˜¯å¦æ”¯æŒæŒ‡å®šçš„ç¼–ç¨‹è¯­è¨€</li>\n<li>è¿”å›è¯­è¨€å®šä¹‰å¯¹è±¡æˆ–  <code>undefined</code></li>\n</ul>\n<h4 id=\"222-hljshighlightstr-options\"><a class=\"anchor\" href=\"#222-hljshighlightstr-options\">#</a> 2.2.2  <code>hljs.highlight(str, options)</code></h4>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlight</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  language<span class=\"token operator\">:</span> lang<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ignoreIllegals<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ul>\n<li><strong>è¾“å…¥</strong>ï¼šåŸå§‹ä»£ç å­—ç¬¦ä¸²å’Œè¯­è¨€æ ‡è¯†</li>\n<li><strong>å¤„ç†</strong>ï¼š\n<ol>\n<li>ä½¿ç”¨è¯¥è¯­è¨€çš„è¯­æ³•è§„åˆ™è¿›è¡Œè¯æ³•åˆ†æ</li>\n<li>è¯†åˆ«å…³é”®å­—ã€å­—ç¬¦ä¸²ã€æ³¨é‡Šã€å‡½æ•°åç­‰</li>\n<li>ä¸ºæ¯ä¸ªè¯­æ³•å…ƒç´ æ·»åŠ   <code>&lt;span&gt;</code>  æ ‡ç­¾å’Œå¯¹åº”çš„ CSS ç±»å</li>\n</ol>\n</li>\n<li><strong>è¾“å‡º</strong>ï¼šåŒ…å«é«˜äº®æ ‡è®°çš„ HTML å­—ç¬¦ä¸²</li>\n</ul>\n<p><strong>ç¤ºä¾‹è½¬æ¢è¿‡ç¨‹</strong>ï¼š</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾“å…¥</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> hello <span class=\"token operator\">=</span> <span class=\"token string\">\"world\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//highlight.js å¤„ç†åï¼ˆç®€åŒ–ç‰ˆï¼‰</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>span <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"hljs-keyword\"</span><span class=\"token operator\">></span><span class=\"token keyword\">const</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>span <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"hljs-variable\"</span><span class=\"token operator\">></span>hello<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>span <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"hljs-string\"</span><span class=\"token operator\">></span><span class=\"token string\">\"world\"</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"223-hljshighlightautostr\"><a class=\"anchor\" href=\"#223-hljshighlightautostr\">#</a> 2.2.3  <code>hljs.highlightAuto(str)</code></h4>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlightAuto</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ul>\n<li>è‡ªåŠ¨æ£€æµ‹ä»£ç çš„è¯­è¨€ç±»å‹</li>\n<li>è¿”å›æ£€æµ‹ç»“æœå’Œé«˜äº®åçš„ HTML</li>\n</ul>\n<h3 id=\"23-è¿”å›å€¼çš„ç»“æ„\"><a class=\"anchor\" href=\"#23-è¿”å›å€¼çš„ç»“æ„\">#</a> 2.3 è¿”å›å€¼çš„ç»“æ„</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  value<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// é«˜äº®åçš„ HTML å­—ç¬¦ä¸²</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  language<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// æ£€æµ‹åˆ°çš„è¯­è¨€</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  relevance<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>     <span class=\"token comment\">// åŒ¹é…åº¦åˆ†æ•°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ä¸‰-ä¸¤è€…å¦‚ä½•ç»“åˆ\"><a class=\"anchor\" href=\"#ä¸‰-ä¸¤è€…å¦‚ä½•ç»“åˆ\">#</a> ä¸‰ã€ä¸¤è€…å¦‚ä½•ç»“åˆ</h2>\n<h3 id=\"31-å®Œæ•´çš„å¤„ç†æµç¨‹\"><a class=\"anchor\" href=\"#31-å®Œæ•´çš„å¤„ç†æµç¨‹\">#</a> 3.1 å®Œæ•´çš„å¤„ç†æµç¨‹</h3>\n<pre><code>AI å›å¤çš„ Markdown æ–‡æœ¬\n    â†“\nä¾‹å¦‚ï¼š\njavascript\nconst x = 1;\n\nâ€‹    â†“\nmarkdown-it è§£æå™¨è¯†åˆ«åˆ°ä»£ç å—\nâ€‹    â†“\nè°ƒç”¨ highlight å‡½æ•°\nâ€‹    â†“\nhighlight.js è¿›è¡Œè¯­æ³•åˆ†æå’Œé«˜äº®\nâ€‹    â†“\nè¿”å›å¸¦é«˜äº®æ ‡è®°çš„ HTML\nâ€‹    â†“\nmarkdown-it å°† HTML æ’å…¥æœ€ç»ˆè¾“å‡º\nâ€‹    â†“\næµè§ˆå™¨æ¸²æŸ“ HTML\nâ€‹    â†“\nCSS æ ·å¼åº”ç”¨é¢œè‰²\nâ€‹    â†“\nç”¨æˆ·çœ‹åˆ°é«˜äº®çš„ä»£ç \n</code></pre>\n<h3 id=\"32-ä»£ç å®ç°è¯¦è§£\"><a class=\"anchor\" href=\"#32-ä»£ç å®ç°è¯¦è§£\">#</a> 3.2 ä»£ç å®ç°è¯¦è§£</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function-variable function\">highlight</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>str<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> lang<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†è¯­è¨€ä¸” highlight.js æ”¯æŒ</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lang <span class=\"token operator\">&amp;&amp;</span> hljs<span class=\"token punctuation\">.</span><span class=\"token function\">getLanguage</span><span class=\"token punctuation\">(</span>lang<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token comment\">// ä½¿ç”¨æŒ‡å®šè¯­è¨€è¿›è¡Œé«˜äº®</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">'&lt;pre class=\"hljs\">&lt;code>'</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlight</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> language<span class=\"token operator\">:</span> lang<span class=\"token punctuation\">,</span> ignoreIllegals<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">'&lt;/code>&lt;/pre>'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœé«˜äº®å¤±è´¥ï¼ˆä¾‹å¦‚ä»£ç æœ‰è¯­æ³•é”™è¯¯ï¼‰ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„é€»è¾‘</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// ç¬¬äºŒæ­¥ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šè¯­è¨€æˆ–è¯­è¨€ä¸æ”¯æŒï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token string\">'&lt;pre class=\"hljs\">&lt;code>'</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlightAuto</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token string\">'&lt;/code>&lt;/pre>'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">// ç¬¬ä¸‰æ­¥ï¼šå¦‚æœè‡ªåŠ¨æ£€æµ‹ä¹Ÿå¤±è´¥ï¼Œè¿”å›è½¬ä¹‰çš„çº¯æ–‡æœ¬ä»£ç </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">'&lt;pre class=\"hljs\">&lt;code>'</span> <span class=\"token operator\">+</span> md<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">escapeHtml</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/code>&lt;/pre>'</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚ fallbackï¼Ÿ</strong></p>\n<ol>\n<li><strong>ç¬¬ä¸€å±‚</strong>ï¼šç”¨æˆ·æ˜ç¡®æŒ‡å®šè¯­è¨€ï¼Œä½¿ç”¨è¯¥è¯­è¨€çš„é«˜äº®è§„åˆ™ï¼ˆæœ€å‡†ç¡®ï¼‰</li>\n<li><strong>ç¬¬äºŒå±‚</strong>ï¼šè‡ªåŠ¨æ£€æµ‹è¯­è¨€ï¼ˆç”¨æˆ·æœªæŒ‡å®šæ—¶ï¼‰</li>\n<li><strong>ç¬¬ä¸‰å±‚</strong>ï¼šå¦‚æœéƒ½å¤±è´¥ï¼Œè‡³å°‘ä¿è¯ä»£ç èƒ½å®‰å…¨æ˜¾ç¤ºï¼ˆé˜²æ­¢ XSSï¼‰</li>\n</ol>\n<h3 id=\"33-html-ç»“æ„\"><a class=\"anchor\" href=\"#33-html-ç»“æ„\">#</a> 3.3 HTML ç»“æ„</h3>\n<p>æœ€ç»ˆç”Ÿæˆçš„ HTML ç»“æ„ï¼š</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pre</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>code</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-keyword<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>const<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-variable<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>x<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-operator<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>=<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-number<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-punctuation<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>code</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>pre</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"å››-css-æ ·å¼çš„ä½œç”¨\"><a class=\"anchor\" href=\"#å››-css-æ ·å¼çš„ä½œç”¨\">#</a> å››ã€CSS æ ·å¼çš„ä½œç”¨</h2>\n<h3 id=\"41-ä¸ºä»€ä¹ˆéœ€è¦-css\"><a class=\"anchor\" href=\"#41-ä¸ºä»€ä¹ˆéœ€è¦-css\">#</a> 4.1 ä¸ºä»€ä¹ˆéœ€è¦ CSSï¼Ÿ</h3>\n<p>highlight.js åªæ˜¯æ·»åŠ äº†ç±»åï¼Œ<strong>å®é™…çš„é¢œè‰²æ˜¯é€šè¿‡ CSS å®ç°çš„</strong>ã€‚</p>\n<h3 id=\"42-css-ä¸»é¢˜æ–‡ä»¶\"><a class=\"anchor\" href=\"#42-css-ä¸»é¢˜æ–‡ä»¶\">#</a> 4.2 CSS ä¸»é¢˜æ–‡ä»¶</h3>\n<figure class=\"highlight typescript\"><figcaption data-lang=\"typescript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token string\">'highlight.js/styles/github-dark.css'</span></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†æ‰€æœ‰è¯­æ³•å…ƒç´ çš„é¢œè‰²å®šä¹‰ï¼š</p>\n<figure class=\"highlight css\"><figcaption data-lang=\"CSS\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token selector\">.hljs-keyword</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> #ff7b72<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token selector\">.hljs-string</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> #a5d6ff<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token selector\">.hljs-number</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> #79c0ff<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token selector\">.hljs-comment</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> #8b949e<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/* ... æ›´å¤šæ ·å¼ ... */</span></pre></td></tr></table></figure><h3 id=\"43-è‡ªå®šä¹‰æ ·å¼å¢å¼º\"><a class=\"anchor\" href=\"#43-è‡ªå®šä¹‰æ ·å¼å¢å¼º\">#</a> 4.3 è‡ªå®šä¹‰æ ·å¼å¢å¼º</h3>\n<figure class=\"highlight css\"><figcaption data-lang=\"CSS\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* ä»£ç å—å®¹å™¨æ ·å¼ */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token selector\">:deep(.markdown-body pre.hljs)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 16px<span class=\"token punctuation\">;</span>                    <span class=\"token comment\">/* å†…è¾¹è· */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">overflow-x</span><span class=\"token punctuation\">:</span> auto<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">/* æ¨ªå‘æ»šåŠ¨ */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">border</span><span class=\"token punctuation\">:</span> 1px solid <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 255<span class=\"token punctuation\">,</span> 0.1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* è¾¹æ¡† */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">border-radius</span><span class=\"token punctuation\">:</span> 8px<span class=\"token punctuation\">;</span>               <span class=\"token comment\">/* åœ†è§’ */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 1em<span class=\"token punctuation\">;</span>                <span class=\"token comment\">/* åº•éƒ¨é—´è· */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/* ä»£ç å†…å®¹æ ·å¼ */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token selector\">:deep(.markdown-body pre.hljs code)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> transparent <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* é€æ˜èƒŒæ™¯ */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token property\">font-family</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'SF Mono'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Monaco'</span><span class=\"token punctuation\">,</span> ...<span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* ç­‰å®½å­—ä½“ */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token property\">line-height</span><span class=\"token punctuation\">:</span> 1.6<span class=\"token punctuation\">;</span>                           <span class=\"token comment\">/* è¡Œé«˜ */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">white-space</span><span class=\"token punctuation\">:</span> pre<span class=\"token punctuation\">;</span>                           <span class=\"token comment\">/* ä¿ç•™ç©ºç™½ */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆéœ€è¦  <code>!important</code> ï¼Ÿ</strong></p>\n<ul>\n<li>highlight.js çš„ä¸»é¢˜ CSS å¯èƒ½è®¾ç½®äº†èƒŒæ™¯è‰²</li>\n<li>æˆ‘ä»¬éœ€è¦è¦†ç›–å®ƒï¼Œè®©ä»£ç å—ä½¿ç”¨ç»Ÿä¸€çš„èƒŒæ™¯è‰²</li>\n</ul>\n<h3 id=\"44-è¡Œå†…ä»£ç -vs-ä»£ç å—\"><a class=\"anchor\" href=\"#44-è¡Œå†…ä»£ç -vs-ä»£ç å—\">#</a> 4.4 è¡Œå†…ä»£ç  vs ä»£ç å—</h3>\n<figure class=\"highlight css\"><figcaption data-lang=\"CSS\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* è¡Œå†…ä»£ç ï¼ˆä¸åŒ…å« .hljs ç±»ï¼‰ */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token selector\">:deep(.markdown-body code:not(.hljs))</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token function\">rgba</span><span class=\"token punctuation\">(</span>175<span class=\"token punctuation\">,</span> 184<span class=\"token punctuation\">,</span> 193<span class=\"token punctuation\">,</span> 0.2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span> 0.2em 0.4em<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">/* ç®€å•çš„ç°è‰²èƒŒæ™¯ï¼Œä¸é«˜äº® */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/* ä»£ç å—ï¼ˆåŒ…å« .hljs ç±»ï¼‰ */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token selector\">:deep(.markdown-body pre.hljs)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">/* å®Œæ•´çš„è¯­æ³•é«˜äº®æ ·å¼ */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"äº”-å®Œæ•´çš„æ‰§è¡Œç¤ºä¾‹\"><a class=\"anchor\" href=\"#äº”-å®Œæ•´çš„æ‰§è¡Œç¤ºä¾‹\">#</a> äº”ã€å®Œæ•´çš„æ‰§è¡Œç¤ºä¾‹</h2>\n<h3 id=\"51-è¾“å…¥ç¤ºä¾‹\"><a class=\"anchor\" href=\"#51-è¾“å…¥ç¤ºä¾‹\">#</a> 5.1 è¾“å…¥ç¤ºä¾‹</h3>\n<p>è¿™æ˜¯ä¸€ä¸ª JavaScript ç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">greet</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Hello, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"52-å¤„ç†è¿‡ç¨‹\"><a class=\"anchor\" href=\"#52-å¤„ç†è¿‡ç¨‹\">#</a> 5.2 å¤„ç†è¿‡ç¨‹</h3>\n<ol>\n<li>\n<p><strong>markdown-it è§£æ</strong>ï¼š</p>\n<ul>\n<li>è¯†åˆ«åˆ°ä»£ç å—ï¼Œè¯­è¨€æ˜¯  <code>javascript</code></li>\n<li>æå–ä»£ç å†…å®¹ï¼š <code>function greet(name) &#123; ... &#125;</code></li>\n<li>è°ƒç”¨  <code>highlight('function greet...', 'javascript')</code></li>\n</ul>\n</li>\n<li>\n<p><strong>highlight.js å¤„ç†</strong>ï¼š</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hljs<span class=\"token punctuation\">.</span><span class=\"token function\">highlight</span><span class=\"token punctuation\">(</span><span class=\"token string\">'function greet(name) &#123; ... &#125;'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token literal-property property\">language</span><span class=\"token operator\">:</span> <span class=\"token string\">'javascript'</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ul>\n<li>è¯†åˆ«  <code>function</code>  ä¸ºå…³é”®å­—</li>\n<li>è¯†åˆ«  <code>greet</code>  ä¸ºå‡½æ•°å</li>\n<li>è¯†åˆ«  <code>name</code>  ä¸ºå‚æ•°</li>\n<li>è¯†åˆ«å­—ç¬¦ä¸²æ¨¡æ¿</li>\n</ul>\n</li>\n<li>\n<p><strong>ç”Ÿæˆ HTML</strong>ï¼š</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pre</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>code</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-keyword<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>function<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-title function_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>greet<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    (<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-params<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>name<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>) &#123;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-keyword<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>return<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hljs-string<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>`Hello, $&#123;name&#125;!`<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>code</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>pre</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>CSS åº”ç”¨</strong>ï¼š</p>\n<ul>\n<li><code>.hljs-keyword</code>  â†’ çº¢è‰²ï¼ˆ <code>#ff7b72</code> ï¼‰</li>\n<li><code>.hljs-string</code>  â†’ è“è‰²ï¼ˆ <code>#a5d6ff</code> ï¼‰</li>\n<li><code>.hljs-title.function_</code>  â†’ é»„è‰²</li>\n<li>ç­‰ç­‰...</li>\n</ul>\n</li>\n<li>\n<p><strong>æœ€ç»ˆæ¸²æŸ“</strong>ï¼š</p>\n<ul>\n<li>æµè§ˆå™¨è§£æ HTML</li>\n<li>åº”ç”¨ CSS æ ·å¼</li>\n<li>ç”¨æˆ·çœ‹åˆ°å½©è‰²é«˜äº®çš„ä»£ç </li>\n</ul>\n</li>\n</ol>\n<h2 id=\"å…­-å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“\"><a class=\"anchor\" href=\"#å…­-å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“\">#</a> å…­ã€å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“</h2>\n<h3 id=\"61-ä¸ºä»€ä¹ˆè¿™æ ·èƒ½å·¥ä½œ\"><a class=\"anchor\" href=\"#61-ä¸ºä»€ä¹ˆè¿™æ ·èƒ½å·¥ä½œ\">#</a> 6.1 ä¸ºä»€ä¹ˆè¿™æ ·èƒ½å·¥ä½œï¼Ÿ</h3>\n<ol>\n<li>\n<p><strong>markdown-it çš„æ‰©å±•æœºåˆ¶</strong>ï¼š</p>\n<ul>\n<li><code>highlight</code>  é€‰é¡¹æ˜¯ markdown-it æä¾›çš„<strong>æ’ä»¶æ¥å£</strong></li>\n<li>å…è®¸å¼€å‘è€…è‡ªå®šä¹‰ä»£ç å—çš„å¤„ç†æ–¹å¼</li>\n</ul>\n</li>\n<li>\n<p><strong>highlight.js çš„è¯­æ³•åˆ†æ</strong>ï¼š</p>\n<ul>\n<li>ä½¿ç”¨<strong>è¯æ³•åˆ†æå™¨</strong>ï¼ˆLexerï¼‰è¯†åˆ«è¯­æ³•å…ƒç´ </li>\n<li>æ¯ç§è¯­è¨€éƒ½æœ‰å¯¹åº”çš„è¯­æ³•è§„åˆ™å®šä¹‰</li>\n<li>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å’ŒçŠ¶æ€æœºè¿›è¡ŒåŒ¹é…</li>\n</ul>\n</li>\n<li>\n<p><strong>CSS ç±»åçš„çº¦å®š</strong>ï¼š</p>\n<ul>\n<li>highlight.js ä½¿ç”¨ç»Ÿä¸€çš„ç±»åè§„èŒƒï¼ˆå¦‚  <code>.hljs-keyword</code> ï¼‰</li>\n<li>CSS ä¸»é¢˜æ–‡ä»¶å®šä¹‰äº†è¿™äº›ç±»åçš„é¢œè‰²</li>\n<li>å¼€å‘è€…å¯ä»¥åˆ‡æ¢ä¸»é¢˜æˆ–è‡ªå®šä¹‰æ ·å¼</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"62-æ€§èƒ½è€ƒè™‘\"><a class=\"anchor\" href=\"#62-æ€§èƒ½è€ƒè™‘\">#</a> 6.2 æ€§èƒ½è€ƒè™‘</h3>\n<ul>\n<li><strong>ç¼“å­˜æœºåˆ¶</strong>ï¼šhighlight.js ä¼šç¼“å­˜å·²è§£æçš„è¯­è¨€å®šä¹‰</li>\n<li><strong>æŒ‰éœ€åŠ è½½</strong>ï¼šå¯ä»¥åªåŠ è½½éœ€è¦çš„è¯­è¨€åŒ…</li>\n<li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šå¯¹äºå¤§æ–‡ä»¶ï¼Œå¯ä»¥è€ƒè™‘å¼‚æ­¥é«˜äº®</li>\n</ul>\n<h3 id=\"63-å®‰å…¨æ€§\"><a class=\"anchor\" href=\"#63-å®‰å…¨æ€§\">#</a> 6.3 å®‰å…¨æ€§</h3>\n<ul>\n<li><strong>HTML è½¬ä¹‰</strong>ï¼š <code>md.utils.escapeHtml(str)</code>  é˜²æ­¢ XSS æ”»å‡»</li>\n<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå¤šå±‚ fallback ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿèƒ½æ˜¾ç¤ºä»£ç </li>\n</ul>\n<h2 id=\"ä¸ƒ-ä¸-gemini-æ•ˆæœçš„å¯¹æ¯”\"><a class=\"anchor\" href=\"#ä¸ƒ-ä¸-gemini-æ•ˆæœçš„å¯¹æ¯”\">#</a> ä¸ƒã€ä¸ Gemini æ•ˆæœçš„å¯¹æ¯”</h2>\n<h3 id=\"71-ç›¸ä¼¼ä¹‹å¤„\"><a class=\"anchor\" href=\"#71-ç›¸ä¼¼ä¹‹å¤„\">#</a> 7.1 ç›¸ä¼¼ä¹‹å¤„</h3>\n<ul>\n<li>âœ… ä½¿ç”¨è¯­æ³•é«˜äº®åº“ï¼ˆGemini å¯èƒ½ä¹Ÿä½¿ç”¨ç±»ä¼¼æ–¹æ¡ˆï¼‰</li>\n<li>âœ… æ·±è‰²ä¸»é¢˜ï¼ˆ <code>github-dark</code> ï¼‰</li>\n<li>âœ… åœ†è§’è¾¹æ¡†å’Œé€‚å½“çš„å†…è¾¹è·</li>\n<li>âœ… è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼</li>\n<li>âœ… ç­‰å®½å­—ä½“</li>\n</ul>\n<h3 id=\"72-å¯èƒ½çš„å¢å¼º\"><a class=\"anchor\" href=\"#72-å¯èƒ½çš„å¢å¼º\">#</a> 7.2 å¯èƒ½çš„å¢å¼º</h3>\n<ul>\n<li>ä»£ç å¤åˆ¶æŒ‰é’®</li>\n<li>è¡Œå·æ˜¾ç¤º</li>\n<li>è¯­è¨€æ ‡è¯†æ ‡ç­¾</li>\n<li>ä»£ç æŠ˜å åŠŸèƒ½</li>\n</ul>\n<h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>ä»£ç é«˜äº®çš„å®ç°æœ¬è´¨ä¸Šæ˜¯ï¼š</p>\n<ol>\n<li><strong>è§£æ</strong>ï¼šmarkdown-it è¯†åˆ«ä»£ç å—</li>\n<li><strong>åˆ†æ</strong>ï¼šhighlight.js è¿›è¡Œè¯­æ³•åˆ†æ</li>\n<li><strong>æ ‡è®°</strong>ï¼šæ·»åŠ  HTML æ ‡ç­¾å’Œ CSS ç±»å</li>\n<li><strong>æ¸²æŸ“</strong>ï¼šCSS åº”ç”¨é¢œè‰²æ ·å¼</li>\n<li><strong>æ˜¾ç¤º</strong>ï¼šæµè§ˆå™¨æ¸²æŸ“æœ€ç»ˆæ•ˆæœ</li>\n</ol>\n<p>æ•´ä¸ªè¿‡ç¨‹æ˜¯<strong>å£°æ˜å¼</strong>çš„ï¼šæˆ‘ä»¬å®šä¹‰äº†è§„åˆ™ï¼Œåº“è‡ªåŠ¨å¤„ç†ç»†èŠ‚ï¼Œæœ€ç»ˆå¾—åˆ°ç¾è§‚çš„é«˜äº®ä»£ç ã€‚</p>\n",
            "tags": [
                "markdown",
                "markdown-it",
                "highlight.js"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%AF%81%E6%98%8E-%E5%B7%B2%E7%9F%A5%E8%B5%B7%E5%A7%8B%E5%9D%90%E6%A0%87%E6%B1%82%E7%BB%95%E5%8F%A6%E4%B8%80%E7%82%B9%E5%9D%90%E6%A0%87%E6%97%8B%E8%BD%AC%E5%90%8E%E7%9A%84%E7%BB%88%E7%82%B9%E5%9D%90%E6%A0%87/",
            "url": "https://aynya.github.io/%E8%AF%81%E6%98%8E-%E5%B7%B2%E7%9F%A5%E8%B5%B7%E5%A7%8B%E5%9D%90%E6%A0%87%E6%B1%82%E7%BB%95%E5%8F%A6%E4%B8%80%E7%82%B9%E5%9D%90%E6%A0%87%E6%97%8B%E8%BD%AC%E5%90%8E%E7%9A%84%E7%BB%88%E7%82%B9%E5%9D%90%E6%A0%87/",
            "title": "è¯æ˜-å·²çŸ¥èµ·å§‹åæ ‡æ±‚ç»•å¦ä¸€ç‚¹åæ ‡æ—‹è½¬åçš„ç»ˆç‚¹åæ ‡",
            "date_published": "2025-12-12T06:49:49.000Z",
            "content_html": "<p>è‡³äºæˆ‘ä¸ºä»€ä¹ˆä¼šæƒ³è¦æ¥è¯æ˜è¿™ä¸ªå‘¢<br />\næœ€è¿‘åœ¨çœ‹ vue æ–‡æ¡£ï¼Œé‡åˆ°äº†ä¸€ä¸ª vue çš„ç¤ºä¾‹<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbi52dWVqcy5vcmcvZXhhbXBsZXMvI3N2Zw==\">ç‚¹å‡»æ­¤è·³è½¬</span></p>\n<hr />\n<p>ç¤ºä¾‹æŠ½è±¡ï¼šå¯¹äºä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œéœ€è¦æ ¹æ®æ•°æ®å¯¹è±¡çš„  <code>value</code>  å±æ€§ æ¥æ„å»ºä¸€ä¸ªé›·è¾¾å›¾<br />\né›·è¾¾å›¾ï¼šåœ¨ä¸€ä¸ªåœ†å‘¨ä¸Šï¼Œå¹³å±€åˆ†å‡º n ä¸ªç‚¹ï¼Œç„¶åæŠŠè¿™ n ä¸ªç‚¹è¿æ¥èµ·æ¥ï¼Œå¯¹å†…éƒ¨è¿›è¡Œå¡«å……<br />\né—®é¢˜æŠ½è±¡ï¼šå·²çŸ¥æœ‰ n ä¸ªç‚¹ï¼Œèµ·å§‹ç‚¹åæ ‡ä¸º <code>(x_0, y_0)</code> ï¼Œæ±‚å‡ºç»•ç‚¹ <code>(0, 0)</code>  æ—‹è½¬åçš„ç»ˆç‚¹åæ ‡</p>\n<hr />\n<h1 id=\"é—®é¢˜å‰–åˆ†\"><a class=\"anchor\" href=\"#é—®é¢˜å‰–åˆ†\">#</a> é—®é¢˜å‰–åˆ†</h1>\n<ol>\n<li>æ—¢ç„¶è¦å¹³å‡åˆ†æˆ n ä¸ªç‚¹ï¼Œé‚£ä¹ˆæ¯ä¸ªç‚¹çš„è§’åº¦å¢é‡ä¸º <code>360 / n</code>  åº¦ï¼Œæˆ‘ä»¬è®¾ä¸º <code>Î¸</code></li>\n<li>ç„¶ååˆå·²çŸ¥èµ·å§‹ç‚¹çš„åæ ‡ä¸º <code>(x_0, y_0)</code></li>\n<li>é‚£ä¹ˆç»ˆç‚¹çš„åæ ‡ä¸º <code>(x_1, y_1)</code></li>\n</ol>\n<p>æˆ‘ä»¬å°±æ˜¯è¦æ±‚è¿™ä¸ª <code>(x_1, y_1)</code></p>\n<h1 id=\"è¯æ˜è¿‡ç¨‹æ–¹ç¨‹è”ç«‹\"><a class=\"anchor\" href=\"#è¯æ˜è¿‡ç¨‹æ–¹ç¨‹è”ç«‹\">#</a> è¯æ˜è¿‡ç¨‹ï¼ˆæ–¹ç¨‹è”ç«‹ï¼‰</h1>\n<h2 id=\"æ¡ä»¶\"><a class=\"anchor\" href=\"#æ¡ä»¶\">#</a> æ¡ä»¶</h2>\n<ol>\n<li>å·²çŸ¥èµ·å§‹ç‚¹åæ ‡ä¸º <code>(xâ‚€, yâ‚€)</code></li>\n<li>å·²çŸ¥æ—‹è½¬è§’åº¦ä¸º <code>Î¸</code></li>\n</ol>\n<h2 id=\"ç›®æ ‡\"><a class=\"anchor\" href=\"#ç›®æ ‡\">#</a> ç›®æ ‡</h2>\n<ol>\n<li>æ±‚å‡ºç»•ç‚¹ <code>(0, 0)</code>  æ—‹è½¬åçš„ç»ˆç‚¹åæ ‡ <code>(xâ‚, yâ‚)</code></li>\n</ol>\n<h2 id=\"è¯æ˜\"><a class=\"anchor\" href=\"#è¯æ˜\">#</a> è¯æ˜</h2>\n<p>è®¾èµ·å§‹ç‚¹ä¸º <code>A(xâ‚€, yâ‚€)</code> , ç»ˆç‚¹ä¸º <code>B(xâ‚, yâ‚)</code> , åŸç‚¹ä¸º <code>O(0, 0)</code> ï¼Œ <code>OA</code>  åˆ°  <code>OB</code>  çš„æ—‹è½¬è§’åº¦ä¸º <code>Î¸</code> ï¼Œ <code>OA</code>  çš„æ—‹è½¬è§’åº¦ä¸º <code>Î±</code> ï¼Œ <code>OB</code>  çš„æ—‹è½¬è§’åº¦ä¸º <code>Î²</code> ï¼Œé•¿åº¦ä¸º <code>r</code> <br />\n åˆ™æœ‰ <code>Î± + Î¸ = Î²</code> <br />\n <code>sin(Î²) = sin(Î± + Î¸) = sin(Î±) * cos(Î¸) + cos(Î±) * sin(Î¸)</code> <br />\n <code>cos(Î²) = cos(Î± + Î¸) = cos(Î±) * cos(Î¸) - sin(Î±) * sin(Î¸)</code> <br />\n <code>sin(Î±) = yâ‚€/rï¼Œcos(Î±) = xâ‚€/rï¼Œsin(Î²) = yâ‚/rï¼Œcos(Î²) = xâ‚/r</code> <br />\n ä»£å…¥ä¸Šå¼å¾—ï¼š<br />\n <code>xâ‚ = r * cos(Î²) = r * cos(Î± + Î¸) = r * (cos(Î±) * cos(Î¸) - sin(Î±) * sin(Î¸))</code> <br />\n <code>yâ‚ = r * sin(Î²) = r * sin(Î± + Î¸) = r * (sin(Î±) * cos(Î¸) + cos(Î±) * sin(Î¸))</code> <br />\n <code>xâ‚ = r * ( (xâ‚€/r) * cos(Î¸) - (yâ‚€/r) * sin(Î¸) ) = xâ‚€ * cos(Î¸) - yâ‚€ * sin(Î¸)</code> <br />\n <code>yâ‚ = r * ( (yâ‚€/r) * cos(Î¸) + (xâ‚€/r) * sin(Î¸) ) = yâ‚€ * cos(Î¸) + xâ‚€ * sin(Î¸)</code> <br />\n æœ€ç»ˆå¯å¾—ï¼š<br />\n <code>xâ‚ = xâ‚€ * cos (Î¸) - yâ‚€ * sin (Î¸)</code> <br />\n <code>yâ‚ = yâ‚€ * cos (Î¸) + xâ‚€ * sin (Î¸)</code> <br />\n è¯æ¯•</p>\n<h1 id=\"è¯æ˜è¿‡ç¨‹åæ ‡ç³»æ—‹è½¬\"><a class=\"anchor\" href=\"#è¯æ˜è¿‡ç¨‹åæ ‡ç³»æ—‹è½¬\">#</a> è¯æ˜è¿‡ç¨‹ï¼ˆåæ ‡ç³»æ—‹è½¬ï¼‰</h1>\n<h2 id=\"æ¡ä»¶-2\"><a class=\"anchor\" href=\"#æ¡ä»¶-2\">#</a> æ¡ä»¶</h2>\n<ol>\n<li>å·²çŸ¥èµ·å§‹ç‚¹åæ ‡ä¸º <code>A(xâ‚€, yâ‚€)</code></li>\n<li>å·²çŸ¥æ—‹è½¬è§’åº¦ä¸º <code>Î¸</code></li>\n<li>åŸåæ ‡ç³»çš„å•ä½å‘é‡ä¸º <code>(e0_x, e0_y)</code></li>\n<li>ç›®æ ‡åæ ‡ç³»çš„å•ä½å‘é‡ä¸º <code>(e1_x, e1_y)</code></li>\n</ol>\n<h2 id=\"ç›®æ ‡-2\"><a class=\"anchor\" href=\"#ç›®æ ‡-2\">#</a> ç›®æ ‡</h2>\n<ol>\n<li>æ±‚åæ ‡ç³»æ—‹è½¬åçš„ç»ˆç‚¹åæ ‡ <code>B(xâ‚, yâ‚)</code> ï¼ˆç›¸å¯¹äºåŸåæ ‡ç³»çš„åæ ‡ï¼‰</li>\n</ol>\n<h2 id=\"è¯æ˜-2\"><a class=\"anchor\" href=\"#è¯æ˜-2\">#</a> è¯æ˜</h2>\n<ol>\n<li>èµ·å§‹ç‚¹ A åœ¨åŸåæ ‡ç³»ä¸­çš„å‘é‡è¡¨è¾¾ï¼š <code>å‘é‡ A = xâ‚€ Ã— e0_x + yâ‚€ Ã— e0_y</code></li>\n<li>ç»ˆç‚¹ B åœ¨ç›®æ ‡åæ ‡ç³»ä¸­çš„å‘é‡è¡¨è¾¾ï¼ˆåæ ‡ä¸å˜ï¼Œåæ ‡ç³»æ—‹è½¬ï¼‰ï¼š <code>å‘é‡ B = xâ‚€ Ã— e1_x + yâ‚€ Ã— e1_y</code></li>\n<li>ç›®æ ‡åæ ‡ç³»å•ä½å‘é‡ä¸åŸåæ ‡ç³»çš„å…³ç³»ï¼ˆæ—‹è½¬ Î¸ è§’æ¨å¯¼ï¼‰ï¼š\n<ul>\n<li><code>e1_x = cos(Î¸) Ã— e0_x + sin(Î¸) Ã— e0_y</code></li>\n<li><code>e1_y = -sin (Î¸) Ã— e0_x + cos (Î¸) Ã— e0_y</code></li>\n</ul>\n</li>\n<li>æœ€ç»ˆï¼Œå°† e1_xã€e1_y ä»£å…¥å‘é‡ B çš„è¡¨è¾¾å¼ï¼š\n<ul>\n<li><code>å‘é‡ B = xâ‚€ Ã— [cos (Î¸) Ã— e0_x + sin (Î¸) Ã— e0_y] + yâ‚€ Ã— [-sin (Î¸) Ã— e0_x + cos (Î¸) Ã— e0_y]</code></li>\n</ul>\n</li>\n<li>å±•å¼€å¹¶æŒ‰åŸåæ ‡ç³»å•ä½å‘é‡åˆ†ç»„ï¼š\n<ul>\n<li><code>å‘é‡ B = [xâ‚€ Ã— cos (Î¸) - yâ‚€ Ã— sin (Î¸)] Ã— e0_x + [xâ‚€ Ã— sin (Î¸) + yâ‚€ Ã— cos (Î¸)] Ã— e0_y</code></li>\n</ul>\n</li>\n<li>ç”±äºå‘é‡ B åœ¨åŸåæ ‡ç³»ä¸­çš„åæ ‡ä¸º (xâ‚, yâ‚)ï¼Œå¯¹åº”ç³»æ•°å³ä¸ºåæ ‡å€¼ï¼š\n<ul>\n<li><code>xâ‚ = xâ‚€ Ã— cos (Î¸) - yâ‚€ Ã— sin (Î¸)</code></li>\n<li><code>yâ‚ = yâ‚€ Ã— cos (Î¸) + xâ‚€ Ã— sin (Î¸)</code></li>\n</ul>\n</li>\n</ol>\n<p>å½“ç„¶ï¼Œè¿™ä¸ªæ˜¯ç»•åŸç‚¹æ—‹è½¬çš„ï¼Œé‚£ä¹ˆå¦‚æœè¦ç»•å¦ä¸€ç‚¹æ—‹è½¬ï¼Œåªéœ€è¦å…ˆæŠŠåæ ‡å¹³ç§»åˆ°åŸç‚¹ï¼Œæ—‹è½¬åå†å¹³ç§»å›æ¥å³å¯</p>\n<h1 id=\"æ—‹è½¬çŸ©é˜µ\"><a class=\"anchor\" href=\"#æ—‹è½¬çŸ©é˜µ\">#</a> æ—‹è½¬çŸ©é˜µ</h1>\n<p>æ€»ç»“ä¸Šè¿°è¿‡ç¨‹ï¼Œå¾—åˆ°æ—‹è½¬çŸ©é˜µä¸ºï¼š</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span> <span class=\"token function\">cos</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span>   <span class=\"token operator\">-</span><span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>   Ã—   <span class=\"token punctuation\">[</span> xâ‚€ <span class=\"token punctuation\">]</span>   <span class=\"token operator\">=</span>   <span class=\"token punctuation\">[</span> <span class=\"token function\">xâ‚€Ã—cos</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">yâ‚€Ã—sin</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xâ‚<span class=\"token punctuation\">,</span> yâ‚<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span>    <span class=\"token function\">cos</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span>       <span class=\"token punctuation\">[</span> yâ‚€ <span class=\"token punctuation\">]</span>       <span class=\"token punctuation\">[</span> <span class=\"token function\">xâ‚€Ã—sin</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">yâ‚€Ã—cos</span><span class=\"token punctuation\">(</span>Î¸<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h1 id=\"æºç \"><a class=\"anchor\" href=\"#æºç \">#</a> æºç </h1>\n<p>è¿™é‡Œçš„ï¼Œindex æ˜¯æŒ‡ç¬¬å‡ ä¸ªç‚¹ï¼Œtotal æ˜¯æ€»å…±æœ‰å¤šå°‘ä¸ªç‚¹ï¼Œè¿™å°±å¯ä»¥æ±‚å‡ºé›·è¾¾å›¾ä¸­çš„æ¯ä¸ªç‚¹çš„åæ ‡<br />\nåªæ˜¯è®¡ç®—è¿‡ç¨‹ï¼Œéå¯ç›´æ¥ä½¿ç”¨çš„ä»£ç ï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œä¿®æ”¹</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">valueToPoint</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">,</span> total</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> angle <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> total<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> index</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> cos <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">cos</span><span class=\"token punctuation\">(</span>angle<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> sin <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>angle<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> tx <span class=\"token operator\">=</span> x <span class=\"token operator\">*</span> cos <span class=\"token operator\">-</span> y <span class=\"token operator\">*</span> sin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> ty <span class=\"token operator\">=</span> x <span class=\"token operator\">*</span> sin <span class=\"token operator\">+</span> y <span class=\"token operator\">*</span> cos</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> tx<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> ty</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Math",
                "Math"
            ]
        },
        {
            "id": "https://aynya.github.io/node-js-%E4%B8%AD-AI-%E6%B5%81%E5%BC%8F%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/",
            "url": "https://aynya.github.io/node-js-%E4%B8%AD-AI-%E6%B5%81%E5%BC%8F%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/",
            "title": "node.js ä¸­ AI æµå¼è¾“å…¥è¾“å‡º",
            "date_published": "2025-12-02T09:39:26.000Z",
            "content_html": "<p>æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ç”¨åŸç”Ÿ Node.js  <code>http</code>  æ¨¡å—å’Œå‰ç«¯  <code>fetch</code>  API å®ç°ä¸€ä¸ªå¥å£®çš„ã€ç±»ä¼¼ ChatGPT æ•ˆæœçš„æµå¼ AI å“åº”æœåŠ¡<br />\nä»¥åŠæœ¬äººåœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜å’Œè§£å†³æ–¹æ³•</p>\n<hr />\n<h1 id=\"ç¬¬ä¸€æ­¥æ­å»ºåŸºç¡€-ä¸€ä¸ªç®€å•çš„-http-æœåŠ¡\"><a class=\"anchor\" href=\"#ç¬¬ä¸€æ­¥æ­å»ºåŸºç¡€-ä¸€ä¸ªç®€å•çš„-http-æœåŠ¡\">#</a> ç¬¬ä¸€æ­¥ï¼šæ­å»ºåŸºç¡€ - ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡</h1>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å“åº”å®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡å™¨ã€‚æˆ‘ä»¬ä½¿ç”¨ Node.js å†…ç½®çš„  <code>http</code>  æ¨¡å—ï¼Œå› ä¸ºå®ƒæ— éœ€ä»»ä½•å¤–éƒ¨ä¾èµ–ï¼Œèƒ½è®©æˆ‘ä»¬æ›´ä¸“æ³¨äºåº•å±‚çš„æµå¼æ•°æ®å¤„ç†<br />\n <code>server.js</code>  - ç‰ˆæœ¬ 1</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> http <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> hostname <span class=\"token operator\">=</span> <span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">5173</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å“åº”å¤´ï¼Œå‘Šè¯‰æµè§ˆå™¨æˆ‘ä»¬è¦å‘é€çš„æ˜¯ â€œæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰â€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/event-stream'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string-property property\">'Cache-Control'</span><span class=\"token operator\">:</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string-property property\">'Connection'</span><span class=\"token operator\">:</span> <span class=\"token string\">'keep-alive'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">let</span> id <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> intervalId <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      id<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token operator\">></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>intervalId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\">// SSE æ ¼å¼ï¼šä»¥ \"data:\" å¼€å¤´ï¼Œä»¥ \"\\n\\n\" ç»“å°¾</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Sending message </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">data: è¿™æ˜¯æ¶ˆæ¯ </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\\n\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// ç»“æŸå“åº”</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// å½“å®¢æˆ·ç«¯å…³é—­è¿æ¥æ—¶ï¼Œåœæ­¢å‘é€</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'close'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ã€‚'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>server<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span> hostname<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">æœåŠ¡å™¨æ­£åœ¨è¿è¡Œäº http://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>hostname<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>port<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>test.js</code>  - ç‰ˆæœ¬ 1</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">runTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// 1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:5173\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// const reader = response.body.getReader();</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// const decoder = new TextDecoder();</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// ç­‰å¾…æ¶ˆæ¯å‘é€å®Œåï¼Œæ‰“å°å®Œæ•´å“åº”</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// 2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// æµå¼è¯»å–å“åº”ä½“</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// while (true) &#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//   const &#123; value, done &#125; = await reader.read();</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">//   if (done) break;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//   const chunk = decoder.decode(value);</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">//   console.log(chunk);</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// &#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">runTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ­¤æ—¶è¿è¡Œè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¼šå‘ç°ï¼Œç›´åˆ°æ‰€æœ‰æ¶ˆæ¯å‘é€å®Œæ¯•ï¼Œæ‰ä¼šæ‰“å°å®Œæ•´å“åº”<br />\nä½†æ˜¯åœ¨å®é™…çš„ AI å¯¹è¯ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¾¹æ¥æ”¶è¾¹å¤„ç†å“åº”ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æ¶ˆæ¯å‘é€å®Œæ¯•<br />\nè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æŠŠç›®å…‰æ”¾åœ¨ä»£ç ä¸­çš„ä¸¤ä¸ª  <code>await</code>  è¯­å¥</p>\n<ul>\n<li>ç¬¬ä¸€ä¸ª  <code>await fetch(&quot;http://127.0.0.1:5173&quot;)</code>  ç­‰å¾…æœåŠ¡å™¨å“åº”</li>\n<li>ç¬¬äºŒä¸ª  <code>await response.text()</code>  ç­‰å¾…æ‰€æœ‰æ¶ˆæ¯å‘é€å®Œæ¯•ï¼Œè¿”å›å®Œæ•´å“åº”</li>\n</ul>\n<p>å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„æ˜¯ç¬¬äºŒä¸ª  <code>await response.text()</code> <br />\n è¿™ä¸ªæ—¶å€™å°±è¦ç”¨æµå¼è¯»å–å“åº”ä½“çš„æ–¹å¼ï¼Œè¾¹æ¥æ”¶è¾¹å¤„ç†å“åº”</p>\n<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä»¥åŠå»ºç«‹äº†ä¸€ä¸ªæŒä¹…çš„æµå¼è¿æ¥</p>\n<hr />\n<h1 id=\"ç¬¬äºŒæ­¥è¿æ¥-ai-æ¨¡å‹-è·å–çœŸå®çš„æµå¼æ•°æ®\"><a class=\"anchor\" href=\"#ç¬¬äºŒæ­¥è¿æ¥-ai-æ¨¡å‹-è·å–çœŸå®çš„æµå¼æ•°æ®\">#</a> ç¬¬äºŒæ­¥ï¼šè¿æ¥ AI æ¨¡å‹ - è·å–çœŸå®çš„æµå¼æ•°æ®</h1>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠé™æ€æ¶ˆæ¯è½¬æ¢æˆçœŸå®çš„ AI å“åº”ã€‚æˆ‘ä»¬ä½¿ç”¨  <code>openai</code>  åº“æ¥è°ƒç”¨ AI æ¨¡å‹ï¼Œå¹¶å¼€å¯æµå¼å“åº”æ¨¡å¼ï¼ˆ <code>stream: true</code> ï¼‰</p>\n<p>ä½†è¿™é‡Œæˆ‘ä»¬é‡åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜</p>\n<h2 id=\"é—®é¢˜1åŸç”Ÿ-nodejs-ä¸­reqbodyåœ¨å“ªé‡Œ\"><a class=\"anchor\" href=\"#é—®é¢˜1åŸç”Ÿ-nodejs-ä¸­reqbodyåœ¨å“ªé‡Œ\">#</a> é—®é¢˜ 1ï¼šåŸç”Ÿ node.js ä¸­ï¼Œ <code>req.body</code>  åœ¨å“ªé‡Œï¼Ÿ</h2>\n<p>å½“å®¢æˆ·ç«¯é€šè¿‡ <code>POST</code>  è¯·æ±‚æŠŠç”¨æˆ·çš„æé—®ï¼ˆPromptï¼‰å‘é€ç»™æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯ä» <code>req.body</code>  ä¸­è·å–æ•°æ®ã€‚ä½†åœ¨åŸç”Ÿ <code>http</code>  æ¨¡å—ä¸­ï¼Œ <code>req</code>  å¯¹è±¡æ˜¯ä¸€ä¸ªå¯è¯»æµï¼ˆ <code>ReadableStream</code> ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ã€‚æ²¡æœ‰åƒ <code>express</code>  è¿™æ ·çš„æ¡†æ¶è‡ªåŠ¨è§£æ <code>POST</code>  è¯·æ±‚ä½“çš„åŠŸèƒ½ã€‚æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä»æµä¸­è¯»å–æ•°æ®</p>\n<p>è§£å†³æ–¹æ³•ï¼šç›‘å¬ <code>req</code>  å¯¹è±¡çš„ <code>data</code>  å’Œ  <code>end</code>  äº‹ä»¶æ¥å¼‚æ­¥æ‹¼æ¥å’Œè§£æè¯·æ±‚ä½“</p>\n<p>ä¸‹é¢å°±æ˜¯ <code>server.js</code>  çš„è¿›åŒ–ç‰ˆæœ¬ï¼ŒåŒ…å«äº†è¯·æ±‚ä½“è§£æå’Œè°ƒç”¨ AI çš„é€»è¾‘<br />\n <code>server.js</code>  - ç‰ˆæœ¬ 2</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//... (OpenAI å®¢æˆ·ç«¯é…ç½®) ...</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// å¼‚æ­¥è·å–è¯·æ±‚ä½“çš„è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestBody</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">let</span> body <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">chunk</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      body <span class=\"token operator\">+=</span> chunk<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// å½“è¯·æ±‚ä½“ä¸ºç©ºæ—¶ï¼Œè¿”å›ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œé¿å… JSON.parse æŠ¥é”™</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>body <span class=\"token operator\">||</span> <span class=\"token string\">'&#123;&#125;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ— æ•ˆçš„ JSON è¯·æ±‚ä½“'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">//... (è®¾ç½® SSE å“åº”å¤´) ...</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getRequestBody</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// &lt;-- ä½¿ç”¨è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">const</span> userPrompt <span class=\"token operator\">=</span> body<span class=\"token punctuation\">.</span>prompt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userPrompt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data: &#123;\"error\": \"Prompt ä¸èƒ½ä¸ºç©º\"&#125;\\n\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> openai<span class=\"token punctuation\">.</span>chat<span class=\"token punctuation\">.</span>completions<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token literal-property property\">model</span><span class=\"token operator\">:</span> <span class=\"token string\">'YOUR_AI_MODEL'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ›¿æ¢æˆä½ çš„æ¨¡å‹</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token literal-property property\">messages</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">role</span><span class=\"token operator\">:</span> <span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> userPrompt <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token literal-property property\">stream</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// è¿­ä»£ AI è¿”å›çš„æµ</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> chunk <span class=\"token keyword\">of</span> stream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> chunk<span class=\"token punctuation\">.</span>choices<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">?.</span>delta<span class=\"token operator\">?.</span>content <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token comment\">// å°† AI çš„å†…å®¹å—å°è£…æˆ SSE æ ¼å¼å¹¶å‘é€</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">data: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> content <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\\n\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">//... (é”™è¯¯å¤„ç†) ...</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç»“æŸå“åº”</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">//... (æœåŠ¡å™¨ç›‘å¬) ...</span></pre></td></tr></table></figure><p>ç°åœ¨ï¼ŒæœåŠ¡å™¨ä»¥åŠèƒ½å¤Ÿæ¥æ”¶å®¢æˆ·ç«¯çš„ <code>prompt</code>  äº†ï¼Œå¹¶å°†æ•°æ®æµå‘é€ç»™å®¢æˆ·ç«¯</p>\n<hr />\n<h1 id=\"ç¬¬ä¸‰æ­¥å®¢æˆ·ç«¯é™·é˜±-çœ‹ä¼¼æ­£ç¡®çš„è§£æ\"><a class=\"anchor\" href=\"#ç¬¬ä¸‰æ­¥å®¢æˆ·ç«¯é™·é˜±-çœ‹ä¼¼æ­£ç¡®çš„è§£æ\">#</a> ç¬¬ä¸‰æ­¥ï¼šå®¢æˆ·ç«¯é™·é˜± -&quot;çœ‹ä¼¼æ­£ç¡®çš„è§£æ&quot;</h1>\n<p>åœ¨å®¢æˆ·ç«¯ï¼Œè‡ªç„¶çš„æƒ³åˆ°ï¼Œæ—¢ç„¶æœåŠ¡å™¨å‘é€è¿‡æ¥çš„æ¶ˆæ¯éƒ½ä»¥ <code>\\n\\n</code>  ç»“å°¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨ <code>split('\\n\\n')</code>  æ¥è§£ææ¶ˆæ¯<br />\n <code>test.js</code> -â€œå¤©çœŸâ€ ç‰ˆæœ¬</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//... (fetch å’Œ reader åˆå§‹åŒ–) ...</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> chunk <span class=\"token operator\">=</span> decoder<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> lines <span class=\"token operator\">=</span> chunk<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// &lt;-- å¤©çœŸçš„åˆ†å‰²</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> line <span class=\"token keyword\">of</span> lines<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">const</span> json <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ä¸€å¼€å§‹ï¼Œè¿™æ®µä»£ç å‡ ä¹æ€»æ˜¯èƒ½æ­£å¸¸å·¥ä½œçš„ã€‚è¿™ç»™æˆ‘ä»¬ä¸€ç§ â€œæ²¡é—®é¢˜â€ çš„é”™è§‰ã€‚ç„¶è€Œï¼Œè¿™åé¢éšè—äº†ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜</p>\n<h2 id=\"é—®é¢˜2ä¸ºä»€ä¹ˆç®€å•çš„åˆ†å‰²æ–¹æ³•æ˜¯ä¸å¯é çš„\"><a class=\"anchor\" href=\"#é—®é¢˜2ä¸ºä»€ä¹ˆç®€å•çš„åˆ†å‰²æ–¹æ³•æ˜¯ä¸å¯é çš„\">#</a> é—®é¢˜ 2ï¼šä¸ºä»€ä¹ˆç®€å•çš„åˆ†å‰²æ–¹æ³•æ˜¯ä¸å¯é çš„ï¼Ÿ</h2>\n<p>æ ¸å¿ƒåŸå› ï¼šTCP æ˜¯ä¸€ä¸ªé¢å‘å­—èŠ‚æµçš„åè®®ï¼Œè€Œä¸æ˜¯é¢å‘æ¶ˆæ¯çš„åè®®<br />\nè¿™æ„å‘³ç€ï¼ŒæœåŠ¡å™¨è°ƒç”¨ä¸€æ¬¡ <code>res.write()</code>  å‘é€çš„æ¶ˆæ¯åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«åˆ†å‰²ä¸ºå¤šä¸ª TCP åŒ…ã€‚ç›¸åº”çš„ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ä¸€æ¬¡ <code>reader.read()</code>  å¯èƒ½åªæ”¶åˆ°è¿™äº›åŒ…ä¸­çš„ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡å®Œæ•´ SSE æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†</p>\n<p>æƒ³è±¡ä¸€ä¸‹ï¼š</p>\n<ol>\n<li>æœåŠ¡å™¨å‘é€ï¼š <code>data: &#123;&quot;content&quot;:&quot;ä½ å¥½&quot;&#125;\\n\\n</code></li>\n<li>ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œè¿™æ¡æ¶ˆæ¯è¢«æ‹†åˆ†ä¸ºä¸¤ä¸ª TCP åŒ…ï¼š\n<ul>\n<li>åŒ… 1ï¼š <code>data: &#123;&quot;con</code></li>\n<li>åŒ… 2ï¼š <code>tent&quot;:&quot;ä½ å¥½&quot;&#125;\\n\\n</code></li>\n</ul>\n</li>\n<li>åˆ†å‰²è§£æï¼š\n<ul>\n<li>ç¬¬ä¸€æ¬¡ <code>read</code>  æ”¶åˆ° <code>åŒ…1</code> ï¼Œåˆ†å‰²åå¾—åˆ° <code>data: &#123;&quot;con</code> ï¼Œè§£æä¼šæŠ¥é”™</li>\n<li>ç¬¬äºŒæ¬¡ <code>read</code>  æ”¶åˆ° <code>åŒ…2</code> ï¼Œåˆ†å‰²åå¾—åˆ° <code>å¥½&quot;&#125;</code> ï¼Œè§£æä¼šæŠ¥é”™</li>\n</ul>\n</li>\n</ol>\n<p>ç»“æœå°±æ˜¯æ•°æ®ä¸¢å¤±æˆ–è§£æé”™è¯¯ã€‚æœ¬åœ°ä¸»è¦æ˜¯å› ä¸ºå»¶è¿Ÿä½ã€é€Ÿåº¦å—ï¼ŒNode.js çš„ç½‘ç»œå±‚ä¼˜åŒ–ï¼ˆå¦‚ Nagle ç®—æ³•ï¼‰å¸¸å¸¸ä¼šæŠŠå¤šæ¬¡å°çš„ write åˆå¹¶æˆä¸€ä¸ªå¤§çš„ TCP åŒ…å†å‘é€ï¼Œæ©ç›–äº†è¿™ä¸ªé—®é¢˜</p>\n<hr />\n<h1 id=\"ç¬¬å››æ­¥ç¨³å¥ä¹‹æ³•-å®ç°å®¢æˆ·ç«¯ç¼“å†²åŒº\"><a class=\"anchor\" href=\"#ç¬¬å››æ­¥ç¨³å¥ä¹‹æ³•-å®ç°å®¢æˆ·ç«¯ç¼“å†²åŒº\">#</a> ç¬¬å››æ­¥ï¼šç¨³å¥ä¹‹æ³• - å®ç°å®¢æˆ·ç«¯ç¼“å†²åŒº</h1>\n<p>ä¸ºäº†è§£å†³æ¶ˆæ¯ç¢ç‰‡é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å®¢æˆ·ç«¯å®ç°ä¸€ä¸ªç¼“å†²åŒºã€‚å®ƒçš„å·¥ä½œåŸç†å°±åƒä¸€ä¸ªè“„æ°´æ± </p>\n<ol>\n<li>è“„æ°´ï¼šå°†æ¯æ¬¡ <code>reader.read()</code>  åˆ°çš„å­—èŠ‚æ•°æ®æš‚å­˜åˆ°ç¼“å†²åŒº</li>\n<li>å¤„ç†ï¼šå½“ç¼“å†²åŒºç§¯ç´¯åˆ°è¶³å¤Ÿå¤šçš„æ•°æ®ï¼ˆå¦‚ <code>\\n\\n</code> ï¼‰æ—¶ï¼Œè¿›è¡Œè§£æå’Œå¤„ç†</li>\n<li>æ”¾æ°´ï¼šå¦‚æœæ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œå°±ä»ç¼“å†²åŒºä¸­æå–å‡ºä¸€æ¡å®Œæ•´çš„ä¿¡æ¯è¿›è¡Œå¤„ç†</li>\n<li>æ¸…ç†ï¼šå°†å·²ç»å¤„ç†è¿‡çš„æ¶ˆæ¯ä»ç¼“å†²åŒºå¤´éƒ¨ç§»é™¤</li>\n<li>å¾ªç¯ï¼šé‡å¤ä»¥ä¸Šæ­¥éª¤<br />\n <code>test.js</code>  - ç¨³å¥ç‰ˆæœ¬</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAIStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">//... (fetch å’Œ reader åˆå§‹åŒ–) ...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">let</span> buffer <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// &lt;-- å…³é”®çš„ç¼“å†²åŒº</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// å°†æ–°æ•°æ®å—è§£ç å¹¶è¿½åŠ åˆ°ç¼“å†²åŒº</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    buffer <span class=\"token operator\">+=</span> decoder<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">stream</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æµç»“æŸæ—¶ï¼Œæœ€åå¤„ç†ä¸€æ¬¡ç¼“å†²åŒº</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¯æ¬¡æ”¶åˆ°æ•°æ®éƒ½å°è¯•å¤„ç†</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// å°†æ¶ˆæ¯å¤„ç†é€»è¾‘æå–æˆä¸€ä¸ªå‡½æ•°</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">function</span> <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">let</span> boundaryIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// å¾ªç¯å¤„ç†ç¼“å†²åŒºä¸­æ‰€æœ‰å®Œæ•´çš„æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>boundaryIndex <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token comment\">// æå–ä¸€æ¡å®Œæ•´çš„æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> boundaryIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token comment\">// ä»ç¼“å†²åŒºç§»é™¤å·²å¤„ç†çš„æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      buffer <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span>boundaryIndex <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">const</span> json <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ— æ³•è§£æçš„ JSON:\"</span><span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"ç¬¬äº”æ­¥éªŒè¯\"><a class=\"anchor\" href=\"#ç¬¬äº”æ­¥éªŒè¯\">#</a> ç¬¬äº”æ­¥ï¼šéªŒè¯</h1>\n<p>ä¿®æ”¹æœåŠ¡å™¨ï¼Œè®©å®ƒæ•…æ„å°†ä¸€æ¡æ¶ˆæ¯æ‹†å¼€å‘é€<br />\n <code>server.js</code>  - ç ´åæ€§æµ‹è¯•</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"--- å¼€å§‹ç ´åæ€§æµ‹è¯• ---\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"å‘é€ä¸å®Œæ•´çš„æ¶ˆæ¯çš„ç¬¬ä¸€éƒ¨åˆ†...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 1. å‘é€ä¸€æ¡ SSE æ¶ˆæ¯çš„å‰åŠéƒ¨åˆ†ï¼Œæ³¨æ„æœ«å°¾æ²¡æœ‰ `\\n\\n`</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data: &#123;\"content\":\"This is a very long message that will be broken'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 2. ç­‰å¾… 50 æ¯«ç§’</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"50ms åï¼Œå‘é€æ¶ˆæ¯çš„å‰©ä½™éƒ¨åˆ†...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token string\">' in the middle.\"&#125;\\n\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"--- æµ‹è¯•ç»“æŸ ---\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸ªå’Œå¤©çœŸçš„ç‰ˆæœ¬å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç¨³å¥ç‰ˆæœ¬èƒ½å¤Ÿæ­£ç¡®å¤„ç†æ¶ˆæ¯ç¢ç‰‡ï¼Œè€Œå¤©çœŸç‰ˆæœ¬åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šä¸¢å¤±æ•°æ®</p>\n<h1 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<ol>\n<li>ä½¿ç”¨åŸç”Ÿæ¨¡å—æ—¶ï¼Œä¸èƒ½æƒ³å½“ç„¶çš„è®¤ä¸ºæ¡†æ¶æä¾›çš„ä¾¿åˆ©åŠŸèƒ½æ—¶ç†æ‰€åº”å½“å­˜åœ¨çš„</li>\n<li>åœ¨å¤„ç†ä»»ä½•åŸºäºæµçš„åè®®æ—¶ï¼Œå®¢æˆ·ç«¯ç¼“å†²åŒºæ—¶ä¿è¯æ•°æ®å®Œæ•´æ€§çš„å…³é”®</li>\n<li>æµå¯ä»¥è®©æˆ‘ä»¬ä»¥å¢é‡çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æ¥æ”¶æ‰€æœ‰æ•°æ®</li>\n</ol>\n<h1 id=\"æºç \"><a class=\"anchor\" href=\"#æºç \">#</a> æºç </h1>\n<p><code>server.js</code></p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> http <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> dotenv <span class=\"token keyword\">from</span> <span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> OpenAI <span class=\"token keyword\">from</span> <span class=\"token string\">'openai'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>dotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// é…ç½® AI å®¢æˆ·ç«¯</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> openai <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OpenAI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// æ›¿æ¢</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token literal-property property\">apiKey</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ARK_API_KEY</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token literal-property property\">baseURL</span><span class=\"token operator\">:</span> <span class=\"token string\">'https://ark.cn-beijing.volces.com/api/v3'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> hostname <span class=\"token operator\">=</span> <span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">5173</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestBody</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">let</span> body <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">chunk</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      body <span class=\"token operator\">+=</span> chunk<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Buffer è½¬å­—ç¬¦ä¸²</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>body <span class=\"token operator\">||</span> <span class=\"token string\">'&#123;&#125;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid JSON in request body'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/event-stream'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SSE æ ‡å‡†ç±»å‹</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token string-property property\">'Cache-Control'</span><span class=\"token operator\">:</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token string-property property\">'Connection'</span><span class=\"token operator\">:</span> <span class=\"token string\">'keep-alive'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getRequestBody</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">const</span> userPrompt <span class=\"token operator\">=</span> body<span class=\"token punctuation\">.</span>prompt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">æ”¶åˆ° Prompt: \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>userPrompt<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ­£åœ¨å‘ AI è¯·æ±‚æµå¼å“åº”...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> openai<span class=\"token punctuation\">.</span>chat<span class=\"token punctuation\">.</span>completions<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token literal-property property\">model</span><span class=\"token operator\">:</span> <span class=\"token string\">'ep-m-20251118124237-7zths'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token literal-property property\">messages</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">role</span><span class=\"token operator\">:</span> <span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> userPrompt <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token literal-property property\">stream</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AI æµå·²å¼€å§‹ï¼Œæ­£åœ¨è½¬å‘ç»™å®¢æˆ·ç«¯...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> chunk <span class=\"token keyword\">of</span> stream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> chunk<span class=\"token punctuation\">.</span>choices<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>delta<span class=\"token operator\">?.</span>content <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token comment\">// å°†æ¯ä¸ªæ•°æ®å—æŒ‰ SSE æ ¼å¼å†™å…¥å“åº”æµ</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">å‘é€å†…å®¹å—: \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>content<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">data: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> content <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\\n\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AI æµç»“æŸã€‚\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\">//console.log (\"--- å¼€å§‹ç ´åæ€§æµ‹è¯• ---\");</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\">//console.log (\"å‘é€ä¸å®Œæ•´çš„æ¶ˆæ¯çš„ç¬¬ä¸€éƒ¨åˆ†...\");</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\">//// 1. å‘é€ä¸€æ¡ SSE æ¶ˆæ¯çš„å‰åŠéƒ¨åˆ†ï¼Œæ³¨æ„æœ«å°¾æ²¡æœ‰ `\\n\\n`</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">// res.write('data: &#123;\"content\":\"This is a very long message that will be broken');</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">//// 2. ç­‰å¾… 50 æ¯«ç§’</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">// await new Promise((resolve) => &#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token comment\">//   setTimeout(() => &#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token comment\">//     console.log (\"50ms åï¼Œå‘é€æ¶ˆæ¯çš„å‰©ä½™éƒ¨åˆ†...\");</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token comment\">//     res.write(' in the middle.\"&#125;\\n\\n');</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token comment\">//     // End the response *inside* the timeout callback</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token comment\">//     res.end(); </span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token comment\">//     console.log (\"--- æµ‹è¯•ç»“æŸ ---\");</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token comment\">//     resolve(); // Signal that the async operation is complete</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">//   &#125;, 50);</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">// &#125;);</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"å¤„ç†è¯·æ±‚æ—¶å‡ºé”™:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>headersSent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è°ƒç”¨ AI æœåŠ¡æ—¶å‘ç”Ÿé”™è¯¯ã€‚'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>writableEnded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>server<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span> hostname<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">AI æœåŠ¡å™¨æ­£åœ¨è¿è¡Œäº http://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>hostname<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>port<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨ã€‚'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><code>test.js</code></p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAIStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ­£åœ¨è¿æ¥åˆ° AI æœåŠ¡å™¨...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:5173/chat\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">prompt</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ä½ å¥½\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">getReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">const</span> decoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">let</span> fullText <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">let</span> buffer <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç¼“å†²åŒº</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"è¿æ¥æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶æ•°æ®æµ...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>value<span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¤„ç†æµç»“æŸåç¼“å†²åŒºä¸­çš„ä¸å®Œæ•´æ–‡æœ¬:'</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n--- æ•°æ®æµç»“æŸ ---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    buffer <span class=\"token operator\">+=</span> decoder<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">stream</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// å°†æ¶ˆæ¯å¤„ç†é€»è¾‘æå–åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ä¸­ï¼Œä»¥ä¾¿å¤ç”¨</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">function</span> <span class=\"token function\">processBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">let</span> boundaryIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>boundaryIndex <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> boundaryIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      buffer <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>boundaryIndex <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">const</span> json <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            fullText <span class=\"token operator\">+=</span> content<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">æ”¶åˆ°ç‰‡æ®µ: \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>content<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ— æ³•è§£æçš„ JSON æ•°æ®:'</span><span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nå®Œæ•´å“åº”:\"</span><span class=\"token punctuation\">,</span> fullText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token function\">getAIStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"è¡¥å……\"><a class=\"anchor\" href=\"#è¡¥å……\">#</a> è¡¥å……</h1>\n<p>æˆ‘ä»¬æ‰‹åŠ¨çš„æ­ç¤ºäº†åº•å±‚çš„ç»†èŠ‚ï¼Œä½†åœ¨çœŸæ­£çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œä½¿ç”¨ç¤¾åŒºæ²‰æ·€çš„æœ€ä½³å®è·µå’Œå·¥å…·åº“æ¥ç®€åŒ–ä»£ç ã€æé«˜å¥å£®æ€§</p>\n<ol>\n<li>åç«¯ï¼šä½¿ç”¨ <code>express.js</code>  ç®€åŒ–æœåŠ¡å™¨çš„å¼€å‘</li>\n<li>å‰ç«¯ï¼šä½¿ç”¨ <code>@microsoft/fetch-event-source</code>  æ›¿ä»£æˆ‘ä»¬è‡ªå·±æ‰‹å†™çš„ <code>buffer</code>  å¤„ç†é€»è¾‘\n<ul>\n<li>API å…¼å®¹ï¼šä¸ <code>fetch</code>  ç±»ä¼¼</li>\n<li>è‡ªåŠ¨è§£æï¼šå†…ç½®äº† SSE è§£æé€»è¾‘ï¼Œä¸å†å…³ç³» <code>buffer</code> ã€ç­‰å‰ç¼€å¤„ç†</li>\n<li>é”™è¯¯å¤„ç†å’Œé‡è¯•ï¼šæä¾›æ›´å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸé’©å­</li>\n<li>å¥å£®æ€§</li>\n</ul>\n</li>\n</ol>\n",
            "tags": [
                "node.js",
                "node.js",
                "AI"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BB%A5%E4%B8%80%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8%E7%BB%84%E4%BB%B6%E5%BC%80%E5%90%AF-web-component/",
            "url": "https://aynya.github.io/%E4%BB%A5%E4%B8%80%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8%E7%BB%84%E4%BB%B6%E5%BC%80%E5%90%AF-web-component/",
            "title": "ä»¥ä¸€ä¸ªè®¡æ•°å™¨ç»„ä»¶å¼€å¯ web component",
            "date_published": "2025-11-28T08:42:31.000Z",
            "content_html": "<p>æœ¬æ–‡ä¹Ÿæ˜¯åœ¨é˜…è¯»çº¢å®ä¹¦ä¸­äº†è§£åˆ°äº† web componentï¼Œæ–‡ä¸­æåŠçš„ lit-html å†ä¸Šç¯‡æ–‡ç« ä¸­å·²ç»æåŠè¿‡</p>\n<p>web components æä¾›äº†ä¸€ä¸ªå®˜æ–¹çš„ã€åŸç”Ÿçš„è§£å†³æ–¹æ¡ˆã€‚å®ƒä¸æ˜¯ä¸€ä¸ªåº“ï¼Œè€Œæ˜¯ä¸€å¥—æµè§ˆå™¨å†…ç½®çš„æ ‡å‡†ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåˆ›å»ºç‹¬ç«‹ã€å¯å¤ç”¨ã€ä¸”ä¸å—ä»»ä½•æ¡†æ¶é™åˆ¶çš„ UI ç»„ä»¶</p>\n<hr />\n<p><strong>ç›®æ ‡ï¼šæ„å»ºå…·å¤‡ä»¥ä¸‹åŠŸèƒ½çš„ <code>my-counter</code> </strong></p>\n<ul>\n<li>å¯å¤ç”¨ï¼šä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾</li>\n<li>æ ·å¼éš”ç¦»ï¼šä½¿ç”¨ Shadow DOM</li>\n<li>é«˜æ€§èƒ½ï¼šä½¿ç”¨ <code>lit-html</code>  é«˜æ•ˆæ›´æ–° UI</li>\n<li>å¯é…ç½®ï¼šé€šè¿‡å±æ€§è‡ªå®šä¹‰åˆå§‹å€¼ã€æ­¥é•¿ç­‰</li>\n</ul>\n<hr />\n<h1 id=\"part-1web-component-çš„ä¸‰å¤§æ”¯æŸ±\"><a class=\"anchor\" href=\"#part-1web-component-çš„ä¸‰å¤§æ”¯æŸ±\">#</a> Part 1ï¼šWeb Component çš„ä¸‰å¤§æ”¯æŸ±</h1>\n<h2 id=\"step-1æ­å»ºéª¨æ¶-custom-elementsè‡ªå®šä¹‰å…ƒç´ \"><a class=\"anchor\" href=\"#step-1æ­å»ºéª¨æ¶-custom-elementsè‡ªå®šä¹‰å…ƒç´ \">#</a> Step 1ï¼šæ­å»ºéª¨æ¶ --Custom Elementsï¼ˆè‡ªå®šä¹‰å…ƒç´ ï¼‰</h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HTMLElement</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¿…é¡»è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// å½“å…ƒç´ è¢«æ’å…¥åˆ° DOM æ–‡æ¡£æµæ—¶è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">connectedCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// åŸºç¡€æ¸²æŸ“ï¼šå†…å®¹ä¼šå’Œé¡µé¢çš„å…¨å±€æ ·å¼æ··åœ¨ä¸€èµ·</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;p>æˆ‘æ˜¯ä¸€ä¸ªè®¡æ•°å™¨&lt;/p>'</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// æ³¨å†Œç»„ä»¶ï¼Œæ ‡ç­¾åå¿…é¡»åŒ…å«è¿å­—ç¬¦</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>customElements<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-counter'</span><span class=\"token punctuation\">,</span> MyCounter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>é€šè¿‡ç»§æ‰¿ <code>HTMLElement</code>  èµ‹äºˆç»„ä»¶ç”Ÿå‘½åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«æµè§ˆå™¨è¯†åˆ«å’Œç®¡ç†</li>\n<li>é€šè¿‡ <code>connectedCallback</code>  æ–¹æ³•ï¼Œåœ¨å…ƒç´ æ’å…¥ DOM æ–‡æ¡£æµæ—¶è¿›è¡Œåˆå§‹åŒ–æ¸²æŸ“</li>\n<li>è¿™é‡Œçš„ <code>this</code>  æŒ‡å‘å½“å‰å®ä¾‹åŒ–çš„ç»„ä»¶å¯¹è±¡ï¼Œå³ <code>my-counter</code>  å…ƒç´ </li>\n<li>é€šè¿‡ <code>customElements.define</code>  æ–¹æ³•ï¼Œå°†ç»„ä»¶æ³¨å†Œåˆ°æµè§ˆå™¨ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè‡ªå®šä¹‰æ ‡ç­¾åï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç»„ä»¶ç±»å</li>\n</ol>\n<h2 id=\"step-2éš”ç¦»ä¿æŠ¤-shadow-domå½±å­-dom\"><a class=\"anchor\" href=\"#step-2éš”ç¦»ä¿æŠ¤-shadow-domå½±å­-dom\">#</a> Step 2ï¼šéš”ç¦»ä¿æŠ¤ --Shadow DOMï¼ˆå½±å­ DOMï¼‰</h2>\n<p>ä¸ºäº†è§£å†³æ ·å¼å†²çªï¼Œæˆ‘ä»¬ä¸ºç»„ä»¶åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ã€å°è£…çš„ DOM æ ‘</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HTMLElement</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 1. å¼€å¯å½±å­ DOM æ¨¡å¼</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachShadow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">'open'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">connectedCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 2. æŠŠå†…å®¹å’Œå†…éƒ¨æ ·å¼å†™è¿› shadowRoot</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>shadowRoot<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      &lt;style> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        p &#123; </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          color: blue; /* ä»…åœ¨ç»„ä»¶å†…éƒ¨ç”Ÿæ•ˆ */</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          font-weight: bold;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        &#125; </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      &lt;/style> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      &lt;p>æˆ‘æ˜¯è¢«ä¿æŠ¤çš„è®¡æ•°å™¨&lt;/p></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>customElements<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-counter'</span><span class=\"token punctuation\">,</span> MyCounter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>é€šè¿‡ <code>attachShadow</code>  æ–¹æ³•å¼€å¯å½±å­ DOM æ¨¡å¼ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé…ç½®å¯¹è±¡ï¼Œ <code>mode</code>  ä¸º <code>open</code>  è¡¨ç¤ºå…è®¸å¤–éƒ¨è®¿é—®ï¼Œ <code>closed</code>  è¡¨ç¤ºä¸å…è®¸å¤–éƒ¨è®¿é—®</li>\n<li>é€šè¿‡ <code>shadowRoot</code>  å±æ€§è®¿é—®å½±å­ DOM æ ‘ï¼Œå°†å†…å®¹å’Œå†…éƒ¨æ ·å¼å†™è¿›å®ƒ</li>\n</ol>\n<h1 id=\"part-2æ€§èƒ½ä¸å“åº”å¼lit-html\"><a class=\"anchor\" href=\"#part-2æ€§èƒ½ä¸å“åº”å¼lit-html\">#</a> Part 2ï¼šæ€§èƒ½ä¸å“åº”å¼ï¼ˆlit-htmlï¼‰</h1>\n<h2 id=\"step-3å¼•å…¥ç¥å™¨-lit-html\"><a class=\"anchor\" href=\"#step-3å¼•å…¥ç¥å™¨-lit-html\">#</a> Step 3ï¼šå¼•å…¥ç¥å™¨ --lit-html</h2>\n<p>è¿™ä¸ªæ—¶å€™å‘ç°ï¼Œæ¯æ¬¡åˆ›å»ºæ ‡ç­¾æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>connectedCallback</code>  æ–¹æ³•ï¼Œå¯¼è‡´é‡å¤æ¸²æŸ“<br />\næœ€å¼€å§‹çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†æ¨¡æ¿å†™åœ¨ HTML æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>document.getElementById</code>  æ–¹æ³•è·å–ï¼Œç„¶åå…‹éš†åˆ° <code>shadowRoot</code>  ä¸­</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>template</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>my-counter-template<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">&lt;!-- åŸºç¡€æ¨¡æ¿ --></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>template</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·åˆä¸æ»¡è¶³é«˜å†…èšä½è€¦åˆçš„åŸåˆ™ï¼Œå› ä¸ºæ¨¡æ¿å’Œç»„ä»¶çš„ä»£ç éƒ½å†™åœ¨ HTML æ–‡ä»¶ä¸­</p>\n<p>å› æ­¤æˆ‘ä»¬å°±ä½¿ç”¨ <code>lit-html</code>  åº“ï¼Œå°†æ¨¡æ¿å†™åœ¨ JavaScript æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>html</code>  å‡½æ•°æ¸²æŸ“åˆ° <code>shadowRoot</code>  ä¸­ï¼Œæ—¢æ»¡è¶³é«˜å†…èšä½è€¦åˆçš„åŸåˆ™ï¼Œåˆèƒ½å¤Ÿå®ç°é«˜æ•ˆæ›´æ–° UI</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> html<span class=\"token punctuation\">,</span> render <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'https://unpkg.com/lit-html@^2.0.0/lit-html.js'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HTMLElement</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachShadow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">'open'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 1. å®šä¹‰å¢åŠ çš„æ–¹æ³• (ä½¿ç”¨ç®­å¤´å‡½æ•°é”å®š this)ï¼Œæ³¨æ„ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function-variable function\">_increment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ•°æ®å˜äº†ï¼Œè¯·æ±‚æ›´æ–°ç•Œé¢</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// 2. å®šä¹‰æ¨¡æ¿ (View)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">get</span> <span class=\"token function\">template</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> html<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      &lt;style></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        button &#123; cursor: pointer; padding: 5px 10px; &#125;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      &lt;/style></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      &lt;div>å½“å‰è®¡æ•°: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/div></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      &lt;button @click=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_increment<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">>+1&lt;/button></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// 3. æ ¸å¿ƒæ¸²æŸ“æ–¹æ³•</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>template<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>shadowRoot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token function\">connectedCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// é¦–æ¬¡æŒ‚è½½æ—¶æ¸²æŸ“ä¸€æ¬¡</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>customElements<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-counter'</span><span class=\"token punctuation\">,</span> MyCounter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>é€šè¿‡ <code>html</code>  å‡½æ•°å®šä¹‰æ¨¡æ¿ï¼Œä½¿ç”¨  <code>$&#123;&#125;</code>  æ’å€¼è¡¨è¾¾å¼æ’å…¥åŠ¨æ€æ•°æ®</li>\n<li>é€šè¿‡ <code>render</code>  å‡½æ•°å°†æ¨¡æ¿æ¸²æŸ“åˆ° <code>shadowRoot</code>  ä¸­ï¼Œrender çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ¨¡æ¿ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç›®æ ‡ DOM èŠ‚ç‚¹</li>\n<li>é€šè¿‡ <code>connectedCallback</code>  æ–¹æ³•ï¼Œåœ¨å…ƒç´ æ’å…¥ DOM æ–‡æ¡£æµæ—¶è¿›è¡Œåˆå§‹åŒ–æ¸²æŸ“</li>\n</ol>\n<h2 id=\"step-4æ‰“é€šå†…å¤–-å“åº”-html-å±æ€§å˜åŒ–\"><a class=\"anchor\" href=\"#step-4æ‰“é€šå†…å¤–-å“åº”-html-å±æ€§å˜åŒ–\">#</a> Step 4ï¼šæ‰“é€šå†…å¤– -- å“åº” HTML å±æ€§å˜åŒ–</h2>\n<p>ä¸ºäº†è®©ç»„ä»¶å¯é…ç½®ï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬å¤–éƒ¨çš„ HTML å±æ€§ï¼ˆ <code>initial-count</code> ï¼‰çš„å˜åŒ–</p>\n<ol>\n<li>é€šè¿‡ <code>static get observedAttributes() &#123; return [...] &#125;</code>  å‘ŠçŸ¥æµè§ˆå™¨åªç›‘å¬ç‰¹å®šçš„å±æ€§</li>\n<li>é€šè¿‡ <code>attributeChangedCallback(name, oldVal, newVal)</code>  æ–¹æ³•ï¼Œåœ¨å±æ€§å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°ç»„ä»¶çŠ¶æ€</li>\n</ol>\n<h1 id=\"å®Œæ•´ä»£ç \"><a class=\"anchor\" href=\"#å®Œæ•´ä»£ç \">#</a> å®Œæ•´ä»£ç </h1>\n<h2 id=\"testjs\"><a class=\"anchor\" href=\"#testjs\">#</a> test.js</h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> html<span class=\"token punctuation\">,</span> render <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'https://unpkg.com/lit-html@^2.0.0/lit-html.js'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyCounter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HTMLElement</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">static</span> <span class=\"token keyword\">get</span> <span class=\"token function\">observedAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ç›‘å¬ initial-count å±æ€§å˜åŒ–</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'initial-count'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»º Shadow DOM</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachShadow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">'open'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token function\">attributeChangedCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> oldVal<span class=\"token punctuation\">,</span> newVal</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'initial-count'</span> <span class=\"token operator\">&amp;&amp;</span> oldVal <span class=\"token operator\">!==</span> newVal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token comment\">// å½“ initial-count å±æ€§å˜åŒ–æ—¶ï¼Œæ›´æ–°ç»„ä»¶çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>newVal<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token function\">connectedCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// é¦–æ¬¡æŒ‚è½½æ—¶æ¸²æŸ“ä¸€æ¬¡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token function-variable function\">_increment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// ç‚¹å‡» +1 æŒ‰é’®æ—¶ï¼Œå¢åŠ è®¡æ•°å¹¶æ›´æ–° initial-count å±æ€§</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count <span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// åŒæ­¥æ›´æ–° initial-count å±æ€§</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'initial-count'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">get</span> <span class=\"token function\">template</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// å®šä¹‰æ¨¡æ¿ (View)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">return</span> html<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          &lt;style></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            /* :host ä»£è¡¨ç»„ä»¶æœ¬èº« */</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            :host &#123;</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              display: block;</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              font-family: sans-serif;</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              margin-bottom: 20px;</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            &#125;</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            .container &#123;</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              padding: 20px;</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>              background-color: #f0f0f0;</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>              border-radius: 8px;</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              text-align: center;</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            &#125;</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            button &#123;</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              padding: 8px 16px;</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              font-size: 16px;</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>              cursor: pointer;</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              background-color: #007bff;</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              color: white;</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>              border: none;</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>              border-radius: 4px;</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            &#125;</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            button:hover &#123;</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>              background-color: #0056b3;</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            &#125;</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          &lt;/style></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          &lt;div class=\"container\"></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            &lt;h2>Lit è®¡æ•°å™¨&lt;/h2></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            &lt;p>Count: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>count<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/p></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            &lt;button @click=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_increment<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">>+ Plus&lt;/button></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          &lt;/div></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">// æ ¸å¿ƒæ¸²æŸ“æ–¹æ³•</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>template<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>shadowRoot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token comment\">// å®šä¹‰è‡ªå®šä¹‰å…ƒç´  my-counter</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>customElements<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-counter'</span><span class=\"token punctuation\">,</span> MyCounter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"testhtml\"><a class=\"anchor\" href=\"#testhtml\">#</a> test.html</h2>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Document<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./test.js<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>module<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>my-counter</span> <span class=\"token attr-name\">initial-count</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>my-counter</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h1 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<ol>\n<li><strong>Custom Elements</strong>ï¼šè§£å†³äº† HTML æ ‡ç­¾è¯­ä¹‰åŒ–å’Œå¤ç”¨é—®é¢˜</li>\n<li><strong>Shadow DOM</strong>ï¼šè§£å†³äº† CSS å’Œ DOM çš„<strong>å°è£…å’Œéš”ç¦»</strong>é—®é¢˜</li>\n<li><strong>lit-HTML</strong>ï¼šè§£å†³äº†åŸç”Ÿ DOM æ“ä½œ<strong>æ€§èƒ½ä½ä¸‹</strong>å’Œ<strong>ç¹ç</strong>é—®é¢˜</li>\n<li><strong>Attribute Observation</strong>ï¼šè§£å†³äº†ç»„ä»¶ä¸å¤–éƒ¨ä¸–ç•Œè¿›è¡Œ<strong>æ•°æ®é€šä¿¡</strong>å’Œ<strong>åˆå§‹åŒ–</strong>çš„é—®é¢˜</li>\n</ol>\n",
            "tags": [
                "JavaScript",
                "web component"
            ]
        },
        {
            "id": "https://aynya.github.io/%E5%88%9D%E9%81%87-lit-html/",
            "url": "https://aynya.github.io/%E5%88%9D%E9%81%87-lit-html/",
            "title": "åˆé‡ lit-html",
            "date_published": "2025-11-28T08:04:31.000Z",
            "content_html": "<p>æœ¬æ–‡ä¸»è¦ç®€å•èŠèŠ <code>lit-html</code>  çš„æ ¸å¿ƒåŸç†</p>\n<hr />\n<p>åœ¨ä¹‹å‰ï¼Œæˆ‘äº†è§£åˆ°çš„åªæœ‰ React çš„è™šæ‹Ÿ domã€‚<br />\n&quot;æ¯æ¬¡æ¸²æŸ“ç”Ÿæˆæ–°æ ‘ -&gt; å¯¹æ¯”ä¸¤æ£µæ ‘ -&gt; æ‰¾å‡ºå·®å¼‚ -&gt; æ›´æ–°çœŸå® dom&quot;</p>\n<p>ä½†æ˜¯ï¼Œ <code>lit-html</code>  èµ°äº†ä¸€æ¡å®Œå…¨ä¸åŒçš„è·¯ã€‚æ²¡æœ‰è™šæ‹Ÿ domï¼Œä¸è¿›è¡Œå¤æ‚çš„æ ‘å¯¹æ¯”ï¼Œå´èƒ½å¤Ÿå®ç°æé«˜çš„æ€§èƒ½</p>\n<hr />\n<h1 id=\"æ ¸å¿ƒä¸€es6çš„-æ ‡ç­¾æ¨¡æ¿å­—é¢é‡\"><a class=\"anchor\" href=\"#æ ¸å¿ƒä¸€es6çš„-æ ‡ç­¾æ¨¡æ¿å­—é¢é‡\">#</a> æ ¸å¿ƒä¸€ï¼šES6 çš„ -- æ ‡ç­¾æ¨¡æ¿å­—é¢é‡</h1>\n<p>ES6 çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œæ ‡ç­¾æ¨¡æ¿å­—é¢é‡ã€‚<br />\nå½“å†™å‡ºå¦‚ä¸‹ä»£ç æ—¶</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token string\">\"ay\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>html<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;h1>Hello, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/h1></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>html</code>  å…¶å®æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æµè§ˆå™¨åœ¨å¤„ç†è¿™æ®µä»£ç æ—¶ï¼Œä¼šæŠŠæ¨¡æ¿æ‹†è§£æˆä¸¤éƒ¨åˆ†ä¼ ç»™è¿™ä¸ªå‡½æ•°</p>\n<ol>\n<li>Stringsï¼š <code>[&quot;&lt;h1&gt;Hello, &quot;, &quot;&lt;/h1&gt;&quot;]</code> ;</li>\n<li>Valuesï¼š <code>[&quot;ay&quot;]</code> ;</li>\n</ol>\n<p>å…³é”®ï¼šæ— è®ºè¿™ä¸ªç»„ä»¶é‡æ–°æ¸²æŸ“å¤šå°‘æ¬¡ï¼Œ<strong>é™æ€å­—ç¬¦ä¸²æ•°ç»„åœ¨å†…å­˜ä¸­æ—¶åŒä¸€ä¸ªå¼•ç”¨ï¼Œæ°¸è¿œä¸å˜</strong></p>\n<p>lit-html åŒºåˆ†å‡ºäº†é™æ€å­—ç¬¦ä¸²å’ŒåŠ¨æ€æ•°æ®ï¼Œåªå¤„ç†åè€…</p>\n<h1 id=\"æ ¸å¿ƒäºŒåŸç”Ÿtemplateå…ƒç´ \"><a class=\"anchor\" href=\"#æ ¸å¿ƒäºŒåŸç”Ÿtemplateå…ƒç´ \">#</a> æ ¸å¿ƒäºŒï¼šåŸç”Ÿ <code>&lt;template&gt;</code>  å…ƒç´ </h1>\n<p>æœ‰äº†é™æ€å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥ç”¨åŸç”Ÿçš„ <code>&lt;template&gt;</code>  å…ƒç´ æ¥å­˜å‚¨è¿™äº›å­—ç¬¦ä¸²<br />\n <code>&lt;template&gt;</code>  æ˜¯ HTML æ ‡å‡†ä¸­çš„ä¸€ä¸ªç‰¹æ®Šæ ‡ç­¾ã€‚å®ƒé‡Œé¢çš„å†…å®¹ä¼šè¢«æµè§ˆå™¨è§£æï¼Œä½†ä¸ä¼š<strong>æ¸²æŸ“</strong>ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œ<strong>è„šæœ¬</strong>ã€‚å°±ç±»ä¼¼äºä¸€ä¸ªæ¨¡æ¿</p>\n<h2 id=\"ç¬¬ä¸€æ¬¡æ¸²æŸ“æµç¨‹\"><a class=\"anchor\" href=\"#ç¬¬ä¸€æ¬¡æ¸²æŸ“æµç¨‹\">#</a> ç¬¬ä¸€æ¬¡æ¸²æŸ“æµç¨‹</h2>\n<p>å‡è®¾æœ‰å¦‚ä¸‹ä»£ç </p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">renderTemplate</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> html<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;div>Count: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>count<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/div></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>render</code>  æ—¶ï¼Œlit-html ä¼šåšå¦‚ä¸‹å‡ æ­¥</p>\n<ol>\n<li>é¢„å¤„ç†ä¸å ä½<br />\n lit-html æ‹¿åˆ°é™æ€å­—ç¬¦ä¸²ï¼Œä»–ä¼šæŠŠå˜é‡çš„ä½ç½®ç”¨ä¸€ä¸ª<strong>ç‰¹æ®Šçš„å ä½ç¬¦</strong>å¡«ä¸Š<br />\nç”Ÿæˆçš„æ¨¡æ¿ä¸º<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>template</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>Count: <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>template</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure></li>\n<li>ç¼“å­˜<br />\n lit-html ä¼šç”¨é‚£ä¸ªé™æ€å­—ç¬¦ä¸²æ•°ç»„ä½œä¸º keyï¼Œç¼“å­˜è¿™ä¸ª <code>&lt;template&gt;</code>  å…ƒç´ <br />\nä¸‹æ¬¡æ¸²æŸ“æ—¶å°±ä¸éœ€è¦è§£æ HTML å­—ç¬¦ä¸²äº†</li>\n<li>å…‹éš†ä¸å¯»å€<br />\nç°åœ¨è¦æ˜¾ç¤ºå†…å®¹ã€‚lit-html ä¼šæŠŠ <code>&lt;template&gt;</code>  çš„å†…å®¹<strong>å…‹éš†</strong>ä¸€ä»½ï¼Œç„¶åé€šè¿‡ <code>TreeWalker</code>  æ¥éå†è¿™ä¸ªå…‹éš†åçš„ DOM æ ‘ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„å ä½ç¬¦</li>\n<li>åˆ›å»º Parts<br />\n å½“æ‰¾åˆ°å ä½ç¬¦æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª <code>Part</code>  å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‰‹é‡Œæ‹¿ç€å¯¹è¿™ä¸ªå…·ä½“ DOM èŠ‚ç‚¹çš„ç›´æ¥å¼•ç”¨<br />\næ­¤æ—¶ï¼Œä»–å°±ä¸éœ€è¦å» DOM æ ‘ä¸­æ‰¾èŠ‚ç‚¹ï¼Œ <code>Part</code>  å¯¹è±¡å°±ç›´è¾¾èŠ‚ç‚¹</li>\n</ol>\n<h1 id=\"æ ¸å¿ƒä¸‰ç²¾ç¡®æ›´æ–°\"><a class=\"anchor\" href=\"#æ ¸å¿ƒä¸‰ç²¾ç¡®æ›´æ–°\">#</a> æ ¸å¿ƒä¸‰ï¼šç²¾ç¡®æ›´æ–°</h1>\n<p>å½“çŠ¶æ€æ”¹å˜ï¼Œ <code>count</code>  å˜æˆ 1ï¼Œå†æ¬¡è°ƒç”¨ <code>render</code></p>\n<ol>\n<li>è¯†åˆ«ï¼š <code>html</code>  å‡½æ•°è¿è¡Œï¼Œæ£€æŸ¥é™æ€å­—ç¬¦ä¸²æ•°ç»„æ˜¯å¦å˜åŒ–</li>\n<li>è·³è¿‡ï¼šå®Œå…¨è·³è¿‡ HTML è§£æã€DOM åˆ›å»ºã€DOM éå†</li>\n<li>å¯¹æ¯”æ•°æ®</li>\n<li>ç›´è¾¾æ›´æ–°ï¼šæ‰¾åˆ°è¿™ä¸ªä½ç½®çš„ <code>Part</code>  å¯¹è±¡ï¼Œç›´æ¥æ›´æ–°èŠ‚ç‚¹çš„å†…å®¹</li>\n</ol>\n<h1 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<ol>\n<li>å®ƒåˆ©ç”¨ ES6 æ¨¡æ¿å­—ç¬¦ä¸² æ¥åŒºåˆ†é™æ€å’ŒåŠ¨æ€</li>\n<li>å®ƒåˆ©ç”¨ HTML  <code>&lt;template&gt;</code>  æ¥é«˜æ•ˆå…‹éš†</li>\n<li>å®ƒåˆ©ç”¨ é—­åŒ…å’Œå¯¹è±¡å¼•ç”¨ (Parts) æ¥é¿å…æ˜‚è´µçš„ DOM æŸ¥è¯¢</li>\n</ol>\n<p>å°±å¥½æ¯”ä¸€ä¸ªæœ‰ç€æ˜ç¡®ç›®æ ‡çš„ä¿®ç†å·¥ï¼Œä»–ä¼šç›´è¾¾åœ¨ DOM æ ‘ä¸­éœ€è¦ä¿®å¤çš„åœ°æ–¹ï¼Œç„¶åç›´æ¥å¯¹è¿™ä¸ªèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯å»éå†æ•´ä¸ªæ ‘</p>\n",
            "tags": [
                "JavaScript",
                "web component"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Encoding-API-%E6%B5%81%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Encoding-API-%E6%B5%81%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/",
            "title": "ä½¿ç”¨ Encoding API æµç¼–ç è§£ç ",
            "date_published": "2025-11-27T09:20:32.000Z",
            "content_html": "<p>æœ¬æ–‡ä¸»è¦é€šè¿‡ä¸¤ä¸ªä¾‹å­æ‹†è§£å¦‚ä½•ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨åˆ›å»ºä¸€ä¸ªæ…¢é€Ÿæ•°æ®æºï¼Œå¹¶é€šè¿‡ <code>pipeThrough</code>  ç®¡é“å’Œ <code>TextEncoderStream</code> ã€ <code>TextDecoderStream</code>  å®ç°æ•°æ®çš„ç¼–ç è§£ç </p>\n<h1 id=\"åŸºç¡€æ¦‚å¿µæµçš„ä¸‰ä½ä¸€ä½“\"><a class=\"anchor\" href=\"#åŸºç¡€æ¦‚å¿µæµçš„ä¸‰ä½ä¸€ä½“\">#</a> åŸºç¡€æ¦‚å¿µï¼šæµçš„ä¸‰ä½ä¸€ä½“</h1>\n<ol>\n<li>å¯è¯»æµï¼ˆReadableStreamï¼‰ï¼šæ•°æ®çš„æºå¤´ã€‚æ•°æ®ä»è¿™é‡Œæµå‡º</li>\n<li>å¯å†™æµï¼ˆWritableStreamï¼‰ï¼šæ•°æ®çš„ç»ˆç‚¹ã€‚æ•°æ®æµå…¥è¿™é‡Œå¹¶è¢«å¤„ç†</li>\n<li>Transform æµï¼ˆTransformStreamï¼‰ï¼šæ•°æ®çš„ä¸­é—´å¤„ç†å™¨ã€‚å®ƒæ¥æ”¶ä¸€ç§æ ¼å¼çš„è¾“å…¥æµï¼Œå¹¶è¾“å‡ºå¦ä¸€ç§æ ¼å¼çš„æµï¼ˆä¾‹å¦‚ï¼šè¾“å…¥å­—ç¬¦ä¸² <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>â†’</mo></mrow><annotation encoding=\"application/x-tex\">\\rightarrow</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">â†’</span></span></span></span> è¾“å‡ºå­—èŠ‚ï¼‰</li>\n</ol>\n<h1 id=\"ç¤ºä¾‹ä¸€å­—ç¬¦ä¸²ç¼–ç ä¸æµçš„åˆ›å»ºæºå¤´\"><a class=\"anchor\" href=\"#ç¤ºä¾‹ä¸€å­—ç¬¦ä¸²ç¼–ç ä¸æµçš„åˆ›å»ºæºå¤´\">#</a> ç¤ºä¾‹ä¸€ï¼šå­—ç¬¦ä¸²ç¼–ç ä¸æµçš„åˆ›å»ºï¼ˆæºå¤´ï¼‰</h1>\n<p>å°†å­—ç¬¦  <code>foo</code>  æ¨¡æ‹Ÿæˆæ¯éš”ä¸€ç§’åˆ°è¾¾çš„æ•°æ®æµï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæµè§ˆå™¨å¤„ç†æ•°æ®æ‰€éœ€è¦çš„å­—èŠ‚æ ¼å¼ï¼ˆUTF-8 ç¼–ç ï¼‰</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">102</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// A. å¼‚æ­¥ç”Ÿæˆå™¨ï¼šæ•°æ®æº</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">chars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> encodedText <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Uint8Array<span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> charChunk <span class=\"token keyword\">of</span> encodedText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// æš‚åœ 1 ç§’ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">yield</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> charChunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// B. å¯è¯»æµï¼šå°è£…æ•°æ®æº</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> encodedTextStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReadableStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">async</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">controller</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// éå†å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œå°†æ•°æ®æ¨å…¥æµä¸­</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> charChunk <span class=\"token keyword\">of</span> <span class=\"token function\">chars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>charChunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    controller<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ•°æ®å‘é€å®Œæ¯•ï¼Œå…³é—­æµ</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// C. æ¶ˆè´¹è€…ï¼šè¯»å–å­—èŠ‚æ•°æ®</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> encodedTextStream<span class=\"token punctuation\">.</span><span class=\"token function\">getReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"å­—èŠ‚æ•°æ®ï¼š\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>æ•°æ®æºçš„æ ¼å¼ï¼šæ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ä¸€ä¸ª  <code>Uint8Array</code>  å­—èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚å¯¹åº”ä¸€ä¸ªå­—ç¬¦çš„ UTF-8 ç¼–ç ï¼Œæ‰€æœ‰æ¶‰åŠç½‘ç»œä¼ è¾“æˆ–æ–‡ä»¶ I/O çš„åŸå§‹æ•°æ®æµï¼Œéƒ½å¿…é¡»ä»¥ <code>Uint8Array</code>  çš„å½¢å¼æµåŠ¨</li>\n<li><code>ReadableStream</code>  çš„å¯åŠ¨\n<ul>\n<li><code>async start(controller)</code>  å‡½æ•°åœ¨æµè¢«æ¶ˆè´¹æ—¶è¿è¡Œ</li>\n<li><code>for await (let chunk of chars())</code>  ä¼šæš‚åœï¼Œç­‰å¾…  <code>chars()</code>  ç”Ÿæˆå™¨æ¯ç§’  <code>yield</code>  å‡ºä¸€ä¸ª  <code>Uint8Array</code>  æ•°æ®å—</li>\n</ul>\n</li>\n</ol>\n<h1 id=\"ç¤ºä¾‹äºŒç®¡é“ä¸å®æ—¶è§£ç è§£ç å™¨\"><a class=\"anchor\" href=\"#ç¤ºä¾‹äºŒç®¡é“ä¸å®æ—¶è§£ç è§£ç å™¨\">#</a> ç¤ºä¾‹äºŒï¼šç®¡é“ä¸å®æ—¶è§£ç ï¼ˆè§£ç å™¨ï¼‰</h1>\n<p>å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çœ‹åˆ°çš„æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ä¸€å †å­—èŠ‚æ•°ç»„ã€‚è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ <code>TextDecoderStream</code>  å°†å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦ä¸²æµ</p>\n<p>å°†ä¸Šé¢çš„ <code>encodedTextStream</code>  é€šè¿‡ <code>pipeThrough</code>  ç®¡é“è¿æ¥åˆ° <code>TextDecoderStream</code> ï¼Œå³å¯å®ç°å®æ—¶è§£ç </p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//... (chars () å’Œ encodedTextStream çš„å®šä¹‰ä¿æŒä¸å˜)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// æ–°å¢ï¼šè§£ç æµ</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> decodedTextStream <span class=\"token operator\">=</span> encodedTextStream<span class=\"token punctuation\">.</span><span class=\"token function\">pipeThrough</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoderStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// è¯»å–è§£ç æµ</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> decodedTextStream<span class=\"token punctuation\">.</span><span class=\"token function\">getReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"è§£ç å­—ç¬¦ï¼š\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>\n<p><code>pipeThrough()</code>  çš„åŠ›é‡</p>\n<ul>\n<li><code>encodedTextStream.pipeThrough(new TextDecoderStream())</code>  åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®å¤„ç†ç®¡é“</li>\n<li>æ•°æ®æµï¼š <code>Uint8Array</code>  æµ -&gt;  <code>TextDecoderStream</code>  -&gt;  <code>String</code>  æµ</li>\n<li><code>TextDecoderStream</code>  æ¥æ”¶åˆ°ä¸Šæ¸¸çš„å­—èŠ‚æ•°ç»„åï¼Œç«‹å³å°†å…¶è§£ç ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å­—ç¬¦ä¸²è¾“å‡ºåˆ°æ–°çš„æµ</li>\n</ul>\n</li>\n<li>\n<p>è§£ç çš„æ™ºèƒ½æ€§</p>\n<ul>\n<li>å¦‚æœæ•°æ®æ˜¯å•å­—èŠ‚å­—ç¬¦ï¼ˆä¾‹å¦‚ ASCII å­—ç¬¦ï¼‰ï¼Œ <code>TextDecoderStream</code>  ä¼šç«‹å³å°†å…¶è§£ç ä¸ºå­—ç¬¦ä¸²</li>\n<li>å¦‚æœæ•°æ®æ˜¯å¤šå­—èŠ‚å­—ç¬¦ï¼ˆä¾‹å¦‚ UTF-8 ç¼–ç çš„ä¸­æ–‡å­—ç¬¦ï¼‰ï¼Œ <code>TextDecoderStream</code>  ä¼šç­‰å¾…è¶³å¤Ÿçš„å­—èŠ‚æ•°ï¼Œæ‰èƒ½å°†å…¶è§£ç ä¸ºå­—ç¬¦ä¸²</li>\n</ul>\n<pre><code>[102, 111, 111] -&gt; &quot;foo&quot;\n[240, 159, 152, 138] -&gt; ğŸ˜€\n</code></pre>\n</li>\n</ol>\n<h1 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<ol>\n<li>å¼‚æ­¥ç”Ÿæˆå™¨ï¼šçµæ´»æ•°æ®æºã€</li>\n<li><code>ReadableStream</code> ï¼šä½œä¸ºæ•°æ®æµçš„å…¥å£</li>\n<li>ç®¡é“ï¼šä½œä¸ºæ•°æ®å¤„ç†å’Œæ ¼å¼è½¬æ¢çš„æµæ°´çº¿</li>\n<li><code>TextEncoderStream</code> / <code>TextDecoderStream</code> ï¼šä½œä¸ºå­—èŠ‚å’Œå­—ç¬¦ä¸²çš„è½¬æ¢å·¥å…·</li>\n</ol>\n",
            "tags": [
                "JavaScript",
                "ç¼–ç è§£ç "
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-IntersectionObserver-%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-IntersectionObserver-%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/",
            "title": "ä½¿ç”¨ IntersectionObserver å®ç°å›¾ç‰‡æ‡’åŠ è½½",
            "date_published": "2025-11-25T09:31:58.000Z",
            "content_html": "<p>æœ¬æ–‡ä¸»è¦æ˜¯åœ¨é˜…è¯»çº¢å®ä¹¦æ—¶ï¼Œé‡Œé¢æåˆ°äº†  <code>IntersectionObserver</code>  å¯ä»¥å®ç°å›¾ç‰‡æ‡’åŠ è½½ï¼Œæ‰€ä»¥å°±æƒ³è‡ªå·±å®ç°ä¸€ä¸‹ã€‚</p>\n<p>ä¹‹å‰äº†è§£åˆ°çš„ä¸»è¦è¿˜æ˜¯ç›‘å¬ <code>scroll</code>  äº‹ä»¶ï¼Œè°ƒç”¨ <code>getBoundingClientRect</code>  æ–¹æ³•æ¥åˆ¤æ–­å›¾ç‰‡æ˜¯å¦è¿›å…¥åˆ°è§†å£</p>\n<p>è€Œ IntersectionObserver å®ƒæä¾›äº†ä¸€ç§å¼‚æ­¥è§‚å¯Ÿç›®æ ‡å…ƒç´ ä¸å…¶ç¥–å…ˆå…ƒç´ æˆ–é¡¶çº§æ–‡æ¡£è§†å£äº¤å‰çŠ¶æ€å˜åŒ–çš„æ–¹æ³•ï¼Œå®ƒçš„æ€§èƒ½ä¹Ÿè¿œè¶…ä¼ ç»Ÿçš„  <code>scroll</code>  äº‹ä»¶ç›‘å¬</p>\n<h1 id=\"ä½¿ç”¨-intersectionobserver-å®ç°å›¾ç‰‡æ‡’åŠ è½½\"><a class=\"anchor\" href=\"#ä½¿ç”¨-intersectionobserver-å®ç°å›¾ç‰‡æ‡’åŠ è½½\">#</a> ä½¿ç”¨ IntersectionObserver å®ç°å›¾ç‰‡æ‡’åŠ è½½</h1>\n<h2 id=\"ç¬¬ä¸€æ­¥å‡†å¤‡-html\"><a class=\"anchor\" href=\"#ç¬¬ä¸€æ­¥å‡†å¤‡-html\">#</a> ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ HTML</h2>\n<p>æ ¸å¿ƒæ˜¯ï¼Œä¸ç›´æ¥åœ¨ <code>img</code>  æ ‡ç­¾ä¸Šæ·»åŠ  <code>src</code>  å±æ€§ï¼Œè€Œæ˜¯æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§ï¼Œä¾‹å¦‚ <code>data-src</code></p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1.0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Document<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\"></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token selector\">.image-container</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 80%<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 0 auto<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token selector\">img</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> block<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 400px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 20px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> #f0f0f0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>image-container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Alexander<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Brian<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Luis<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Jack<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://api.dicebear.com/9.x/adventurer/svg?seed=Mason<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// ç¼–å†™é€»è¾‘</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"ç¬¬äºŒæ­¥ç¼–å†™-javascript-é€»è¾‘\"><a class=\"anchor\" href=\"#ç¬¬äºŒæ­¥ç¼–å†™-javascript-é€»è¾‘\">#</a> ç¬¬äºŒæ­¥ï¼šç¼–å†™ JavaScript é€»è¾‘</h2>\n<ol>\n<li>é€‰å–æ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡</li>\n<li>åˆ›å»º <code>IntersectionObserver</code>  å®ä¾‹ï¼šæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ç›®æ ‡å…ƒç´ å‘ç”Ÿå¯è§æ€§å˜åŒ–æ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°±ä¼šè¢«æ‰§è¡Œ</li>\n<li>åœ¨å›è°ƒå‡½æ•°ä¸­å¤„ç†é€»è¾‘ï¼š\n<ul>\n<li>éå†è§¦å‘å˜åŒ–çš„ <code>entries</code></li>\n<li>æ£€æŸ¥ <code>entry.isIntersecting</code>  æ˜¯å¦ä¸º <code>true</code> ï¼Œå¦‚æœæ˜¯ï¼Œè¯´æ˜å›¾ç‰‡è¿›å…¥åˆ°è§†å£ï¼Œéœ€è¦åŠ è½½å›¾ç‰‡</li>\n<li>åŠ è½½å›¾ç‰‡ï¼šå°† <code>data-src</code>  å±æ€§çš„å€¼èµ‹å€¼ç»™ <code>src</code>  å±æ€§</li>\n<li>å…³é”®ï¼šå›¾ç‰‡åŠ è½½åï¼Œè°ƒç”¨ <code>observer.unobserve(entry.target)</code>  æ–¹æ³•ï¼Œåœæ­¢è§‚å¯Ÿè¯¥å›¾ç‰‡ï¼Œé¿å…é‡å¤åŠ è½½</li>\n</ul>\n</li>\n<li>è®©è§‚å¯Ÿè€…å¼€å§‹å·¥ä½œï¼šè°ƒç”¨ <code>observer.observe(target)</code>  æ–¹æ³•ï¼Œå¼€å§‹è§‚å¯Ÿç›®æ ‡å…ƒç´ </li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 1. é€‰å–æ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> images <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'img[data-src]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">lazyLoad</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">target</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// 2. åˆ›å»º IntersectionObserver å®ä¾‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> io <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entries<span class=\"token punctuation\">,</span> observer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 3. éå† entries</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    entries<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entry</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> src <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 4. åŠ è½½å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        img<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 5. å›¾ç‰‡åŠ è½½åï¼Œç§»é™¤ data-src å±æ€§</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        img<span class=\"token punctuation\">.</span><span class=\"token function\">removeAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 6. å›¾ç‰‡åŠ è½½åï¼Œåœæ­¢è§‚å¯Ÿè¯¥å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        observer<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token literal-property property\">threshold</span><span class=\"token operator\">:</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  io<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// 7. éå†æ‰€æœ‰å›¾ç‰‡ï¼Œè°ƒç”¨ lazyLoad å‡½æ•°</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>images<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>lazyLoad<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>HTMLï¼šä½¿ç”¨ <code>data-src</code>  å±æ€§æ¥å­˜å‚¨å›¾ç‰‡çš„çœŸå®åœ°å€<br />\n JavaScriptï¼šä½¿ç”¨  <code>IntersectionObserver</code>  ç›‘è§†å›¾ç‰‡<br />\né€»è¾‘ï¼šå½“å›¾ç‰‡  <code>isIntersecting</code> ï¼ˆè¿›å…¥è§†å£ï¼‰æ—¶ï¼Œå°†  <code>data-src</code>  æ›¿æ¢ä¸º  <code>src</code> <br />\n æ€§èƒ½ï¼šåŠ è½½å  <code>unobserve</code> ï¼ˆåœæ­¢è§‚å¯Ÿï¼‰ï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€</p>\n",
            "tags": [
                "JavaScript",
                "å›¾ç‰‡æ‡’åŠ è½½"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Async-Generator-%E6%89%93%E9%80%A0%E4%BA%8B%E4%BB%B6%E6%B5%81/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8-Async-Generator-%E6%89%93%E9%80%A0%E4%BA%8B%E4%BB%B6%E6%B5%81/",
            "title": "ä½¿ç”¨ Async Generator æ‰“é€ äº‹ä»¶æµ",
            "date_published": "2025-11-13T09:26:11.000Z",
            "content_html": "<h1 id=\"ä½¿ç”¨-async-generator-æ‰“é€ äº‹ä»¶æµ\"><a class=\"anchor\" href=\"#ä½¿ç”¨-async-generator-æ‰“é€ äº‹ä»¶æµ\">#</a> ä½¿ç”¨ Async Generator æ‰“é€ äº‹ä»¶æµ</h1>\n<h2 id=\"å¼•è¨€å¼‚æ­¥ç¼–ç¨‹çš„èŒƒå¼è½¬æ¢\"><a class=\"anchor\" href=\"#å¼•è¨€å¼‚æ­¥ç¼–ç¨‹çš„èŒƒå¼è½¬æ¢\">#</a> å¼•è¨€ï¼šå¼‚æ­¥ç¼–ç¨‹çš„èŒƒå¼è½¬æ¢</h2>\n<p>ä¼ ç»Ÿçš„ <code>addEventListener</code>  æ–¹æ³•ä¸ºäº‹ä»¶ç»‘å®šå›è°ƒå‡½æ•°è™½ç„¶æœ‰æ•ˆï¼Œä½†å½“æˆ‘ä»¬å¤„ç†å¤æ‚çš„ã€æœ‰æ—¶åºçš„äº‹ä»¶åºåˆ—æ—¶ï¼Œä»£ç å¾ˆå¿«å°±ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚</p>\n<p>æœ¬æ–‡ä»‹ç»ä½¿ç”¨ Async Generator æ‰“é€ äº‹ä»¶æµï¼Œå±•ç¤ºäº†å¦‚ä½•å°†å¼‚æ­¥äº‹ä»¶è½¬æ¢ä¸ºå¯è¿­ä»£çš„åºåˆ—</p>\n<h2 id=\"æ ¸å¿ƒä»£ç å°†äº‹ä»¶è½¬åŒ–ä¸º-observable-stream\"><a class=\"anchor\" href=\"#æ ¸å¿ƒä»£ç å°†äº‹ä»¶è½¬åŒ–ä¸º-observable-stream\">#</a> æ ¸å¿ƒä»£ç ï¼šå°†äº‹ä»¶è½¬åŒ–ä¸º Observable Stream</h2>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">ResolveFunction<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> PromiseLike<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Observable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// Promise é˜Ÿåˆ—ï¼šå­˜å‚¨ç­‰å¾…è¢«äº‹ä»¶è§£å†³çš„ Promise</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">private</span> promiseQueue<span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">//resolve å‡½æ•°ï¼šæŒ‡å‘å½“å‰é˜Ÿåˆ—å¤´éƒ¨ Promise çš„è§£å†³å‡½æ•°</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">private</span> resolve<span class=\"token operator\">:</span> ResolveFunction<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promiseQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolve <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åˆå§‹å¯åŠ¨ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªç­‰å¾… Promise</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºä¸€ä¸ªæ–° Promiseï¼Œå¹¶å°†å®ƒçš„ resolve å‡½æ•°èµ‹å€¼ç»™ this.resolve</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promiseQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolve <span class=\"token operator\">=</span> resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºä¸‹ä¸€ä¸ª Promise</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promiseQueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// æ ¸å¿ƒæ–¹æ³•ï¼šå°† DOM äº‹ä»¶è½¬åŒ–ä¸ºå¼‚æ­¥ç”Ÿæˆå™¨æµ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  async <span class=\"token operator\">*</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>element<span class=\"token operator\">:</span> EventTarget<span class=\"token punctuation\">,</span> eventType<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> AsyncGenerator<span class=\"token operator\">&lt;</span>Event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ (Push é˜¶æ®µ)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Event<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">// 1. è§£å†³å½“å‰æ­£åœ¨ç­‰å¾…çš„ Promiseï¼Œå°†äº‹ä»¶æ•°æ®æ¨é€å‡ºå»</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\">// 2. ç«‹å³åˆ›å»ºä¸‹ä¸€ä¸ª Promiseï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">// å¼‚æ­¥ç”Ÿæˆå™¨ï¼šå¯åŠ¨æ‹‰å–æµç¨‹ (Pull é˜¶æ®µ)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\">// å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª Promise è¢«äº‹ä»¶è§£å†³</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token comment\">// æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿ dequeue ä¸è¿”å› undefinedï¼Œé€šå¸¸é€šè¿‡é€»è¾‘ä¿è¯é˜Ÿåˆ—éç©º</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">const</span> nextPromise <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextPromise<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          <span class=\"token keyword\">yield</span> <span class=\"token keyword\">await</span> nextPromise<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\">// å¦‚æœ dequeue è¿”å› undefinedï¼Œåˆ™æ— é™å¾ªç¯ä¼šå¡ä½ï¼Œä½†æˆ‘ä»¬åœ¨é€»è¾‘ä¸Šä¿è¯äº† enqueue ç´§è·Ÿ resolveã€‚</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>è¿è¡Œç¤ºä¾‹</strong></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> observable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// å‡è®¾é¡µé¢ä¸­å­˜åœ¨ä¸€ä¸ª &lt;button> å…ƒç´ </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> button <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>button<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> clickStream <span class=\"token operator\">=</span> observable<span class=\"token punctuation\">.</span><span class=\"token function\">fromEvent</span><span class=\"token punctuation\">(</span>button<span class=\"token punctuation\">,</span> <span class=\"token string\">'click'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// ä½¿ç”¨ for await...of çº¿æ€§å¤„ç†äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> e <span class=\"token keyword\">of</span> clickStream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æŒ‰é’®è¢«ç‚¹å‡»äº†:'</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">//... å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œå¤æ‚çš„å¼‚æ­¥æ“ä½œï¼Œæµç¨‹ä¾ç„¶æ¸…æ™°</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"æœºåˆ¶è§£æ\"><a class=\"anchor\" href=\"#æœºåˆ¶è§£æ\">#</a> æœºåˆ¶è§£æ</h2>\n<p>åˆ©ç”¨ Promise é˜Ÿåˆ—ï¼Œå®ç°äº†äº‹ä»¶å‘ç”Ÿï¼ˆæ¨é€ï¼‰å’Œä»£ç å¤„ç†ï¼ˆæ‹‰å–ï¼‰ä¹‹é—´çš„å®‰å…¨åŒæ­¥</p>\n<ol>\n<li>\n<p>é˜Ÿåˆ—ä¸ºä»€ä¹ˆæ—¶å¿…é¡»çš„ï¼Ÿ<br />\nç¡®ä¿æ—¶åºå’Œé˜²æ­¢äº‹ä»¶ä¸¢å¤±<br />\nåœ¨ä»»ä½•æ—¶å€™ï¼Œ <code>this.resolve</code>  æ€»æ˜¯æŒ‡å‘å½“å‰ç­‰å¾…è¢«è§£å†³çš„ Promise çš„è§£å†³å‡½æ•°ã€‚å½“äº‹ä»¶ä»¥æå¿«çš„é€Ÿåº¦å‘ç”Ÿæ—¶ï¼Œé˜Ÿåˆ—æä¾›äº†ä¸€ä¸ªç¼“å†²</p>\n<ul>\n<li>äº‹ä»¶ A è§¦å‘ï¼š <code>resolve(A)</code>  è§£å†³äº† Promise P1ï¼Œå¹¶åˆ›å»ºäº† Promise P2.</li>\n<li>äº‹ä»¶ B è§¦å‘ï¼šåœ¨ <code>async generator</code>  å¾ªç¯æ¥å¾—åŠæ‹‰å– P2 ä¹‹å‰ï¼Œäº‹ä»¶ B å·²ç»è§¦å‘ï¼Œå®ƒå®‰å…¨çš„ <code>resolve(B)</code>  è§£å†³äº† P2ï¼Œå¹¶åˆ›å»ºäº† P3</li>\n<li>æ‹‰å–å¾ªç¯ï¼šå¾ªç¯ä¾æ¬¡æ¢å¤ï¼Œå…ˆäº§å‡º Aï¼Œå†äº§å‡º B</li>\n</ul>\n<p>å¦‚æœæ²¡æœ‰é˜Ÿåˆ—ï¼Œåœ¨å¿«é€Ÿè¿ç»­äº‹ä»¶ä¸­ï¼Œç¬¬äºŒä¸ªäº‹ä»¶ B ææœ‰å¯èƒ½æ‰¾ä¸åˆ°ç­‰å¾…çš„ Promise è€Œè¢«ä¸¢å¤±ã€‚é˜Ÿåˆ—ç¡®ä¿äº‹ä»¶çš„å‘ç”Ÿé¡ºåºä¸å¤„ç†é¡ºåºä¸¥æ ¼ä¸€è‡´</p>\n</li>\n<li>\n<p>push ä¸ pull å®Œç¾ç»“åˆ<br />\n | æ¨¡å‹ | è§’è‰² | åŠ¨ä½œ | æè¿° |<br />\n| ----- | ----- | ----- | ----- |<br />\n| push | äº‹ä»¶ç›‘å¬å™¨ |  <code>this.resolve(e)</code>  | äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°†æ•°æ®æ¨å…¥ç»™æ­£åœ¨ç­‰å¾…çš„ Promiseã€‚|<br />\n| pull | å¼‚æ­¥ç”Ÿæˆå™¨ |  <code>yield await nextPromise</code>  | ä»£ç å¤„ç†ï¼ˆæ‹‰å–ï¼‰ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ï¼Œç¡®ä¿æ—¶åºã€‚|</p>\n</li>\n</ol>\n<h2 id=\"å¯¹æ¯”\"><a class=\"anchor\" href=\"#å¯¹æ¯”\">#</a> å¯¹æ¯”</h2>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>ä¼ ç»Ÿ addEventListener</th>\n<th>Observable + async generator</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ä»£ç é£æ ¼</td>\n<td>åŸºäºå›è°ƒï¼Œå®¹æ˜“åµŒå¥—ã€‚</td>\n<td>åŸºäº  <code>for await...of</code>  å¾ªç¯ï¼Œæµç¨‹çº¿æ€§åŒ–ã€‚</td>\n</tr>\n<tr>\n<td>æ—¶åºæ§åˆ¶</td>\n<td>éœ€æ‰‹åŠ¨ç®¡ç†è®¡æ•°å™¨ã€è®¡æ—¶å™¨å’Œå¤–éƒ¨çŠ¶æ€ã€‚</td>\n<td>ä½¿ç”¨  <code>await</code>  å…³é”®å­—è‡ªç„¶åœ°æš‚åœ / ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚</td>\n</tr>\n<tr>\n<td>ç»ˆæ­¢ / æ¸…ç†</td>\n<td>å¿…é¡»æ‰‹åŠ¨è°ƒç”¨  <code>removeEventListener</code> ã€‚</td>\n<td>å¯ä»¥é€šè¿‡  <code>break</code>  é€€å‡ºå¾ªç¯ï¼Œå¹¶åœ¨è¿­ä»£å™¨çš„  <code>return</code>  æ–¹æ³•ä¸­å®ç°è‡ªåŠ¨æ¸…ç†ï¼ˆæ˜“äºæ‰©å±•ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td>ç¤ºä¾‹</td>\n<td>ç­‰å¾… 3 æ¬¡ç‚¹å‡»éœ€è¦å¤–éƒ¨è®¡æ•°å™¨å’Œæ‰‹åŠ¨æ¸…ç†ã€‚</td>\n<td>ç­‰å¾… 3 æ¬¡ç‚¹å‡»åªéœ€ä¸€ä¸ªç®€å•çš„  <code>if (count === 3) break;</code> ã€‚</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "JavaScript",
                "Async Generator",
                "äº‹ä»¶æµ"
            ]
        },
        {
            "id": "https://aynya.github.io/Axios-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%8C%96%E5%B0%81%E8%A3%85%EF%BC%88%E5%8E%BB%E9%87%8D%E4%B8%8E%E9%98%B2%E6%8A%96%EF%BC%89/",
            "url": "https://aynya.github.io/Axios-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%8C%96%E5%B0%81%E8%A3%85%EF%BC%88%E5%8E%BB%E9%87%8D%E4%B8%8E%E9%98%B2%E6%8A%96%EF%BC%89/",
            "title": "Axios è¯·æ±‚ä¼˜åŒ–å°è£…ï¼ˆå»é‡ä¸é˜²æŠ–ï¼‰",
            "date_published": "2025-10-27T13:25:49.000Z",
            "content_html": "<h1 id=\"axios-è¯·æ±‚ä¼˜åŒ–å°è£…å»é‡ä¸é˜²æŠ–\"><a class=\"anchor\" href=\"#axios-è¯·æ±‚ä¼˜åŒ–å°è£…å»é‡ä¸é˜²æŠ–\">#</a> Axios è¯·æ±‚ä¼˜åŒ–å°è£…ï¼ˆå»é‡ä¸é˜²æŠ–ï¼‰</h1>\n<p>æ ¸å¿ƒç›®æ ‡æ˜¯å°è£…ä¸€ä¸ªå¥å£®çš„ <code>request</code>  å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å‘èµ·è¯·æ±‚å‰èƒ½è‡ªåŠ¨å¤„ç†é˜Ÿåˆ—ä¸­çš„é‡å¤è¯·æ±‚ï¼ˆå»é‡ï¼‰ï¼Œå¹¶èƒ½é€šè¿‡é…ç½®å®ç°å‘é€é¢‘ç‡é™åˆ¶ï¼ˆé˜²æŠ–ï¼‰</p>\n<p><strong>æ ¸å¿ƒåŠŸèƒ½</strong></p>\n<ol>\n<li>è¯·æ±‚å»é‡ï¼šåˆ©ç”¨ Axios æ‹¦æˆªå™¨ï¼Œåœ¨å‘é€è¯·æ±‚å‰å’Œå“åº”æ¥æ”¶åï¼Œé€šè¿‡ <code>CancelToken</code>  æœºåˆ¶å–æ¶ˆç›¸åŒçš„å¾…å‘è¯·æ±‚</li>\n<li>è¯·æ±‚é˜²æŠ–ï¼šå…è®¸ç”¨æˆ·å†è¯·æ±‚é…ç½®ä¸­æŒ‡å®š <code>debounce</code>  å»¶è¿Ÿæ—¶é—´ï¼Œä»è€Œé™åˆ¶è¯·æ±‚çš„å‘é€é¢‘ç‡</li>\n</ol>\n<h2 id=\"è¯·æ±‚å»é‡æœºåˆ¶\"><a class=\"anchor\" href=\"#è¯·æ±‚å»é‡æœºåˆ¶\">#</a> è¯·æ±‚å»é‡æœºåˆ¶</h2>\n<ol>\n<li>æ ¸å¿ƒæ•°æ®ç»“æ„<br />\nä½¿ç”¨ä¸€ä¸ª <code>Map</code>  ç»“æ„æ¥å­˜å‚¨å¾…å–æ¶ˆçš„è¯·æ±‚ï¼š</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> pendingRequests <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Canceler<span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>Keyï¼šå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”±è¯·æ±‚æ–¹æ³•ã€URLã€å‚æ•°å’Œæ•°æ®ç»„æˆ</li>\n<li>Valueï¼šAxios çš„ <code>Cancelr</code>  å‡½æ•°ï¼Œç”¨äºå–æ¶ˆè¯·æ±‚</li>\n</ul>\n<ol start=\"2\">\n<li>ç”Ÿæˆè¯·æ±‚å”¯ä¸€ Key<br />\n <code>getRequestKey</code>  å‡½æ•°è´Ÿè´£ç”Ÿæˆä¸€ä¸ªç¨³å®šçš„è¯·æ±‚æ ‡è¯†ç¬¦ã€‚ä¸ºäº†ç¡®ä¿è¯·æ±‚æ— è®ºä½•æ—¶å‘é€éƒ½èƒ½åŒ¹é…ã€‚</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// å°† JSON å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥ç¡®ä¿ç¨³å®šæ€§</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>æ‹¦æˆªå™¨å®ç°é€»è¾‘</li>\n</ol>\n<ul>\n<li>è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆ <code>service.interceptors.request</code> ï¼‰\n<ul>\n<li><code>removePendingRequest</code> ï¼š åœ¨å‘é€æ–°è¯·æ±‚å‰ï¼Œæ£€æŸ¥ <code>pendingRequests</code>  ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒ Key çš„è¯·æ±‚ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç«‹å³æ‰§è¡Œ <code>Canceler</code>  å‡½æ•°å–æ¶ˆæ—§è¯·æ±‚ï¼Œå¹¶ä» Map ä¸­åˆ é™¤</li>\n<li><code>addPendingRequest</code> ï¼šä¸ºå½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>CancelToken</code> ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ° <code>pendingRequests</code>  Map ä¸­</li>\n</ul>\n</li>\n<li>å“åº”æ‹¦æˆªå™¨ï¼ˆ <code>service.interceptors.response</code> ï¼‰\n<ul>\n<li>æ— è®ºè¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½éœ€è¦è°ƒç”¨ <code>removePendingRequest(response.config)</code>  å°†å…¶ä» <code>pendingRequests</code>  é˜Ÿåˆ—ä¸­ç§»é™¤</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"è¯·æ±‚é˜²æŠ–æœºåˆ¶\"><a class=\"anchor\" href=\"#è¯·æ±‚é˜²æŠ–æœºåˆ¶\">#</a> è¯·æ±‚é˜²æŠ–æœºåˆ¶</h2>\n<ol>\n<li>æ ¸å¿ƒé˜²æŠ–å‡½æ•° <code>debounceRequest</code> <br />\n è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªæ‰§è¡Œè¯·æ±‚çš„å‡½æ•° <code>func</code>  å’Œå»¶è¿Ÿæ—¶é—´ <code>delay</code> ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¢«é˜²æŠ–çš„æ–°å‡½æ•°</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> debounceTimer<span class=\"token operator\">:</span> ReturnType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> setTimeout<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ä½¿ç”¨å…¨å±€è®¡æ—¶å™¨æ¥ç¡®ä¿æ‰€æœ‰é˜²æŠ–è¯·æ±‚å…±äº«çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">debounceRequest</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function-variable function\">func</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  delay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>debounceTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¯æ¬¡è°ƒç”¨éƒ½æ¸…é™¤ä¸Šä¸€ä¸ªè®¡æ—¶å™¨</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      debounceTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å»¶è¿Ÿåæ‰§è¡ŒåŸå§‹è¯·æ±‚</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>Promise å°è£…ï¼šå…³é”®åœ¨äºä½¿ç”¨ <code>new Promise</code>  å°è£…äº† <code>setTimeout</code>  å†…éƒ¨çš„åŸå§‹è¯·æ±‚ã€‚è¿™ç¡®ä¿äº†å¤–éƒ¨è°ƒç”¨è€…å¾—åˆ°çš„ Promise ( <code>lastRequestPromise</code> ) åªæœ‰åœ¨å»¶è¿Ÿç»“æŸåã€åŸå§‹è¯·æ±‚çœŸæ­£æ‰§è¡Œå¹¶å®Œæˆæ—¶æ‰ä¼šè¢« resolve /reject</li>\n</ul>\n<ol start=\"2\">\n<li>ç»Ÿä¸€å…¥å£ <code>request</code> <br />\n <code>request</code>  å‡½æ•°ä½œä¸ºå°è£…çš„æœ€ç»ˆ APIï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æ˜¯å¦éœ€è¦å¼€å¯é˜²æŠ–åŠŸèƒ½</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">request</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>options<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœé…ç½®ä¸­å­˜åœ¨ debounce å­—æ®µï¼Œåˆ™åº”ç”¨é˜²æŠ–åŒ…è£…</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 1. åˆ›å»ºä¸€ä¸ªé˜²æŠ–ç‰ˆæœ¬çš„ service.request å‡½æ•°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// 2. ç«‹å³æ‰§è¡Œè¿™ä¸ªé˜²æŠ–å‡½æ•°ï¼Œå¹¶ä¼ å…¥ options</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">debounceRequest</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">=></span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// å¦åˆ™ï¼Œç«‹å³å‘é€è¯·æ±‚</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">return</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"å®Œæ•´ä»£ç å®ç°\"><a class=\"anchor\" href=\"#å®Œæ•´ä»£ç å®ç°\">#</a> å®Œæ•´ä»£ç å®ç°</h2>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">&#123;</span> InternalAxiosRequestConfig<span class=\"token punctuation\">,</span> AxiosRequestConfig<span class=\"token punctuation\">,</span> Canceler<span class=\"token punctuation\">,</span> AxiosResponse  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">CustomRequestConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AxiosRequestConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  debounce<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> pendingRequests <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Canceler<span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">addPendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  config<span class=\"token punctuation\">.</span>cancelToken <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>cancelToken <span class=\"token operator\">||</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">axios</span><span class=\"token punctuation\">.</span><span class=\"token function\">CancelToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cancel<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> cancel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">const</span> requestKey <span class=\"token operator\">=</span> <span class=\"token function\">getRequestKey</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>requestKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> cancel <span class=\"token operator\">=</span> pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>requestKey<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Canceler<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">å–æ¶ˆé‡å¤è¯·æ±‚: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>requestKey<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    pendingRequests<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>requestKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> service <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  baseURL<span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  timeout<span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>service<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> InternalAxiosRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token function\">addPendingRequest</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">return</span> config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  error <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>service<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token punctuation\">(</span>response<span class=\"token operator\">:</span> AxiosResponse<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  error <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token function\">removePendingRequest</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span><span class=\"token function\">isCancel</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è¯·æ±‚å·²å–æ¶ˆ:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'è¯·æ±‚å‘ç”Ÿé”™è¯¯:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token keyword\">let</span> debounceTimer<span class=\"token operator\">:</span> ReturnType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> setTimeout<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">debounceRequest</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token function-variable function\">func</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  delay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>config<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>debounceTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      debounceTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'qwer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">request</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>options<span class=\"token operator\">:</span> CustomRequestConfig<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">debounceRequest</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">=></span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">.</span>debounce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token keyword\">return</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> request<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "è¯·æ±‚",
                "Axios",
                "å»é‡",
                "é˜²æŠ–"
            ]
        },
        {
            "id": "https://aynya.github.io/%E6%90%9C%E7%B4%A2%E6%A1%86%E7%9B%B8%E5%85%B3%E5%AE%9E%E7%8E%B0%E4%B8%8E%E9%83%A8%E5%88%86%E4%BC%98%E5%8C%96/",
            "url": "https://aynya.github.io/%E6%90%9C%E7%B4%A2%E6%A1%86%E7%9B%B8%E5%85%B3%E5%AE%9E%E7%8E%B0%E4%B8%8E%E9%83%A8%E5%88%86%E4%BC%98%E5%8C%96/",
            "title": "æœç´¢æ¡†ç›¸å…³å®ç°ä¸éƒ¨åˆ†ä¼˜åŒ–",
            "date_published": "2025-09-24T15:16:38.000Z",
            "content_html": "<h1 id=\"ç›®æ ‡\"><a class=\"anchor\" href=\"#ç›®æ ‡\">#</a> ç›®æ ‡</h1>\n<p>å®ç°ä¸€ä¸ªæœç´¢æ¡†ï¼Œè¾“å…¥å†…å®¹åï¼Œå®æ—¶æœç´¢å¹¶å±•ç¤ºä¸‹æ‹‰æ¡†åŒ¹é…çš„ç»“æœã€‚</p>\n<ol>\n<li>è¾“å…¥å†…å®¹</li>\n<li>æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£ï¼Œè¿”å›å­—ç¬¦ä¸²æ•°ç»„</li>\n<li>è¾“å…¥æ¡†åšé˜²æŠ–</li>\n<li>ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚</li>\n<li>ä¸‹æ‹‰æ¡†é‡‡ç”¨è™šæ‹Ÿåˆ—è¡¨</li>\n</ol>\n<h2 id=\"è¾“å…¥å†…å®¹\"><a class=\"anchor\" href=\"#è¾“å…¥å†…å®¹\">#</a> è¾“å…¥å†…å®¹</h2>\n<p>é€šè¿‡ <code>input</code>  ç»„ä»¶å¹¶é‡‡ç”¨ <code>onChange</code>  äº‹ä»¶æ¥è·å–è¾“å…¥çš„å†…å®¹</p>\n<h2 id=\"æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£\"><a class=\"anchor\" href=\"#æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£\">#</a> æ ¹æ®å†…å®¹è¯·æ±‚æ¥å£</h2>\n<p>æŠŠæ¥å£è¯·æ±‚æ“ä½œå†™åˆ° <code>useEffect</code>  ä¸­<br />\nè·å–åˆ°ç»“æœå <code>setState</code>  åˆ°å…¨å±€<br />\næ³¨æ„ï¼šæ¯æ¬¡è¯·æ±‚å®Œåï¼Œéœ€è¦å¯¹æ•´ä¸ªåˆ—è¡¨çš„æ»šåŠ¨æ¡è¿›è¡Œå¤åŸ</p>\n<h2 id=\"è¾“å…¥æ¡†åšé˜²æŠ–\"><a class=\"anchor\" href=\"#è¾“å…¥æ¡†åšé˜²æŠ–\">#</a> è¾“å…¥æ¡†åšé˜²æŠ–</h2>\n<p>é˜²æŠ–å•ç‹¬å†™ä¸€ä¸ª <code>hook</code> ï¼š <code>useDebounce&lt;T&gt;(value: T, delay: number): T </code></p>\n<ol>\n<li>ä¼ å…¥ä¸€ä¸ªå€¼å’Œå»¶æ—¶æ—¶é—´</li>\n<li>åœ¨å†…éƒ¨é€šè¿‡ <code>setState</code>  ç»´æŠ¤ä¸€ä¸ª <code>debounceValue</code></li>\n<li>æ¯æ¬¡ <code>value</code>  å‘ç”Ÿæ”¹å˜æ—¶çˆ¶ç»„ä»¶é‡æ¸²æŸ“ï¼Œæ•´ä¸ª <code>hook</code>  é‡æ–°æ‰§è¡Œ</li>\n<li>å¸è½½æ—¶å–æ¶ˆåŸæ¥çš„å»¶æ—¶ï¼ŒæŒ‚è½½æ—¶è®¾ç½®å»¶æ—¶ï¼Œå»¶æ—¶å®Œåå†å¯¹ <code>debounceValue</code>  èµ‹å€¼</li>\n<li>è¿”å› <code>debounceValue</code>  å³å¯</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useDebounce</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> delay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>debouncedValue<span class=\"token punctuation\">,</span> setDebouncedValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">setDebouncedValue</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> debouncedValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚\"><a class=\"anchor\" href=\"#ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚\">#</a> ä»¥é˜Ÿåˆ—å½¢å¼è¯·æ±‚</h2>\n<p>æœ‰å¯èƒ½ä¸€ç§æƒ…å†µï¼šå½“å‰ä¸€æ¬¡çš„è¯·æ±‚æ¯”ç¬¬äºŒæ¬¡æ…¢ï¼Œé‚£ä¹ˆæ¥æ”¶æ—¶å°±ä¼šè¦†ç›–æœ€è¿‘çš„ä¸€æ¬¡ç»“æœ<br />\næ‰€ä»¥è¿™é‡Œå°±è¦æœ‰ä¸ªå…ˆåé¡ºåº</p>\n<ol>\n<li>ä»¥ <code>useRef</code>  æ¥åˆå§‹åŒ–ä¸€ä¸ªå‘é€ <code>ID</code></li>\n<li>æ¯æ¬¡å‘é€è¯·æ±‚å‰éƒ½è®°å½•ä¸€ä¸‹å‘é€çš„ <code>ID</code></li>\n<li>é€šè¿‡é—­åŒ… +  <code>useRef</code></li>\n<li>å½“å“åº”åˆ°è¾¾çš„æ—¶å€™åªéœ€è¦å¯¹æ¯” <code>useRef</code>  å’Œé—­åŒ…ä¸­è®°å½•çš„å€¼æ˜¯å¦ç›¸ç­‰å°±å¯ä»¥åˆ¤æ–­æ˜¯ä¸æ˜¯æœ€æ–°çš„</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> latestRequestRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> currentRequest <span class=\"token operator\">=</span> <span class=\"token operator\">++</span>latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">fetchSearchResults</span><span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentRequest <span class=\"token operator\">===</span> latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// å½“ç»“æœæ›´æ–°æ—¶ï¼Œé‡ç½®æ»šåŠ¨ä½ç½®</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>debouncedInputValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"è™šæ‹Ÿåˆ—è¡¨çš„å®ç°å®šé«˜\"><a class=\"anchor\" href=\"#è™šæ‹Ÿåˆ—è¡¨çš„å®ç°å®šé«˜\">#</a> è™šæ‹Ÿåˆ—è¡¨çš„å®ç°ï¼ˆå®šé«˜ï¼‰</h2>\n<p>ç›®çš„ï¼šåªæ¸²æŸ“å¯è§éƒ¨åˆ†çš„ dom</p>\n<ol>\n<li>é€šè¿‡ <code>scrollTop</code>  è·å–åˆ°æ»šåŠ¨æ¡çš„ä½ç½®</li>\n<li>æ ¹æ®å…¬å¼ <code>startIndex = Math.floor(scrollTop / ITEM_HEIGHT)</code>  è·å–å¼€å§‹ä¸‹æ ‡</li>\n<li>æ ¹æ®å…¬å¼ <code>endIndex = Math.min(results.length - 1, startIndex + VISIBLE_ITEMS_COUNT)</code>  è·å–ç»“æŸä¸‹æ ‡</li>\n<li>ç„¶åæ ¹æ®è¿™ä¸¤ä¸ªä¸‹æ ‡å»åˆ‡åˆ†æ•°ç»„ï¼Œå¾—åˆ°çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦æ¸²æŸ“çš„å†…å®¹ï¼ˆä½†æ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¦æ¸²æŸ“çš„å†…å®¹ï¼Œé‚£ä¸Šä¸‹ä¸¤è¾¹ç©ºç€çš„åœ°æ–¹æ€ä¹ˆåŠï¼Œå½“ç„¶æ˜¯ç”¨ <code>padding</code>  å»å¡«å……å•¦ï¼‰</li>\n<li>é‚£ä¹ˆï¼Œ <code>paddingTop = paddingTop = startIndex * ITEM_HEIGHT;</code></li>\n<li><code>paddingBottom = (results.length - (endIndex + 1)) * ITEM_HEIGHT</code></li>\n</ol>\n<p>è¿™æ ·ï¼Œæ•´ä¸ªç»“æ„å°±æ˜¯ï¼Œçˆ¶ <code>div</code>  çš„æ ·å¼å°±æ˜¯ <code>paddingTop</code>  +  <code>paddingBottom</code> ï¼Œå­å°±æ˜¯éœ€è¦å¾ªç¯æ¸²æŸ“çš„å†…å®¹äº†</p>\n<p>æ»šåŠ¨æ—¶æ•´ä¸ªé“¾è·¯ï¼šæ»šåŠ¨äº‹ä»¶è§¦å‘ï¼Œé‡æ¸²æŸ“ï¼Œæ¥ç€ä»ç¬¬ä¸€æ­¥å¼€å§‹æ‰§è¡Œ</p>\n<h1 id=\"å…·ä½“ä»£ç \"><a class=\"anchor\" href=\"#å…·ä½“ä»£ç \">#</a> å…·ä½“ä»£ç </h1>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> useState<span class=\"token punctuation\">,</span> useEffect<span class=\"token punctuation\">,</span> useRef<span class=\"token punctuation\">,</span> useCallback <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> useDebounce <span class=\"token keyword\">from</span> <span class=\"token string\">'../hooks/useDebounce'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// æ¨¡æ‹Ÿä¸€ä¸ª API è¯·æ±‚</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">ITEM_HEIGHT</span> <span class=\"token operator\">=</span> <span class=\"token number\">36</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¯ä¸ªåˆ—è¡¨é¡¹çš„é«˜åº¦ï¼ŒåŒ…æ‹¬ padding å’Œ border</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">VISIBLE_ITEMS_COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯è§çš„åˆ—è¡¨é¡¹æ•°é‡</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> Search<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>inputValue<span class=\"token punctuation\">,</span> setInputValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>results<span class=\"token punctuation\">,</span> setResults<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>loading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isInputFocused<span class=\"token punctuation\">,</span> setIsInputFocused<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>scrollTop<span class=\"token punctuation\">,</span> setScrollTop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ»šåŠ¨ä½ç½®</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">const</span> debouncedInputValue <span class=\"token operator\">=</span> <span class=\"token function\">useDebounce</span><span class=\"token punctuation\">(</span>inputValue<span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> listRef <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HTMLUListElement<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¼•ç”¨ä¸‹æ‹‰åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">const</span> latestRequestRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">const</span> currentRequest <span class=\"token operator\">=</span> <span class=\"token operator\">++</span>latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token function\">fetchSearchResults</span><span class=\"token punctuation\">(</span>debouncedInputValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentRequest <span class=\"token operator\">===</span> latestRequestRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token comment\">// å½“ç»“æœæ›´æ–°æ—¶ï¼Œé‡ç½®æ»šåŠ¨ä½ç½®</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>debouncedInputValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleResultClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>result<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">setInputValue</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">setIsInputFocused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">setResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç‚¹å‡»åæ¸…ç©ºç»“æœï¼Œéšè—ä¸‹æ‹‰æ¡†</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleInputBlur</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token comment\">// å»¶è¿Ÿè®¾ç½® isInputFocused ä¸º falseï¼Œä»¥ä¾¿åœ¨ç‚¹å‡»ä¸‹æ‹‰é¡¹æ—¶æœ‰æ—¶é—´è§¦å‘ handleResultClick</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token function\">setIsInputFocused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">const</span> handleScroll <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token function\">setScrollTop</span><span class=\"token punctuation\">(</span>listRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>scrollTop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">// è™šæ‹Ÿæ»šåŠ¨è®¡ç®—</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">const</span> startIndex <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>scrollTop <span class=\"token operator\">/</span> <span class=\"token constant\">ITEM_HEIGHT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">const</span> endIndex <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> startIndex <span class=\"token operator\">+</span> <span class=\"token constant\">VISIBLE_ITEMS_COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">const</span> visibleResults <span class=\"token operator\">=</span> results<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">,</span> endIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">const</span> paddingTop <span class=\"token operator\">=</span> startIndex <span class=\"token operator\">*</span> <span class=\"token constant\">ITEM_HEIGHT</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">const</span> paddingBottom <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>endIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token constant\">ITEM_HEIGHT</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">,</span> endIndex<span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">,</span> endIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> paddingTop<span class=\"token punctuation\">,</span> paddingBottom<span class=\"token punctuation\">,</span> scrollTop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>relative w-[300px]<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>inputValue<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setInputValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                <span class=\"token attr-name\">onFocus</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setIsInputFocused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                <span class=\"token attr-name\">onBlur</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>handleInputBlur<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                <span class=\"token attr-name\">placeholder</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Search...<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>w-full p-2 border border-gray-300 rounded-md<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            </span><span class=\"token punctuation\">&#123;</span>loading <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>absolute right-2.5 top-2 text-sm text-gray-500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            </span><span class=\"token punctuation\">&#123;</span>isInputFocused <span class=\"token operator\">&amp;&amp;</span> results<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                    <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>listRef<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                    <span class=\"token attr-name\">onScroll</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>handleScroll<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                    <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>absolute top-full left-0 right-0 z-10 list-none p-0 m-0 bg-white border border-gray-300 rounded-md shadow-lg overflow-y-auto<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                    <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\">&lt;!--swigï¿¼0--</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                ></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\">&lt;!--swigï¿¼1--</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        </span><span class=\"token punctuation\">&#123;</span>visibleResults<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                                <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span>result<span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                                <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">handleResultClick</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                                <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>px-2 flex items-center border-b border-gray-100 cursor-pointer box-border hover:bg-gray-50<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                                <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\">&lt;!--swigï¿¼2--</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                            ></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                                </span><span class=\"token punctuation\">&#123;</span>result<span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token plain-text\"></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Search<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "æœç´¢",
                "React",
                "æ€§èƒ½ä¼˜åŒ–"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BF%AB%E6%8D%B7%E9%94%AE%E7%BB%91%E5%AE%9A/",
            "url": "https://aynya.github.io/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BF%AB%E6%8D%B7%E9%94%AE%E7%BB%91%E5%AE%9A/",
            "title": "ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š",
            "date_published": "2025-05-25T13:02:28.000Z",
            "content_html": "<h1 id=\"ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š\"><a class=\"anchor\" href=\"#ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š\">#</a> ä¸ªæ€§åŒ–å¿«æ·é”®ç»‘å®š</h1>\n<p><strong>åœ¨ React åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ react-hotkeys-hook åº“æ¥å®ç°å¿«æ·é”®ç»‘å®šï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘å…ˆæš‚æ—¶ä½¿ç”¨ä¸€ä¸‹æœ€åŸå§‹çš„å†™æ³•ï¼Œå“ˆå“ˆã€‚</strong></p>\n<h2 id=\"æ€è·¯\"><a class=\"anchor\" href=\"#æ€è·¯\">#</a> æ€è·¯</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªå¿«æ·é”®åˆ°äº‹ä»¶çš„æ˜ å°„è¡¨</li>\n<li>æ·»åŠ ç›‘å¬äº‹ä»¶</li>\n<li>è·å–å½“å‰æŒ‰ä¸‹çš„é”®</li>\n<li>åˆ¤æ–­å½“å‰çš„é˜¶æ®µï¼Œå¦‚æœæ˜¯ä¿®æ”¹é˜¶æ®µï¼Œåˆ™ä¿®æ”¹å¯¹åº”äº‹ä»¶çš„å¿«æ·é”®ï¼Œå¦‚æœæ˜¯æ‰§è¡Œé˜¶æ®µï¼Œåˆ™æ‰§è¡Œå¯¹åº”äº‹ä»¶</li>\n</ol>\n<h2 id=\"ä»£ç \"><a class=\"anchor\" href=\"#ä»£ç \">#</a> ä»£ç </h2>\n<pre><code class=\"language-Tsx\">import React, &#123; useState, useEffect, useCallback &#125; from 'react';\n\ninterface Shortcut &#123;\n  event: () =&gt; void;\n  keys: string[];\n&#125;\n\nfunction redo() &#123;\n  console.log('Redo action');\n&#125;\nfunction undo() &#123;\n  console.log('Undo action');\n&#125;\nfunction save() &#123;\n  console.log('Save action');\n&#125;\n\nconst ShortcutManager: React.FC = () =&gt; &#123;\n  // å¿«æ·é”®äº‹ä»¶æ˜ å°„è¡¨\n  const [shortcuts, setShortcuts] = useState&lt;Shortcut[]&gt;([ \n    &#123; event: redo, keys: ['Control', 'z'] &#125;,\n    &#123; event: undo, keys: ['Control', 'y'] &#125;,\n    &#123; event: save, keys: ['Control', 's'] &#125;\n  ]);\n  // ç¼–è¾‘çŠ¶æ€\n  const [editingIndex, setEditingIndex] = useState&lt;number | null&gt;(null);\n  // æ–°çš„å¿«æ·é”®\n  const [newKeys, setNewKeys] = useState&lt;string[]&gt;([]);\n\n  // ç¨³å®šçš„handleKeyDownå‡½æ•°\n  const handleKeyDown = useCallback((e: KeyboardEvent) =&gt; &#123;\n    const newKey: string[] = [];\n    if (e.ctrlKey || e.metaKey) e.preventDefault();\n    if (e.ctrlKey) newKey.push('Control');\n    if (e.altKey) newKey.push('Alt');\n    if (e.shiftKey) newKey.push('Shift');\n    if (e.metaKey) newKey.push('Meta');\n    if (e.key !== 'Control' &amp;&amp; e.key !== 'shift') newKey.push(e.key.toLowerCase());\n    if (editingIndex !== null) &#123;\n      // å¦‚æœåœ¨ç¼–è¾‘çŠ¶æ€ï¼Œæ›´æ–°æ–°çš„å¿«æ·é”®\n      const updatedShortcuts = shortcuts.map((sc, idx) =&gt; &#123;\n        if (idx === editingIndex) &#123;\n          return &#123; ...sc, keys: newKey &#125;;\n        &#125;\n        return sc;\n      &#125;);\n      setShortcuts(updatedShortcuts);\n    &#125; else &#123;\n      // å¦‚æœä¸åœ¨ç¼–è¾‘çŠ¶æ€ï¼Œæ‰§è¡Œå¯¹åº”çš„å¿«æ·é”®äº‹ä»¶\n      const shortcut = shortcuts.find(sc =&gt; sc.keys.join('+') === newKey.join('+'));\n      shortcut?.event();\n    &#125;\n  &#125;, [editingIndex, shortcuts]);\n\n  // æ·»åŠ å’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨\n  useEffect(() =&gt; &#123;\n    window.addEventListener('keydown', handleKeyDown);\n    return () =&gt; &#123;\n      window.removeEventListener('keydown', handleKeyDown);\n    &#125;;\n  &#125;, [editingIndex, handleKeyDown]);\n\n  const startEditing = (index: number) =&gt; &#123;\n    setEditingIndex(index);\n    setNewKeys([]);\n  &#125;;\n\n  const stopEditing = () =&gt; &#123;\n    setEditingIndex(null);\n    if (newKeys.length &gt; 0) &#123;\n      const updatedShortcuts = shortcuts.map((sc, idx) =&gt; idx === editingIndex ? &#123; ...sc, keys: newKeys &#125; : sc);\n      setShortcuts(updatedShortcuts);\n    &#125;\n  &#125;;\n\n  return (\n    &lt;div&gt;\n      &#123;shortcuts.map((sc, index) =&gt; (\n        &lt;div key=&#123;index&#125;&gt;\n          &lt;span&gt;&#123;sc.event.name&#125;å¿«æ·é”®&lt;/span&gt;\n          &lt;span&gt;&#123;sc.keys.join('+')&#125;&lt;/span&gt;\n          &#123;editingIndex === index ? (\n            &lt;button onClick=&#123;stopEditing&#125;&gt;å®Œæˆ&lt;/button&gt;\n          ) : (\n            &lt;button onClick=&#123;() =&gt; startEditing(index)&#125;&gt;ä¿®æ”¹&lt;/button&gt;\n          )&#125;\n        &lt;/div&gt;\n      ))&#125;\n    &lt;/div&gt;\n  );\n&#125;;\n\nfunction App() &#123;\n  return (\n    &lt;div className=&quot;App&quot;&gt;\n      &lt;ShortcutManager /&gt;\n    &lt;/div&gt;\n  );\n&#125;\n\nexport default App;\n</code></pre>\n",
            "tags": [
                "ä½“éªŒ",
                "React",
                "å¿«æ·é”®"
            ]
        },
        {
            "id": "https://aynya.github.io/%E4%BD%BF%E7%94%A8Konva-Tween%E5%AE%9E%E7%8E%B0%E6%8B%96%E6%8B%BD%E5%90%8E%E7%9A%84%E6%83%AF%E6%80%A7%E5%8A%A8%E7%94%BB/",
            "url": "https://aynya.github.io/%E4%BD%BF%E7%94%A8Konva-Tween%E5%AE%9E%E7%8E%B0%E6%8B%96%E6%8B%BD%E5%90%8E%E7%9A%84%E6%83%AF%E6%80%A7%E5%8A%A8%E7%94%BB/",
            "title": "ä½¿ç”¨Konva.Tweenå®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»",
            "date_published": "2025-05-25T09:22:05.000Z",
            "content_html": "<h1 id=\"ä½¿ç”¨konvatweenå®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»\"><a class=\"anchor\" href=\"#ä½¿ç”¨konvatweenå®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»\">#</a> ä½¿ç”¨ Konva.Tween å®ç°æ‹–æ‹½åçš„æƒ¯æ€§åŠ¨ç”»</h1>\n<p><strong>åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼Œä¸ºç”¨æˆ·æä¾›æµç•…è‡ªç„¶çš„äº¤äº’ä½“éªŒè‡³å…³é‡è¦ã€‚é€šè¿‡ä¸ºæ‹–æ‹½æ“ä½œæ·»åŠ æƒ¯æ€§æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥è®©åº”ç”¨æ„Ÿè§‰æ›´åŠ ç”ŸåŠ¨å’Œè‡ªç„¶ã€‚</strong></p>\n<h2 id=\"å‡†å¤‡å·¥ä½œ\"><a class=\"anchor\" href=\"#å‡†å¤‡å·¥ä½œ\">#</a> å‡†å¤‡å·¥ä½œ</h2>\n<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿å·²å®‰è£… Konva.js åº“ã€‚</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> konva</pre></td></tr></table></figure><p>æˆ–è€…è¯´ç›´æ¥åœ¨ HTML ä¸­ç›´æ¥å¼•ç”¨</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/konva@8.3.10/konva.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"åˆ›å»ºåœºæ™¯å’ŒèŠ‚ç‚¹\"><a class=\"anchor\" href=\"#åˆ›å»ºåœºæ™¯å’ŒèŠ‚ç‚¹\">#</a> åˆ›å»ºåœºæ™¯å’ŒèŠ‚ç‚¹</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªåœºæ™¯å’Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ·»åŠ åˆ°åœºæ™¯ä¸­ã€‚</li>\n<li>æ¯æ¬¡æ‹–æ‹½æ—¶éƒ½è®¡ç®—é€Ÿåº¦ï¼ˆä¸ä¸Šæ¬¡æ‹–æ‹½ä½ç½®çš„å·®å€¼ï¼‰</li>\n<li>åˆ›å»ºä¸€ä¸ª Tween å¯¹è±¡ï¼Œå¹¶è®¾ç½®å…¶å±æ€§ä¸ºèŠ‚ç‚¹çš„ä½ç½®å’Œé€Ÿåº¦</li>\n</ol>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/konva@8.3.10/konva.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token comment\">// åˆ›å»ºèˆå°å’Œå›¾å±‚</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">const</span> height <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>innerHeight<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">const</span> stage <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Stage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token literal-property property\">container</span><span class=\"token operator\">:</span> <span class=\"token string\">\"container\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token literal-property property\">height</span><span class=\"token operator\">:</span> height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">let</span> layer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Layer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      stage<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">let</span> rect <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token literal-property property\">height</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token literal-property property\">fill</span><span class=\"token operator\">:</span> <span class=\"token string\">\"green\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token literal-property property\">draggable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      layer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>rect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      layer<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token keyword\">let</span> lastTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">let</span> lastPos <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">let</span> lastVelocity <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token keyword\">let</span> lastVelocitx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">function</span> <span class=\"token function\">calculateVelocity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token keyword\">const</span> dt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastPos<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastPos<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dt <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            lastVelocitx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            lastVelocity <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            lastVelocitx <span class=\"token operator\">=</span> dx <span class=\"token operator\">/</span> dt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            lastVelocity <span class=\"token operator\">=</span> dy <span class=\"token operator\">/</span> dt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token comment\">// console.log('Velocity:', lastVelocity);</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        lastTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        lastPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      rect<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dragstart\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        lastTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        lastPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      rect<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dragmove\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token function\">calculateVelocity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      rect<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dragend\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>lastVelocitx<span class=\"token punctuation\">,</span> lastVelocity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token keyword\">const</span> targetX <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> lastVelocitx <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ ¹æ®é€Ÿåº¦é¢„æµ‹ç»ˆç‚¹</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">const</span> targetY <span class=\"token operator\">=</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> lastVelocity <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token comment\">// ä½¿ç”¨ Tween åˆ›å»ºæƒ¯æ€§åŠ¨ç”»</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Tween</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          <span class=\"token literal-property property\">node</span><span class=\"token operator\">:</span> rect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          <span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// åŠ¨ç”»æŒç»­æ—¶é—´</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          <span class=\"token literal-property property\">easing</span><span class=\"token operator\">:</span> Konva<span class=\"token punctuation\">.</span>Easings<span class=\"token punctuation\">.</span>EaseOut<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ç¼“åŠ¨å‡½æ•°</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> targetX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> targetY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"tweenå±æ€§è¯¦è§£\"><a class=\"anchor\" href=\"#tweenå±æ€§è¯¦è§£\">#</a> Tween å±æ€§è¯¦è§£</h2>\n<h3 id=\"æ ¸å¿ƒå±æ€§è¯´æ˜\"><a class=\"anchor\" href=\"#æ ¸å¿ƒå±æ€§è¯´æ˜\">#</a> æ ¸å¿ƒå±æ€§è¯´æ˜</h3>\n<ol>\n<li>\n<p><strong>node</strong>ï¼ˆå¿…å¡«ï¼‰</p>\n<ul>\n<li>ç±»å‹ï¼š <code>Konva.Node</code></li>\n<li>ä½œç”¨ï¼šæŒ‡å®šè¦åº”ç”¨åŠ¨ç”»çš„èŠ‚ç‚¹å¯¹è±¡ï¼ˆå¦‚  <code>rect</code>   <code>circle</code>  ç­‰ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>node: rect</code></li>\n</ul>\n</li>\n<li>\n<p><strong>duration</strong>ï¼ˆå¿…å¡«ï¼‰</p>\n<ul>\n<li>ç±»å‹ï¼š <code>Number</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>duration: 1</code>  è¡¨ç¤º 1 ç§’å®ŒæˆåŠ¨ç”»</li>\n<li>æ³¨æ„ï¼šç»“åˆ  <code>easing</code>  å‡½æ•°å¯å®ç°ç¼“åŠ¨æ•ˆæœ</li>\n</ul>\n</li>\n<li>\n<p><strong>easing</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Function</code></li>\n<li>ä½œç”¨ï¼šæ§åˆ¶åŠ¨ç”»çš„ç¼“åŠ¨æ›²çº¿</li>\n<li>å¸¸ç”¨é¢„è®¾ï¼š\n<ul>\n<li><code>Konva.Easings.Linear</code>  çº¿æ€§åŒ€é€Ÿ</li>\n<li><code>Konva.Easings.EaseIn</code>  å…ˆæ…¢åå¿«</li>\n<li><code>Konva.Easings.EaseOut</code>  å…ˆå¿«åæ…¢ï¼ˆé€‚åˆæƒ¯æ€§æ•ˆæœï¼‰</li>\n<li><code>Konva.Easings.EaseInOut</code>  æ…¢ - å¿« - æ…¢</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>ç›®æ ‡å±æ€§</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Number</code></li>\n<li>ä½œç”¨ï¼šæŒ‡å®šèŠ‚ç‚¹è¦åŠ¨ç”»åˆ°çš„ç›®æ ‡å±æ€§å€¼ï¼ˆå¯è®¾ç½®å¤šä¸ªï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>x: targetX, y: targetY, rotation: 360</code></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"é«˜çº§é…ç½®\"><a class=\"anchor\" href=\"#é«˜çº§é…ç½®\">#</a> é«˜çº§é…ç½®</h3>\n<ol start=\"5\">\n<li>\n<p><strong>onFinish</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Function</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»ç»“æŸæ—¶çš„å›è°ƒå‡½æ•°</li>\n<li>ç¤ºä¾‹ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function-variable function\">onFinish</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'åŠ¨ç”»å®Œæˆ'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>\n<p><strong>onUpdate</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Function</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»æ¯å¸§æ›´æ–°æ—¶çš„å›è°ƒ</li>\n<li>ç¤ºä¾‹ï¼š<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function-variable function\">onUpdate</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  layer<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰‹åŠ¨é‡ç»˜å›¾å±‚</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>\n<p><strong>repeat</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Number</code></li>\n<li>ä½œç”¨ï¼šåŠ¨ç”»é‡å¤æ¬¡æ•°ï¼ˆ0 è¡¨ç¤ºä¸é‡å¤ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>repeat: 2</code>  åŠ¨ç”»å°†æ‰§è¡Œ 3 æ¬¡ï¼ˆåˆå§‹ 1 æ¬¡ + é‡å¤ 2 æ¬¡ï¼‰</li>\n</ul>\n</li>\n<li>\n<p><strong>yoyo</strong></p>\n<ul>\n<li>ç±»å‹ï¼š <code>Boolean</code></li>\n<li>ä½œç”¨ï¼šæ˜¯å¦å¼€å¯å¾€è¿”åŠ¨ç”»ï¼ˆéœ€è¦é…åˆ repeat ä½¿ç”¨ï¼‰</li>\n<li>ç¤ºä¾‹ï¼š <code>yoyo: true</code>  åŠ¨ç”»ä¼šæ­£å‘æ’­æ”¾ååå‘æ’­æ”¾</li>\n</ul>\n</li>\n</ol>\n",
            "tags": [
                "Canvas",
                "Konva",
                "æƒ¯æ€§åŠ¨ç”»"
            ]
        },
        {
            "id": "https://aynya.github.io/%E6%89%8B%E5%86%99Promise/",
            "url": "https://aynya.github.io/%E6%89%8B%E5%86%99Promise/",
            "title": "æ‰‹å†™Promise",
            "date_published": "2025-04-26T13:48:44.000Z",
            "content_html": "<h1 id=\"æ‰‹å†™promise\"><a class=\"anchor\" href=\"#æ‰‹å†™promise\">#</a> æ‰‹å†™ Promise</h1>\n<h2 id=\"æ„é€ å‡½æ•°\"><a class=\"anchor\" href=\"#æ„é€ å‡½æ•°\">#</a> æ„é€ å‡½æ•°</h2>\n<p><strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>å®šä¹‰ç±» =&gt; æ·»åŠ æ„é€ å‡½æ•° =&gt; å®šä¹‰resolve/reject =&gt; æ‰§è¡Œå›è°ƒå‡½æ•°\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// state = PENDING;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// result = undefined;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"çŠ¶æ€åŠåŸå› \"><a class=\"anchor\" href=\"#çŠ¶æ€åŠåŸå› \">#</a> çŠ¶æ€åŠåŸå› </h2>\n<p><strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>æ·»åŠ çŠ¶æ€ =&gt; æ·»åŠ åŸå›  =&gt; è°ƒæ•´resolve/reject =&gt; çŠ¶æ€ä¸å¯é€†\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"thenæ–¹æ³•\"><a class=\"anchor\" href=\"#thenæ–¹æ³•\">#</a> then æ–¹æ³•</h2>\n<h3 id=\"æˆåŠŸæˆ–å¤±è´¥å›è°ƒ\"><a class=\"anchor\" href=\"#æˆåŠŸæˆ–å¤±è´¥å›è°ƒ\">#</a> æˆåŠŸæˆ–å¤±è´¥å›è°ƒ</h3>\n<p>æ ¹æ®å½“å‰çš„çŠ¶æ€ï¼Œæ‰§è¡Œå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚ç‰¹æ®Šçš„å¦‚æœä¼ å…¥çš„å›è°ƒå‡½æ•°ä¸æ˜¯å‡½æ•°ï¼Œè¿”å›åŸå€¼<br />\n<strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>æ·»åŠ å®ä¾‹æ–¹æ³• =&gt; å‚æ•°åˆ¤æ–­ =&gt; æ‰§è¡ŒæˆåŠŸ/å¤±è´¥å›è°ƒ\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¼‚æ­¥å’Œå¤šæ¬¡è°ƒç”¨\"><a class=\"anchor\" href=\"#å¼‚æ­¥å’Œå¤šæ¬¡è°ƒç”¨\">#</a> å¼‚æ­¥å’Œå¤šæ¬¡è°ƒç”¨</h3>\n<p>æ ¹æ®å½“å‰çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ pendingï¼Œå…ˆå°†å›è°ƒå‡½æ•°ä¿å­˜èµ·æ¥ï¼Œç­‰çŠ¶æ€æ”¹å˜åï¼Œå†æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚å¦‚æœå¤šæ¬¡è°ƒç”¨ thenï¼Œå°†å›è°ƒå‡½æ•°ä¿å­˜èµ·æ¥ï¼Œç­‰çŠ¶æ€æ”¹å˜åï¼Œå†æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚<br />\n<strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>å®šä¹‰å®ä¾‹å±æ€§ =&gt; ä¿å­˜å›è°ƒå‡½æ•° =&gt; æ‰§è¡ŒæˆåŠŸ/å¤±è´¥å›è°ƒ\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [&#123;onFulfilled, onRejected&#125;, ã€‚ã€‚ã€‚]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onFulfilled<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onRejected<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                onFulfilled<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                onRejected</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"å¼‚æ­¥ä»»åŠ¡\"><a class=\"anchor\" href=\"#å¼‚æ­¥ä»»åŠ¡\">#</a> å¼‚æ­¥ä»»åŠ¡</h2>\n<p>å…ˆæ‰§è¡Œå®é˜Ÿåˆ—ï¼Œå†æ‰§è¡Œå¾®é˜Ÿåˆ—ã€‚<br />\nè€Œ Promise æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å…ˆæ‰§è¡Œå¾®é˜Ÿåˆ—ï¼Œå†æ‰§è¡Œå®é˜Ÿåˆ—ã€‚<br />\n<strong>æ ¸å¿ƒæ­¥éª¤</strong>ï¼š</p>\n<pre><code>å®šä¹‰å‡½æ•° =&gt; è°ƒç”¨æ ¸å¿ƒAPI =&gt; è°ƒç”¨å‡½æ•°\n</code></pre>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [&#123;onFulfilled, onRejected&#125;, ã€‚ã€‚ã€‚]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onFulfilled<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token comment\">// æ‰§è¡Œå›è°ƒ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span>onRejected<span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token function-variable function\">onFulfilled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                        <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token function-variable function\">onRejected</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> queueMicrotask <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token function\">queueMicrotask</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> MutationObserver <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token keyword\">const</span> obs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token keyword\">const</span> divNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        obs<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>divNode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span><span class=\"token literal-property property\">childList</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        divNode<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<ol>\n<li><strong>æ„é€ å‡½æ•°</strong><br />\næ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå™¨å‡½æ•° <code>executor</code> ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š   <code>resolve</code>  å’Œ <code>reject</code> ã€‚è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ç”¨äºå°† <code>Promise</code>  çš„çŠ¶æ€ä» <code>pending</code>  è½¬å˜ä¸º <code>fulfilled</code>  å’Œ <code>rejected</code> ã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// å½“å‰çŠ¶æ€ï¼Œé»˜è®¤ä¸º pending</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// å­˜å‚¨ resolve æˆ– reject çš„ç»“æœ</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>            <span class=\"token comment\">// å­˜å‚¨ then æ–¹æ³•ä¸­æ³¨å†Œçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending è½¬å˜ä¸º fulfilled</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„ onFulfilled å›è°ƒ</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onFulfilled <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending è½¬å˜ä¸º rejected</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„ onRejected å›è°ƒ</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onRejected <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœæ‰§è¡Œå™¨æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ç›´æ¥è°ƒç”¨ reject</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>then æ–¹æ³•</strong><br />\n <code>then</code>  æ–¹æ³•å…è®¸æˆ‘ä»¬ä¸º <code>Promise</code>  æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°ã€‚æ— è®ºå½“å‰ <code>Promise</code>  çš„çŠ¶æ€æ˜¯ <code>fulfilled</code>  è¿˜æ˜¯ <code>rejected</code> ï¼Œ <code>then</code>  æ–¹æ³•éƒ½ä¼šè§¦å‘ç›¸åº”çš„å›è°ƒã€‚å¦‚æœ <code>Promise</code>  ä»ç„¶å¤„äº <code>pending</code>  çŠ¶æ€ï¼Œåˆ™ä¼šå°†å›è°ƒå­˜å‚¨èµ·æ¥ï¼Œç­‰åˆ°çŠ¶æ€æ”¹å˜æ—¶å†æ‰§è¡Œã€‚</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// å¦‚æœ then çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™æä¾›é»˜è®¤å®ç°</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token function-variable function\">onFulfilled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                            <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                            <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token function-variable function\">onRejected</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                            <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                            <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">return</span> p2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿”å›æ–°çš„ Promise</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>é™æ€æ–¹æ³•</strong><br />\nä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œè¿˜å®ç°äº†ä¸¤ä¸ªé™æ€æ–¹æ³• <code>resolve</code>  å’Œ <code>reject</code> ï¼Œå®ƒä»¬å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå·²ç»æˆ–æ‹’ç»çš„ <code>Promise</code></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li><strong>è§£æè¿”å›å€¼å‡½æ•°</strong><br />\nå½“ <code>then</code>  æ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªå€¼ã€‚å¦‚æœè¿”å›çš„æ˜¯å¦ä¸€ä¸ª <code>Promise</code> ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…å®ƒçš„çŠ¶æ€å˜åŒ–ï¼›å¦åˆ™ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªå€¼ä½œä¸ºæ–° <code>Promise</code>  çš„ç»“æœ</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chaining cycle detected for promise'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        x<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li><strong>å¼‚æ­¥ä»»åŠ¡</strong><br />\nä¸ºäº†ç¡®ä¿å›è°ƒå‡½æ•°æ€»æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•° <code>runAsynctask</code>  æ¥è°ƒåº¦ä»»åŠ¡ï¼Œä¼˜å…ˆå°è¯•ä½¿ç”¨ <code>queueMicrotask</code> ï¼Œå¦‚æœä¸æ”¯æŒåˆ™å›é€€åˆ° <code>MutationObserver</code>  æˆ– <code>setTimeout</code></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> queueMicrotask <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token function\">queueMicrotask</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> MutationObserver <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> obs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">const</span> divNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        obs<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>divNode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">childList</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        divNode<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li><strong>ä»£ç </strong></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// ä¸‰ç§çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPromise</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    #handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨ then æ–¹æ³•ä¸­æ³¨å†Œçš„å›è°ƒå‡½æ•° [&#123;onFulfilled, onRejected&#125;, ã€‚ã€‚ã€‚]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ– Promise</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     * @param &#123;Function&#125; executor - æ‰§è¡Œå™¨å‡½æ•°ï¼Œæ¥æ”¶ resolve å’Œ reject ä½œä¸ºå‚æ•°</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending -> fulfilled</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onFulfilled <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// æ”¹çŠ¶æ€: pending -> rejected</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ç¡®ä¿çŠ¶æ€åªèƒ½ä» pending -> rejected</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> reason<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token comment\">// è§¦å‘æ‰€æœ‰å·²æ³¨å†Œçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> onRejected <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">// æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„æ‰§è¡Œå™¨å‡½æ•°ï¼Œä¼ å…¥ resolve å’Œ reject</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœæ‰§è¡Œå™¨å‡½æ•°æ‰§è¡Œå‡ºé”™ï¼Œåˆ™è°ƒç”¨ reject</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>     * æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>     * @param &#123;Function&#125; onFulfilled - æˆåŠŸæ—¶çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>     * @param &#123;Function&#125; onRejected - å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ then ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œå‚è€ƒ MDN æ–‡æ¡£è¿”å›</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        onFulfilled <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onFulfilled <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        onRejected <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> onRejected <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">:</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">throw</span> reason <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">// è¿”å›æ–°çš„ promise</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">const</span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token comment\">// å½“å‰çŠ¶æ€ä¸º fulfilledï¼Œåˆ™ç›´æ¥è°ƒç”¨ onFulfilled</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                        <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                        <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è§£æå›è°ƒå‡½æ•°çš„è¿”å›å€¼</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                <span class=\"token comment\">// å½“å‰çŠ¶æ€ä¸º rejectedï¼Œåˆ™ç›´æ¥è°ƒç”¨ onRejected</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                        <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ‰§è¡Œå›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                        <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è§£æå›è°ƒå‡½æ•°çš„è¿”å›å€¼</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token comment\">// å½“å‰çŠ¶æ€ä¸º pendingï¼Œåˆ™å°†å›è°ƒå‡½æ•°å­˜å‚¨èµ·æ¥ï¼Œå¾…çŠ¶æ€æ”¹å˜æ—¶å†æ‰§è¡Œ</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    <span class=\"token function-variable function\">onFulfilled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                        <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                                <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                                <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                    <span class=\"token function-variable function\">onRejected</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                        <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                                <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                                <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token keyword\">return</span> p2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿”å›æ–°çš„ promise</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>     * æ³¨å†Œå¤±è´¥çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>     * @param &#123;Function&#125; onRejected - å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>onRejected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>     * æ³¨å†Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>     * @param &#123;Function&#125; callback - æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>     */</span>    </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token function\">finally</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œ</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>     * å°†ä¼ å…¥çš„å€¼è½¬ä¸ºä¸€ä¸ª resolved çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>     * @param &#123;*&#125; value - éœ€è¦è½¬æ¢çš„å€¼</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ª resolved çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>            <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœå·²ç»æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è½¬æ¢ä¸º resolved çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>     * è¿”å›ä¸€ä¸ª rejected çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>     * @param &#123;*&#125; reason - æ‹’ç»çš„åŸå› </pre></td></tr><tr><td data-num=\"143\"></td><td><pre>     * @returns &#123;MyPromise&#125; è¿”å›ä¸€ä¸ª rejected çŠ¶æ€çš„ Promise</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åˆ›å»ºä¸€ä¸ªæ–°çš„ rejected Promise</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"153\"></td><td><pre> * è§£æ Promise çš„è¿”å›å€¼ xï¼Œå¹¶å†³å®šå¦‚ä½•æ›´æ–°æ–°çš„ Promise p2 çš„çŠ¶æ€</pre></td></tr><tr><td data-num=\"154\"></td><td><pre> * @param &#123;MyPromise&#125; p2 - æ–°çš„ Promise å¯¹è±¡</pre></td></tr><tr><td data-num=\"155\"></td><td><pre> * @param &#123;*&#125; x - then å›è°ƒå‡½æ•°çš„è¿”å›å€¼</pre></td></tr><tr><td data-num=\"156\"></td><td><pre> * @param &#123;Function&#125; resolve - p2 çš„ resolve å‡½æ•°</pre></td></tr><tr><td data-num=\"157\"></td><td><pre> * @param &#123;Function&#125; reject - p2 çš„ reject å‡½æ•°</pre></td></tr><tr><td data-num=\"158\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p2<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ x æ˜¯ p2 æœ¬èº«ï¼ŒæŠ›å‡ºå¾ªç¯å¼•ç”¨é”™è¯¯</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chaining cycle detected for promise'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">MyPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœ x æ˜¯ä¸€ä¸ª Promise é€’å½’è§£æçŠ¶æ€</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        x<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre></pre></td></tr><tr><td data-num=\"176\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"177\"></td><td><pre> * å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼ˆå¾®ä»»åŠ¡ä¼˜å…ˆï¼‰</pre></td></tr><tr><td data-num=\"178\"></td><td><pre> * @param &#123;Function&#125; callback - éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡</pre></td></tr><tr><td data-num=\"179\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">runAsynctask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> queueMicrotask <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>        <span class=\"token function\">queueMicrotask</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> MutationObserver <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token keyword\">const</span> obs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        <span class=\"token keyword\">const</span> divNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        obs<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>divNode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">childList</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>        divNode<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "JavaScript",
                "JavaScript",
                "Promise"
            ]
        },
        {
            "id": "https://aynya.github.io/%E5%A4%9A%E7%A7%8D%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/",
            "url": "https://aynya.github.io/%E5%A4%9A%E7%A7%8D%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/",
            "title": "å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º",
            "date_published": "2025-04-17T10:04:44.000Z",
            "content_html": "<h1 id=\"å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º\"><a class=\"anchor\" href=\"#å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º\">#</a> å¤šç§æ ¼å¼çš„å¯¼å…¥å¯¼å‡º</h1>\n<p>æ”¯æŒ <code>JSON</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€ä¸“æœ‰æ–‡ä»¶ <code>dmp</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€ <code>xlsx</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€ <code>md</code>  æ ¼å¼çš„å¯¼å…¥å¯¼å‡ºã€‚<br />\næ”¯æŒå¯¼å‡º <code>png</code> ã€ <code>jpg</code> ã€ <code>svg</code> ã€ <code>pdf</code>  æ ¼å¼ã€‚</p>\n<p>è¿™é‡Œä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å°ºå¯¸å­—æ®µ [width, height]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// æ–°å¢æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢æ–¹å‘å±æ€§ (åªåœ¨ center å¸ƒå±€ä¸­ä½¿ç”¨)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">State</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'top-to-bottom'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å¸ƒå±€é£æ ¼å±æ€§</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"json\"><a class=\"anchor\" href=\"#json\">#</a> JSON</h2>\n<h3 id=\"å¯¼å‡º\"><a class=\"anchor\" href=\"#å¯¼å‡º\">#</a> å¯¼å‡º</h3>\n<p>æ„å»ºåˆ†å±‚é€’å½’çš„ json å­—ç¬¦ä¸²ï¼Œç„¶åä¿å­˜åˆ°æœ¬åœ°ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º JSON æ–‡ä»¶</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsJSON</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// é€’å½’æ„å»ºåˆ†å±‚èŠ‚ç‚¹ç»“æ„</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> buildHierarchy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// æ„å»ºå½“å‰èŠ‚ç‚¹çš„å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> currentNode <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            text<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            position<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            children<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token function\">buildHierarchy</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>Boolean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            size<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            collapsed<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            direction<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>direction</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> currentNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹é€’å½’æ„å»ºæ•´ä¸ªæ ‘</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> <span class=\"token function\">buildHierarchy</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// æ„é€ æœ€ç»ˆå¯¼å‡ºçš„æ•°æ®</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        nodes<span class=\"token operator\">:</span> root<span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¯¼å‡ºçš„èŠ‚ç‚¹æ˜¯åˆ†å±‚çš„ç»“æ„</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        connections<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>connections</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»º Blob å¹¶ä¿å­˜æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥\"><a class=\"anchor\" href=\"#å¯¼å…¥\">#</a> å¯¼å…¥</h3>\n<p>å®šä¹‰ json èŠ‚ç‚¹ç±»å‹</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">JSONNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> JSONNode<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¯é€‰å±æ€§</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è§£æ json æ–‡ä»¶å†…å®¹ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè§£ææˆåŠŸè¿”å›ä¸€ä¸ª State å¯¹è±¡ï¼Œè§£æå¤±è´¥è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚<br />\né€’å½’æ„å»ºèŠ‚ç‚¹ç»“æ„ï¼Œæ›´æ–°åˆ° store ä¸­ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šé€’å½’è§£æå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">const</span> parseHierarchy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> JSONNode<span class=\"token punctuation\">,</span> parsedData<span class=\"token operator\">:</span> ParsedData<span class=\"token punctuation\">,</span> parentId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> collapsed<span class=\"token punctuation\">,</span> direction <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token comment\">// åˆ›å»º</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token keyword\">const</span> currentNode<span class=\"token operator\">:</span> Node <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        position<span class=\"token operator\">:</span> position <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›ä½ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        size<span class=\"token operator\">:</span> size <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›å°ºå¯¸ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        collapsed<span class=\"token operator\">:</span> collapsed <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›æŠ˜å çŠ¶æ€ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        direction<span class=\"token operator\">:</span> direction<span class=\"token operator\">||</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ–¹å‘å±æ€§æ˜¯å¯é€‰çš„</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token comment\">// æ·»åŠ åˆ°èŠ‚ç‚¹è®°å½•</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> currentNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token comment\">// å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å»ºç«‹è¿æ¥</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parentId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token comment\">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>children <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                            <span class=\"token function\">parseHierarchy</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token comment\">// è¯»å–</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Empty file content'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token comment\">// è§£æ JSON æ•°æ®</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token comment\">// åˆå§‹åŒ–</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token keyword\">const</span> parsedData<span class=\"token operator\">:</span> ParsedData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    connections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>nodes <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid JSON structure'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token comment\">// è§£æèŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token function\">parseHierarchy</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–°å…¨å±€çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                    connections<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading JSON file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid JSON file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"dmp\"><a class=\"anchor\" href=\"#dmp\">#</a> dmp</h2>\n<p><code>dmp</code>  æ ¼å¼æ˜¯æˆ‘è¿™ä¸ªæ€ç»´å¯¼å›¾çš„ä¸“æœ‰æ ¼å¼ï¼Œå®ƒåŒ…å«èŠ‚ç‚¹ä¿¡æ¯ã€è¿çº¿ä¿¡æ¯ã€å¸ƒå±€ä¿¡æ¯ç­‰ã€‚</p>\n<h3 id=\"å¯¼å‡º-2\"><a class=\"anchor\" href=\"#å¯¼å‡º-2\">#</a> å¯¼å‡º</h3>\n<p>ç›´æ¥å°† state è½¬æ¢ä¸º json å­—ç¬¦ä¸²ï¼Œç„¶åä¿å­˜åˆ°æœ¬åœ°ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸ºä¸“æœ‰æ–‡ä»¶ dmp æ ¼å¼</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsDMP</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// æ„é€ æœ€ç»ˆå¯¼å‡ºçš„æ•°æ®</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        nodes<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ‰å¹³åŒ–ä¸º Node å¯¹è±¡æ•°ç»„</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        connections<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        selectedNodeId<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>selectedNodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        layoutStyle<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>layoutStyle</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>type<span class=\"token operator\">:</span> <span class=\"token string\">'application/dmp'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.dmp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥-2\"><a class=\"anchor\" href=\"#å¯¼å…¥-2\">#</a> å¯¼å…¥</h3>\n<p>ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè§£æ json å¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡æ•°ç»„è½¬æ¢åˆ° store ä¸­éœ€è¦çš„æ˜ å°„å½¢å¼ï¼Œæ›´æ–° state</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å…¥ DMP æ–‡ä»¶</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param file - DMP æ–‡ä»¶å¯¹è±¡</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @returns Promise&lt;void></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromDMP <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// è¯»å–æ–‡ä»¶å†…å®¹</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>content<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Empty file content'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token comment\">// è§£æ DMP æ ¼å¼</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>nodes <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>data<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid DMP structure'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">// åˆå§‹åŒ–</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">const</span> parsedData<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token comment\">// è§£æèŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                data<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> Node<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// å¯¹è±¡æ•°ç»„è½¬æ˜ å°„</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    parsedData<span class=\"token punctuation\">[</span>node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–°å…¨å±€çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    connections<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>selectedNodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>layoutStyle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading DMP file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid DMP file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"xlsx\"><a class=\"anchor\" href=\"#xlsx\">#</a> XLSX</h2>\n<p><code>XLSX</code>  æ ¼å¼æ˜¯ Excel è¡¨æ ¼çš„æ ¼å¼ï¼Œå®ƒåŒ…å«èŠ‚ç‚¹ä¿¡æ¯ã€è¿çº¿ä¿¡æ¯ã€å¸ƒå±€ä¿¡æ¯ç­‰ã€‚</p>\n<h3 id=\"å¯¼å‡º-3\"><a class=\"anchor\" href=\"#å¯¼å‡º-3\">#</a> å¯¼å‡º</h3>\n<p>åœ¨å¯¼å‡ºä¸º <code>Excel</code>  æ—¶éœ€è¦å¯¼å…¥ <code>xlsx</code>  åº“ï¼Œç„¶åä½¿ç”¨ <code>xlsx</code>  åº“çš„ <code>utils.json_to_sheet</code>  æ–¹æ³•å°†æ•°æ®è½¬æ¢ä¸º <code>sheet</code> ï¼Œå†ä½¿ç”¨ <code>xlsx</code>  åº“çš„ <code>writeFile</code>  æ–¹æ³•å°† <code>sheet</code>  å†™å…¥æ–‡ä»¶ã€‚<br />\nåˆ†ä¸º nodes è¡¨æ ¼å’Œ connections è¡¨æ ¼ä»¥åŠ global state è¡¨æ ¼ã€‚<br />\nå°†è¿™äº›è¡¨æ ¼å†™å…¥æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ–‡ä»¶åã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º Excel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsExcel</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes<span class=\"token punctuation\">,</span> connections<span class=\"token punctuation\">,</span> selectedNodeId<span class=\"token punctuation\">,</span> layoutStyle <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// Nodes è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> nodesData <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        text<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        position_x<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        position_y<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        size_width<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        size_height<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        collapsed<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        direction<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// Connections è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">const</span> connectionsData <span class=\"token operator\">=</span> connections<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> from<span class=\"token punctuation\">,</span> to <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// Global State è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> globalStateData <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span> key<span class=\"token operator\">:</span> <span class=\"token string\">'selectedNodeId'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> selectedNodeId <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span> key<span class=\"token operator\">:</span> <span class=\"token string\">'layoutStyle'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> layoutStyle <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºå·¥ä½œç°¿</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">const</span> workbook <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ  Nodes å·¥ä½œè¡¨</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">const</span> nodesWorksheet <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">json_to_sheet</span><span class=\"token punctuation\">(</span>nodesData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_append_sheet</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> nodesWorksheet<span class=\"token punctuation\">,</span> <span class=\"token string\">'Nodes'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ  Connections å·¥ä½œè¡¨</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">const</span> connectionsWorksheet <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">json_to_sheet</span><span class=\"token punctuation\">(</span>connectionsData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_append_sheet</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> connectionsWorksheet<span class=\"token punctuation\">,</span> <span class=\"token string\">'Connections'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ  Global State å·¥ä½œè¡¨</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">const</span> globalStateWorksheet <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">json_to_sheet</span><span class=\"token punctuation\">(</span>globalStateData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">book_append_sheet</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> globalStateWorksheet<span class=\"token punctuation\">,</span> <span class=\"token string\">'Global State'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">// å¯¼å‡ºæ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span>workbook<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap_data.xlsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥-3\"><a class=\"anchor\" href=\"#å¯¼å…¥-3\">#</a> å¯¼å…¥</h3>\n<p>å®šä¹‰æ•°æ®ç»“æ„</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰è§£æåçš„æ•°æ®ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">NodeRow</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    position_x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    position_y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    size_width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    size_height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­—ç¬¦ä¸² 'true' æˆ– 'false'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">ConnectionRow</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    from<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    to<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">GlobalStateRow</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    value<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç”±äº <code>xlsx</code>  æ–‡ä»¶çš„æ ¼å¼æ˜¯ <code>ArrayBuffer</code> ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸º <code>ArrayBuffer</code> ï¼Œå†ä½¿ç”¨ <code>xlsx</code>  åº“çš„ <code>read</code>  æ–¹æ³•è§£ææ–‡ä»¶ã€‚<br />\nç„¶åæŠŠä¸‰ä¸ªè¡¨æ ¼åˆ†åˆ«è§£æä¸º <code>Node</code> ã€ <code>Connection</code>  å’Œ <code>GlobalState</code>  å¯¹è±¡ï¼Œå¹¶æ›´æ–°åˆ° <code>store</code>  ä¸­ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">importFromXlsx</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> ArrayBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token keyword\">const</span> workbook <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'array'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token comment\">// è§£æ Nodes è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token keyword\">const</span> nodesSheet <span class=\"token operator\">=</span> workbook<span class=\"token punctuation\">.</span>Sheets<span class=\"token punctuation\">[</span><span class=\"token string\">'Nodes'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">const</span> nodesData <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">sheet_to_json</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>NodeRow<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>nodesSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>nodesData<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">const</span> nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                nodesData<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    nodes<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        id<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        text<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">.</span>position_x<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">.</span>position_y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">.</span>size_width<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">.</span>size_height<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        collapsed<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">===</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        direction<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">||</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// è§£æ Connections è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">const</span> connectionsSheet <span class=\"token operator\">=</span> workbook<span class=\"token punctuation\">.</span>Sheets<span class=\"token punctuation\">[</span><span class=\"token string\">'Connections'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token keyword\">const</span> connectionsData <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">sheet_to_json</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ConnectionRow<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>connectionsSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token keyword\">const</span> connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                connectionsData<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>row<span class=\"token punctuation\">.</span>from<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>row<span class=\"token punctuation\">.</span>to<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å…³ç³»</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                connections<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">,</span> childId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token comment\">// è§£æ Global State è¡¨æ ¼</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token keyword\">const</span> globalStateSheet <span class=\"token operator\">=</span> workbook<span class=\"token punctuation\">.</span>Sheets<span class=\"token punctuation\">[</span><span class=\"token string\">'Global State'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>globalStateSheet<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing \"Global State\" sheet'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token keyword\">const</span> globalStateData <span class=\"token operator\">=</span> <span class=\"token constant\">XLSX</span><span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">sheet_to_json</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>GlobalStateRow<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>globalStateSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token keyword\">let</span> selectedNodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token keyword\">let</span> layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'top-to-bottom'</span> <span class=\"token operator\">=</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                globalStateData<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token string\">'selectedNodeId'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                        selectedNodeId <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token string\">'layoutStyle'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                            row<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token string\">'top-to-bottom'</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                            layoutStyle <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>value <span class=\"token keyword\">as</span> <span class=\"token keyword\">typeof</span> layoutStyle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–° store çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                    connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    selectedNodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                    layoutStyle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> nodes<span class=\"token punctuation\">,</span> connections <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading XLSX file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid XLSX file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsArrayBuffer</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"markdown\"><a class=\"anchor\" href=\"#markdown\">#</a> markdown</h2>\n<h3 id=\"å¯¼å‡º-4\"><a class=\"anchor\" href=\"#å¯¼å‡º-4\">#</a> å¯¼å‡º</h3>\n<p>é€šè¿‡è®¾è®¡æ ‡é¢˜çš„çº§åˆ«ï¼Œå°±å¯ä»¥åŒºåˆ†ä¸åŒçš„å±‚çº§ï¼Œä»è€Œå®ç°ä¸åŒå±‚çº§çš„å¯¼å‡ºã€‚<br />\nè¿™ä¸ªå¯ä»¥é€šè¿‡é€’å½’å®ç°ï¼Œæ ¹èŠ‚ç‚¹çš„æ ‡é¢˜çº§åˆ«ä¸º 1ï¼Œä»¥æ­¤ç±»æ¨</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡º markdown</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsMarkdown</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// é€’å½’ç”Ÿæˆ Markdown å†…å®¹</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generateMarkdown</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> level <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹çš„æ ‡é¢˜</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">const</span> heading <span class=\"token operator\">=</span> <span class=\"token string\">'#'</span><span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span>level<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">const</span> metadata <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            id<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            position<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            size<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            collapsed<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            direction<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹çš„ Markdown è¡¨ç¤º</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">let</span> markdown <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>heading<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>node<span class=\"token punctuation\">.</span>text<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> &lt;!-- </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>metadata<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> -->\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœèŠ‚ç‚¹æœªæŠ˜å ï¼Œåˆ™é€’å½’ç”Ÿæˆå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                markdown <span class=\"token operator\">+=</span> <span class=\"token function\">generateMarkdown</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> level <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> markdown<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹ç”Ÿæˆ Markdown</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">const</span> rootMarkdown <span class=\"token operator\">=</span> <span class=\"token function\">generateMarkdown</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// å°† Markdown å†…å®¹ä¸‹è½½ä¸ºæ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>rootMarkdown<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'text/markdown'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    a<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> url<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    a<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'mindmap.md'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    a<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å…¥-4\"><a class=\"anchor\" href=\"#å¯¼å…¥-4\">#</a> å¯¼å…¥</h3>\n<p>è¿™é‡Œå…ˆè¯»æ–‡ä»¶ï¼Œè¯»å‡ºæ¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯¹æ”¹å­—ç¬¦ä¸²è¿›è¡Œè§£æ<br />\né€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å¯¹æ¯ä¸€è¡Œçš„æ ‡é¢˜è¿›è¡ŒåŒ¹é…ï¼Œç„¶åæ ¹æ®åŒ¹é…ç»“æœç”ŸæˆèŠ‚ç‚¹å’Œè¿æ¥å…³ç³»ã€‚<br />\nåŒ¹é…å†…å®¹å¦‚ä¸‹</p>\n<pre><code># æ ‡é¢˜å†…å®¹ &lt;!-- æ³¨é‡Šå†…å®¹ --&gt;\n</code></pre>\n<p><strong>åœ¨é€’å½’åˆ†å±‚æ—¶</strong>ï¼Œä½¿ç”¨æ ˆæ¥æ‰¾åˆ°çˆ¶èŠ‚ç‚¹çš„ idï¼Œç„¶åæŠŠå½“å‰èŠ‚ç‚¹çš„ id æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„ children ä¸­ (<strong>ç±»ä¼¼äºæ‹¬å·åŒ¹é…</strong>)<br />\n æŠŠè§£æå‡ºæ¥çš„å†…å®¹æ›´æ–°åˆ° store ä¸­</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å…¥ Markdown æ–‡ä»¶</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param file - Markdown æ–‡ä»¶å¯¹è±¡</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @returns </pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// å¯¼å…¥ Markdown æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromMarkdown <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token operator\">?.</span>result <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token comment\">// å®šä¹‰è§£æåçš„èŠ‚ç‚¹å’Œè¿æ¥</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">const</span> nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">const</span> connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token comment\">// å½“å‰å±‚çº§çš„èŠ‚ç‚¹æ ˆ</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token keyword\">const</span> nodeStack<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> level<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token comment\">// é€è¡Œè§£æ Markdown</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                content<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    <span class=\"token comment\">// åŒ¹é…æ ‡é¢˜å’Œå…ƒæ•°æ®</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token keyword\">const</span> headingMatch <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^(#+)\\s+(.+?)\\s+&lt;!--\\s+(.+?)\\s+--></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>headingMatch<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>_<span class=\"token punctuation\">,</span> hashes<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> headingMatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    <span class=\"token keyword\">const</span> level <span class=\"token operator\">=</span> hashes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    <span class=\"token comment\">// è§£æå…ƒæ•°æ®</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token keyword\">const</span> nodeData <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token keyword\">const</span> nodeId <span class=\"token operator\">=</span> nodeData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    <span class=\"token comment\">// åˆ›å»ºèŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        id<span class=\"token operator\">:</span> nodeId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        position<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        size<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                        collapsed<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                        direction<span class=\"token operator\">:</span> nodeData<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">||</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token comment\">// ç¡®å®šçˆ¶å­å…³ç³»</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> nodeStack<span class=\"token punctuation\">[</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>level <span class=\"token operator\">>=</span> level<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                        nodeStack<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token keyword\">const</span> parentId <span class=\"token operator\">=</span> nodeStack<span class=\"token punctuation\">[</span>nodeStack<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>nodeId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                    <span class=\"token comment\">// å°†å½“å‰èŠ‚ç‚¹å‹å…¥æ ˆ</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                    nodeStack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> nodeId<span class=\"token punctuation\">,</span> level <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–° store çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                    nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error reading Markdown file:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid Markdown file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"å›¾ç‰‡æ ¼å¼çš„å¯¼å‡º\"><a class=\"anchor\" href=\"#å›¾ç‰‡æ ¼å¼çš„å¯¼å‡º\">#</a> å›¾ç‰‡æ ¼å¼çš„å¯¼å‡º</h2>\n<p>åœ¨å¯¼å‡ºå›¾ç‰‡ä¹‹æ—¶éƒ½éœ€è¦å¯¹èŠ‚ç‚¹åœ¨æ–°çš„ <code>stage</code>  ä¸­è¿›è¡Œé‡ç»˜ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ¯ä¸ªæ— è®ºåœ¨å“ªé‡Œï¼Œå¯¼å‡ºçš„å†…å®¹éƒ½æ˜¯æ­£ç¡®çš„ã€‚</p>\n<ol>\n<li><strong>è§„åˆ’åŒºåŸŸ</strong></li>\n</ol>\n<ul>\n<li>æ¯ä¸ªèŠ‚ç‚¹ä½ç½®æˆ‘ä»¬éƒ½å¯ä»¥ä» <code>store</code>  ä¸­çŸ¥é“ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦éå†ä¸€é <code>store</code> ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹çš„ä½ç½®ï¼Œæ‰¾åˆ°æœ€å¤§çš„ <code>x</code>  å’Œ <code>y</code>  åæ ‡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªåæ ‡æ¥ç¡®å®šæ•´ä¸ªåŒºåŸŸçš„å¤§å°ã€‚</li>\n</ul>\n<ol start=\"2\">\n<li><strong>ç»˜åˆ¶èŠ‚ç‚¹</strong></li>\n</ol>\n<ul>\n<li>æ ¹æ®è§„åˆ’çš„åŒºåŸŸï¼Œåœ¨ <code>stage</code>  ä¸­ç»˜åˆ¶èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹çš„ä½ç½®ï¼Œç»˜åˆ¶èŠ‚ç‚¹</li>\n</ul>\n<ol start=\"3\">\n<li><strong>ç»˜åˆ¶è¿çº¿</strong></li>\n</ol>\n<ul>\n<li>æ ¹æ®è§„åˆ’çš„åŒºåŸŸï¼Œæ ¹æ®èŠ‚ç‚¹çš„ä½ç½®ï¼Œç»˜åˆ¶è¿çº¿</li>\n</ul>\n<p>é‡ç»˜ä»£ç ï¼š</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * ç”Ÿæˆä¸´æ—¶çš„ Konva Stageï¼ŒåŒ…å«æ‰€æœ‰èŠ‚ç‚¹å’Œè¿æ¥çº¿ã€‚</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns &#123;Object&#125; åŒ…å« stage å’Œ layer çš„å¯¹è±¡</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generateStage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// ä» Store ä¸­è·å–èŠ‚ç‚¹å’Œè¿æ¥ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes<span class=\"token punctuation\">,</span> connections<span class=\"token punctuation\">,</span> layoutStyle <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nodes <span class=\"token operator\">||</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰èŠ‚ç‚¹å¯ä»¥å¯¼å‡º'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹ç•Œæ¡†ï¼ˆåªåŒ…å«å¯è§èŠ‚ç‚¹ï¼‰</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">let</span> minX <span class=\"token operator\">=</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            minY <span class=\"token operator\">=</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            maxX <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            maxY <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">const</span> visibleNodes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨å¯è§èŠ‚ç‚¹çš„ ID</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// é€’å½’éå†èŠ‚ç‚¹æ ‘ï¼Œæ”¶é›†å¯è§èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">traverseNodes</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™è·³è¿‡</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå¯è§</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token comment\">// æ›´æ–°è¾¹ç•Œæ¡†</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            minX <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>minX<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            minY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>minY<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            maxX <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxX<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            maxY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxY<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœèŠ‚ç‚¹æœªæŠ˜å ï¼Œé€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">traverseNodes</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">traverseNodes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token comment\">// å¦‚æœæ²¡æœ‰å¯è§èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>visibleNodes<span class=\"token punctuation\">.</span>size <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰å¯è§èŠ‚ç‚¹å¯ä»¥å¯¼å‡º'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token comment\">// è®¡ç®—å†…å®¹åŒºåŸŸçš„å®½é«˜</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">const</span> contentWidth <span class=\"token operator\">=</span> maxX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">const</span> contentHeight <span class=\"token operator\">=</span> maxY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»ºä¸´æ—¶çš„ Stage å’Œ Layer</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">const</span> tempContainer <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        tempContainer<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> <span class=\"token string\">'absolute'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        tempContainer<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> <span class=\"token string\">'-9999px'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// éšè—å®¹å™¨</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>tempContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">const</span> tempStage <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Stage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            container<span class=\"token operator\">:</span> tempContainer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            width<span class=\"token operator\">:</span> contentWidth<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            height<span class=\"token operator\">:</span> contentHeight<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token keyword\">const</span> tempLayer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Layer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        tempStage<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>tempLayer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token comment\">// æ·»åŠ ç™½è‰²èƒŒæ™¯çŸ©å½¢ï¼ˆé˜²æ­¢åœ¨ jpg ä¸­é€æ˜èƒŒæ™¯ä¼šè¢«æŸ“æˆé»‘è‰²ï¼‰</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            x<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            y<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            width<span class=\"token operator\">:</span> contentWidth<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            height<span class=\"token operator\">:</span> contentHeight<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            fill<span class=\"token operator\">:</span> <span class=\"token string\">'white'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// å¼ºåˆ¶ç™½è‰²èƒŒæ™¯</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            listening<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">// é˜²æ­¢å½±å“äº¤äº’</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token comment\">// ç»˜åˆ¶å¯è§èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token keyword\">const</span> rect <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span> <span class=\"token comment\">// è°ƒæ•´ä½ç½®ï¼Œä½¿å†…å®¹å±…ä¸­</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                fill<span class=\"token operator\">:</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                stroke<span class=\"token operator\">:</span> <span class=\"token string\">'#000'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                strokeWidth<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> minX <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> minY <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                text<span class=\"token operator\">:</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                fontSize<span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                fill<span class=\"token operator\">:</span> <span class=\"token string\">'#000'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                width<span class=\"token operator\">:</span> width <span class=\"token operator\">-</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                padding<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>rect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token comment\">// ç»˜åˆ¶å¯è§è¿æ¥çº¿</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        connections<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>fromId<span class=\"token punctuation\">,</span> toId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>fromId<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>visibleNodes<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>toId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>startX<span class=\"token punctuation\">,</span> startY<span class=\"token punctuation\">,</span> endX<span class=\"token punctuation\">,</span> endY<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">calculateConnectionPoints</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                conn</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>            <span class=\"token keyword\">const</span> line <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Shape</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                <span class=\"token function-variable function\">sceneFunc</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> shape<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span>startX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span> startY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è°ƒæ•´ä½ç½®</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'top-to-bottom'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>                        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>                            endX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>                            startY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>                            endX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                            endY <span class=\"token operator\">-</span> minY</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                            startX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                            endY <span class=\"token operator\">-</span> minY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                            endX <span class=\"token operator\">-</span> minX<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                            endY <span class=\"token operator\">-</span> minY</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillStrokeShape</span><span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>                stroke<span class=\"token operator\">:</span> <span class=\"token string\">'black'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>                strokeWidth<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        tempLayer<span class=\"token punctuation\">.</span><span class=\"token function\">batchDraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¼ºåˆ¶ç»˜åˆ¶</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token operator\">:</span> tempStage<span class=\"token punctuation\">,</span> layer<span class=\"token operator\">:</span> tempLayer<span class=\"token punctuation\">,</span> container<span class=\"token operator\">:</span> tempContainer <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ç”Ÿæˆ Stage å¤±è´¥'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºpng\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºpng\">#</a> å¯¼å‡ºä¸º png</h3>\n<p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°é‡ç»˜çš„ <code>stage</code> ï¼Œç›´æ¥ä½¿ç”¨ <code>stage.toDataURL()</code>  å³å¯å¾—åˆ°ä¸€ä¸ª png å›¾ç‰‡çš„ base64 å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡ <code>download</code>  è¿›è¡Œä¸‹è½½ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º png</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsPNG</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// å¯¼å‡ºå›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">const</span> dataUrl <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            mimeType<span class=\"token operator\">:</span> <span class=\"token string\">'image/png'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            pixelRatio<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»ºä¸‹è½½é“¾æ¥</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> dataUrl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        link<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'mindmap.png'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºjpg\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºjpg\">#</a> å¯¼å‡ºä¸º jpg</h3>\n<p><strong>æ³¨æ„</strong>å¦‚æœæ²¡æœ‰ç»™ <code>stage</code>  è®¾ç½®ä¸€ä¸ªèƒŒæ™¯é¢œè‰²ï¼Œé‚£ä¹ˆå¯¼å‡ºçš„å›¾ç‰‡ä¼šå‡ºç°é»‘è‰²èƒŒæ™¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆè®¾ç½®ä¸€ä¸ªç™½è‰²èƒŒæ™¯ã€‚<br />\næˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°é‡ç»˜çš„ <code>stage</code> ï¼Œç›´æ¥ä½¿ç”¨ <code>stage.toDataURL()</code>  å³å¯å¾—åˆ°ä¸€ä¸ª jpg å›¾ç‰‡çš„ base64 å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡ <code>download</code>  è¿›è¡Œä¸‹è½½ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º jpg</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsJPG</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">const</span> dataUrl <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            mimeType<span class=\"token operator\">:</span> <span class=\"token string\">'image/jpeg'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            quality<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å›¾ç‰‡è´¨é‡</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            pixelRatio<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æé«˜åˆ†è¾¨ç‡</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> dataUrl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        link<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'mindmap.jpg'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºpdf\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºpdf\">#</a> å¯¼å‡ºä¸º pdf</h3>\n<p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°é‡ç»˜çš„ <code>stage</code> ï¼Œç„¶åä½¿ç”¨ <code>jspdf</code>  è¿›è¡Œå¯¼å‡ºã€‚<br />\n<strong>æ³¨æ„</strong> å½“ <code>stage</code>  ä¸­çš„å®½åº¦å¤§äºé«˜åº¦æ—¶ï¼Œé‡‡ç”¨æ¨ªå‘å¸ƒå±€å¯¼å‡º pdfï¼Œå½“ <code>stage</code>  ä¸­çš„é«˜åº¦å¤§äºå®½åº¦æ—¶ï¼Œé‡‡ç”¨çºµå‘å¸ƒå±€å¯¼å‡º pdfã€‚<br />\n<strong>è¿™æ˜¯å› ä¸ºåœ¨ pdf ä¸­å†…å®¹çš„å®é™…å®½é«˜æ¯”ä¾‹éœ€è¦ä¸ PDF é¡µé¢çš„æ¯”ä¾‹åŒ¹é…</strong></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º PDF</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsPDF</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ç”Ÿæˆä¸´æ—¶ Stage</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// å¯¼å‡ºå›¾ç‰‡ä¸º Data URL</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> dataUrl <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">toDataURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            mimeType<span class=\"token operator\">:</span> <span class=\"token string\">'image/png'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            pixelRatio<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æé«˜åˆ†è¾¨ç‡</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// è·å– Stage çš„å®½é«˜ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">const</span> stageWidthPx <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">const</span> stageHeightPx <span class=\"token operator\">=</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»º jsPDF å®ä¾‹</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// æ ¹æ®èˆå°çš„å®½é«˜å†³å®šé¡µé¢æ–¹å‘</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// åœ¨ pdf ä¸­å†…å®¹çš„å®é™…å®½é«˜æ¯”ä¾‹éœ€è¦ä¸ PDF é¡µé¢çš„æ¯”ä¾‹åŒ¹é…</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">//pdf é¡µé¢çš„æ–¹å‘å†³å®šäº† pdf çš„å®½é«˜æ¯”</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">let</span> pdf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stageWidthPx <span class=\"token operator\">></span> stageHeightPx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            pdf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">jsPDF</span><span class=\"token punctuation\">(</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>stageWidthPx<span class=\"token punctuation\">,</span> stageHeightPx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ¨ªå‘å¸ƒå±€</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            pdf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">jsPDF</span><span class=\"token punctuation\">(</span><span class=\"token string\">'p'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>stageHeightPx<span class=\"token punctuation\">,</span> stageWidthPx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// çºµå‘å¸ƒå±€</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token comment\">// å°†å›¾ç‰‡æ·»åŠ åˆ° PDF ä¸­</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token comment\">// æ³¨æ„ï¼šç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ 'px' ä½œä¸ºå•ä½ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦è¿›è¡Œå•ä½è½¬æ¢</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        pdf<span class=\"token punctuation\">.</span><span class=\"token function\">addImage</span><span class=\"token punctuation\">(</span>dataUrl<span class=\"token punctuation\">,</span> <span class=\"token string\">'PNG'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> stageWidthPx<span class=\"token punctuation\">,</span> stageHeightPx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\">// ä¸‹è½½ PDF æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        pdf<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mindmap.pdf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯¼å‡ºä¸ºsvg\"><a class=\"anchor\" href=\"#å¯¼å‡ºä¸ºsvg\">#</a> å¯¼å‡ºä¸º svg</h3>\n<p><strong>svg æ˜¯ä¸€ç§ç”¨äºæè¿°äºŒç»´å›¾å½¢çš„æ ‡è®°è¯­è¨€ï¼Œå®ƒä½¿ç”¨ XML æ ¼å¼æ¥å®šä¹‰å›¾å½¢çš„å½¢çŠ¶ã€é¢œè‰²ã€å¤§å°ç­‰å±æ€§ã€‚</strong><br />\nè¿™ä¸ªæˆ‘ç›®å‰è¿˜ä¸èƒ½å®ç°æ‰‹åŠ¨å¯¼å‡º<br />\nè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>react-konva-to-svg</code>  åº“ï¼Œè¿™ä¸ªåº“å¯ä»¥å°† <code>Konva</code>  çš„ <code>Stage</code>  å¯¼å‡ºä¸º <code>svg</code> ã€‚<br />\nç›´æ¥ä½¿ç”¨ <code>exportStageSVG</code>  å°±å¯ä»¥å°† <code>Stage</code>  å¯¼å‡ºä¸º <code>svg</code> ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * å¯¼å‡ºä¸º SVG</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @returns void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportAsSVG</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ç”Ÿæˆä¸´æ—¶ Stage</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">generateStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> stage<span class=\"token punctuation\">,</span> container <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// ä½¿ç”¨ react-konva-to-svg å¯¼å‡º SVG</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> svgContent <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">exportStageSVG</span><span class=\"token punctuation\">(</span>stage<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token function-variable function\">onBefore</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¼€å§‹å¯¼å‡º SVG:'</span><span class=\"token punctuation\">,</span> stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token function-variable function\">onAfter</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SVG å¯¼å‡ºå®Œæˆ:'</span><span class=\"token punctuation\">,</span> stage<span class=\"token punctuation\">,</span> layer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»º Blob å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>svgContent<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'image/svg+xml'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// ä¸‹è½½ SVG æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.svg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¯¼å‡º SVG æ—¶å‡ºé”™:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">// æ¸…ç†ä¸´æ—¶èµ„æº</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        stage<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<p>ğŸ¾è‡³æ­¤ï¼Œæ€ç»´å¯¼å›¾å¯ä»¥æ”¯æŒå¯¼å‡ºå¤šç§æ ¼å¼</p>\n",
            "tags": [
                "canvas",
                "React",
                "konva.js"
            ]
        },
        {
            "id": "https://aynya.github.io/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E5%A6%82%E4%BD%95%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5xmind%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6/",
            "url": "https://aynya.github.io/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E5%A6%82%E4%BD%95%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5xmind%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6/",
            "title": "æ€ç»´å¯¼å›¾å¦‚ä½•å¯¼å‡ºå¯¼å…¥xmindæ ¼å¼æ–‡ä»¶",
            "date_published": "2025-04-16T13:14:40.000Z",
            "content_html": "<h1 id=\"å¦‚ä½•å°†æ€ç»´å¯¼å›¾å¯¼å‡ºå¯¼å…¥ä¸ºxmindæ–‡ä»¶\"><a class=\"anchor\" href=\"#å¦‚ä½•å°†æ€ç»´å¯¼å›¾å¯¼å‡ºå¯¼å…¥ä¸ºxmindæ–‡ä»¶\">#</a> ğŸ“å¦‚ä½•å°†æ€ç»´å¯¼å›¾å¯¼å‡ºå¯¼å…¥ä¸º XMind æ–‡ä»¶</h1>\n<p><code>Xmind</code>  æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <code>ZIP</code>  å‹ç¼©åŒ…ã€‚å…¶ä¸­åŒ…å«äº†å¤šä¸ª JSON æ–‡ä»¶ (å¦‚ <code>content.json</code> ï¼Œ  <code>metadata.json</code>  ç­‰)ï¼Œè¿™äº›æ–‡ä»¶æè¿°äº†æ€ç»´å¯¼å›¾çš„å†…å®¹å’Œç»“æ„</p>\n<h2 id=\"1-ï¸-å‡†å¤‡å·¥ä½œ\"><a class=\"anchor\" href=\"#1-ï¸-å‡†å¤‡å·¥ä½œ\">#</a> 1. ğŸ› ï¸ å‡†å¤‡å·¥ä½œ</h2>\n<ul>\n<li><strong>JSZip</strong>: ç”¨äºåˆ›å»º ZIP æ–‡ä»¶ã€‚å…è®¸æˆ‘ä»¬è½»æ¾åˆ›å»ºç¬¦åˆ XMind è§„èŒƒçš„ ZIP æ–‡ä»¶</li>\n<li><strong>file-saver</strong>: ç”¨äºä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶ã€‚è¿™ä¸ªåº“ç®€åŒ–äº†æµè§ˆå™¨ç¯å¢ƒä¸‹çš„æ–‡ä»¶ä¸‹è½½è¿‡ç¨‹ã€‚</li>\n</ul>\n<h2 id=\"2-å®šä¹‰æ•°æ®ç»“æ„\"><a class=\"anchor\" href=\"#2-å®šä¹‰æ•°æ®ç»“æ„\">#</a> 2. ğŸ” å®šä¹‰æ•°æ®ç»“æ„</h2>\n<h3 id=\"nodeæ¥å£\"><a class=\"anchor\" href=\"#nodeæ¥å£\">#</a>  <code>Node</code>  æ¥å£</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹ ID</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹æ–‡æœ¬</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹ä½ç½®</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–¹å‘å±æ€§</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ¸…æ™°çš„è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹åŠå…¶å…³ç³»</p>\n<h3 id=\"topicæ¥å£\"><a class=\"anchor\" href=\"#topicæ¥å£\">#</a>  <code>Topic</code>  æ¥å£</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾ä¸»é¢˜ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Topic</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    structureClass<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      attached<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>Topic</code>  æ˜¯ XMind ä¸­çš„ä¸»ä½“ (èŠ‚ç‚¹) æ¨¡å‹ï¼Œå®ƒä¸ä»…åŒ…å«èŠ‚ç‚¹çš„åŸºæœ¬å±æ€§ï¼Œè¿˜å…è®¸é€’å½’åœ°å®šä¹‰å­èŠ‚ç‚¹ã€‚èƒ½å¤Ÿæ„å»ºå¤æ‚çš„æ ‘çŠ¶ç»“æ„</p>\n<h3 id=\"sheetæ¥å£\"><a class=\"anchor\" href=\"#sheetæ¥å£\">#</a>  <code>Sheet</code>  æ¥å£</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾å·¥ä½œè¡¨ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Sheet</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    extensions<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    topicPositioning<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    topicOverlapping<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    coreVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    rootTopic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>Sheet</code>  æ˜¯ XMind ä¸­çš„å·¥ä½œè¡¨æ¨¡å‹ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæ ¹ä¸»é¢˜ï¼Œä»¥åŠå„ç§å±æ€§ï¼Œå¦‚æ ‡é¢˜ã€æ‰©å±•ã€ä¸»é¢˜å®šä½ã€ä¸»é¢˜é‡å ç­‰ã€‚æœ‰åŠ©äºæˆ‘ä»¬ç»„ç»‡æ•´ä¸ªæ€ç»´å¯¼å›¾çš„æ•°æ®ç»“æ„ã€‚</p>\n<h3 id=\"contentjson-metadatajson-manifestjsonç±»å‹\"><a class=\"anchor\" href=\"#contentjson-metadatajson-manifestjsonç±»å‹\">#</a>  <code>ContentJSON</code> ,  <code>MetadataJSON</code> ,  <code>ManifestJSON</code>  ç±»å‹</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰ content.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">type</span> <span class=\"token class-name\">ContentJSON</span> <span class=\"token operator\">=</span> Sheet<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// å®šä¹‰ metadata.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">MetadataJSON</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    modifier<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    dataStructureVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    creator<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    layoutEngineVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    activeSheetId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// å®šä¹‰ manifest.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ManifestJSON</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string-property property\">\"file-entries\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">[</span>filename<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™äº›äº‹ XMind æ–‡ä»¶ä¸­çš„æ ¸å¿ƒ JSON æ–‡ä»¶ï¼Œ <code>ContentJSON</code>  åŒ…å«äº†æ€ç»´å¯¼å›¾çš„æ‰€æœ‰å†…å®¹ï¼› <code>MetadataJSON</code>  æä¾›äº†å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚ç‰ˆæœ¬å·å’Œåˆ›å»ºè€…ï¼› <code>ManifestJSON</code>  æè¿°äº†æ–‡ä»¶æ¸…å•ï¼ŒæŒ‡å®šäº†æ¯ä¸ªæ–‡ä»¶çš„åç§°å’Œåª’ä½“ç±»å‹ã€‚è¿™äº›æ–‡ä»¶å…±åŒæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„ XMind æ–‡ä»¶ã€‚</p>\n<h2 id=\"3-è¾…åŠ©å‡½æ•°\"><a class=\"anchor\" href=\"#3-è¾…åŠ©å‡½æ•°\">#</a> 3. ğŸ§© è¾…åŠ©å‡½æ•°</h2>\n<p>æˆ‘ä»¬å°†ç¼–å†™è¾…åŠ©å‡½æ•°æ¥æ„å»ºæ€ç»´å¯¼å›¾çš„å†…å®¹</p>\n<h3 id=\"buildchildrenå‡½æ•°\"><a class=\"anchor\" href=\"#buildchildrenå‡½æ•°\">#</a>  <code>buildChildren</code>  å‡½æ•°</h3>\n<p>é€’å½’çš„æ„å»ºå­èŠ‚ç‚¹æ ‘çŠ¶ç»“æ„ï¼Œ å°†æ¯ä¸ªèŠ‚ç‚¹è½¬æ¢ä¸º <code>Topic</code>  å¯¹è±¡ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šé€’å½’æ„å»ºå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> buildChildren <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> parentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Processing parentId: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Node with id \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\" not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">const</span> childrenIds <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">;</span> <span class=\"token comment\">// è·å–å½“å‰çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Children IDs for parentId \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\":</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> childrenIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// æ ¹æ®å­èŠ‚ç‚¹ ID æ„å»ºå­èŠ‚ç‚¹åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> childrenIds</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Topic <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">const</span> childNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>childNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Child node with id \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>childId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\" not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                id<span class=\"token operator\">:</span> childNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                structureClass<span class=\"token operator\">:</span> <span class=\"token string\">'org.xmind.ui.logic.right'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                title<span class=\"token operator\">:</span> childNode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                children<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    attached<span class=\"token operator\">:</span> <span class=\"token function\">buildChildren</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">,</span> childNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> topic <span class=\"token keyword\">is</span> Topic <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿‡æ»¤æ‰æ— æ•ˆçš„å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"createcontentjson-å‡½æ•°\"><a class=\"anchor\" href=\"#createcontentjson-å‡½æ•°\">#</a>  <code>createContentJSON</code>  å‡½æ•°</h3>\n<p>ç”¨äºæ„å»º <code>content.json</code>  æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†æ•´ä¸ªæ€ç»´å¯¼å›¾çš„æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½æ­£ç¡®è½¬æ¢æˆ XMind æ ¼å¼</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šæ„å»º content.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> createContentJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ContentJSON <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// æ„å»ºæ ¹èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">const</span> rootTopic<span class=\"token operator\">:</span> Topic <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        id<span class=\"token operator\">:</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        structureClass<span class=\"token operator\">:</span> <span class=\"token string\">'org.xmind.ui.logic.right'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        title<span class=\"token operator\">:</span> rootNode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            attached<span class=\"token operator\">:</span> <span class=\"token function\">buildChildren</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">,</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ä»æ ¹èŠ‚ç‚¹å¼€å§‹é€’å½’</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            id<span class=\"token operator\">:</span> <span class=\"token string\">'simpleMindMap_1744799393059'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token string\">'sheet'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            title<span class=\"token operator\">:</span> <span class=\"token string\">'æ€ç»´å¯¼å›¾æ ‡é¢˜'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            extensions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            topicPositioning<span class=\"token operator\">:</span> <span class=\"token string\">'fixed'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            topicOverlapping<span class=\"token operator\">:</span> <span class=\"token string\">'overlap'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            coreVersion<span class=\"token operator\">:</span> <span class=\"token string\">'2.100.0'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            rootTopic<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"createmetadatajson-å‡½æ•°\"><a class=\"anchor\" href=\"#createmetadatajson-å‡½æ•°\">#</a>  <code>createMetadataJSON</code>  å‡½æ•°</h3>\n<p>ç”¨äºæ„å»º <code>metadata.json</code>  æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†æ€ç»´å¯¼å›¾çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚ç‰ˆæœ¬å·ã€åˆ›å»ºè€…ç­‰ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šæ„å»º metadata.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> createMetadataJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MetadataJSON <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        modifier<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ä¿®æ”¹è€…ï¼ˆå¯ä¸ºç©ºï¼‰</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        dataStructureVersion<span class=\"token operator\">:</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ•°æ®ç»“æ„ç‰ˆæœ¬</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        creator<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            name<span class=\"token operator\">:</span> <span class=\"token string\">'mind-map'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// åˆ›å»ºè€…åç§°</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        layoutEngineVersion<span class=\"token operator\">:</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¸ƒå±€å¼•æ“ç‰ˆæœ¬</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        activeSheetId<span class=\"token operator\">:</span> <span class=\"token string\">'simpleMindMap_1744799393059'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å½“å‰æ´»åŠ¨çš„å·¥ä½œè¡¨ ID</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"createmanifestjson-å‡½æ•°\"><a class=\"anchor\" href=\"#createmanifestjson-å‡½æ•°\">#</a>  <code>createManifestJSON</code>  å‡½æ•°</h3>\n<p>ç”¨äºæ„å»º <code>manifest.json</code>  æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æè¿°äº†æ–‡ä»¶æ¸…å•ï¼ŒæŒ‡å®šäº†æ¯ä¸ªæ–‡ä»¶çš„åç§°å’Œåª’ä½“ç±»å‹ã€‚è¿™å¯¹è§£å‹å’Œè§£æ XMind æ–‡ä»¶å¾ˆé‡è¦ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šæ„å»º manifest.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> createManifestJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ManifestJSON <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string-property property\">\"file-entries\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token string-property property\">\"content.json\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//content.json çš„åª’ä½“ç±»å‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token string-property property\">\"metadata.json\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//metadata.json çš„åª’ä½“ç±»å‹</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token string-property property\">\"manifest.json\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string-property property\">\"media-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//manifest.json çš„åª’ä½“ç±»å‹</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"4-å¯¼å‡ºxmindæ–‡ä»¶\"><a class=\"anchor\" href=\"#4-å¯¼å‡ºxmindæ–‡ä»¶\">#</a> 4. ğŸš€ å¯¼å‡º XMind æ–‡ä»¶</h2>\n<p>æœ€åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›å†…å®¹æ‰“åŒ…æˆ <code>.xmind</code>  æ–‡ä»¶ä¸‹è½½ã€‚<br />\né€šè¿‡ <code>JSZip</code>  åº“ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤šä¸ª JSON æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª ZIP æ–‡ä»¶ã€‚æ¨¡æ‹Ÿ XMind æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ã€‚ç”Ÿæˆçš„æ–‡ä»¶å¯ä»¥ç›´æ¥è¢« XMind åº”ç”¨ç¨‹åºæ‰“å¼€ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å¯¼å‡ºä¸º XMind æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> exportAsXMind <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// è·å–èŠ‚ç‚¹æ•°æ®</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// æ£€æŸ¥ nodes æ˜¯å¦ä¸ºç©º</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nodes <span class=\"token operator\">||</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'æ²¡æœ‰èŠ‚ç‚¹å¯ä»¥å¯¼å‡º'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// æ„å»º content.json</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">const</span> contentJson<span class=\"token operator\">:</span> ContentJSON <span class=\"token operator\">=</span> <span class=\"token function\">createContentJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// æ„å»º metadata.json</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">const</span> metadataJson<span class=\"token operator\">:</span> MetadataJSON <span class=\"token operator\">=</span> <span class=\"token function\">createMetadataJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// æ„å»º manifest.json</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">const</span> manifestJson<span class=\"token operator\">:</span> ManifestJSON <span class=\"token operator\">=</span> <span class=\"token function\">createManifestJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// ä½¿ç”¨ JSZip æ‰“åŒ…</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">const</span> zip <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSZip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'content.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>contentJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'metadata.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>metadataJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'manifest.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>manifestJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// ç”Ÿæˆå¹¶ä¸‹è½½æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">generateAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'blob'</span><span class=\"token punctuation\">,</span> compression<span class=\"token operator\">:</span> <span class=\"token string\">'DEFLATE'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">saveAs</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">,</span> <span class=\"token string\">'mindmap.xmind'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'å¯¼å‡ºå¤±è´¥:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> ğŸ‰</h3>\n<p><strong>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†æ€ç»´å¯¼å›¾æ•°æ®å¯¼å‡ºä¸º XMind æ ¼å¼çš„æ–‡ä»¶ã€‚</strong></p>\n<hr />\n<h3 id=\"æ›´æ–°2025-4-17\"><a class=\"anchor\" href=\"#æ›´æ–°2025-4-17\">#</a> âœ¨æ›´æ–°ï¼š2025-4-17</h3>\n<p>æ›´æ–°å†…å®¹ï¼š</p>\n<ul>\n<li>æ·»åŠ äº†å¯¼å…¥ xmind æ ¼å¼æ–‡ä»¶çš„åŠŸèƒ½ã€‚</li>\n</ul>\n<h4 id=\"1-æ•°æ®ç»“æ„å®šä¹‰\"><a class=\"anchor\" href=\"#1-æ•°æ®ç»“æ„å®šä¹‰\">#</a> 1. æ•°æ®ç»“æ„å®šä¹‰</h4>\n<p>è¿™é‡Œå’Œä¹‹å‰ç±»ä¼¼</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾ä¸»é¢˜ç±»å‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">Topic</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    structureClass<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹ä½ç½®</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        attached<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// å®šä¹‰æ€ç»´å¯¼å›¾å·¥ä½œè¡¨ç±»å‹</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">Sheet</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    extensions<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    topicPositioning<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    topicOverlapping<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    coreVersion<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    rootTopic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// å®šä¹‰ content.json çš„ç±»å‹</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">type</span> <span class=\"token class-name\">ContentJSON</span> <span class=\"token operator\">=</span> Sheet<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// å®šä¹‰è§£æåçš„æ•°æ®ç»“æ„</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">ParsedData</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// èŠ‚ç‚¹è®°å½•</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿æ¥å…³ç³»åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"2-é€’å½’è§£æå­èŠ‚ç‚¹å‡½æ•°\"><a class=\"anchor\" href=\"#2-é€’å½’è§£æå­èŠ‚ç‚¹å‡½æ•°\">#</a> 2. é€’å½’è§£æå­èŠ‚ç‚¹å‡½æ•°</h4>\n<p>é€šè¿‡é€’å½’çš„æ–¹å¼è§£æå­èŠ‚ç‚¹ï¼Œå¹¶æ„å»ºèŠ‚ç‚¹è®°å½•å’Œè¿æ¥å…³ç³»åˆ—è¡¨ã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°ï¼šé€’å½’è§£æå­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> parseChildren <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>topic<span class=\"token operator\">:</span> Topic<span class=\"token punctuation\">,</span> parentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> parsedData<span class=\"token operator\">:</span> ParsedData<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> collapsed<span class=\"token punctuation\">,</span> children <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> topic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºå½“å‰èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">const</span> node<span class=\"token operator\">:</span> Node <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        text<span class=\"token operator\">:</span> title<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        position<span class=\"token operator\">:</span> position <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›ä½ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        size<span class=\"token operator\">:</span> size <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›å°ºå¯¸ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        collapsed<span class=\"token operator\">:</span> collapsed <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœæ²¡æœ‰æä¾›æŠ˜å çŠ¶æ€ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        direction<span class=\"token operator\">:</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// æ–¹å‘å±æ€§æ˜¯å¯é€‰çš„</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ åˆ°èŠ‚ç‚¹è®°å½•</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å»ºç«‹è¿æ¥</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>parentId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">---</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>id<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>children<span class=\"token operator\">?.</span>attached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        children<span class=\"token punctuation\">.</span>attached<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childTopic<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token function\">parseChildren</span><span class=\"token punctuation\">(</span>childTopic<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"3-è§£æxmindæ–‡ä»¶å‡½æ•°\"><a class=\"anchor\" href=\"#3-è§£æxmindæ–‡ä»¶å‡½æ•°\">#</a> 3. è§£æ XMind æ–‡ä»¶å‡½æ•°</h4>\n<p>è¯»å…¥æ–‡ä»¶è¿”å›ä¸€ä¸ª Promiseï¼Œè§£ææ–‡ä»¶å†…å®¹å¹¶è¿”å›è§£æåçš„æ•°æ®ã€‚<br />\nç”±äº XMind æ–‡ä»¶æ˜¯ä¸€ä¸ª ZIP æ ¼å¼çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ JSZip åº“æ¥è§£æã€‚</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// å¯¼å…¥ xmind æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> importFromXMind <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>file<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">const</span> zip <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSZip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        zip<span class=\"token punctuation\">.</span><span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>unzipped<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token comment\">// è¯»å– content.json</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">return</span> unzipped<span class=\"token punctuation\">.</span><span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">'content.json'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">async</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>contentJsonText<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>contentJsonText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing content.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token comment\">// è§£æ content.json</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">const</span> contentJson<span class=\"token operator\">:</span> ContentJSON <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>contentJsonText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token comment\">// åˆå§‹åŒ–è§£ææ•°æ®</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">const</span> parsedData<span class=\"token operator\">:</span> ParsedData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    connections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token comment\">// è§£ææ ¹èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token keyword\">const</span> rootSheet <span class=\"token operator\">=</span> contentJson<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootSheet <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>rootSheet<span class=\"token punctuation\">.</span>rootTopic<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid content.json structure'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token function\">parseChildren</span><span class=\"token punctuation\">(</span>rootSheet<span class=\"token punctuation\">.</span>rootTopic<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> parsedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token comment\">// æ›´æ–° store çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    nodes<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    connections<span class=\"token operator\">:</span> parsedData<span class=\"token punctuation\">.</span>connections<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä» metadata.json è·å–</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Failed to import XMind file: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h3 id=\"-2\"><a class=\"anchor\" href=\"#-2\">#</a> ğŸ˜˜</h3>\n<p>ç°åœ¨ä¸ä»…å¯ä»¥å¯¼å‡ºä¸º Xmind æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å¯¼å…¥ Xmind æ–‡ä»¶äº†ï¼Œè™½ç„¶å¯¼å…¥åªé™äºæœ¬æ€ç»´å¯¼å›¾çš„å¯¼å‡ºçš„å¯¼å…¥ï¼Œä½†æ˜¯å¯¼å‡ºçš„æ˜¯å¯ä»¥é€‚é… Xmind çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¼å…¥åˆ° Xmind ä¸­ã€‚</p>\n",
            "tags": [
                "canvas",
                "React",
                "xmind",
                "TypeScript"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E5%AE%9E%E7%8E%B0%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E4%BC%98%E9%9B%85%E8%BF%9E%E7%BA%BF/",
            "url": "https://aynya.github.io/%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF%E5%AE%9E%E7%8E%B0%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E4%BC%98%E9%9B%85%E8%BF%9E%E7%BA%BF/",
            "title": "è´å¡å°”æ›²çº¿å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿",
            "date_published": "2025-04-11T08:58:11.000Z",
            "content_html": "<h1 id=\"æ„é€ äºŒæ¬¡è´å¡å°”æ›²çº¿è½»æ¾å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿\"><a class=\"anchor\" href=\"#æ„é€ äºŒæ¬¡è´å¡å°”æ›²çº¿è½»æ¾å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿\">#</a> ğŸ“ æ„é€ äºŒæ¬¡è´å¡å°”æ›²çº¿ï¼šè½»æ¾å®ç°èŠ‚ç‚¹é—´çš„ä¼˜é›…è¿çº¿</h1>\n<p>åœ¨å¼€å‘æ€ç»´å¯¼å›¾æˆ–æ ‘çŠ¶ç»“æ„åº”ç”¨æ—¶ï¼Œå¦‚ä½•ä¼˜é›…åœ°è¿æ¥èŠ‚ç‚¹å¹¶ç»˜åˆ¶å¹³æ»‘çš„çº¿æ¡</p>\n<hr />\n<h2 id=\"è´å¡å°”æ›²çº¿ç®€ä»‹\"><a class=\"anchor\" href=\"#è´å¡å°”æ›²çº¿ç®€ä»‹\">#</a> âœ¨ è´å¡å°”æ›²çº¿ç®€ä»‹</h2>\n<p>è´å¡å°”æ›²çº¿æ˜¯ä¸€ç§ç”¨äºç”Ÿæˆå¹³æ»‘æ›²çº¿çš„æ•°å­¦å·¥å…· ã€‚å®ƒå¹¿æ³›åº”ç”¨äºå›¾å½¢è®¾è®¡ã€åŠ¨ç”»ã€UI å¼€å‘ç­‰é¢†åŸŸã€‚è´å¡å°”æ›²çº¿çš„ç‰¹ç‚¹æ˜¯å¯ä»¥é€šè¿‡æ§åˆ¶ç‚¹æ¥è°ƒæ•´æ›²çº¿çš„å½¢çŠ¶ï¼Œä»è€Œç”Ÿæˆå„ç§å¹³æ»‘çš„è·¯å¾„ã€‚<br />\nå¤šä¸ªè´å¡å°”æ›²çº¿çš„ç»„åˆå¯ä»¥ç”Ÿæˆå„ç§å¤æ‚çš„æ›²çº¿ï¼Œå¦‚åœ†å¼§ã€æ›²çº¿ã€è´å¡å°”æ›²çº¿ç­‰ã€‚<br />\nä¸€æ¬¡è´å¡å°”æ›²çº¿çš„å…¬å¼æ˜¯ï¼š <code>B(t) = (1 - t) * Pâ‚€ + t * Pâ‚</code></p>\n<h2 id=\"äºŒæ¬¡è´å¡å°”æ›²çº¿\"><a class=\"anchor\" href=\"#äºŒæ¬¡è´å¡å°”æ›²çº¿\">#</a> äºŒæ¬¡è´å¡å°”æ›²çº¿</h2>\n<p>äºŒæ¬¡è´å¡å°”æ›²çº¿æ˜¯æœ€ç®€å•çš„è´å¡å°”æ›²çº¿ç±»å‹ä¹‹ä¸€ï¼Œå®ƒç”±ä»¥ä¸‹ä¸‰ä¸ªç‚¹å®šä¹‰ï¼š</p>\n<ul>\n<li><strong>èµ·ç‚¹ (Pâ‚€)</strong>ï¼šæ›²çº¿çš„èµ·å§‹ç‚¹ã€‚</li>\n<li><strong>æ§åˆ¶ç‚¹ (Pâ‚)</strong>ï¼šå†³å®šæ›²çº¿çš„å¼¯æ›²æ–¹å‘å’Œç¨‹åº¦ã€‚</li>\n<li><strong>ç»ˆç‚¹ (Pâ‚‚)</strong>ï¼šæ›²çº¿çš„ç»“æŸç‚¹ã€‚<br />\né€šè¿‡è¿™ä¸‰ä¸ªç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€æ¡å¹³æ»‘çš„æ›²çº¿ã€‚å…¶å…¬å¼å¦‚ä¸‹ï¼š<br />\n <code>B(t) = (1 - t) ^ 2 * Pâ‚€ + 2 * t * (1 - t) * Pâ‚ + t ^ 2 * Pâ‚‚</code>  t âˆˆ [0, 1]</li>\n</ul>\n<h3 id=\"ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿è¿æ¥èŠ‚ç‚¹\"><a class=\"anchor\" href=\"#ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿è¿æ¥èŠ‚ç‚¹\">#</a> ğŸ›  ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿è¿æ¥èŠ‚ç‚¹</h3>\n<p>è¿™é‡Œé‡‡ç”¨ <code>react-konva</code>  ä¸­çš„ <code>Shape</code>  ç»„ä»¶æ¥ç»˜åˆ¶äºŒæ¬¡è´å¡å°”æ›²çº¿ã€‚ <code>Shape</code>  æä¾›äº†ä¸€ä¸ª <code>sceneFunc</code>  å±æ€§ï¼Œå…è®¸æˆ‘ä»¬ç›´æ¥æ“ä½œ Canvas ä¸Šä¸‹æ–‡</p>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Shape</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token attr-name\">sceneFunc</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> shape<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span>startX<span class=\"token punctuation\">,</span> startY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç§»åŠ¨åˆ°èµ·ç‚¹</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            startX<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// æ§åˆ¶ç‚¹ X åæ ‡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            endY<span class=\"token punctuation\">,</span>     <span class=\"token comment\">// æ§åˆ¶ç‚¹ Y åæ ‡</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            endX<span class=\"token punctuation\">,</span>     <span class=\"token comment\">// ç»ˆç‚¹ X åæ ‡</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            endY      <span class=\"token comment\">// ç»ˆç‚¹ Y åæ ‡</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillStrokeShape</span><span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åº”ç”¨å¡«å……å’Œæè¾¹</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token attr-name\">stroke</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>blue<span class=\"token punctuation\">\"</span></span>       <span class=\"token comment\">// çº¿æ¡é¢œè‰²</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token attr-name\">strokeWidth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span></span>     <span class=\"token comment\">// çº¿æ¡å®½åº¦</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">/></span></span></pre></td></tr></table></figure><h2 id=\"å‚è€ƒèµ„æ–™å¤šæ¬¡ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä¸‹\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™å¤šæ¬¡ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä¸‹\">#</a> ğŸ“š å‚è€ƒèµ„æ–™ (å¤šæ¬¡ä¹Ÿå¯ä»¥å‚è€ƒå¦‚ä¸‹)</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rb252YWpzLm9yZy9kb2NzL3NhbmRib3gvTW9kaWZ5X0N1cnZlc193aXRoX0FuY2hvcl9Qb2ludHMuaHRtbA==\">konva å®˜æ–¹æ–‡æ¡£</span></li>\n</ul>\n",
            "tags": [
                "canvas",
                "konva",
                "è´å¡å°”æ›²çº¿"
            ]
        },
        {
            "id": "https://aynya.github.io/%E8%80%83%E8%99%91%E5%B0%BA%E5%AF%B8%E7%9A%84%E5%A4%9A%E5%8F%89%E6%A0%91%E5%88%86%E5%B1%82%E9%80%92%E5%BD%92%E5%B8%83%E5%B1%80%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/",
            "url": "https://aynya.github.io/%E8%80%83%E8%99%91%E5%B0%BA%E5%AF%B8%E7%9A%84%E5%A4%9A%E5%8F%89%E6%A0%91%E5%88%86%E5%B1%82%E9%80%92%E5%BD%92%E5%B8%83%E5%B1%80%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/",
            "title": "è€ƒè™‘å°ºå¯¸çš„å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£",
            "date_published": "2025-04-11T07:57:44.000Z",
            "content_html": "<h1 id=\"å¸¦å°ºå¯¸å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£\"><a class=\"anchor\" href=\"#å¸¦å°ºå¯¸å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£\">#</a> ğŸŒ³ å¸¦å°ºå¯¸å¤šå‰æ ‘åˆ†å±‚é€’å½’å¸ƒå±€ç®—æ³•è¯¦è§£</h1>\n<p><strong>è¿™é‡Œä¸»è¦åº”ç”¨ä¸æ€ç»´å¯¼å›¾ï¼Œæ ‘çš„æ–¹å‘æ˜¯ä»å·¦åˆ°å³</strong><br />\nè®©ä½ çš„æ ‘å½¢ç»“æ„ã€Œä¸¥ä¸åˆç¼ã€ï¼âœ¨ æœ¬ç®—æ³•å¯å®ç°ï¼š<br />\nâœ… çˆ¶èŠ‚ç‚¹å‚ç›´å±…ä¸­äºå­èŠ‚ç‚¹åŒºåŸŸ<br />\nâœ… å­èŠ‚ç‚¹å³ä¾§ç«–ç›´æ’åˆ—ä¸é‡å <br />\nâœ… æ”¯æŒåŠ¨æ€å°ºå¯¸å’ŒæŠ˜å çŠ¶æ€<br />\nâœ… O (n) æ—¶é—´å¤æ‚åº¦</p>\n<hr />\n<h2 id=\"æ ¸å¿ƒæ€æƒ³\"><a class=\"anchor\" href=\"#æ ¸å¿ƒæ€æƒ³\">#</a> ğŸ§© æ ¸å¿ƒæ€æƒ³</h2>\n<p>åˆ†ä¸º<strong>ä¸¤é˜¶æ®µ</strong></p>\n<ol>\n<li><strong>ğŸ“ é¢„è®¡ç®—é˜¶æ®µ</strong>ï¼šè‡ªåº•å‘ä¸Šç»Ÿè®¡å­æ ‘å°ºå¯¸</li>\n<li><strong>ğŸ¯ å®šä½é˜¶æ®µ</strong>ï¼šè‡ªé¡¶å‘ä¸‹é€’å½’å¸ƒå±€</li>\n</ol>\n<hr />\n<h2 id=\"ï¸-å®ç°\"><a class=\"anchor\" href=\"#ï¸-å®ç°\">#</a> ğŸ› ï¸ å®ç°</h2>\n<h3 id=\"1-æ•°æ®ç»“æ„å®šä¹‰\"><a class=\"anchor\" href=\"#1-æ•°æ®ç»“æ„å®šä¹‰\">#</a> 1. ğŸ“¦ æ•°æ®ç»“æ„å®šä¹‰</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// èŠ‚ç‚¹ä¸­å¿ƒåæ ‡</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// [å®½åº¦ï¼Œé«˜åº¦]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// å­èŠ‚ç‚¹ ID åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"2-ï¸-é…ç½®å‚æ•°\"><a class=\"anchor\" href=\"#2-ï¸-é…ç½®å‚æ•°\">#</a> 2. âš™ï¸ é…ç½®å‚æ•°</h3>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">CONFIG</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  horizontalSpacing<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">//  çˆ¶å­æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  verticalSpacing<span class=\"token operator\">:</span> <span class=\"token number\">30</span>     <span class=\"token comment\">//  å…„å¼Ÿå‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"3-é¢„è®¡ç®—å­æ ‘å°ºå¯¸\"><a class=\"anchor\" href=\"#3-é¢„è®¡ç®—å­æ ‘å°ºå¯¸\">#</a> 3. ğŸ“ é¢„è®¡ç®—å­æ ‘å°ºå¯¸</h3>\n<p>é€šè¿‡é€’å½’çš„æ–¹å¼ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹å­æ ‘çš„å°ºå¯¸ (åŒ…æ‹¬è‡ªèº«)<br />\n<strong> ç®—æ³•åŸç†</strong></p>\n<ul>\n<li><strong>è‡ªåº•å‘ä¸Šé€’å½’</strong>ï¼šä»å¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œé€æ­¥å‘ä¸Šè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘å°ºå¯¸ã€‚</li>\n<li><strong>è€ƒè™‘æŠ˜å çŠ¶æ€</strong>ï¼šå¦‚æœèŠ‚ç‚¹è¢«æŠ˜å ï¼Œå®ƒçš„å­èŠ‚ç‚¹å°†ä¸å‚ä¸å¸ƒå±€ï¼Œç›´æ¥è¿”å›èŠ‚ç‚¹è‡ªèº«çš„å°ºå¯¸ã€‚</li>\n<li><strong>åˆå¹¶å­èŠ‚ç‚¹å°ºå¯¸</strong>ï¼šå¯¹äºéå¶å­èŠ‚ç‚¹ï¼Œéœ€è¦è®¡ç®—å…¶æ‰€æœ‰å­èŠ‚ç‚¹çš„é«˜åº¦æ€»å’Œ (å¹¶ä¸è‡ªèº«é«˜åº¦å–æœ€å¤§å€¼)ï¼Œå¹¶æ‰¾å‡ºæœ€å¤§å­èŠ‚ç‚¹çš„å®½åº¦ã€‚</li>\n</ul>\n<p>å›¾è§£è¿æ¥ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly92aWV3ZXIuZGlhZ3JhbXMubmV0Lz90YWdzPSU3QiU3RCZhbXA7bGlnaHRib3g9MSZhbXA7aGlnaGxpZ2h0PTAwMDBmZiZhbXA7ZWRpdD1fYmxhbmsmYW1wO2xheWVycz0xJmFtcDtuYXY9MSZhbXA7dGl0bGU9JUU2JTlDJUFBJUU1JTkxJUJEJUU1JTkwJThEJUU3JUJCJTk4JUU1JTlCJUJFLmRyYXdpbyZhbXA7ZGFyaz1hdXRvI1IlM0NteGZpbGUlM0UlM0NkaWFncmFtJTIwbmFtZSUzRCUyMiVFNyVBQyVBQyUyMDElMjAlRTklQTElQjUlMjIlMjBpZCUzRCUyMkk0S0VmanRHV1IxX1E0cjZZUmNPJTIyJTNFN1poZGI1c3dGSVolMkZqUzhiWWZQcHk1RFFkbHJYVGFxbVNiMWo0SUpYQnpQSGFaTDklMkJwbGdFcjdhWkJxMHk3YXIySzhQWUo3WDUyQUhtTFBGNWtxRWVmcUJ4NFFCWk1RYllNNEJRaEJCUyUyRjBVeXJaVVhOc29oVVRRV0FjZGhEdjZnMml4Q2x2Um1Dd2JnWkp6Sm1uZUZDT2VaU1NTRFMwVWdxJTJCYllRJTJCY05aJTJCYWh3bnBDSGRSeUxycUZ4ckx0RlE5NUI3MGEwS1R0SG95ZEhBNXNnaXJZUDBteXpTTSUyQmJvbW1RRXdaNEp6V2JZV214bGhCYnlLUzNuZDVUT2olMkI0a0prc2xUTHZDdjUyTDJIdWVYQ1dMM241ZTNVZkp4ZGFIdjhoU3lsWDVoUFZtNXJRZ0l2c3BpVXR6RUFLYSUyRlRxa2tkM2tZRmFOcjViblNVcmxncWdkVnN6dXA2Z2xFU0xLcFNYcVNWNFF2aUJSYkZWS05ZZzFNcnhqbzZ2NjZ4bDlMYVEyOW83VlFPNTdzNzN5QW9ocWF5eTh3UW44ZUk5TnFNdks2aUNBYWlkRzN4JTJCQW0lMkJmeVVmT2UzOXh2bjVwM0pieDlIV2tjZElEM1lUbWEwZiUyRmszZ3pUMFFucWdqTTA0NDBMMU01NlJZYmkxODY5bmJTRzNCeHV5eHVKbUhlZW1pbXRlTktPVllGdGZoTkVqa2NjQkhtanZjREthWCUyQnMyQzc4Uzlva3ZxYVE4VTVvbzM5TXZ5RkwxZGJocGpTOW9IQmR6OFVOR2swSmc1S0VlUDlYeVBrNXdHZXByY1dIMXN2enlHUk43R0JjUnRwdXJ2JTJCclhiZXh4MFIzTFJMdHJZdUFBM3dDJTJCQlFJYiUyQkJqNEpnZ3d3TzVPOFlEdkFqenZHSzJJeUthSkZmRklrU0hpSmVaOXE2R1pjRU9BZDV2ZzkyV29CdDdwQVclMkJPQmQ3NXU3Tm5qT1N4bk5ZV3BNZkR2dVFaelVPM0ozbHNnQVBncVliS0UzJTJCWE0lMkJlZlBKWjNIUHlySm8lMkYzajRMZkUzMHI4UGglMkYxZnJkcXRYbjRhdFdyZW9NUDdhSmJlTmFQaHoxclczMFM4WmQ0TUgyQ2RiRTlGcUdvWWtOTzU1QkEwNlEzZlVOdWVhazJtd003MTNQaVU1VnZ1a2NLQUJxNHpZMUFJWTdKUUQlMkJmTGVEbTRLcGMzNlZUMjJNSndacyUyQkdDaE55NSUyQjhJU1Q0dGtsRHZTRyUyQmxZNVJ3JTJCb3o2Yk1hR2RVYUo2VUx4aE1mWUM5TTg0WDJ6bWdyWFpwWHZkc09WQyUyQnFPN2hIOUxkV08xJTJGWmpQNENRJTNEJTNEJTNDJTJGZGlhZ3JhbSUzRSUzQyUyRm14ZmlsZSUzRQ==\">è®¡ç®—å°ºå¯¸</span></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹ ID</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„ä¸€ä¸ªæ˜ å°„</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @returns å½“å‰èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ &#123;width: number, height: number&#125;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€æˆ–å¶å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// é€’å½’è®¡ç®—å­èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">let</span> totalChildHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">let</span> maxChildWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    totalChildHeight <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    maxChildWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxChildWidth<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆåŒ…å«é—´è·ï¼‰</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> totalChildHeight <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹å®½åº¦ = è‡ªèº«å®½åº¦ + æœ€å¤§å­èŠ‚ç‚¹å®½åº¦ + æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> maxChildWidth <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆå–è‡ªèº«é«˜åº¦å’Œå­æ ‘é«˜åº¦ä¸­çš„è¾ƒå¤§å€¼ï¼‰</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">const</span> totalHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subtreeHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"4-èŠ‚ç‚¹æ ‘å¸ƒå±€\"><a class=\"anchor\" href=\"#4-èŠ‚ç‚¹æ ‘å¸ƒå±€\">#</a> 4. ğŸ“ˆ èŠ‚ç‚¹æ ‘å¸ƒå±€</h3>\n<p>æ ¹æ®è®¡ç®—å‡ºçš„å­æ ‘å°ºå¯¸ï¼Œé€’å½’åœ°è®¾ç½®æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½®<br />\n<strong>ç®—æ³•åŸç†</strong>ï¼š</p>\n<ul>\n<li><strong>è‡ªé¡¶å‘ä¸‹é€’å½’</strong>ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œæ ¹æ®çˆ¶èŠ‚ç‚¹çš„ä½ç½®å’Œå­æ ‘å°ºå¯¸ï¼Œç¡®å®šæ¯ä¸ªå­èŠ‚ç‚¹çš„ä½ç½®ã€‚</li>\n<li><strong>å‚ç›´å±…ä¸­å¯¹é½</strong>ï¼šä¸ºäº†ä¿æŒè§†è§‰ä¸Šçš„å¹³è¡¡ï¼Œå­èŠ‚ç‚¹ç›¸å¯¹äºçˆ¶èŠ‚ç‚¹å‚ç›´å±…ä¸­å¯¹é½ã€‚</li>\n<li><strong>å¿½ç•¥æŠ˜å èŠ‚ç‚¹</strong>ï¼šå¦‚æœæŸä¸ªèŠ‚ç‚¹è¢«æŠ˜å ï¼Œåˆ™ä¸å¤„ç†å…¶å­èŠ‚ç‚¹ã€‚</li>\n</ul>\n<p>å…„å¼ŸèŠ‚ç‚¹éœ€è¦ç´¯åŠ å‚ç›´ä½ç§»æ‰ä¿è¯ä¸ä¼šé‡å <br />\nå¹¶ä¸”æ³¨æ„çˆ¶èŠ‚ç‚¹æ˜¯æ›´å…·èŠ‚ç‚¹æ ‘çš„é«˜åº¦æ¥ç¡®å®šå‚ç›´ä½ç½®çš„åç§»é‡ï¼Œè€Œå­èŠ‚ç‚¹åˆ™æ˜¯æ ¹æ®è‡ªèº«é«˜åº¦æ¥ç¡®å®šå‚ç›´ä½ç½®çš„åç§»é‡ã€‚</p>\n<p>å›¾è§£ï¼š<span class=\"exturl\" data-url=\"aHR0cHM6Ly92aWV3ZXIuZGlhZ3JhbXMubmV0Lz90YWdzPSU3QiU3RCZhbXA7bGlnaHRib3g9MSZhbXA7aGlnaGxpZ2h0PTAwMDBmZiZhbXA7ZWRpdD1fYmxhbmsmYW1wO2xheWVycz0xJmFtcDtuYXY9MSZhbXA7dGl0bGU9JUU2JTlDJUFBJUU1JTkxJUJEJUU1JTkwJThEJUU3JUJCJTk4JUU1JTlCJUJFLmRyYXdpbyZhbXA7ZGFyaz1hdXRvI1IlM0NteGZpbGUlM0UlM0NkaWFncmFtJTIwbmFtZSUzRCUyMiVFNyVBQyVBQyUyMDElMjAlRTklQTElQjUlMjIlMjBpZCUzRCUyMkk0S0VmanRHV1IxX1E0cjZZUmNPJTIyJTNFN1psYmI1c3dHSVolMkZqUyUyQkx3TVNBTDBPU3R0TzZybEpWVGVvZEE0ZXdPbkZtbkNiWnI1OEpKZ1J3RHRWQ0RsTjdVJTJGUGhFOCUyRkxhJTJCd3Z3TzZORjNjOG1JNiUyQnNZaFFBTTFvQWV3JTJCZ05DQ1ZrZiUyQnl5TExQT0lpTXclMkZFUElsVXBUTHduUHdoS2xoVW15VVJTU3NWQldOVUpOTnFNR1NUQ1FsRkpSWnd6dWJWYWtOR3E2Tk9nNWcwQXM5aFFKdlJIMGtrUm5uVWcyNFp2eWRKUENwR3RoeWMzeGtIUldYMUpPa29pTmg4STJRUGdOM2pqSW04TkY3MENNM2dGVnp5ZHJkYjdxNG54c2xFSE5MQXYlMkIlMkZ6M2xjOHZZMGhmWDFKSDhQNCUyQiUyQnhHOWZJZTBKbDZZRFZac1N3SWNEYWJSQ1RyeEFTMlB4OGxnanhQZ3pDN081ZWF5OWhJakttOHNtU3hPYWxpQk1JRldXeUUxQ1R2Q0JzVHdaZXlpcnJyS0Y3cWhiRmNkVDNmd0s5Q293M3lSYk5BQ1I2dk95Nlp5SUxDOGdGRThQSVFyZDJ4ZzVFRlc0TDA2MjN3RUwlMkI4eDclMkZaNCUyQnZDZWZoaXM4ZTNsdDZqQmhFTnQ0TWgyZWpja0k3OUpnMFRTbnVNTWk2dkoyeENqc1B0QVA5QlY0TU5kdHJpMXRuUFRTNnUwNndZempoZCUyQmp3STM0allEN0NrdmNKSmslMkJtOUt0UGdKNkZQTEUxRXdpWXl4dlBuOURPeWlmdzZQTlR1ajVNb3l1YmlCelNKc3dBbHc4MzZYUlZlMSUyQk5NQktvdHpxUk84eSUyQmZhYUFqcVdpWmhnT3JCdkJRVTBtTmtHNWJPcUttamdNSCUyQkNid08yQ0FnSSUyQkJiNE1CQnRoZFJUemd1d0QzRzFwTEtLS3FZd0U5bEhBSTM0VmQ5MEpVUFhjRTlnZzMySGZzcG9zY0RYdTdMZmJPJTJGJTJCMmhOaXprdXNod0xGeiUyQlZSU0ZHa1YxYm1wTlVWZmpKZ1R3QUhpeUlJM2pyMHgwJTJGVzV5OFVkbE9LbXh2RThaTXJ6d3pETGd6JTJGWHR1T3ViVHRHVHJtJTJGRjlyMXRTZXN5MWxUWnEySmQ5bDB5M3VEamJURnFha0VEV1EzQkxOTXlJR3FLQmwzYmNGRmJ3bWtPZzNKSjdQYUJuTFRjOEhWTmdLMVZaQUQ4JTJGbXJuMXdWZDUlMkZxV3hOVWUyNjdvZ0t3enI0UFdBWWZNcTNPTjVSM3JJN1p6eWRPbVViWTVxTFhUcm1VZlpCOE11ajdBM2hYYngzTWR3M08yYnV6YzVtbjF0RTdTSEZlM09XbEl5YUtiWlpzbEdUS0pWTEVmMGlCTmszQ2JqMHFPSkdwa29mZFMzT0NDTkZ5S0dDZFUlMkJ1aTkycjBPbGhyaGlTVnk0TFZJZGkwZEJEMXNJRmp0SldVekhoTFZFRzVrb0d0OWRkRCUyQnZrVEFZeUlhZmEwVVhEJTJGOFA0aXFPVFhWUlQxMW9oS1pOU3hPY3hscUslMkJPdGg2UTUwNXdia2xON2R5NGc1WDNBa2VQY2xDNGc1MzNBTHY0Q2t0NTFEN2FhOVphWDVjOSUyQiUyQmNwVyUyRm5ocUQlMkY0QyUzQyUyRmRpYWdyYW0lM0UlM0MlMkZteGZpbGUlM0U=\">å¸ƒå±€</span></p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * é€’å½’è®¾ç½®æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½® (å‰åºéå†)</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹çš„ ID</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„éšå°„</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param parentX çˆ¶èŠ‚ç‚¹çš„ X åæ ‡</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param parentY çˆ¶èŠ‚ç‚¹çš„ Y åæ ‡</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> sizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹ä½ç½®ï¼ˆæ ¹æ®è¯¥ç‚¹çš„èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ï¼Œå‚ç›´å±…ä¸­ï¼‰</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePosition</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€ä¸å¤„ç†å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­èŠ‚ç‚¹èµ·å§‹ä½ç½®</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> sizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// å­èŠ‚ç‚¹æ°´å¹³ä½ç½®</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">const</span> childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">+</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">// é€’å½’å¸ƒå±€</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">// æ›´æ–°ç´¯ç§¯ Y åæ ‡ï¼ˆåŒ…å«é—´è·ï¼‰</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h2 id=\"ä¼˜åŒ–å»ºè®®\"><a class=\"anchor\" href=\"#ä¼˜åŒ–å»ºè®®\">#</a> âš¡ä¼˜åŒ–å»ºè®®</h2>\n<ul>\n<li>å¦‚æœçˆ¶èŠ‚ç‚¹çš„é«˜åº¦å°±æ˜¯è¯¥èŠ‚ç‚¹æ ‘çš„é«˜åº¦æ—¶ï¼Œå­èŠ‚ç‚¹ä¼šåœ¨çˆ¶èŠ‚ç‚¹ Y åæ ‡çš„å¼€å§‹å¤„å¼€å§‹æ’åˆ— (å¾…è§£å†³)</li>\n<li>ç¼“å­˜å­æ ‘çš„å°ºå¯¸ï¼Œé¿å…é‡å¤è®¡ç®—</li>\n<li>å¢é‡æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼Œå‡å°‘é‡ç»˜æ¬¡æ•°</li>\n</ul>\n<h2 id=\"é€‚ç”¨åœºæ™¯\"><a class=\"anchor\" href=\"#é€‚ç”¨åœºæ™¯\">#</a> ğŸŒŸ é€‚ç”¨åœºæ™¯</h2>\n<ul>\n<li>æ€ç»´å¯¼å›¾å·¥å…· ğŸ§ </li>\n<li>æ–‡ä»¶ç›®å½•å¯è§†åŒ– ğŸ“‚</li>\n<li>ç»„ç»‡æ¶æ„å›¾ ğŸ‘¥</li>\n</ul>\n<hr />\n<p>ğŸ’¡ å°è´´å£«ï¼šè°ƒæ•´  <code>horizontalSpacing</code>  å’Œ  <code>verticalSpacing</code>  å¯è·å¾—ä¸åŒé£æ ¼çš„å¸ƒå±€æ•ˆæœï¼ğŸ¨</p>\n<hr />\n<p>âœ¨ä¼˜åŒ–æ›´æ–°ï¼š2025-04-13<br />\n ä¼˜åŒ–å†…å®¹ï¼š</p>\n<ul>\n<li>å°†å¸ƒå±€ä»£ç æ”¾åˆ°ä¸»å‡½æ•°ä¸­ï¼Œç”¨ <code>map</code>  å»è®°å½•æ›´æ–°åçš„èŠ‚ç‚¹ä½ç½®ï¼Œå¸ƒå±€ç»“æŸåç»Ÿä¸€æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°ã€‚</li>\n</ul>\n<p>ä¼˜åŒ–åŸå› ï¼š</p>\n<ul>\n<li>åŸæ¥çš„ä»£ç åœ¨å¸ƒå±€çš„æ—¶å€™æ¯æ¬¡ç®—å‡ºçš„ä½ç½®éƒ½ç›´æ¥è°ƒç”¨ <code>setNodePosition</code>  å»æ›´æ–°ï¼Œä¼šå¯¼è‡´ç»„ä»¶é‡æ¸²æŸ“å¤šæ¬¡ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>\n</ul>\n<p><strong>å®æµ‹å¯ä»¥å¤§å¤§å‡å°‘é‡ç»˜æ¬¡æ•°ï¼Œæå‡æ€§èƒ½ã€‚</strong></p>\n<p>ä»£ç ï¼š</p>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateTreeLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// 1. åˆ›å»ºä¸´æ—¶ä½ç½®å­˜å‚¨å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// 2. æ¸…ç©ºä½ç½®</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// 3. ä¿®æ”¹åçš„å¸ƒå±€å‡½æ•°ï¼ˆä¸å†ç›´æ¥æ›´æ–°çŠ¶æ€ï¼‰</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨åˆ°ä¸´æ—¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token keyword\">const</span> childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">+</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token comment\">// 5. ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä½ç½®</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<p>âœ¨ä¼˜åŒ–æ›´æ–°ï¼š2025-04-16<br />\n æ›´æ–°å†…å®¹ï¼š</p>\n<ul>\n<li>ä½¿ç”¨æ€ç»´å¯¼å›¾çš„æ ‘å¸ƒå±€ç®—æ³•ï¼Œå®ç°äº† <code>right-to-left</code>  &amp;  <code>center</code>  &amp;  <code>top-to-bottom</code>  æ ‘å¸ƒå±€ç»“æ„ï¼Œç°åœ¨ä¸€å…±æœ‰å››ç§æ ‘å¸ƒå±€ç»“æ„</li>\n</ul>\n<p>æ›´æ–°åŸå› ï¼š</p>\n<ul>\n<li>åŸæ¥çš„å¸ƒå±€ç»“æ„å¤ªå•ä¸€</li>\n</ul>\n<p>æ­¥éª¤ï¼š</p>\n<ol>\n<li><strong>çŠ¶æ€ç®¡ç†ä¸­æ·»åŠ å¸ƒå±€ç»“æ„é€‰æ‹©</strong></li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å°ºå¯¸å­—æ®µ [width, height]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// æ–°å¢æŠ˜å çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢æ–¹å‘å±æ€§ (åªåœ¨ center å¸ƒå±€ä¸­ä½¿ç”¨)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">State</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> Node<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    connections<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    selectedNodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    layoutStyle<span class=\"token operator\">:</span> <span class=\"token string\">'left-to-right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right-to-left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'center'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'top-to-bottom'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ–°å¢å¸ƒå±€é£æ ¼å±æ€§</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li><strong>å¯¹äº center å¸ƒå±€éœ€è¦ä¸€ä¸ªç‰¹å®šçš„ direction å±æ€§</strong><br />\n <code>center</code>  å¸ƒå±€æˆ‘é‡‡ç”¨çš„æ˜¯åªå¯¹äºæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¿›è¡Œå·¦å³åŒºåˆ†ï¼Œä¸€åŠåœ¨å·¦ä¸€åŠåœ¨å³è¾¹ï¼Œå…¶ä»–çš„å­èŠ‚ç‚¹å°±ç›´æ¥ç»§æ‰¿å…¶çˆ¶èŠ‚ç‚¹çš„ <code>direction</code>  å±æ€§ã€‚è¿™æ ·å°±å¯ä»¥åˆ’åˆ†å‡ºå·¦å­æ ‘å’Œå³å­æ ‘ã€‚<br />\nå½“ç„¶ï¼åœ¨æ¯æ¬¡å¯¹æ ¹èŠ‚ç‚¹è¿›è¡Œæ“ä½œæ—¶éƒ½éœ€è¦ä»æ–°è®¡ç®— <code>direction</code>  å±æ€§.<br />\n å› æ­¤åœ¨çŠ¶æ€ç®¡ç†ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æ›´æ–° center å¸ƒå±€çš„ direction</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function-variable function\">updateChildrenDirections</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">const</span> updateNodeDirection <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> parentDirection<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>node<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœçˆ¶èŠ‚ç‚¹æœ‰æ–¹å‘ï¼Œç»§æ‰¿çˆ¶èŠ‚ç‚¹çš„æ–¹å‘</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parentDirection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> parentDirection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token comment\">// é€’å½’æ›´æ–°å­èŠ‚ç‚¹çš„æ–¹å‘</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token function\">updateNodeDirection</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// console.log(JSON.parse(JSON.stringify(rootNode.children)))</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rootNode <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token builtin\">Array</span><span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">const</span> child <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'center'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    child<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        index <span class=\"token operator\">&lt;</span> rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">?</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    child<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'right-to-left'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    child<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// console.log(JSON.parse(JSON.stringify(rooFtNode.children)))</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\">// è°ƒç”¨å‡½æ•°æ›´æ–°æ‰€æœ‰å­èŠ‚ç‚¹çš„æ–¹å‘</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">const</span> child <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token function\">updateNodeDirection</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><strong>left-to-right &amp; right-to-left å¸ƒå±€ä»£ç </strong><br />\nåªéœ€è¦å°†ä¹‹å‰çš„å¸ƒå±€ä»£ç åŒºåˆ†ä¸ºå·¦å³ï¼Œä¿®æ”¹ <code>childX</code>  çš„è®¡ç®—æ–¹æ³•å³å¯å®ç°</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useMindmapStore <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/useMindmapStore'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeWidth</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeHeight</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> horizontalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// çˆ¶å­èŠ‚ç‚¹æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> verticalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// å…„å¼ŸèŠ‚ç‚¹å‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateTreeLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">const</span> layoutStyle <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>layoutStyle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// 1. åˆ›å»ºä¸´æ—¶ä½ç½®å­˜å‚¨å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">// 2. ä¿®æ”¹æ¸…ç©ºä½ç½®çš„æ–¹å¼</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// 3. ä¿®æ”¹åçš„å¸ƒå±€å‡½æ•°ï¼ˆä¸å†ç›´æ¥æ›´æ–°çŠ¶æ€ï¼‰</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨åˆ°ä¸´æ—¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token keyword\">let</span> childX <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'left-to-right'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// åŠ </span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">+</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>layoutStyle <span class=\"token operator\">===</span> <span class=\"token string\">'right-to-left'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// å‡</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        childX <span class=\"token operator\">=</span> currentX <span class=\"token operator\">-</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token comment\">// 5. ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä½ç½®</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"88\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"89\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹ ID</pre></td></tr><tr><td data-num=\"90\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"91\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„ä¸€ä¸ªæ˜ å°„</pre></td></tr><tr><td data-num=\"92\"></td><td><pre> * @returns å½“å‰èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ &#123;width: number, height: number&#125;</pre></td></tr><tr><td data-num=\"93\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€æˆ–å¶å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// é€’å½’è®¡ç®—å­èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token keyword\">let</span> totalChildHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token keyword\">let</span> maxChildWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    totalChildHeight <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    maxChildWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxChildWidth<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆåŒ…å«é—´è·ï¼‰</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> totalChildHeight <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token comment\">// å½“å‰èŠ‚ç‚¹å®½åº¦ = è‡ªèº«å®½åº¦ + æœ€å¤§å­èŠ‚ç‚¹å®½åº¦ + æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> maxChildWidth <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—æ€»é«˜åº¦ï¼ˆå–è‡ªèº«é«˜åº¦å’Œå­æ ‘é«˜åº¦ä¸­çš„è¾ƒå¤§å€¼ï¼‰</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token keyword\">const</span> totalHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subtreeHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> totalHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> calculateTreeLayout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li><strong>center å¸ƒå±€ä»£ç </strong><br />\nåˆ’åˆ†ä¸ºå·¦å­æ ‘å’Œå³å­æ ‘ï¼Œå·¦å­æ ‘æŒ‰ç…§ <code>right-to-left</code>  å¸ƒå±€ï¼Œå³å­æ ‘æŒ‰ç…§ <code>left-to-right</code>  å¸ƒå±€ã€‚æ³¨æ„è®¡ç®—å­æ ‘å°ºå¯¸çš„æ—¶å€™ä¹Ÿéœ€è¦å°†ä¸¤ä¸ªå­æ ‘åˆ†å¼€è®¡ç®—ã€‚æ€»çš„æ¥è¯´å°±æ˜¯å°†å·¦å³å­æ ‘åˆ†åˆ«æ‰§è¡Œä¸¤æ¬¡å¸ƒå±€ç®—æ³•å°±å¯ä»¥å®ç°ã€‚</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useMindmapStore <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/useMindmapStore'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    direction<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'left'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'right'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ä½¿ç”¨ Store ä¸­çš„ direction å±æ€§</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeWidth</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeHeight</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> horizontalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// çˆ¶å­èŠ‚ç‚¹æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">const</span> verticalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// å…„å¼ŸèŠ‚ç‚¹å‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€ï¼ˆä»ä¸­é—´å‘å·¦å³å¸ƒå±€ï¼‰</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateCenterLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">// ä¸´æ—¶å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„æ–°ä½ç½®</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// åˆå§‹åŒ–æ‰€æœ‰èŠ‚ç‚¹ä½ç½®ä¸º [0, 0]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// å­æ ‘å°ºå¯¸ç¼“å­˜ï¼ˆå…¨å±€å…±äº«ï¼‰</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// åˆ†ç¦»å·¦å³å­æ ‘</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">const</span> leftChildren <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">const</span> rightChildren <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> nodes<span class=\"token punctuation\">[</span>childId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">// å¸ƒå±€å·¦ä¾§å­æ ‘</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutLeftTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token keyword\">let</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                currentX <span class=\"token operator\">-=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> currentX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                childY <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">let</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        leftChildren<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> originalRootX<span class=\"token punctuation\">,</span> sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            sum <span class=\"token operator\">+=</span> childSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token comment\">// å¸ƒå±€å³ä¾§å­æ ‘</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutRightTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutTree</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            parentId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            <span class=\"token keyword\">let</span> currentX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">===</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                currentX <span class=\"token operator\">+=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY <span class=\"token operator\">+</span> nodeSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Setting position for </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>nodeId<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">:</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> currentX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">,</span> nodeId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                childY <span class=\"token operator\">+=</span> childSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token keyword\">let</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        rightChildren<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            <span class=\"token function\">layoutTree</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> originalRootX<span class=\"token punctuation\">,</span> sum<span class=\"token punctuation\">,</span> rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            sum <span class=\"token operator\">+=</span> childSize<span class=\"token operator\">?.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token comment\">// å¸ƒå±€å·¦å³å­æ ‘</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token function\">layoutLeftTree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token function\">layoutRightTree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token keyword\">let</span> minY <span class=\"token operator\">=</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token keyword\">let</span> maxY <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">Infinity</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> nodeId <span class=\"token keyword\">in</span> newPositions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token keyword\">const</span> y <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        minY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>minY<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        maxY <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxY<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>minY<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> Number<span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>maxY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        minY <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        maxY <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">minY: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>minY<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">, maxY: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>maxY<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>    <span class=\"token comment\">// è®¾ç½®æ ¹èŠ‚ç‚¹ä½ç½®</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>originalRootX<span class=\"token punctuation\">,</span> maxY <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token comment\">// æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„ä½ç½®</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>    useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre></pre></td></tr><tr><td data-num=\"164\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"165\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"166\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>    nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>        sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>        <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    <span class=\"token keyword\">let</span> totalHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token keyword\">let</span> maxWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        totalHeight <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        maxWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>maxWidth<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>    <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> totalHeight <span class=\"token operator\">-</span> verticalSpacing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> maxWidth <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> subtreeWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> calculateCenterLayout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li><strong>top-to-bottom çš„å¸ƒå±€ä»£ç </strong><br />\nåªéœ€è¦å°†åŸæ¥çš„å¸ƒå±€ç®—æ³•ï¼Œå®½åº¦æ”¹ä¸ºé«˜åº¦ï¼Œé«˜åº¦æ”¹ä¸ºå®½åº¦å³å¯ã€‚æ ¸å¿ƒçš„è®¡ç®—æ€æƒ³ä¹Ÿæ˜¯ä¸å˜ï¼Œå…ˆå°ºå¯¸å†å¸ƒå±€ï¼Œä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ <code>left-to-right</code>  é¡ºæ—¶é’ˆæ—‹æ”¹å˜ <code>x</code>  å’Œ <code>y</code>  åæ ‡å¾—æ¥çš„ã€‚</li>\n</ol>\n<figure class=\"highlight ts\"><figcaption data-lang=\"TypeScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> useMindmapStore <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/useMindmapStore'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">interface</span> <span class=\"token class-name\">TreeNode</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  position<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  size<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  children<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  collapsed<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// è¾…åŠ©å‡½æ•°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeWidth</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getNodeHeight</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">:</span> TreeNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">const</span> horizontalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// çˆ¶å­èŠ‚ç‚¹æ°´å¹³é—´è·</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> verticalSpacing <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// å…„å¼ŸèŠ‚ç‚¹å‚ç›´é—´è·</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * è®¡ç®—æ•´ä¸ªæ ‘çš„å¸ƒå±€</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">calculateVerticaLayout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nodes <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">const</span> rootNode <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootX <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> originalRootY <span class=\"token operator\">=</span> rootNode<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// 1. åˆ›å»ºä¸´æ—¶ä½ç½®å­˜å‚¨å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">const</span> newPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token comment\">// 2. ä¿®æ”¹æ¸…ç©ºä½ç½®çš„æ–¹å¼</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—å­æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeSizes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> subtreeSizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>subtreeSizes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">// 3. ä¿®æ”¹åçš„å¸ƒå±€å‡½æ•°ï¼ˆä¸å†ç›´æ¥æ›´æ–°çŠ¶æ€ï¼‰</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">layoutNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    parentX<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    parentY<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">const</span> nodeSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">const</span> currentX <span class=\"token operator\">=</span> parentX <span class=\"token operator\">+</span> nodeSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">const</span> currentY <span class=\"token operator\">=</span> parentY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    newPositions<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>currentX<span class=\"token punctuation\">,</span> currentY<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å­˜å‚¨åˆ°ä¸´æ—¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">let</span> childX <span class=\"token operator\">=</span> parentX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> subtreeSizes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">let</span> childY <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      childY <span class=\"token operator\">=</span> currentY <span class=\"token operator\">+</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> childX<span class=\"token punctuation\">,</span> childY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      childX <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>width <span class=\"token operator\">+</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token function\">layoutNode</span><span class=\"token punctuation\">(</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">// 4. è®¡ç®—ä½ç½®åç§»å¹¶æ‰¹é‡æ›´æ–°</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootX <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token keyword\">const</span> computedRootY <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>rootNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> computedRootX <span class=\"token operator\">-</span> originalRootX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> computedRootY <span class=\"token operator\">-</span> originalRootY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">// åº”ç”¨åç§»å¹¶å‡†å¤‡æœ€ç»ˆä½ç½®</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token keyword\">const</span> finalPositions<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>newPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    finalPositions<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> dx<span class=\"token punctuation\">,</span> y <span class=\"token operator\">-</span> dy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">// 5. ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä½ç½®</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  useMindmapStore<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>actions<span class=\"token punctuation\">.</span><span class=\"token function\">setNodePositions</span><span class=\"token punctuation\">(</span>finalPositions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"85\"></td><td><pre> * é¢„è®¡æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸ï¼Œå¹¶è¿”å›æ€»å®½åº¦å’Œæ€»é«˜åº¦ (ååºéå†)</pre></td></tr><tr><td data-num=\"86\"></td><td><pre> * @param nodeId å½“å‰èŠ‚ç‚¹ ID</pre></td></tr><tr><td data-num=\"87\"></td><td><pre> * @param nodes æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡</pre></td></tr><tr><td data-num=\"88\"></td><td><pre> * @param sizes æ¯ä¸ªèŠ‚ç‚¹æ ‘å°ºå¯¸çš„ä¸€ä¸ªæ˜ å°„</pre></td></tr><tr><td data-num=\"89\"></td><td><pre> * @returns å½“å‰èŠ‚ç‚¹æ ‘çš„å°ºå¯¸ &#123;width: number, height: number&#125;</pre></td></tr><tr><td data-num=\"90\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token keyword\">const</span> calculateSubtreeSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  nodeId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  nodes<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TreeNode<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  sizes<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">[</span>nodeId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">// æŠ˜å çŠ¶æ€æˆ–å¶å­èŠ‚ç‚¹</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>collapsed <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> <span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">// é€’å½’è®¡ç®—å­èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token keyword\">let</span> totalChildHeight <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">let</span> maxChildWidth <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>childId <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token keyword\">const</span> childSize <span class=\"token operator\">=</span> <span class=\"token function\">calculateSubtreeSize</span><span class=\"token punctuation\">(</span>childId<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">,</span> sizes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    maxChildWidth <span class=\"token operator\">+=</span> childSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    totalChildHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>totalChildHeight<span class=\"token punctuation\">,</span> childSize<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeHeight <span class=\"token operator\">=</span> <span class=\"token function\">getNodeHeight</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> totalChildHeight <span class=\"token operator\">+</span> verticalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token keyword\">const</span> subtreeWidth <span class=\"token operator\">=</span> maxChildWidth <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> horizontalSpacing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token keyword\">const</span> totalWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token function\">getNodeWidth</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subtreeWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token comment\">// è®¾ç½®å½“å‰èŠ‚ç‚¹æ ‘å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  sizes<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>nodeId<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> totalWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token operator\">:</span> totalWidth<span class=\"token punctuation\">,</span> height<span class=\"token operator\">:</span> subtreeHeight <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> calculateVerticaLayout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ğŸ¾è‡³æ­¤ï¼Œå®Œæˆäº† <code>left-to-right</code>  &amp;  <code>right-to-left</code>  &amp;  <code>center</code>  &amp;  <code>top-to-bottom</code>  ç»“æ„çš„å¸ƒå±€ï¼Œå½“ç„¶ï¼åç»­ä¹Ÿå¯ä»¥æ·»åŠ  <code>æ—¶é—´è½´å¸ƒå±€ç»“æ„</code>  &amp;  <code>é±¼éª¨å›¾</code>  &amp;  <code>åŠ›å¯¼å‘</code> ç­‰ç­‰è®¸å¤šç»“æ„å¸ƒå±€</p>\n<hr />\n",
            "tags": [
                "canvas",
                "JavaScript",
                "æ ‘",
                "æ€ç»´å¯¼å›¾"
            ]
        },
        {
            "id": "https://aynya.github.io/Konva-js%E5%AE%9E%E7%8E%B0%E8%B6%85%E8%87%AA%E7%84%B6%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/",
            "url": "https://aynya.github.io/Konva-js%E5%AE%9E%E7%8E%B0%E8%B6%85%E8%87%AA%E7%84%B6%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/",
            "title": "Konva.jså®ç°è¶…è‡ªç„¶æ–‡æœ¬ç¼–è¾‘",
            "date_published": "2025-04-10T03:38:33.000Z",
            "content_html": "<h1 id=\"å½“-canvas-é‡è§-domåœ¨-konva-ä¸­å®ç°ä¸æ»‘æ–‡æœ¬ç¼–è¾‘çš„æŠ€å·§\"><a class=\"anchor\" href=\"#å½“-canvas-é‡è§-domåœ¨-konva-ä¸­å®ç°ä¸æ»‘æ–‡æœ¬ç¼–è¾‘çš„æŠ€å·§\">#</a> ğŸ¨ å½“ Canvas é‡è§ DOMï¼šåœ¨ Konva ä¸­å®ç°ä¸æ»‘æ–‡æœ¬ç¼–è¾‘çš„æŠ€å·§</h1>\n<h2 id=\"ä¸ºä»€ä¹ˆéœ€è¦-dom-canvas-çš„æ··åˆæ–¹æ¡ˆ\"><a class=\"anchor\" href=\"#ä¸ºä»€ä¹ˆéœ€è¦-dom-canvas-çš„æ··åˆæ–¹æ¡ˆ\">#</a> ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ DOM + Canvas çš„æ··åˆæ–¹æ¡ˆï¼Ÿ</h2>\n<p>konva çš„ <code>Text</code>  ç»„ä»¶è™½ç„¶å¼ºå¤§ï¼Œä½†åœ¨å¤„ç†<strong>å¤æ‚æ–‡æœ¬ç¼–è¾‘</strong>æ—¶å­˜åœ¨å±€é™ï¼š</p>\n<ul>\n<li>âŒ¨ï¸ ç¼ºå°‘è‡ªåŠ¨æ¢è¡Œã€å…‰æ ‡æ§åˆ¶ç­‰åŸç”Ÿèƒ½åŠ›</li>\n<li>ğŸ–¥ï¸ å¤æ‚æ ·å¼æ”¯æŒæœ‰é™</li>\n</ul>\n<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé€šè¿‡ DOM å…ƒç´ æ¨¡æ‹Ÿ Canvas çš„æ–‡æœ¬ç¼–è¾‘ï¼</p>\n<hr />\n<h2 id=\"ç›®æ ‡\"><a class=\"anchor\" href=\"#ç›®æ ‡\">#</a> ğŸ“Œ ç›®æ ‡</h2>\n<p>è®© Konva ç”»å¸ƒä¸­çš„èŠ‚ç‚¹æ–‡æœ¬ <strong>åŒå‡»å¯ç¼–è¾‘</strong>ï¼Œæ•ˆæœåƒç›´æ¥åœ¨ Canvas ä¸Šè¾“å…¥æ–‡å­—ä¸€æ ·ä¸æ»‘ï¼ï¼ˆæ— éœ€ Konva çš„å¤æ‚ç»„ä»¶ï¼Œç›´æ¥ç”¨åŸç”Ÿ <code>&lt;textarea&gt;</code>  å®ç°ï¼ï¼‰</p>\n<h2 id=\"æ ¸å¿ƒæ€è·¯\"><a class=\"anchor\" href=\"#æ ¸å¿ƒæ€è·¯\">#</a> ğŸ”§ æ ¸å¿ƒæ€è·¯</h2>\n<ol>\n<li><strong>åŒå‡»è§¦å‘</strong>ï¼šç›‘å¬ konva èŠ‚ç‚¹çš„ <code>onDblClick</code>  äº‹ä»¶</li>\n<li><strong>DOM å®šä½</strong>ï¼šKonva ç”»å¸ƒåæ ‡ç³»è®¡ç®— DOM å…ƒç´ çš„ç»å¯¹ä½ç½®</li>\n<li><strong>åŒæ­¥æ ·å¼</strong>ï¼šè®© <code>&lt;textarea&gt;</code>  å®Œå…¨å¤åˆ» Konva èŠ‚ç‚¹çš„æ ·å¼ (é¢œè‰²ã€å­—ä½“ã€å­—å·ç­‰)</li>\n<li><strong>æ•°æ®åŒæ­¥</strong>ï¼šè¾“å…¥å®Œæˆæ—¶æ›´æ–° Konva èŠ‚ç‚¹æ–‡æœ¬å’Œå°ºå¯¸</li>\n</ol>\n<hr />\n<h2 id=\"ä»£ç \"><a class=\"anchor\" href=\"#ä»£ç \">#</a> ğŸ“ ä»£ç </h2>\n<h3 id=\"1ï¸âƒ£-ç›‘å¬åŒå‡»äº‹ä»¶\"><a class=\"anchor\" href=\"#1ï¸âƒ£-ç›‘å¬åŒå‡»äº‹ä»¶\">#</a> 1ï¸âƒ£ ç›‘å¬åŒå‡»äº‹ä»¶</h3>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleDoubleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> KonvaEventObject<span class=\"token operator\">&lt;</span>MouseEvent<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> stage <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">getStage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// è®¡ç®—ç¼©æ”¾åçš„ä½ç½®</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> areaPosition <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    x<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">scaleX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    y<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">scaleY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// åˆ›å»º DOM è¾“å…¥æ¡†</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">createTextarea</span><span class=\"token punctuation\">(</span>areaPosition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"2ï¸âƒ£-åˆ›å»º-dom-è¾“å…¥æ¡†\"><a class=\"anchor\" href=\"#2ï¸âƒ£-åˆ›å»º-dom-è¾“å…¥æ¡†\">#</a> 2ï¸âƒ£ åˆ›å»º DOM è¾“å…¥æ¡†</h3>\n<ol>\n<li>åˆ›å»º  <code>textarea</code></li>\n<li>æ‰¾åˆ° konva çš„ä½ç½®ï¼Œå¹¶åŒæ­¥åˆ° DOM ä¸­</li>\n<li>å¤åˆ»æ ·å¼</li>\n<li>èšç„¦</li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åˆ›å»º textarea</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> textarea <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"textarea\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"konva-container\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>container<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>container<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>textarea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> <span class=\"token string\">\"absolute\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>areaPosition<span class=\"token punctuation\">.</span>y<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>areaPosition<span class=\"token punctuation\">.</span>x<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>node<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontSize <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> scale<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>border <span class=\"token operator\">=</span> <span class=\"token string\">\"2px solid #4f46e5\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Rect çš„ stroke</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>borderRadius <span class=\"token operator\">=</span> <span class=\"token string\">\"8px\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Rect çš„ cornerRadius</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>padding <span class=\"token operator\">=</span> <span class=\"token string\">\"20px\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Text çš„ padding</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>margin <span class=\"token operator\">=</span> <span class=\"token string\">\"0px\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>overflow <span class=\"token operator\">=</span> <span class=\"token string\">\"hidden\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">\"#ffffff\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Rect çš„ fill</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>outline <span class=\"token operator\">=</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>resize <span class=\"token operator\">=</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>wordBreak <span class=\"token operator\">=</span> <span class=\"token string\">\"break-word\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontFamily <span class=\"token operator\">=</span> <span class=\"token string\">\"Arial, sans-serif\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Text çš„ fontFamily</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>transformOrigin <span class=\"token operator\">=</span> <span class=\"token string\">\"left top\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>color <span class=\"token operator\">=</span> <span class=\"token string\">\"#000000\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤åˆ» Text çš„é¢œè‰²</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"3ï¸âƒ£-æ•°æ®åŒæ­¥ä¸é”€æ¯\"><a class=\"anchor\" href=\"#3ï¸âƒ£-æ•°æ®åŒæ­¥ä¸é”€æ¯\">#</a> 3ï¸âƒ£ æ•°æ®åŒæ­¥ä¸é”€æ¯</h3>\n<ol>\n<li>ç›‘å¬äº‹ä»¶ï¼šç›‘å¬é”®ç›˜äº‹ä»¶ã€å¤±ç„¦äº‹ä»¶</li>\n<li>ç§»é™¤ DOM å…ƒç´ </li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">removeTextarea</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// ç›‘å¬é”®ç›˜äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keydown\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>key <span class=\"token operator\">===</span> <span class=\"token string\">\"Enter\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>e<span class=\"token punctuation\">.</span>shiftKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        textarea<span class=\"token punctuation\">.</span><span class=\"token function\">blur</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// å¤±å»ç„¦ç‚¹è§¦å‘ä¿å­˜</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"input\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">measureText</span><span class=\"token punctuation\">(</span>textarea<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>width<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    textarea<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>height<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// å¤±ç„¦æ—¶ä¿å­˜æ–‡æœ¬</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>textarea<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"blur\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">const</span> newText <span class=\"token operator\">=</span> textarea<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    actions<span class=\"token punctuation\">.</span><span class=\"token function\">updateNodeText</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°èŠ‚ç‚¹æ–‡æœ¬</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    actions<span class=\"token punctuation\">.</span><span class=\"token function\">updateNodeSize</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token function\">measureText</span><span class=\"token punctuation\">(</span>newText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æ›´æ–°èŠ‚ç‚¹å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">removeTextarea</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ç§»é™¤ textarea</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"4ï¸âƒ£-æµ‹é‡æ–‡æœ¬å°ºå¯¸\"><a class=\"anchor\" href=\"#4ï¸âƒ£-æµ‹é‡æ–‡æœ¬å°ºå¯¸\">#</a> 4ï¸âƒ£ æµ‹é‡æ–‡æœ¬å°ºå¯¸</h3>\n<p>é€šè¿‡ç›´æ¥åœ¨ DOM ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„  <code>Konva.Text</code>  å…ƒç´ ï¼Œç„¶åè·å–å®ƒçš„å°ºå¯¸ã€‚ç”±äºè¿™è¾¹å¤åˆ»çš„ <code>padding</code>  æ˜¯ 20px ä¸Šä¸‹å·¦å³éƒ½æœ‰ï¼Œæ‰€ä»¥å®½é«˜éƒ½è¦åŠ ä¸Š 40pxã€‚<br />\nå¦‚æœçŸ¥è¯†å•å•çš„å¤åˆ»ï¼Œå°±ä¸éœ€è¦åŠ  <code>padding</code>  äº†ï¼Œç›´æ¥è¿”å›å®½é«˜å°±è¡Œã€‚</p>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æµ‹é‡æ–‡æœ¬å°ºå¯¸</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> measureText <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>text<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> tempText <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva</span><span class=\"token punctuation\">.</span><span class=\"token function\">Text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        fontSize<span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        text<span class=\"token operator\">:</span> text</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        tempText<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        tempText<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"5ï¸âƒ£-æ–‡æœ¬ä½ç½®è·å–è¯¦è§£å‘é‡è¿ç®—\"><a class=\"anchor\" href=\"#5ï¸âƒ£-æ–‡æœ¬ä½ç½®è·å–è¯¦è§£å‘é‡è¿ç®—\">#</a> 5ï¸âƒ£ æ–‡æœ¬ä½ç½®è·å–è¯¦è§£ (å‘é‡è¿ç®—)</h3>\n<ol>\n<li><code>stage</code>  çš„ <code>x &amp; y</code>  æ˜¯æ•´ä¸ªç”»å¸ƒç›¸å¯¹äºè§†å£çš„åç§»é‡</li>\n<li><code>node</code>  çš„ <code>postion</code>  æ˜¯å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºç”»å¸ƒçš„åç§»é‡</li>\n<li>è€Œæˆ‘ä»¬è¦è·å–çš„æ˜¯å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºè§†å£çš„åç§»é‡</li>\n<li>è€Œ <code>node</code>  å®é™…çš„ç›¸å¯¹äºç”»å¸ƒçš„åç§»é‡æ˜¯å— <code>scale</code>  å½±å“çš„</li>\n<li>æ‰€ä»¥å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºè§†å£çš„åç§»é‡å°±æ˜¯ï¼š <code>stage + node * scale</code></li>\n</ol>\n<figure class=\"highlight tsx\"><figcaption data-lang=\"React TSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è·å–æ–‡æœ¬ä½ç½®</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> areaPosition <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    x<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    y<span class=\"token operator\">:</span> stage<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p>é€šè¿‡ DOM + Canvas çš„æ··åˆæ–¹æ¡ˆï¼Œå®ç°äº†ä¸€ä¸ªè¶…è‡ªç„¶æ–‡æœ¬ç¼–è¾‘çš„ç»„ä»¶ã€‚é€šè¿‡ç›‘å¬ <code>onDblClick</code>  äº‹ä»¶ï¼Œåœ¨ç”»å¸ƒä¸ŠåŒå‡»æ—¶åˆ›å»ºä¸€ä¸ª <code>textarea</code> ï¼Œå¹¶åŒæ­¥æ ·å¼å’Œä½ç½®ã€‚é€šè¿‡é”®ç›˜äº‹ä»¶å’Œå¤±ç„¦äº‹ä»¶ï¼Œå®ç°äº†æ–‡æœ¬çš„ä¿å­˜å’Œå°ºå¯¸çš„æ›´æ–°ã€‚</p>\n<h2 id=\"äº®ç‚¹\"><a class=\"anchor\" href=\"#äº®ç‚¹\">#</a> ğŸŒˆ äº®ç‚¹</h2>\n<ul>\n<li>çº¯åŸç”Ÿ DOM æ“ä½œï¼Œè½»é‡é«˜æ•ˆ</li>\n<li><strong>å®Œç¾èåˆ</strong>ï¼šè¾“å…¥æ¡†ä¸ç”»å¸ƒå…ƒç´ æ— ç¼è¡”æ¥</li>\n</ul>\n<hr />\n<p>ğŸ‰ <strong>ç°åœ¨ï¼Œç”»å¸ƒèŠ‚ç‚¹æ‹¥æœ‰ â€œç¼–è¾‘è¶…èƒ½åŠ›â€ äº†ï¼</strong></p>\n",
            "tags": [
                "canvas",
                "konva",
                "Dom",
                "Text"
            ]
        }
    ]
}